<!doctype html>
<html >
<head>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!--[if lt IE 9]>
                <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
        <![endif]-->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <!-- <link rel="stylesheet" type="text/css" href="template.css" /> -->
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <!-- <script type='text/javascript' src='menu/js/jquery.cookie.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.hoverIntent.minified.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.dcjqaccordion.2.7.min.js'></script> -->

    <!-- <link href="menu/css/skins/blue.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/graphite.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/grey.css" rel="stylesheet" type="text/css" /> -->

    <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->


    <!-- <script src="script.js"></script> -->

    <!-- <script src="jquery.sticky-kit.js "></script> -->
    <script type='text/javascript' src='https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
    <link href="./elegant_bootstrap.css" rel="stylesheet" type="text/css" />
    <!-- <link href="https://cdn.rawgit.com/ryangrose/easy-pandoc-templates/948e28e5/css/elegant_bootstrap.css" rel="stylesheet" type="text/css" /> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script src="https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/script.js"></script>

    <script src="https://cdn.rawgit.com/diversen/pandoc-bootstrap-adaptive-template/959c3622/jquery.sticky-kit.js"></script>
    <meta name="generator" content="pandoc" />
  <meta name="author" content="Gabriel Parmer" />
  <meta name="author" content="Sibin Mohan" />
  <title>GWU CSCi 2410: Systems Programming</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>


    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">GWU CSCi 2410: Systems
Programming</span>
        <ul class="nav pull-right doc-info">
                    <li><p class="navbar-text">Gabriel Parmer</p></li>
                    <li><p class="navbar-text">Sibin Mohan</p></li>
                            </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">

        <ul>
        <li><a href="#intro-to-systems-programming"
        id="toc-intro-to-systems-programming"><span
        class="toc-section-number">1</span> Intro to Systems
        Programming</a>
        <ul>
        <li><a href="#computer-organization"
        id="toc-computer-organization"><span
        class="toc-section-number">1.1</span> Computer
        Organization</a></li>
        <li><a href="#memory-hierarchies"
        id="toc-memory-hierarchies"><span
        class="toc-section-number">1.2</span> Memory
        Hierarchies</a></li>
        <li><a href="#intro-to-c" id="toc-intro-to-c"><span
        class="toc-section-number">1.3</span> Intro to C</a>
        <ul>
        <li><a href="#you-already-know-c"
        id="toc-you-already-know-c">You already know
        <strong>C</strong></a></li>
        <li><a
        href="#c-constructs-if-youre-familiar-with-java-python-etc."
        id="toc-c-constructs-if-youre-familiar-with-java-python-etc."><span
        class="toc-section-number">1.3.1</span> C constructs [if you’re
        familiar with Java, Python, etc.]</a></li>
        <li><a href="#whats-different-from-java"
        id="toc-whats-different-from-java">What’s different [from
        java]</a></li>
        <li><a href="#compound-types" id="toc-compound-types"><span
        class="toc-section-number">1.3.2</span> Compound types</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#intermediate-c" id="toc-intermediate-c"><span
        class="toc-section-number">2</span> Intermediate C</a>
        <ul>
        <li><a href="#objectives" id="toc-objectives"><span
        class="toc-section-number">2.1</span> Objectives</a></li>
        <li><a href="#types" id="toc-types"><span
        class="toc-section-number">2.2</span> Types</a>
        <ul>
        <li><a href="#basic-types" id="toc-basic-types"><span
        class="toc-section-number">2.2.1</span> Basic types</a></li>
        <li><a href="#common-posix-types-and-values"
        id="toc-common-posix-types-and-values"><span
        class="toc-section-number">2.2.2</span> Common POSIX types and
        values</a></li>
        <li><a href="#format-strings" id="toc-format-strings"><span
        class="toc-section-number">2.2.3</span> Format Strings</a></li>
        <li><a href="#compound-types-1" id="toc-compound-types-1"><span
        class="toc-section-number">2.2.4</span> Compound types</a></li>
        <li><a href="#pointers-arrays" id="toc-pointers-arrays"><span
        class="toc-section-number">2.2.5</span> Pointers &amp;
        Arrays</a></li>
        </ul></li>
        <li><a href="#memory-allocation"
        id="toc-memory-allocation"><span
        class="toc-section-number">2.3</span> Memory Allocation</a>
        <ul>
        <li><a href="#common-errors" id="toc-common-errors"><span
        class="toc-section-number">2.3.1</span> Common Errors</a></li>
        </ul></li>
        <li><a href="#exercises" id="toc-exercises"><span
        class="toc-section-number">2.4</span> Exercises</a>
        <ul>
        <li><a href="#c-is-a-thin-language-layer-on-top-of-memory"
        id="toc-c-is-a-thin-language-layer-on-top-of-memory"><span
        class="toc-section-number">2.4.1</span> C is a Thin Language
        Layer on Top of Memory</a></li>
        <li><a href="#quick-and-dirty-key-value-store"
        id="toc-quick-and-dirty-key-value-store"><span
        class="toc-section-number">2.4.2</span> Quick-and-dirty
        Key-Value Store</a></li>
        </ul></li>
        <li><a href="#pointers-and-arrays"
        id="toc-pointers-and-arrays"><span
        class="toc-section-number">2.5</span> Pointers and
        Arrays</a></li>
        <li><a href="#pointer-arithmetic"
        id="toc-pointer-arithmetic"><span
        class="toc-section-number">2.6</span> Pointer
        Arithmetic</a></li>
        <li><a href="#pointer-casting" id="toc-pointer-casting"><span
        class="toc-section-number">2.7</span> Pointer Casting!</a>
        <ul>
        <li><a href="#casting-from-int-to-char"
        id="toc-casting-from-int-to-char"><span
        class="toc-section-number">2.7.1</span> Casting from
        <code>int*</code> to <code>char*</code></a></li>
        <li><a href="#example-3" id="toc-example-3"><span
        class="toc-section-number">2.7.2</span> Example</a></li>
        </ul></li>
        <li><a href="#pointer-casting-void"
        id="toc-pointer-casting-void"><span
        class="toc-section-number">2.8</span> Pointer Casting |
        <code>void*</code></a></li>
        </ul></li>
        <li><a href="#function-pointers"
        id="toc-function-pointers"><span
        class="toc-section-number">3</span> Function Pointers</a>
        <ul>
        <li><a href="#example-bubble-sort"
        id="toc-example-bubble-sort"><span
        class="toc-section-number">3.0.1</span> Example | Bubble
        Sort</a></li>
        <li><a href="#example-generic-bubble-sort"
        id="toc-example-generic-bubble-sort"><span
        class="toc-section-number">3.0.2</span> Example | Generic Bubble
        Sort</a></li>
        <li><a href="#what-is-generic" id="toc-what-is-generic"><span
        class="toc-section-number">3.0.3</span> What is
        “<em>generic</em>”?</a></li>
        <li><a href="#generic-to-concrete-functions"
        id="toc-generic-to-concrete-functions"><span
        class="toc-section-number">3.0.4</span> Generic to
        <em>concrete</em> functions</a></li>
        <li><a href="#putting-it-all-together-using-function-pointers"
        id="toc-putting-it-all-together-using-function-pointers"><span
        class="toc-section-number">3.0.5</span> Putting it all Together
        | Using Function Pointers</a></li>
        <li><a href="#why-bother-if-we-need-concrete-functions-anyways"
        id="toc-why-bother-if-we-need-concrete-functions-anyways"><span
        class="toc-section-number">3.0.6</span> Why bother if we need
        <code>concrete</code> functions anyways?</a></li>
        <li><a
        href="#in-class-exercise-generic-insertion-sort-for-struct"
        id="toc-in-class-exercise-generic-insertion-sort-for-struct"><span
        class="toc-section-number">3.0.7</span> In-class Exercise |
        Generic Insertion Sort for <code>struct</code></a></li>
        </ul></li>
        <li><a href="#c-memory-model-data-structures-and-apis"
        id="toc-c-memory-model-data-structures-and-apis"><span
        class="toc-section-number">4</span> C Memory Model,
        Data-structures, and APIs</a>
        <ul>
        <li><a href="#memory-allocation-options"
        id="toc-memory-allocation-options"><span
        class="toc-section-number">4.1</span> Memory Allocation
        Options</a>
        <ul>
        <li><a href="#internal-allocation"
        id="toc-internal-allocation"><span
        class="toc-section-number">4.1.1</span> Internal
        Allocation</a></li>
        <li><a href="#heap-allocation" id="toc-heap-allocation"><span
        class="toc-section-number">4.1.2</span> Heap Allocation</a></li>
        <li><a href="#global-allocation"
        id="toc-global-allocation"><span
        class="toc-section-number">4.1.3</span> Global
        Allocation</a></li>
        <li><a href="#stack-allocation" id="toc-stack-allocation"><span
        class="toc-section-number">4.1.4</span> Stack
        Allocation</a></li>
        <li><a href="#putting-it-all-together"
        id="toc-putting-it-all-together"><span
        class="toc-section-number">4.1.5</span> Putting it all
        Together</a></li>
        <li><a href="#comparing-c-to-java"
        id="toc-comparing-c-to-java"><span
        class="toc-section-number">4.1.6</span> Comparing C to
        Java</a></li>
        </ul></li>
        <li><a href="#strings" id="toc-strings"><span
        class="toc-section-number">4.2</span> Strings</a>
        <ul>
        <li><a href="#string.h-functions"
        id="toc-string.h-functions"><span
        class="toc-section-number">4.2.1</span> <code>string.h</code>
        Functions</a></li>
        <li><a href="#bonus-explicit-strings"
        id="toc-bonus-explicit-strings"><span
        class="toc-section-number">4.2.2</span> Bonus: Explicit
        Strings</a></li>
        </ul></li>
        <li><a href="#api-design-and-concerns"
        id="toc-api-design-and-concerns"><span
        class="toc-section-number">4.3</span> API Design and
        Concerns</a>
        <ul>
        <li><a href="#return-values" id="toc-return-values"><span
        class="toc-section-number">4.3.1</span> Return Values</a></li>
        <li><a href="#memory-ownership" id="toc-memory-ownership"><span
        class="toc-section-number">4.3.2</span> Memory
        Ownership</a></li>
        </ul></li>
        <li><a href="#exercises-1" id="toc-exercises-1"><span
        class="toc-section-number">4.4</span> Exercises</a>
        <ul>
        <li><a href="#stack-allocation-1"
        id="toc-stack-allocation-1"><span
        class="toc-section-number">4.4.1</span> Stack
        Allocation</a></li>
        <li><a href="#understanding-memory-ownership"
        id="toc-understanding-memory-ownership"><span
        class="toc-section-number">4.4.2</span> Understanding Memory
        Ownership</a></li>
        </ul></li>
        <li><a href="#errors" id="toc-errors"><span
        class="toc-section-number">4.5</span> Errors</a>
        <ul>
        <li><a href="#return-vals-indicate-errors"
        id="toc-return-vals-indicate-errors"><span
        class="toc-section-number">4.5.1</span> <strong>return</strong>
        vals → indicate errors</a></li>
        <li><a href="#errno-variable-and-command"
        id="toc-errno-variable-and-command"><span
        class="toc-section-number">4.5.2</span> <code>errno</code>
        variable and command</a></li>
        <li><a href="#additional-helper-functions"
        id="toc-additional-helper-functions"><span
        class="toc-section-number">4.5.3</span> Additional Helper
        Functions</a></li>
        <li><a
        href="#understand-return-values-of-unix-library-functions"
        id="toc-understand-return-values-of-unix-library-functions"><span
        class="toc-section-number">4.5.4</span> Understand Return Values
        of UNIX library functions:</a></li>
        <li><a
        href="#in-class-exercise-printing-all-error-codesstrings-in-sequence"
        id="toc-in-class-exercise-printing-all-error-codesstrings-in-sequence"><span
        class="toc-section-number">4.5.5</span> In-class Exercise |
        Printing <strong>all</strong> error codes/strings in
        sequence</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#processes" id="toc-processes"><span
        class="toc-section-number">5</span> Processes</a>
        <ul>
        <li><a href="#history-unix-posix-and-linux"
        id="toc-history-unix-posix-and-linux"><span
        class="toc-section-number">5.1</span> History: UNIX, POSIX, and
        Linux</a>
        <ul>
        <li><a href="#tackling-complexity"
        id="toc-tackling-complexity"><span
        class="toc-section-number">5.1.1</span> tackling
        complexity</a></li>
        </ul></li>
        <li><a href="#process" id="toc-process"><span
        class="toc-section-number">5.2</span> process</a></li>
        <li><a href="#fork" id="toc-fork"><span
        class="toc-section-number">5.3</span> <code>fork()</code></a>
        <ul>
        <li><a href="#after-fork" id="toc-after-fork"><span
        class="toc-section-number">5.3.1</span> after
        <code>fork()</code></a></li>
        <li><a href="#process-creationterminationcoordination-api"
        id="toc-process-creationterminationcoordination-api"><span
        class="toc-section-number">5.3.2</span> process
        creation/termination/coordination API</a></li>
        <li><a href="#pdt_t" id="toc-pdt_t"><span
        class="toc-section-number">5.3.3</span>
        <code>pdt_t</code></a></li>
        <li><a href="#lets-revisit-fork"
        id="toc-lets-revisit-fork"><span
        class="toc-section-number">5.3.4</span> let’s revisit
        <code>fork()</code></a></li>
        <li><a href="#fork-return-values"
        id="toc-fork-return-values"><span
        class="toc-section-number">5.3.5</span> <code>fork()</code>
        return values</a></li>
        <li><a href="#fork-questions" id="toc-fork-questions"><span
        class="toc-section-number">5.3.6</span> <code>fork</code>
        Questions</a></li>
        </ul></li>
        <li><a href="#wait" id="toc-wait"><span
        class="toc-section-number">5.4</span> <code>wait()</code></a>
        <ul>
        <li><a href="#process-vs-thread"
        id="toc-process-vs-thread"><span
        class="toc-section-number">5.4.1</span> process vs
        thread</a></li>
        </ul></li>
        <li><a href="#exit" id="toc-exit"><span
        class="toc-section-number">5.5</span> <code>exit()</code></a>
        <ul>
        <li><a href="#interpreting-exit-status"
        id="toc-interpreting-exit-status"><span
        class="toc-section-number">5.5.1</span> Interpreting
        <code>exit()</code> status</a></li>
        <li><a href="#relationship-between-wait-and-exit"
        id="toc-relationship-between-wait-and-exit"><span
        class="toc-section-number">5.5.2</span> Relationship between
        <code>wait()</code> and <code>exit()</code></a></li>
        <li><a href="#life-after-exit" id="toc-life-after-exit"><span
        class="toc-section-number">5.5.3</span> life after
        <code>exit()</code>?</a></li>
        </ul></li>
        <li><a href="#command-line-arguments"
        id="toc-command-line-arguments"><span
        class="toc-section-number">5.6</span> Command Line
        Arguments</a></li>
        <li><a href="#environment-variables"
        id="toc-environment-variables"><span
        class="toc-section-number">5.7</span> Environment Variables</a>
        <ul>
        <li><a href="#environment-variable-apis"
        id="toc-environment-variable-apis"><span
        class="toc-section-number">5.7.1</span> Environment Variable
        APIs</a></li>
        <li><a href="#an-aside-creating-processes-with-posix_spawn"
        id="toc-an-aside-creating-processes-with-posix_spawn"><span
        class="toc-section-number">5.7.2</span> An Aside: Creating
        Processes with <code>posix_spawn</code></a></li>
        </ul></li>
        <li><a href="#representations-of-processes"
        id="toc-representations-of-processes"><span
        class="toc-section-number">5.8</span> Representations of
        Processes</a></li>
        <li><a href="#process-exercises"
        id="toc-process-exercises"><span
        class="toc-section-number">5.9</span> Process Exercises</a>
        <ul>
        <li><a href="#exercise-1-fibonacci-with-fork"
        id="toc-exercise-1-fibonacci-with-fork"><span
        class="toc-section-number">5.9.1</span> Exercise 1: fibonacci
        with <code>fork</code></a></li>
        <li><a
        href="#exercise-2-shell-support-for-environment-variables"
        id="toc-exercise-2-shell-support-for-environment-variables"><span
        class="toc-section-number">5.9.2</span> Exercise 2: Shell
        Support for Environment Variables</a></li>
        <li><a href="#exercise-3-process-detective"
        id="toc-exercise-3-process-detective"><span
        class="toc-section-number">5.9.3</span> Exercise 3: Process
        Detective</a></li>
        </ul></li>
        <li><a href="#executing-other-processes"
        id="toc-executing-other-processes"><span
        class="toc-section-number">5.10</span> Executing Other
        Processes</a>
        <ul>
        <li><a href="#sequence-of-operations"
        id="toc-sequence-of-operations"><span
        class="toc-section-number">5.10.1</span> Sequence of
        operations</a></li>
        </ul></li>
        <li><a href="#exec_-family" id="toc-exec_-family"><span
        class="toc-section-number">5.11</span> <code>exec_()</code>
        family</a>
        <ul>
        <li><a href="#execve" id="toc-execve"><span
        class="toc-section-number">5.11.1</span>
        <code>execve()</code></a></li>
        <li><a href="#fork-and-exec" id="toc-fork-and-exec"><span
        class="toc-section-number">5.11.2</span> <code>fork()</code> and
        <code>exec()</code></a></li>
        <li><a href="#launch-any-child-processes"
        id="toc-launch-any-child-processes"><span
        class="toc-section-number">5.11.3</span> Launch
        <strong>Any</strong> Child Processes</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#process-descriptors"
        id="toc-process-descriptors"><span
        class="toc-section-number">6</span> Process Descriptors</a>
        <ul>
        <li><a href="#key-mechanisms" id="toc-key-mechanisms"><span
        class="toc-section-number">6.0.1</span> Key Mechanisms</a></li>
        <li><a href="#current-working-directory"
        id="toc-current-working-directory"><span
        class="toc-section-number">6.0.2</span> current working
        directory</a></li>
        <li><a href="#process-descriptors-1"
        id="toc-process-descriptors-1"><span
        class="toc-section-number">6.0.3</span> Process
        Descriptors</a></li>
        <li><a href="#file-descriptor-operations"
        id="toc-file-descriptor-operations"><span
        class="toc-section-number">6.0.4</span> File Descriptor
        Operations</a></li>
        <li><a href="#pipes" id="toc-pipes"><span
        class="toc-section-number">6.1</span> Pipes</a>
        <ul>
        <li><a href="#unix-pipes" id="toc-unix-pipes"><span
        class="toc-section-number">6.1.1</span> unix ‘pipes’</a></li>
        <li><a href="#pipes-api" id="toc-pipes-api"><span
        class="toc-section-number">6.1.2</span> pipes api</a></li>
        <li><a href="#the-shell" id="toc-the-shell"><span
        class="toc-section-number">6.1.3</span> The Shell</a></li>
        </ul></li>
        <li><a href="#signals" id="toc-signals"><span
        class="toc-section-number">6.2</span> Signals</a>
        <ul>
        <li><a href="#enter-signals" id="toc-enter-signals"><span
        class="toc-section-number">6.2.1</span> Enter
        ‘<strong>signals</strong>’</a></li>
        <li><a href="#signals-interface"
        id="toc-signals-interface"><span
        class="toc-section-number">6.2.2</span> Signals
        Interface</a></li>
        <li><a href="#notable-signals" id="toc-notable-signals"><span
        class="toc-section-number">6.2.3</span> Notable Signals</a></li>
        <li><a href="#minor-detour-sa_sigaction"
        id="toc-minor-detour-sa_sigaction"><span
        class="toc-section-number">6.2.4</span> Minor Detour |
        <code>sa_sigaction</code></a></li>
        <li><a href="#signals-further-examples"
        id="toc-signals-further-examples"><span
        class="toc-section-number">6.2.5</span> Signals | Further
        Examples</a></li>
        <li><a href="#the-dark-side-of-signals"
        id="toc-the-dark-side-of-signals"><span
        class="toc-section-number">6.2.6</span> The Dark Side of
        Signals</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#files-and-file-handling"
        id="toc-files-and-file-handling"><span
        class="toc-section-number">7</span> Files and File Handling</a>
        <ul>
        <li><a href="#basic-file-access"
        id="toc-basic-file-access"><span
        class="toc-section-number">7.1</span> Basic File Access</a></li>
        <li><a href="#moving-around-in-files"
        id="toc-moving-around-in-files"><span
        class="toc-section-number">7.2</span> Moving Around in
        Files</a></li>
        <li><a href="#other-ways-to-access-files"
        id="toc-other-ways-to-access-files"><span
        class="toc-section-number">7.3</span> Other Ways to Access
        Files</a>
        <ul>
        <li><a href="#memory-mapping-files-mmap"
        id="toc-memory-mapping-files-mmap"><span
        class="toc-section-number">7.3.1</span> Memory Mapping Files |
        <code>mmap()</code></a></li>
        <li><a href="#stream-based-io" id="toc-stream-based-io"><span
        class="toc-section-number">7.3.2</span> Stream-Based
        I/O</a></li>
        </ul></li>
        <li><a href="#accessing-directories"
        id="toc-accessing-directories"><span
        class="toc-section-number">7.4</span> Accessing
        Directories</a></li>
        <li><a href="#exercises-2" id="toc-exercises-2"><span
        class="toc-section-number">7.5</span> Exercises</a>
        <ul>
        <li><a href="#task-1-markdown-tree"
        id="toc-task-1-markdown-tree"><span
        class="toc-section-number">7.5.1</span> Task 1: Markdown
        Tree</a></li>
        <li><a href="#task-2-file-and-directory-sizes"
        id="toc-task-2-file-and-directory-sizes"><span
        class="toc-section-number">7.5.2</span> Task 2: File and
        Directory Sizes</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#io-inter-process-communication"
        id="toc-io-inter-process-communication"><span
        class="toc-section-number">8</span> I/O: Inter-Process
        Communication</a>
        <ul>
        <li><a href="#ipc-example-modern-browsers"
        id="toc-ipc-example-modern-browsers"><span
        class="toc-section-number">8.1</span> IPC Example: Modern
        Browsers</a></li>
        <li><a href="#goals-of-ipc-mechanisms"
        id="toc-goals-of-ipc-mechanisms"><span
        class="toc-section-number">8.2</span> Goals of IPC
        Mechanisms</a></li>
        <li><a href="#files-shared-memory"
        id="toc-files-shared-memory"><span
        class="toc-section-number">8.3</span> Files &amp; Shared
        Memory</a></li>
        <li><a href="#named-pipes" id="toc-named-pipes"><span
        class="toc-section-number">8.4</span> Named Pipes</a>
        <ul>
        <li><a
        href="#challenges-with-named-pipes-for-multi-client-communication"
        id="toc-challenges-with-named-pipes-for-multi-client-communication"><span
        class="toc-section-number">8.4.1</span> Challenges with Named
        Pipes for Multi-Client Communication</a></li>
        </ul></li>
        <li><a href="#unix-domain-sockets"
        id="toc-unix-domain-sockets"><span
        class="toc-section-number">8.5</span> UNIX Domain Sockets</a>
        <ul>
        <li><a href="#domain-sockets-for-multi-client-communication"
        id="toc-domain-sockets-for-multi-client-communication"><span
        class="toc-section-number">8.5.1</span> Domain sockets for
        Multi-Client Communication</a></li>
        </ul></li>
        <li><a href="#ipc-exercises" id="toc-ipc-exercises"><span
        class="toc-section-number">8.6</span> IPC Exercises</a></li>
        </ul></li>
        <li><a
        href="#reinforcing-ideas-assorted-exercises-and-event-notification"
        id="toc-reinforcing-ideas-assorted-exercises-and-event-notification"><span
        class="toc-section-number">9</span> Reinforcing Ideas: Assorted
        Exercises and Event Notification</a>
        <ul>
        <li><a href="#fork-and-stream-behavior"
        id="toc-fork-and-stream-behavior"><span
        class="toc-section-number">9.0.1</span> <code>fork</code> and
        Stream Behavior</a></li>
        <li><a href="#wait-behavior" id="toc-wait-behavior"><span
        class="toc-section-number">9.0.2</span> Wait Behavior</a></li>
        <li><a href="#read-behavior" id="toc-read-behavior"><span
        class="toc-section-number">9.0.3</span> <code>read</code>
        Behavior</a></li>
        <li><a href="#signals-1" id="toc-signals-1"><span
        class="toc-section-number">9.0.4</span> Signals</a></li>
        <li><a href="#communication-with-multiple-clients"
        id="toc-communication-with-multiple-clients"><span
        class="toc-section-number">9.0.5</span> Communication with
        Multiple Clients</a></li>
        <li><a href="#revisiting-ipc-with-multiple-clients"
        id="toc-revisiting-ipc-with-multiple-clients"><span
        class="toc-section-number">9.1</span> Revisiting IPC with
        Multiple Clients</a>
        <ul>
        <li><a href="#system-services" id="toc-system-services"><span
        class="toc-section-number">9.1.1</span> System Services</a></li>
        <li><a href="#understanding-descriptor-events-with-poll"
        id="toc-understanding-descriptor-events-with-poll"><span
        class="toc-section-number">9.1.2</span> Understanding Descriptor
        Events with <code>poll</code></a></li>
        <li><a href="#event-loops-and-poll"
        id="toc-event-loops-and-poll"><span
        class="toc-section-number">9.1.3</span> Event Loops and
        <code>poll</code></a></li>
        <li><a href="#poll-api" id="toc-poll-api"><span
        class="toc-section-number">9.1.4</span> <code>poll</code>
        API</a></li>
        <li><a href="#example-poll-code"
        id="toc-example-poll-code"><span
        class="toc-section-number">9.1.5</span> Example
        <code>poll</code> Code</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#libraries" id="toc-libraries"><span
        class="toc-section-number">10</span> Libraries</a>
        <ul>
        <li><a href="#libraries---goals-and-overview"
        id="toc-libraries---goals-and-overview"><span
        class="toc-section-number">10.1</span> Libraries - Goals and
        Overview</a></li>
        <li><a href="#libraries---header-files"
        id="toc-libraries---header-files"><span
        class="toc-section-number">10.2</span> Libraries - Header
        Files</a></li>
        <li><a
        href="#linking-undefined-symbols-to-references-across-objects"
        id="toc-linking-undefined-symbols-to-references-across-objects"><span
        class="toc-section-number">10.3</span> Linking Undefined Symbols
        to References Across Objects</a>
        <ul>
        <li><a href="#elf-object-format"
        id="toc-elf-object-format"><span
        class="toc-section-number">10.3.1</span> ELF Object
        Format</a></li>
        <li><a href="#linking-summary" id="toc-linking-summary"><span
        class="toc-section-number">10.3.2</span> Linking
        Summary</a></li>
        </ul></li>
        <li><a href="#static-libraries" id="toc-static-libraries"><span
        class="toc-section-number">10.4</span> Static Libraries</a>
        <ul>
        <li><a href="#saving-memory-with-static-libraries"
        id="toc-saving-memory-with-static-libraries"><span
        class="toc-section-number">10.4.1</span> Saving Memory with
        Static Libraries</a></li>
        </ul></li>
        <li><a href="#shareddynamic-libraries"
        id="toc-shareddynamic-libraries"><span
        class="toc-section-number">10.5</span> Shared/Dynamic
        Libraries</a>
        <ul>
        <li><a href="#compiling-and-executing-with-dynamic-libraries"
        id="toc-compiling-and-executing-with-dynamic-libraries"><span
        class="toc-section-number">10.5.1</span> Compiling and Executing
        with Dynamic Libraries</a></li>
        <li><a href="#exec-with-dynamic-linking"
        id="toc-exec-with-dynamic-linking"><span
        class="toc-section-number">10.5.2</span> <code>exec</code> with
        Dynamic Linking</a></li>
        <li><a href="#diving-into-dynamic-linking-at-exec"
        id="toc-diving-into-dynamic-linking-at-exec"><span
        class="toc-section-number">10.5.3</span> Diving into Dynamic
        Linking at <code>exec</code></a></li>
        <li><a href="#dynamic-loading-summary"
        id="toc-dynamic-loading-summary"><span
        class="toc-section-number">10.5.4</span> Dynamic Loading
        Summary</a></li>
        <li><a href="#saving-memory-with-dynamic-libraries"
        id="toc-saving-memory-with-dynamic-libraries"><span
        class="toc-section-number">10.5.5</span> Saving Memory with
        Dynamic Libraries</a></li>
        </ul></li>
        <li><a href="#static-vs.-dynamic-library-memory-usage-summary"
        id="toc-static-vs.-dynamic-library-memory-usage-summary"><span
        class="toc-section-number">10.6</span> Static vs. Dynamic
        Library Memory Usage Summary</a></li>
        </ul></li>
        <li><a
        href="#organizing-software-with-dynamic-libraries-exercises-and-programming"
        id="toc-organizing-software-with-dynamic-libraries-exercises-and-programming"><span
        class="toc-section-number">11</span> Organizing Software with
        Dynamic Libraries: Exercises and Programming</a>
        <ul>
        <li><a href="#exercise-understanding-library-memory-consumption"
        id="toc-exercise-understanding-library-memory-consumption"><span
        class="toc-section-number">11.1</span> Exercise: Understanding
        Library Memory Consumption</a></li>
        <li><a href="#library-trade-offs"
        id="toc-library-trade-offs"><span
        class="toc-section-number">11.2</span> Library
        Trade-offs</a></li>
        <li><a href="#programming-dynamic-libraries"
        id="toc-programming-dynamic-libraries"><span
        class="toc-section-number">11.3</span> Programming Dynamic
        Libraries</a>
        <ul>
        <li><a href="#plugins-and-dynamic-library-apis"
        id="toc-plugins-and-dynamic-library-apis"><span
        class="toc-section-number">11.3.1</span> Plugins and Dynamic
        Library APIs</a></li>
        <li><a href="#interposing-libraries-on-library-apis"
        id="toc-interposing-libraries-on-library-apis"><span
        class="toc-section-number">11.3.2</span> Interposing Libraries
        on Library APIs</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#system-calls-and-memory-management"
        id="toc-system-calls-and-memory-management"><span
        class="toc-section-number">12</span> System Calls and Memory
        Management</a>
        <ul>
        <li><a href="#system-calls" id="toc-system-calls"><span
        class="toc-section-number">12.1</span> System Calls</a>
        <ul>
        <li><a href="#system-calls-and-processes"
        id="toc-system-calls-and-processes"><span
        class="toc-section-number">12.1.1</span> System Calls and
        Processes</a></li>
        </ul></li>
        <li><a href="#observing-system-calls"
        id="toc-observing-system-calls"><span
        class="toc-section-number">12.2</span> Observing System
        Calls</a></li>
        <li><a href="#system-call-overhead"
        id="toc-system-call-overhead"><span
        class="toc-section-number">12.3</span> System Call
        Overhead</a></li>
        <li><a
        href="#library-vs.-kernel-trade-offs-in-memory-allocation"
        id="toc-library-vs.-kernel-trade-offs-in-memory-allocation"><span
        class="toc-section-number">12.4</span> Library vs. Kernel
        Trade-offs in Memory Allocation</a>
        <ul>
        <li><a href="#library-tracking-of-memory"
        id="toc-library-tracking-of-memory"><span
        class="toc-section-number">12.4.1</span> Library Tracking of
        Memory</a></li>
        <li><a href="#malloc-data-structures"
        id="toc-malloc-data-structures"><span
        class="toc-section-number">12.4.2</span> Malloc
        Data-structures</a></li>
        <li><a href="#exercise-smalloc" id="toc-exercise-smalloc"><span
        class="toc-section-number">12.4.3</span> Exercise:
        <code>smalloc</code></a></li>
        </ul></li>
        </ul></li>
        <li><a
        href="#unix-security-users-groups-and-filesystem-permissions"
        id="toc-unix-security-users-groups-and-filesystem-permissions"><span
        class="toc-section-number">13</span> UNIX Security: Users,
        Groups, and Filesystem Permissions</a>
        <ul>
        <li><a href="#file-and-directory-permissions"
        id="toc-file-and-directory-permissions"><span
        class="toc-section-number">13.1</span> File and Directory
        Permissions</a>
        <ul>
        <li><a href="#file-ownership-and-groups"
        id="toc-file-ownership-and-groups"><span
        class="toc-section-number">13.1.1</span> File Ownership and
        Groups</a></li>
        <li><a href="#file-permissions" id="toc-file-permissions"><span
        class="toc-section-number">13.1.2</span> File
        Permissions</a></li>
        <li><a href="#numerical-representation-of-permissions"
        id="toc-numerical-representation-of-permissions"><span
        class="toc-section-number">13.1.3</span> Numerical
        Representation of Permissions</a></li>
        <li><a href="#updating-filedirectory-permissions"
        id="toc-updating-filedirectory-permissions"><span
        class="toc-section-number">13.1.4</span> Updating File/Directory
        Permissions</a></li>
        <li><a href="#changing-filedirectory-owner-and-group"
        id="toc-changing-filedirectory-owner-and-group"><span
        class="toc-section-number">13.1.5</span> Changing File/Directory
        Owner and Group</a></li>
        </ul></li>
        <li><a href="#security-and-programming-with-users-and-groups"
        id="toc-security-and-programming-with-users-and-groups"><span
        class="toc-section-number">13.2</span> Security and Programming
        with Users and Groups</a>
        <ul>
        <li><a href="#user-and-group-strings"
        id="toc-user-and-group-strings"><span
        class="toc-section-number">13.2.1</span> User and Group
        Strings</a></li>
        </ul></li>
        <li><a
        href="#application-specific-privileges-using-set-user-idset-group-id"
        id="toc-application-specific-privileges-using-set-user-idset-group-id"><span
        class="toc-section-number">13.3</span> Application-Specific
        Privileges using set-user-id/set-group-id</a></li>
        <li><a
        href="#applications-of-identify-and-permission-management"
        id="toc-applications-of-identify-and-permission-management"><span
        class="toc-section-number">13.4</span> Applications of Identify
        and Permission Management</a>
        <ul>
        <li><a
        href="#logging-events-selectively-increasing-access-rights"
        id="toc-logging-events-selectively-increasing-access-rights"><span
        class="toc-section-number">13.4.1</span> Logging Events:
        Selectively Increasing Access Rights</a></li>
        <li><a href="#logging-in-carefully-decreasing-access-rights"
        id="toc-logging-in-carefully-decreasing-access-rights"><span
        class="toc-section-number">13.4.2</span> Logging In: Carefully
        Decreasing Access Rights</a></li>
        <li><a href="#sudo-and-su-increasing-access-rights"
        id="toc-sudo-and-su-increasing-access-rights"><span
        class="toc-section-number">13.4.3</span> <code>sudo</code> and
        <code>su</code>: Increasing Access Rights</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#security-attacks-on-system-programs"
        id="toc-security-attacks-on-system-programs"><span
        class="toc-section-number">14</span> Security: Attacks on System
        Programs</a>
        <ul>
        <li><a href="#path-attacks" id="toc-path-attacks"><span
        class="toc-section-number">14.1</span> Path Attacks</a>
        <ul>
        <li><a href="#system" id="toc-system"><span
        class="toc-section-number">14.1.1</span>
        <code>system()</code></a></li>
        <li><a
        href="#path-attacks-with-set-user-id-bits-for-privilege-escalation"
        id="toc-path-attacks-with-set-user-id-bits-for-privilege-escalation"><span
        class="toc-section-number">14.1.2</span> Path Attacks with
        Set-user-id Bits for Privilege Escalation</a></li>
        <li><a href="#ld_preload-attacks"
        id="toc-ld_preload-attacks"><span
        class="toc-section-number">14.1.3</span> <code>LD_PRELOAD</code>
        Attacks?</a></li>
        </ul></li>
        <li><a href="#injection-attacks"
        id="toc-injection-attacks"><span
        class="toc-section-number">14.2</span> Injection
        Attacks</a></li>
        <li><a href="#overflow-attacks" id="toc-overflow-attacks"><span
        class="toc-section-number">14.3</span> Overflow Attacks</a></li>
        </ul></li>
        <li><a href="#the-android-unix-personality"
        id="toc-the-android-unix-personality"><span
        class="toc-section-number">15</span> The Android UNIX
        Personality</a></li>
        <li><a href="#unix-containers" id="toc-unix-containers"><span
        class="toc-section-number">16</span> UNIX Containers</a></li>
        <li><a href="#appendix-c-programming-conventions"
        id="toc-appendix-c-programming-conventions"><span
        class="toc-section-number">17</span> Appendix: C Programming
        Conventions</a>
        <ul>
        <li><a href="#naming-conventions"
        id="toc-naming-conventions"><span
        class="toc-section-number">17.1</span> Naming
        Conventions</a></li>
        <li><a href="#namespacing" id="toc-namespacing"><span
        class="toc-section-number">17.2</span> Namespacing</a></li>
        <li><a href="#headers-and-visibility"
        id="toc-headers-and-visibility"><span
        class="toc-section-number">17.3</span> Headers and
        Visibility</a></li>
        <li><a href="#what-to-include" id="toc-what-to-include"><span
        class="toc-section-number">17.4</span> What to Include?</a></li>
        <li><a href="#depth-complexity" id="toc-depth-complexity"><span
        class="toc-section-number">17.5</span> Depth =
        Complexity</a></li>
        <li><a
        href="#object-orientation-initialization-destruction-and-methods"
        id="toc-object-orientation-initialization-destruction-and-methods"><span
        class="toc-section-number">17.6</span> Object Orientation:
        Initialization, Destruction, and Methods</a></li>
        </ul></li>
        </ul>

        </div>
      </div>
            <div class="span9">
            <h1 data-number="1" id="intro-to-systems-programming"><span
            class="header-section-number">1</span> Intro to Systems
            Programming</h1>
            <h2 data-number="1.1" id="computer-organization"><span
            class="header-section-number">1.1</span> Computer
            Organization</h2>
            <p>Find the <a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/comparch.html">slides</a>.</p>
            <h2 data-number="1.2" id="memory-hierarchies"><span
            class="header-section-number">1.2</span> Memory
            Hierarchies</h2>
            <p>Find the <a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/memory.html#/10">slides</a>.</p>
            <h2 data-number="1.3" id="intro-to-c"><span
            class="header-section-number">1.3</span> Intro to C</h2>
            <h3 class="unnumbered" id="you-already-know-c">You already
            know <strong>C</strong></h3>
            <p>well, some of it anyways…</p>
            <h3 data-number="1.3.1"
            id="c-constructs-if-youre-familiar-with-java-python-etc."><span
            class="header-section-number">1.3.1</span> C constructs [if
            you’re familiar with Java, Python, etc.]</h3>
            <table>
            <thead>
            <tr class="header">
            <th>construct</th>
            <th>syntax</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td>conditionals</td>
            <td><code>if</code> and <code>else</code></td>
            </tr>
            <tr class="even">
            <td>loops</td>
            <td><code>while{}</code>, <code>do...while</code>,
            <code>for</code></td>
            </tr>
            <tr class="odd">
            <td><strong>basic</strong> types</td>
            <td><code>int</code>, <code>float</code>,
            <code>double</code>, <code>char</code></td>
            </tr>
            <tr class="even">
            <td><strong>compound</strong></td>
            <td><code>arrays</code>*</td>
            </tr>
            <tr class="odd">
            <td>functions</td>
            <td><code>ret_val</code>
            <strong><code>func_name</code></strong>
            <code>(args){}</code></td>
            </tr>
            <tr class="even">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>* <strong>no range checks!!</strong>: C will let you
            access an array beyond the maximum size that you have
            specified while creating it. The effects of such access are
            <strong>implementation specific</strong> – each
            platform/operating system will handle it differently. Note
            that on platforms that don’t have memory protection, this
            can cause some serious problems!</p>
            <h3 class="unnumbered" id="whats-different-from-java">What’s
            different [from java]</h3>
            <ul>
            <li>no object-oriented programming</li>
            <li>no function overloading</li>
            <li><strong>no classes!</strong></li>
            <li>we have <code>struct</code> instead
            <ul>
            <li>which is similar but <em>very</em> different</li>
            </ul></li>
            <li><strong>compiled</strong> not interpreted</li>
            <li><strong>pointers!!!</strong></li>
            </ul>
            <h3 data-number="1.3.2" id="compound-types"><span
            class="header-section-number">1.3.2</span> Compound
            types</h3>
            <p><strong>contiguous memory</strong> layouts: objects
            within these data types are laid out in memory, next to each
            other. This becomes important when you’re trying to use
            pointers to access various elements.</p>
            <table>
            <thead>
            <tr class="header">
            <th>type</th>
            <th>usage</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><scb>struct</scb></td>
            <td>related variables (like class)</td>
            </tr>
            <tr class="even">
            <td><scb>union</scb></td>
            <td>same, but <em>shared</em> memory</td>
            </tr>
            <tr class="odd">
            <td><scb>enum</scb></td>
            <td>enumeration, assign names</td>
            </tr>
            <tr class="even">
            <td>array</td>
            <td>pointer to contiguous memory</td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <h4 class="unnumbered" id="no-built-in-boolean"><strong>no
            (built-in) boolean!</strong></h4>
            <p>C does not have a built in boolean data type. We can
            mimic it by using integer values (<scb>0</scb> is
            <code>false</code> while any other non-zero values is
            <code>true</code>).</p>
            <h1 data-number="2" id="intermediate-c"><span
            class="header-section-number">2</span> Intermediate C</h1>
            <h2 data-number="2.1" id="objectives"><span
            class="header-section-number">2.1</span> Objectives</h2>
            <ul>
            <li>Recalling C types with a focus on pointers.</li>
            <li>Focus on more advanced features like
            <code>void *</code>s and function pointers.</li>
            <li>Practice thinking about C programs as memory.</li>
            </ul>
            <h2 data-number="2.2" id="types"><span
            class="header-section-number">2.2</span> Types</h2>
            <h3 data-number="2.2.1" id="basic-types"><span
            class="header-section-number">2.2.1</span> <a
            href="https://en.wikipedia.org/wiki/C_data_types">Basic
            types</a></h3>
            <ul>
            <li><code>char</code> - think “one byte”. Same as
            <code>signed char</code>.</li>
            <li><code>short int</code> - think “two bytes”. Same as
            <code>short</code>.</li>
            <li><code>int</code> - think “four bytes”.</li>
            <li><code>long int</code> - think “potentially larger
            <code>int</code>”. Most commonly known solely as
            <code>long</code>.</li>
            <li><code>float</code>, <code>double</code> - floating point
            values (not used in the class).</li>
            <li><code>void</code> - the lack of a type. Variables
            <em>cannot</em> have this type.</li>
            </ul>
            <div class="sourceCode" id="cb1"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* `void` is fine to denote &quot;no variables/return values&quot;, ... */</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* ...but not fine on variables */</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> a<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>inline_exec_tmp.c:6:7: error: variable has incomplete type &#39;void&#39;
        void a;
             ^
1 error generated.
make[1]: *** [inline_exec_tmp] Error 1</code></pre>
            <ul>
            <li><code>enum</code> - an <code>int</code> or
            <code>short int</code> with some “named” values.</li>
            </ul>
            <div class="sourceCode" id="cb3"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> weekdays <span class="op">{</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    MON<span class="op">,</span> TUES<span class="op">,</span> WED<span class="op">,</span> THURS<span class="op">,</span> FRI</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;MON = </span><span class="sc">%d</span><span class="st">, TUES = </span><span class="sc">%d</span><span class="st">, ..., FRI = </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> MON<span class="op">,</span> TUES<span class="op">,</span> FRI<span class="op">);</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>MON = 0, TUES = 1, ..., FRI = 4</code></pre>
            <p>You can choose the values explicitly
            (e.g. <code>enum grades { MON = 1, TUES = 2, WED = 3, THURS = 4, FRI = 5};</code>).</p>
            <p><strong>Modifiers</strong></p>
            <ul>
            <li><code>unsigned</code> - variables that cannot be
            negative. Given that variables have a fixed bit-width, they
            can use the extra bit (“negative” no longer needs to be
            tracked) to instead represent numbers twice the size of
            <code>signed</code> variants.</li>
            <li><code>signed</code> - signed variables. You don’t see
            this modifier as much because <code>char</code>,
            <code>int</code>, <code>long</code> all default to
            <code>signed</code>.</li>
            <li><code>long</code> - Used to modify another type to make
            it larger in some cases. <code>long int</code> can represent
            larger numbers and is synonymous with <code>long</code>.
            <code>long long int</code> (or <code>long long</code>) is an
            even larger value!</li>
            <li><code>static</code> - this variable should not be
            accessible <em>outside of the .c file</em> in which it is
            defined.</li>
            <li><code>const</code> - an immutable value. We won’t focus
            much on this modifier.</li>
            <li><code>volatile</code> - this variable should be “read
            from memory” every time it is accessed. Confusing now,
            relevant later, but not a focus.</li>
            </ul>
            <h4 data-number="2.2.1.1" id="examples"><span
            class="header-section-number">2.2.1.1</span> Examples</h4>
            <div class="sourceCode" id="cb5"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> a<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">signed</span> <span class="dt">char</span> a_signed<span class="op">;</span>     <span class="co">/* same type as `a` */</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> b<span class="op">;</span>                   <span class="co">/* values between [-128, 127] */</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> b_unsigned<span class="op">;</span> <span class="co">/* values between [0, 256] */</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> c<span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> <span class="dt">int</span> c_shortint<span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> c_short<span class="op">;</span>            <span class="co">/* same as `c_shortint` */</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> <span class="dt">int</span> c_longint<span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> c_long<span class="op">;</span>              <span class="co">/* same type as `c_longint` */</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>MON = 0, TUES = 1, ..., FRI = 4</code></pre>
            <p>You might see all of these, but the common primitives,
            and their sizes:</p>
            <div class="sourceCode" id="cb7"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">/* Commonly used types that you practically see in a lot of C */</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> c<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> uc<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> s<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">short</span> us<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> ui<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> l<span class="op">;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> ul<span class="op">;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;char:</span><span class="sc">\t%ld\n</span><span class="st">short:</span><span class="sc">\t%ld\n</span><span class="st">int:</span><span class="sc">\t%ld\n</span><span class="st">long:</span><span class="sc">\t%ld\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">sizeof</span><span class="op">(</span>c<span class="op">),</span> <span class="kw">sizeof</span><span class="op">(</span>s<span class="op">),</span> <span class="kw">sizeof</span><span class="op">(</span>i<span class="op">),</span> <span class="kw">sizeof</span><span class="op">(</span>l<span class="op">));</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>MON = 0, TUES = 1, ..., FRI = 4</code></pre>
            <h3 data-number="2.2.2"
            id="common-posix-types-and-values"><span
            class="header-section-number">2.2.2</span> Common POSIX
            types and values</h3>
            <ul>
            <li><p><code>stddef.h</code><a href="#fn1"
            class="footnote-ref" id="fnref1"
            role="doc-noteref"><sup>1</sup></a>:</p>
            <ul>
            <li><code>size_t</code>, <code>usize_t</code>,
            <code>ssize_t</code> - types for variables that correspond
            to sizes. These include the size of the memory request to
            <code>malloc</code>, the return value from
            <code>sizeof</code>, and the arguments and return values
            from <code>read</code>/<code>write</code>/…
            <code>ssize_t</code> is signed (allows negative values),
            while the others are unsigned.</li>
            <li><code>NULL</code> - is just
            <code>#define NULL ((void *)0)</code></li>
            </ul></li>
            <li><p><code>limits.h</code><a href="#fn2"
            class="footnote-ref" id="fnref2"
            role="doc-noteref"><sup>2</sup></a>:</p>
            <ul>
            <li><code>INT_MAX</code>, <code>INT_MIN</code>,
            <code>UINT_MAX</code> - maximum and minimum values for a
            signed integer, and the maximum value for an unsigned
            integer.</li>
            <li><code>LONG_MAX</code>, <code>LONG_MIN</code>,
            <code>ULONG_MAX</code> - minimum and maximum numerical
            values for <code>long</code>s and
            <code>unsigned long</code>s.</li>
            <li>Same for <code>short ints</code> (<code>SHRT_MAX</code>,
            etc…) and <code>char</code>s (<code>CHAR_MAX</code>,
            etc…).</li>
            </ul></li>
            </ul>
            <h3 data-number="2.2.3" id="format-strings"><span
            class="header-section-number">2.2.3</span> Format
            Strings</h3>
            <p>Many standard library calls take “format strings”. You’ve
            seen these in <code>printf</code>. The following format
            specifiers should be used:</p>
            <ul>
            <li><code>%d</code> - <code>int</code></li>
            <li><code>%ld</code> - <code>long int</code></li>
            <li><code>%u</code> - <code>unsigned int</code></li>
            <li><code>%c</code> - <code>char</code></li>
            <li><code>%x</code> - <code>unsigned int</code> printed as
            hexadecimal</li>
            <li><code>%lx</code> - <code>long unsigned int</code>
            printed as hexadecimal</li>
            <li><code>%p</code> - prints out any pointer value,
            <code>void *</code></li>
            <li><code>%s</code> - prints out a string,
            <code>char *</code></li>
            </ul>
            <p>Format strings are also used in <code>scanf</code>
            functions to read and parse input.</p>
            <p>You can control the spacing of the printouts using
            <code>%NX</code> where <code>N</code> is the number of
            characters you want printed out (as spaces), and
            <code>X</code> is the format specifier above. For example,
            <code>"%10ld"</code>would print a long integer in a 10
            character slot. Adding <code>\n</code> and <code>\t</code>
            add in the newlines and the tabs. If you need to print out a
            “\”, use <code>\\</code>.</p>
            <h4 data-number="2.2.3.1" id="example"><span
            class="header-section-number">2.2.3.1</span> Example</h4>
            <div class="sourceCode" id="cb9"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;limits.h&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Integers: </span><span class="sc">%d</span><span class="st">, </span><span class="sc">%ld</span><span class="st">, </span><span class="sc">%u</span><span class="st">, </span><span class="sc">%c\n</span><span class="st">&quot;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;Hex and pointers: </span><span class="sc">%lx</span><span class="st">, </span><span class="sc">%p\n</span><span class="st">&quot;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;Strings: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>           INT_MAX<span class="op">,</span> LONG_MAX<span class="op">,</span> UINT_MAX<span class="op">,</span> <span class="ch">&#39;*&#39;</span><span class="op">,</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>           LONG_MAX<span class="op">,</span> <span class="op">&amp;</span>main<span class="op">,</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;hello world&quot;</span><span class="op">);</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>MON = 0, TUES = 1, ..., FRI = 4</code></pre>
            <h3 data-number="2.2.4" id="compound-types-1"><span
            class="header-section-number">2.2.4</span> Compound
            types</h3>
            <ul>
            <li><code>struct</code> - A collection of different values.
            Example: objects with many different fields.</li>
            <li><code>union</code> - <em>One</em> of a set of values.
            Example: what if you want to represent data for one food
            item among others.</li>
            </ul>
            <p>Unions are not very common, but are sometimes useful. The
            size of a <code>union</code> is the <em>maximum</em> size of
            its fields. In contrast, the <code>struct</code> is the
            <em>sum</em> of the sizes of each of its fields.</p>
            <h4 data-number="2.2.4.1" id="example-1"><span
            class="header-section-number">2.2.4.1</span> Example</h4>
            <div class="sourceCode" id="cb11"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> hamburger <span class="op">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> num_burgers<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> cheese<span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> num_patties<span class="op">;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="kw">union</span> food <span class="op">{</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> num_eggs<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> hamburger burger<span class="op">;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">/* Same contents as the union. */</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> all_food <span class="op">{</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> num_eggs<span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> hamburger burger<span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> food f_eggs<span class="op">,</span> f_burger<span class="op">;</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* now I shouldn&#39;t access `.burger` in `f_eggs` */</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    f_eggs<span class="op">.</span>num_eggs <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* This is just syntax for structure initialization. */</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    f_burger<span class="op">.</span>burger <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> hamburger<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>num_burgers <span class="op">=</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>cheese      <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>num_patties <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* now shouldn&#39;t access `.num_eggs` in `f_burger` */</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Size of union:  </span><span class="sc">%ld\n</span><span class="st">Size of struct: </span><span class="sc">%ld\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>           <span class="kw">sizeof</span><span class="op">(</span><span class="kw">union</span> food<span class="op">),</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> all_food<span class="op">));</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>MON = 0, TUES = 1, ..., FRI = 4</code></pre>
            <p>We can see the effect of the <code>union</code>: The size
            is <code>max(fields)</code> rather than
            <code>sum(fields)</code>. What other examples can you think
            of where you might want <code>union</code>s?</p>
            <blockquote>
            <p>An aside on syntax: The structure initialization syntax
            in this example is simply a shorthand. The
            <code>struct hamburger</code> initialization above is
            equivalent to:</p>
            <div class="sourceCode" id="cb13"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>f_burger<span class="op">.</span>burger<span class="op">.</span>num_burgers <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>f_burger<span class="op">.</span>burger<span class="op">.</span>cheese      <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>f_burger<span class="op">.</span>burger<span class="op">.</span>num_patties <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span></code></pre></div>
            <p>Though since there are so many <code>.</code>s, this is a
            little confusing. We’d typically want to simply as:</p>
            <div class="sourceCode" id="cb14"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> hamburger <span class="op">*</span>h <span class="op">=</span> <span class="op">&amp;</span>f_burger<span class="op">.</span>burger<span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>h<span class="op">-&gt;</span>num_burgers <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>h<span class="op">-&gt;</span>cheese      <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>h<span class="op">-&gt;</span>num_patties <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span></code></pre></div>
            <p>More on <code>-&gt;</code> in the next section.</p>
            </blockquote>
            <h3 data-number="2.2.5" id="pointers-arrays"><span
            class="header-section-number">2.2.5</span> Pointers &amp;
            Arrays</h3>
            <p>Variables can have be pointer types
            (e.g. <code>int *a</code>). Variables with pointer types are
            pointers and hold an <em>address</em> to the a variable of
            the type to which they point, or to <code>NULL</code>.
            <code>NULL</code> denotes that the pointer is not valid. You
            want to imagine that variables hold data, for example
            <code>int a = 6</code>:</p>
            <pre><code>a---+
| 6 |
+---+</code></pre>
            <p>A pointer, <code>int *b = &amp;a</code> should be
            imagined as a pointer:</p>
            <pre><code>b ---&gt; a---+
       | 6 |
       +---+</code></pre>
            <p>Note that the “address of”, <code>&amp;</code> operator
            takes a variable and returns its address. If you print out
            the pointer, <code>printf("%p", b)</code>, you’ll get the
            address (i.e. the arrow) To <em>follow the arrow</em>, you
            must <em>dereference</em> the pointer:
            <code>*b == 6</code>.</p>
            <div class="sourceCode" id="cb17"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> value<span class="op">;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">/* here, the `*` is part of the type &quot;int *&quot;, i.e. a pointer to an `int` */</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>foo<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>ptr<span class="op">)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">     * Here, the `*` is the dereference operation, and</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">     * gives us the value that is pointed to.</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>ptr <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;value is initialized to </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> value<span class="op">);</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    foo<span class="op">(&amp;</span>value<span class="op">);</span> <span class="co">/* `&amp;` gives us the address of the variable `value` */</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;value updated to </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> value<span class="op">);</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>MON = 0, TUES = 1, ..., FRI = 4</code></pre>
            <p>Pointers are <em>necessary</em> as they enable us to
            build <em>linked</em> data-structures (linked-lists, binary
            trees, etc…). Languages such as Java assume that <em>every
            single</em> object variable is a pointer, and since <em>all
            object variables</em> are pointers, they don’t need special
            syntax for them.</p>
            <p>Arrays are simple contiguous data items, all of the same
            type. <code>int a[4] = {6, 7, 8, 9}</code> should be
            imagined as:</p>
            <pre><code>a ---&gt; +---+---+---+---+
       | 6 | 7 | 8 | 9 |
       +---+---+---+---+</code></pre>
            <p>When you access an array item, <code>a[2] == 8</code>, C
            is really treating <code>a</code> as a pointer, doing
            pointer arithmetic, and dereferences to find offset
            <code>2</code>.</p>
            <div class="sourceCode" id="cb20"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">6</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">9</span><span class="op">};</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;0th index: </span><span class="sc">%p</span><span class="st"> == </span><span class="sc">%p</span><span class="st">; </span><span class="sc">%d</span><span class="st"> == </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> a<span class="op">,</span>     <span class="op">&amp;</span>a<span class="op">[</span><span class="dv">0</span><span class="op">],</span> <span class="op">*</span>a<span class="op">,</span>       a<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;nth index: </span><span class="sc">%p</span><span class="st"> == </span><span class="sc">%p</span><span class="st">; </span><span class="sc">%d</span><span class="st"> == </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> a <span class="op">+</span> n<span class="op">,</span> <span class="op">&amp;</span>a<span class="op">[</span>n<span class="op">],</span> <span class="op">*(</span>a <span class="op">+</span> n<span class="op">),</span> a<span class="op">[</span>n<span class="op">]);</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>0th index: 0x304c65fe0 == 0x304c65fe0; 6 == 6
nth index: 0x304c65fe4 == 0x304c65fe4; 7 == 7</code></pre>
            <p>Making this a little more clear, lets understand how C
            accesses the <code>n</code>th item. Lets make a pointer
            <code>int *p = a + 1</code> (we’ll just simply and assume
            that <code>n == 1</code> here), we should have this:</p>
            <pre><code>p ---------+
           |
           V
a ---&gt; +---+---+---+---+
       | 6 | 7 | 8 | 9 |
       +---+---+---+---+</code></pre>
            <p>Thus if we dereference <code>p</code>, we access the
            <code>1</code>st index, and access the value
            <code>7</code>.</p>
            <div class="sourceCode" id="cb23"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">6</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">9</span><span class="op">};</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* same thing as the previous example, just making the pointer explicit */</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>p <span class="op">=</span> a <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;nth index: </span><span class="sc">%p</span><span class="st"> == </span><span class="sc">%p</span><span class="st">; </span><span class="sc">%d</span><span class="st"> == </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> p<span class="op">,</span> <span class="op">&amp;</span>a<span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="op">*</span>p<span class="op">,</span> a<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>0th index: 0x304e6afe0 == 0x304e6afe0; 6 == 6
nth index: 0x304e6afe4 == 0x304e6afe4; 7 == 7</code></pre>
            <p>We can see that <em>pointer arithmetic</em> (i.e. doing
            addition/subtraction on pointers) does the same thing as
            array indexing plus a dereference. That is,
            <code>*(a + 1) == a[1]</code>. For the most part, arrays and
            pointers can be viewed as very similar, with only a few
            exceptions<a href="#fn3" class="footnote-ref" id="fnref3"
            role="doc-noteref"><sup>3</sup></a>.</p>
            <p><em>Pointer arithmetic should generally be avoided in
            favor of using the array syntax.</em> One complication for
            pointer arithmetic is that it does not fit our intuition for
            addition:</p>
            <div class="sourceCode" id="cb25"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">6</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">9</span><span class="op">};</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> b<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;a&#39;</span><span class="op">,</span> <span class="ch">&#39;b&#39;</span><span class="op">,</span> <span class="ch">&#39;c&#39;</span><span class="op">,</span> <span class="ch">&#39;d&#39;</span><span class="op">};</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">     * Calculation: How big is the array?</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">     * How big is each item? The division is the number of items.</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> num_items <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>a<span class="op">)</span> <span class="op">/</span> <span class="kw">sizeof</span><span class="op">(</span>a<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> num_items<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;idx </span><span class="sc">%d</span><span class="st"> @ </span><span class="sc">%p</span><span class="st"> &amp; </span><span class="sc">%p\n</span><span class="st">&quot;</span><span class="op">,</span> i<span class="op">,</span> a <span class="op">+</span> i<span class="op">,</span> b <span class="op">+</span> i<span class="op">);</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>0th index: 0x304785fe0 == 0x304785fe0; 6 == 6
nth index: 0x304785fe4 == 0x304785fe4; 7 == 7</code></pre>
            <p>Note that the pointer for the integer array
            (<code>a</code>) is being incremented by 4, while the
            character array (<code>b</code>) by 1. Focusing on the key
            part:</p>
            <pre><code>idx 0 @ ...0 &amp; ...4
idx 1 @ ...4 &amp; ...5
idx 2 @ ...8 &amp; ...6
idx 3 @ ...c &amp; ...7
           ^      ^
           |      |
Adds 4 ----+      |
Adds 1 -----------+</code></pre>
            <p>Thus, pointer arithmetic depends on the <em>size of the
            types within the array</em>. There are types when one wants
            to iterate through each byte of an array, even if the array
            contains larger values such as integers. For example, the
            <code>memset</code> and <code>memcmp</code> functions set
            each byte in an range of memory, and byte-wise compare two
            ranges of memory. In such cases, <em>casts</em> can be used
            to manipulate the pointer type (e.g. <code>(char *)a</code>
            enables <code>a</code> to not be referenced with pointer
            arithmetic that iterates through bytes).</p>
            <h4 data-number="2.2.5.1" id="example-2"><span
            class="header-section-number">2.2.5.1</span> Example</h4>
            <div class="sourceCode" id="cb28"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">/* a simple linked list */</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> student <span class="op">{</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>name<span class="op">;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> student <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> student students<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;Penny&quot;</span><span class="op">,</span> <span class="op">.</span>next <span class="op">=</span> <span class="op">&amp;</span>students<span class="op">[</span><span class="dv">1</span><span class="op">]},</span> <span class="co">/* or `students + 1` */</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{.</span>name <span class="op">=</span> <span class="st">&quot;Gabe&quot;</span><span class="op">,</span>  <span class="op">.</span>next <span class="op">=</span> NULL<span class="op">}</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> student <span class="op">*</span>head <span class="op">=</span> students<span class="op">;</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co"> * head --&gt; students+------+</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co"> *          | Penny | Gabe |</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co"> *          | next  | next |</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co"> *          +-|-----+---|--+</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co"> *            |     ^   +-----&gt;NULL</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co"> *            |     |</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="co"> *            +-----+</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> student <span class="op">*</span>i<span class="op">;</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> head<span class="op">;</span> i <span class="op">!=</span> NULL<span class="op">;</span> i <span class="op">=</span> i<span class="op">-&gt;</span>next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> i<span class="op">-&gt;</span>name<span class="op">);</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>0th index: 0x30cf80fe0 == 0x30cf80fe0; 6 == 6
nth index: 0x30cf80fe4 == 0x30cf80fe4; 7 == 7</code></pre>
            <h4 data-number="2.2.5.2" id="generic-pointer-types"><span
            class="header-section-number">2.2.5.2</span> Generic Pointer
            Types</h4>
            <p>Generally, if you want to treat a pointer type as
            another, you need to use a cast. You rarely want to do this
            (see the <code>memset</code> example below to see an example
            where you might want it). However, there is a need in C to
            have a “generic pointer type” that can be implicitly cast
            into any other pointer type. To get a sense of why this is,
            two simple examples:</p>
            <blockquote>
            <ol type="1">
            <li>What should the type of <code>NULL</code> be?</li>
            </ol>
            </blockquote>
            <p><code>NULL</code> is used as a valid value for
            <em>any</em> pointer (of any type), thus <code>NULL</code>
            must have a generic type that can be used in the code as a
            value for any pointer. Thus, the type of <code>NULL</code>
            must be <code>void *</code>.</p>
            <blockquote>
            <ol start="2" type="1">
            <li><code>malloc</code> returns a pointer to newly-allocated
            memory. What should the type of the return value be?</li>
            </ol>
            </blockquote>
            <p>C solves this with the <code>void *</code> pointer type.
            Recall that <code>void</code> is not a valid type for a
            variable, but a <code>void *</code> is different. It is a
            “generic pointer that cannot be dereferenced*. Note that
            dereferencing a <code>void *</code> pointer shouldn’t work
            as <code>void</code> is not a valid variable type
            (e.g. <code>void *a; *a = 10;</code> doesn’t make much sense
            because <code>*a</code> is type <code>void</code>).</p>
            <div class="sourceCode" id="cb30"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>intptr <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span> <span class="co">/* malloc returns `void *`! */</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>intptr <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">*</span>intptr<span class="op">;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>0th index: 0x30d4a9fe0 == 0x30d4a9fe0; 6 == 6
nth index: 0x30d4a9fe4 == 0x30d4a9fe4; 7 == 7</code></pre>
            <p>Data-structures often aim to store data of any type
            (think: a linked list of anything). Thus, in C, you often
            see <code>void *</code>s to reference the data they
            store.</p>
            <h4 data-number="2.2.5.3"
            id="relationship-between-pointers-arrays-and-arrows"><span
            class="header-section-number">2.2.5.3</span> Relationship
            between Pointers, Arrays, and Arrows</h4>
            <p>Indexing into arrays (<code>a[b]</code>) and arrows
            (<code>a-&gt;b</code>) are redundant syntactic features, but
            they are very convenient.</p>
            <ul>
            <li><code>&amp;a[b]</code> is equivalent to
            <code>a + b</code> where <code>a</code> is a pointer and
            <code>b</code> is an index.</li>
            <li><code>a[b]</code> is equivalent to <code>*(a + b)</code>
            where <code>a</code> is a pointer and <code>b</code> is an
            index.</li>
            <li><code>a-&gt;b</code> is equivalent to
            <code>(*a).b</code> where <code>a</code> is a pointer to a
            variable with a structure type that has <code>b</code> as a
            field.</li>
            </ul>
            <p>Generally, you should always try and stick to the array
            and arrow syntax were possible, as it makes your intention
            much more clear when coding than the pointer arithmetic and
            dereferences.</p>
            <h2 data-number="2.3" id="memory-allocation"><span
            class="header-section-number">2.3</span> Memory
            Allocation</h2>
            <p>Dynamic memory allocations</p>
            <ul>
            <li><code>void *malloc(size_t size)</code> - allocate
            <code>size</code> memory, or return <code>NULL</code>.</li>
            <li><code>void *calloc(size_t nmemb, size_t size)</code> -
            allocate <code>nmemb * size</code> bytes, and initialize
            them to <code>0</code>.</li>
            <li><code>void *realloc(void *ptr, size_t size)</code> -
            pass in a previous allocation, and <em>either</em>
            grow/shrink it to <code>size</code>, or allocate a new chunk
            of memory and copy the data in <code>ptr</code> into it.
            Return the memory of size <code>size</code>, or
            <code>NULL</code> on error.</li>
            <li><code>void free(void *ptr)</code> - deallocate
            previously allocated memory (returned from any of the
            above).</li>
            </ul>
            <p>A few things to keep in mind:</p>
            <ol type="1">
            <li>If you want to allocate an array, then you have to do
            the math yourself for the array size. For example,
            <code>int *arr = malloc(sizeof(int) * n);</code> to allocate
            an array of <code>int</code>s with a length of
            <code>n</code>.</li>
            <li><code>malloc</code> is not guaranteed to initialize its
            memory to <code>0</code>. <em>You</em> must make sure that
            your array gets initialized. It is not uncommon to do a
            <code>memset(arr, 0, sizeof(int) * n);</code> to set the
            memory <code>0</code>.</li>
            <li><code>calloc</code> is guaranteed to initialize all its
            allocated memory to <code>0</code>.</li>
            </ol>
            <h3 data-number="2.3.1" id="common-errors"><span
            class="header-section-number">2.3.1</span> Common
            Errors</h3>
            <ul>
            <li><em>Allocation error.</em> You <em>must</em> check the
            return value of memory allocation functions for
            <code>NULL</code>, and handle the error appropriately.</li>
            </ul>
            <div class="sourceCode" id="cb32"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>a <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Error: did not check return value! */</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>a <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>0th index: 0x3086bbfe0 == 0x3086bbfe0; 6 == 6
nth index: 0x3086bbfe4 == 0x3086bbfe4; 7 == 7</code></pre>
            <ul>
            <li><em>Dangling pointer.</em> If you maintain a pointer to
            a chunk of memory that you <code>free</code>, and then
            dereference that pointer, bad things can happen. The memory
            might have already been re-allocated due to another call to
            <code>malloc</code>, and is used for something completely
            different in your program. It is up to you as a programmer
            to avoid <code>free</code>ing memory until all references to
            it are dropped.</li>
            </ul>
            <div class="sourceCode" id="cb34"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>a <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a <span class="op">==</span> NULL<span class="op">)</span> <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Error: accessing what `a` points to after `free`! */</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">*</span>a<span class="op">;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>0th index: 0x309d8ffe0 == 0x309d8ffe0; 6 == 6
nth index: 0x309d8ffe4 == 0x309d8ffe4; 7 == 7</code></pre>
            <ul>
            <li><em>Memory leaks.</em> If you remove all references to
            memory, but <em>don’t</em> <code>free</code> it, then the
            memory will <em>never</em> get freed. This is a memory
            leak.</li>
            </ul>
            <div class="sourceCode" id="cb36"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>a <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>a<span class="op">)</span> <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Error: never `free`d `a` and no references to it remain! */</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <ul>
            <li><em>Double <code>free</code>.</em> If you
            <code>free</code> the memory twice, bad things can happen.
            You could confuse the memory allocation logic, or you could
            accidentally <code>free</code> an allocation made after the
            first <code>free</code> was called.</li>
            </ul>
            <div class="sourceCode" id="cb38"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>a <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>a<span class="op">)</span> <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>a<span class="op">);</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Error: yeah, don&#39;t do that! */</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <p><code>valgrind</code> will help you debug the last three
            of these issues, and later in the class, we’ll develop a
            library to help debug the first.</p>
            <h2 data-number="2.4" id="exercises"><span
            class="header-section-number">2.4</span> Exercises</h2>
            <h3 data-number="2.4.1"
            id="c-is-a-thin-language-layer-on-top-of-memory"><span
            class="header-section-number">2.4.1</span> C is a Thin
            Language Layer on Top of Memory</h3>
            <p>We’re going to look at a set of variables as memory. When
            variables are created globally, they are simply allocated
            into subsequent addresses.</p>
            <div class="sourceCode" id="cb40"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_values<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">char</span> a <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> b <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> foo <span class="op">{</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> c_a<span class="op">,</span> c_b<span class="op">;</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>c_c<span class="op">;</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> foo c <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> foo<span class="op">)</span> <span class="op">{</span> <span class="op">.</span>c_a <span class="op">=</span> <span class="dv">3</span><span class="op">,</span> <span class="op">.</span>c_c <span class="op">=</span> <span class="op">&amp;</span>b <span class="op">};</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">char</span> end<span class="op">;</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> vars_size<span class="op">;</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>mem<span class="op">;</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Q1: What would you predict the output of &amp;end - &amp;a is? */</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Addresses:</span><span class="sc">\n</span><span class="st">a   @ </span><span class="sc">%p\n</span><span class="st">b   @ </span><span class="sc">%p\n</span><span class="st">c   @ </span><span class="sc">%p\n</span><span class="st">end @ </span><span class="sc">%p\n</span><span class="st">&quot;</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;&amp;end - &amp;a = </span><span class="sc">%ld\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="co">/* Note: you can split strings! */</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>           <span class="op">&amp;</span>a<span class="op">,</span> <span class="op">&amp;</span>b<span class="op">,</span> <span class="op">&amp;</span>c<span class="op">,</span> <span class="op">&amp;</span>end<span class="op">,</span> <span class="op">&amp;</span>end <span class="op">-</span> <span class="op">&amp;</span>a<span class="op">);</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">Initial values:</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    print_values<span class="op">();</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Q2: Describe what these next two lines are doing. */</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>    vars_size <span class="op">=</span> <span class="op">&amp;</span>end <span class="op">-</span> <span class="op">&amp;</span>a<span class="op">;</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    mem <span class="op">=</span> <span class="op">&amp;</span>a<span class="op">;</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Q3: What would you expect in the following printout (with the print uncommented)? */</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">Print out the variables as raw memory</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> vars_size<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">unsigned</span> <span class="dt">char</span> c <span class="op">=</span> mem<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a><span class="co">//      printf(&quot;%x &quot;, c);</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Q4: What would you expect in the following printout (with the print uncommented)? */</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>mem<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> vars_size<span class="op">);</span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* memset(a, b, c): set the memory starting at `a` of size `c` equal `b` */</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">Post-`memset` values:</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="co">//  print_values();</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>print_values<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;a     = </span><span class="sc">%d\n</span><span class="st">b     = </span><span class="sc">%d\n</span><span class="st">c.c_a = </span><span class="sc">%ld\n</span><span class="st">c.c_b = </span><span class="sc">%ld\n</span><span class="st">c.c_c = </span><span class="sc">%p\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>           a<span class="op">,</span> b<span class="op">,</span> c<span class="op">.</span>c_a<span class="op">,</span> c<span class="op">.</span>c_b<span class="op">,</span> c<span class="op">.</span>c_c<span class="op">);</span></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <p><strong>Question</strong> Answer <em>Q1-4</em> in the
            code, uncommenting and modifying where appropriate.</p>
            <h4 data-number="2.4.1.1" id="takeaways"><span
            class="header-section-number">2.4.1.1</span> Takeaways</h4>
            <ol type="1">
            <li>Each variable in C (including fields in structs) want to
            be aligned on a boundary equal to the variable’s type’s
            size. This means that a variable (<code>b</code>) with an
            integer type (<code>sizeof(int) == 4</code>) should always
            have an address that is a multiple of its size
            (<code>&amp;b % sizeof(b) == 0</code>, so an
            <code>int</code>’s address is always divisible by
            <code>4</code>, a <code>long</code>’s by
            <code>8</code>).</li>
            <li>The operation to figure out the size of all the
            variables, <code>&amp;end - &amp;a</code>, is
            <em>crazy</em>. We’re used to performing math operations
            values on things of the same type, but not on
            <em>pointers</em>. This is only possible because C sees the
            variables are chunks of memory that happen to be laid out in
            memory, one after the other.</li>
            <li>The <em>crazy</em> increases with
            <code>mem = &amp;a</code>, and our iteration through
            <code>mem[i]</code>. We’re able to completely ignore the
            types in C, and access memory directly!</li>
            </ol>
            <p><strong>Question</strong>: What would break if we changed
            <code>char a;</code> into <code>int a;</code>? C doesn’t let
            us do math on variables of <em>any type</em>. If you fixed
            compilation problems, would you still get the same
            output?</p>
            <h3 data-number="2.4.2"
            id="quick-and-dirty-key-value-store"><span
            class="header-section-number">2.4.2</span> Quick-and-dirty
            Key-Value Store</h3>
            <p>Please read the <code>man</code> pages for
            <code>lsearch</code> and <code>lfind</code>.
            <code>man</code> pages can be pretty cryptic, and you are
            aiming to get <em>some idea</em> where to start with an
            implementation. An simplistic, and incomplete initial
            implementation:</p>
            <div class="sourceCode" id="cb42"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;search.h&gt;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define NUM_ENTRIES </span><span class="dv">8</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> kv_entry <span class="op">{</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> key<span class="op">;</span> <span class="co">/* only support keys for now... */</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co">/* global values are initialized to `0` */</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> kv_entry entries<span class="op">[</span>NUM_ENTRIES<span class="op">];</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="dt">size_t</span> num_items <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="co"> * Insert into the key-value store the `key` and `value`.</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="co"> * Return `0` on successful insertion of the value, or `-1`</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="co"> * if the value couldn&#39;t be inserted.</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>put<span class="op">(</span><span class="dt">int</span> key<span class="op">,</span> <span class="dt">int</span> value<span class="op">)</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="co"> * Attempt to get a value associated with a `key`.</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="co"> * Return the value, or `0` if the `key` isn&#39;t in the store.</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>get<span class="op">(</span><span class="dt">int</span> key<span class="op">)</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>compare<span class="op">(</span><span class="dt">const</span> <span class="dt">void</span> <span class="op">*</span>a<span class="op">,</span> <span class="dt">const</span> <span class="dt">void</span> <span class="op">*</span>b<span class="op">)</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* We know these are `int`s, so treat them as such! */</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="kw">struct</span> kv_entry <span class="op">*</span>a_ent <span class="op">=</span> a<span class="op">,</span> <span class="op">*</span>b_ent <span class="op">=</span> b<span class="op">;</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a_ent<span class="op">-&gt;</span>key <span class="op">==</span> b_ent<span class="op">-&gt;</span>key<span class="op">)</span> <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> kv_entry keys<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">{.</span>key <span class="op">=</span> <span class="dv">1</span><span class="op">},</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">{.</span>key <span class="op">=</span> <span class="dv">2</span><span class="op">},</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">{.</span>key <span class="op">=</span> <span class="dv">4</span><span class="op">},</span></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">{.</span>key <span class="op">=</span> <span class="dv">3</span><span class="op">}</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> num_kv <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>keys<span class="op">)</span> <span class="op">/</span> <span class="kw">sizeof</span><span class="op">(</span>keys<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> queries<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">4</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">5</span><span class="op">};</span></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> num_queries <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>queries<span class="op">)</span> <span class="op">/</span> <span class="kw">sizeof</span><span class="op">(</span>queries<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Insert the keys. */</span></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> num_kv<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>        lsearch<span class="op">(&amp;</span>keys<span class="op">[</span>i<span class="op">],</span> entries<span class="op">,</span> <span class="op">&amp;</span>num_items<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>entries<span class="op">)</span> <span class="op">/</span> <span class="kw">sizeof</span><span class="op">(</span>entries<span class="op">[</span><span class="dv">0</span><span class="op">]),</span> compare<span class="op">);</span></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Now lets lookup the keys. */</span></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> num_queries<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> kv_entry <span class="op">*</span>ent<span class="op">;</span></span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> val <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>        ent <span class="op">=</span> lfind<span class="op">(&amp;</span>queries<span class="op">[</span>i<span class="op">],</span> entries<span class="op">,</span> <span class="op">&amp;</span>num_items<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>entries<span class="op">[</span><span class="dv">0</span><span class="op">]),</span> compare<span class="op">);</span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ent <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> ent<span class="op">-&gt;</span>key<span class="op">;</span></span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st">: </span><span class="sc">%d</span><span class="st"> @ </span><span class="sc">%p\n</span><span class="st">&quot;</span><span class="op">,</span> i<span class="op">,</span> val<span class="op">,</span> ent<span class="op">);</span></span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <p>You want to implement a simple “key-value” store that is
            very similar in API to a hash-table (many key-value stores
            are implemented using hash-tables!).</p>
            <p><strong>Questions/Tasks:</strong></p>
            <ul>
            <li><em>Q1</em>: What is the difference between
            <code>lsearch</code> and <code>lfind</code>? The
            <code>man</code>pages should help here
            (<code>man 3 lsearch</code>) (you can exit from a
            <code>man</code> page using ‘q’). What operations would you
            want to perform with each (and why)?</li>
            <li><em>Q2</em>: The current implementation doesn’t include
            <em>values</em> at all. It returns the keys instead of
            values. Expand the implementation to properly track
            values.</li>
            <li><em>Q3</em>: Encapsulate the key-value store behind the
            <code>put</code> and <code>get</code> functions.</li>
            <li><em>Q4</em>: Add testing into the <code>main</code> for
            the relevant conditions and failures in <code>get</code> and
            <code>put</code>. # Pointers | Casting <a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/pointer_casting.html/">Slides</a></li>
            </ul>
            <h2 data-number="2.5" id="pointers-and-arrays"><span
            class="header-section-number">2.5</span> Pointers and
            Arrays</h2>
            <p>..are the same thing!</p>
            <ul>
            <li>just different conventions to <strong>access
            memory</strong></li>
            <li><em>e.g.,</em> pointer arithmetic over an array of
            ints</li>
            <li>moves addresses by <strong>size of the int</strong> →
            <code>4</code> bytes</li>
            <li><strong>no interaction</strong> with individual bytes
            <ul>
            <li>only <strong>whole ints</strong></li>
            </ul></li>
            </ul>
            <h2 data-number="2.6" id="pointer-arithmetic"><span
            class="header-section-number">2.6</span> Pointer
            Arithmetic</h2>
            <ul>
            <li>consider an integer array → <code>int a[5]</code></li>
            <li><code>5</code> ints, <strong>each</strong> of
            <code>4</code> bytes <img
            src="./figures/07.01.pointer_cast/pointer_cast.1.png"
            alt="array of integers" /></li>
            </ul>
            <p><br></p>
            <ul>
            <li>so <code>a[0]</code> is: <img
            src="./figures/07.01.pointer_cast/pointer_cast.2.png"
            alt="array of integers" /></li>
            </ul>
            <p><br></p>
            <ul>
            <li>so <code>a[1]</code> is → <strong>same</strong> as
            <code>++a</code>! <img
            src="./figures/07.01.pointer_cast/pointer_cast.3.png"
            alt="array of integers" /></li>
            </ul>
            <p><br></p>
            <ul>
            <li>we <strong>cannot</strong> access the individual bytes,
            i.e., these ones: <img
            src="./figures/07.01.pointer_cast/pointer_cast.4.png"
            alt="array of integers" /></li>
            </ul>
            <p><br></p>
            <p>what if we <strong>want</strong> to access the individual
            bytes?</p>
            <h2 data-number="2.7" id="pointer-casting"><span
            class="header-section-number">2.7</span> Pointer
            Casting!</h2>
            <ul>
            <li>can cast from one pointer type to another!</li>
            <li>between <strong>any two pointers</strong>!</li>
            <li>a pointer is always the same size, <em>i.e.,</em>
            <code>4</code> bytes</li>
            <li>making it point to something else</li>
            <li>doesn’t change the memory underneath
            <ul>
            <li>but, <strong>changes pointer arithmetic</strong>!</li>
            </ul></li>
            </ul>
            <h3 data-number="2.7.1" id="casting-from-int-to-char"><span
            class="header-section-number">2.7.1</span> Casting from
            <code>int*</code> to <code>char*</code></h3>
            <ul>
            <li><p>now, as before, if we have →
            <code>int a[5]</code></p></li>
            <li><p>and we do,
            <strong><code>char* pc = (char*) a ;</code></strong></p></li>
            <li><p><code>pc</code> points to the <strong>same</strong>
            memory region as <code>a</code></p></li>
            <li><p>but now, can treat it as
            <strong>characters</strong></p></li>
            <li><p><em>i.e.,</em> <strong>one byte</strong> <br>
            <br></p></li>
            <li><p>so <code>pc[0]</code> is: <img
            src="./figures/07.01.pointer_cast/pointer_cast.5.png"
            alt="array of integers" /></p></li>
            </ul>
            <p><br></p>
            <ul>
            <li>so <code>pc[1]</code> is → same as <code>++pc</code>!
            <img src="./figures/07.01.pointer_cast/pointer_cast.6.png"
            alt="array of integers" /></li>
            </ul>
            <h3 data-number="2.7.2" id="example-3"><span
            class="header-section-number">2.7.2</span> Example</h3>
            <p>Consider the following code:</p>
            <div class="sourceCode" id="cb44"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">*</span> a <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">*)</span>malloc<span class="op">(</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">)</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>a <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">;</span> <span class="co">// SAME as assert (a)</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>a <span class="op">=</span> <span class="dv">1145258561</span> <span class="op">;</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;a = </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">*</span>a <span class="op">)</span> <span class="op">;</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> ppc <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">*)</span> a <span class="op">;</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> <span class="kw">sizeof</span><span class="op">(</span>a<span class="op">);</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">%c</span><span class="st"> &quot;</span><span class="op">,</span> <span class="op">*</span>pc<span class="op">++</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">)</span> <span class="op">;</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <h2 data-number="2.8" id="pointer-casting-void"><span
            class="header-section-number">2.8</span> Pointer Casting |
            <code>void*</code></h2>
            <ul>
            <li>can cast <strong>any</strong> point to a
            <code>void*</code></li>
            <li>all of these are valid:</li>
            </ul>
            <div class="sourceCode" id="cb45"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span><span class="op">*</span> pv <span class="op">=</span> malloc<span class="op">(</span><span class="dv">32</span><span class="op">);</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span><span class="op">*</span> pi <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">*)</span> pv <span class="op">;</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span><span class="op">*</span> pd <span class="op">=</span> <span class="op">(</span><span class="dt">double</span><span class="op">*)</span> pv <span class="op">;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> pc <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">*)</span> pi <span class="op">;</span> </span></code></pre></div>
            <ul>
            <li>can cast <strong>any</strong> point to a
            <code>void*</code></li>
            <li>all of these are valid:</li>
            <li><strong>cannot</strong> dereference a <code>void*</code>
            directly! compiler does not know the type</li>
            </ul>
            <h1 data-number="3" id="function-pointers"><span
            class="header-section-number">3</span> Function
            Pointers</h1>
            <p>Functions have <strong>types</strong> too. E.g.,</p>
            <div class="sourceCode" id="cb46"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> foo<span class="op">(</span><span class="dt">int</span> i<span class="op">,</span> <span class="dt">double</span> d<span class="op">){...}</span></span></code></pre></div>
            <p>The “type” of this function is: * takes as input two
            arguments → one <code>int</code> and one <code>double</code>
            * returns nothing, hence return type is <code>void</code> *
            <strong>note</strong>: this is <strong>not</strong> the same
            as a return type of <code>void*</code></p>
            <p>Sometimes, you need to decide <em>which</em> function to
            call at <strong>run time</strong>. Why?</p>
            <h3 data-number="3.0.1" id="example-bubble-sort"><span
            class="header-section-number">3.0.1</span> Example | Bubble
            Sort</h3>
            <p>[<a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/code/generic_bubble_sort.c">Follow
            along with the Generic Bubble Sort Code</a>]</p>
            <p>How do you write a bubble sort? Say for an array of
            <code>int</code>s?</p>
            <div class="sourceCode" id="cb47"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Sorting ints</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> bubble_sort_int<span class="op">(</span> <span class="dt">int</span> array<span class="op">[],</span> <span class="dt">int</span> array_size <span class="op">)</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> array_size<span class="op">-</span><span class="dv">1</span> <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> j <span class="op">&lt;</span> i <span class="op">;</span> <span class="op">++</span>j <span class="op">)</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span> array<span class="op">[</span>j<span class="op">]</span> <span class="op">&gt;</span> array<span class="op">[</span>j<span class="op">+</span><span class="dv">1</span><span class="op">]</span> <span class="op">)</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>                <span class="dt">int</span> temp <span class="op">=</span> array<span class="op">[</span>j<span class="op">]</span> <span class="op">;</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>                array<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> array<span class="op">[</span>j<span class="op">+</span><span class="dv">1</span><span class="op">]</span> <span class="op">;</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>                array<span class="op">[</span>j<span class="op">+</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> temp <span class="op">;</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="co">// printing out an array</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_array<span class="op">(</span> <span class="dt">int</span> array<span class="op">[],</span> <span class="dt">int</span> array_size <span class="op">)</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;array = &quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> array_size <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">%d</span><span class="st"> &quot;</span><span class="op">,</span> array<span class="op">[</span>i<span class="op">]</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> my_array<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">2341</span><span class="op">,</span> <span class="dv">8632</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">2344</span><span class="op">,</span> <span class="dv">747645</span> <span class="op">}</span> <span class="op">;</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> array_size <span class="op">=</span> <span class="dv">5</span> <span class="op">;</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// sort the array</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>    bubble_sort<span class="op">(</span> my_array<span class="op">,</span> array_size <span class="op">)</span> <span class="op">;</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>    print_array<span class="op">(</span> my_array<span class="op">,</span> array_size <span class="op">)</span> <span class="op">;</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <p>This works for an array of <code>int</code>s. But what if
            I want to sort an array of <code>double</code>?</p>
            <p>Maybe, write a new function to do that?</p>
            <div class="sourceCode" id="cb49"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Sorting ints</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> bubble_sort_double<span class="op">(</span> <span class="dt">double</span> array<span class="op">[],</span> <span class="dt">int</span> array_size <span class="op">)</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> array_size<span class="op">-</span><span class="dv">1</span> <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> j <span class="op">&lt;</span> i <span class="op">;</span> <span class="op">++</span>j <span class="op">)</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span> array<span class="op">[</span>j<span class="op">]</span> <span class="op">&gt;</span> array<span class="op">[</span>j<span class="op">+</span><span class="dv">1</span><span class="op">]</span> <span class="op">)</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                <span class="dt">double</span> temp <span class="op">=</span> array<span class="op">[</span>j<span class="op">]</span> <span class="op">;</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>                array<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> array<span class="op">[</span>j<span class="op">+</span><span class="dv">1</span><span class="op">]</span> <span class="op">;</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>                array<span class="op">[</span>j<span class="op">+</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> temp <span class="op">;</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>But what if I want to sort an array of <code>char</code>?
            Strings? <code>float</code>s? My custom
            <code>struct</code>s? Do we write one function for each?</p>
            <div class="sourceCode" id="cb50"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> bubble_sort_char<span class="op">(</span> <span class="dt">char</span> array<span class="op">[],</span> <span class="dt">int</span> array_size <span class="op">){...}</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> bubble_sort_strings<span class="op">(</span> <span class="dt">char</span><span class="op">*</span> array<span class="op">[],</span> <span class="dt">int</span> array_size <span class="op">){...}</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> bubble_sort_float<span class="op">(</span> <span class="dt">float</span> array<span class="op">[],</span> <span class="dt">int</span> array_size <span class="op">){...}</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> bubble_sort_struct_student<span class="op">(</span> <span class="kw">struct</span> student array<span class="op">[],</span> <span class="dt">int</span> array_size <span class="op">){...}</span></span></code></pre></div>
            <p>But what if <strong>we don’t know which one will be
            needed until run time?</strong>*</p>
            <p>So, depending on the data that we’re given, or some input
            from the user, we may have to pick one of the above but
            <em>won’t know of the choice at compile time</em>.</p>
            <p>Enter <strong>function pointers</strong>!</p>
            <h3 data-number="3.0.2"
            id="example-generic-bubble-sort"><span
            class="header-section-number">3.0.2</span> Example | Generic
            Bubble Sort</h3>
            <p>A sorting algorithm, at its heart, has two parts:</p>
            <ol type="1">
            <li><em>compare</em>: given two elements, let us know which
            is larger/greater</li>
            <li><em>swap</em>: given two elements, exchange their
            values</li>
            </ol>
            <p>so, in a generic sense, we have:</p>
            <div class="sourceCode" id="cb51"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span> is_greater<span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span> <span class="op">)</span> <span class="co">// If a is larger than b</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    swap<span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span>         <span class="co">// swap their values</span></span></code></pre></div>
            <p>hence, we can rewrite the bubble sort function, in a
            “generic” form as:</p>
            <div class="sourceCode" id="cb52"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Sorting | Generic</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> generic_bubble_sort<span class="op">(...)</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> array_size<span class="op">-</span><span class="dv">1</span> <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> j <span class="op">&lt;</span> i <span class="op">;</span> <span class="op">++</span>j <span class="op">)</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span> is_greater<span class="op">(</span> array<span class="op">[</span>j<span class="op">],</span> array<span class="op">[</span>j<span class="op">+</span><span class="dv">1</span><span class="op">])</span> <span class="op">)</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>                swap<span class="op">(</span> array<span class="op">[</span>j<span class="op">],</span> array<span class="op">[</span>j<span class="op">+</span><span class="dv">1</span><span class="op">]</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>But, what are the <strong>inputs</strong> to the
            function?</p>
            <p>We first need to define the type of the array. Since we
            won’t know the type of the data elements in the array, we
            can’t pick a specific array type.</p>
            <p>But, remember: * arrays and pointers are interchangeable
            * can cast from any pointer type to <code>void*</code> and
            back</p>
            <p>using this, we define the array as a
            <code>void*</code>:</p>
            <div class="sourceCode" id="cb53"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> generic_bubble_sort<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> array<span class="op">,</span> <span class="op">...</span> <span class="op">)</span></span></code></pre></div>
            <p>As before, we need to know the <em>size</em> of the
            entire array, so we can now expand the function signature
            more:</p>
            <div class="sourceCode" id="cb54"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> generic_bubble_sort<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> array<span class="op">,</span> <span class="dt">int</span> array_size<span class="op">,</span> <span class="op">...)</span></span></code></pre></div>
            <p>Remember that a void* pointer is just a pointer to a
            <em>block</em> of memory. C does not know the <em>type of
            each element</em> in the array. So, we
            <strong>cannot</strong> do: * <code>array[i]</code> → since
            the type is a <code>void*</code></p>
            <p>We can use pointer arithmetic with <code>void*</code> so
            this is possible: * <code>array+i</code> → but that moves
            the pointer forward by <code>i</code>
            <strong>bytes</strong></p>
            <p>and <strong>not</strong> by the number of bytes of the
            data type. Recall, * <code>char* pc ; pc+1 ;</code> →
            advances by <code>1</code> byte *
            <code>int* pi ; pi+1 ;</code> → advances by <code>4</code>
            bytes</p>
            <p>Hence, we need information about the <em>size of each
            element</em>, i.e.,</p>
            <div class="sourceCode" id="cb55"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> generic_bubble_sort<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> array<span class="op">,</span> <span class="dt">int</span> array_size<span class="op">,</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="dt">int</span> element_size <span class="op">)</span> </span></code></pre></div>
            <p>So, we can do: <code>array + (i * element_size)</code> to
            move to the next element in the array</p>
            <p>So, for an <code>int</code> array, we get
            (<code>element_size = 4</code>): <img
            src="./figures/07.01.pointer_cast/pointer_cast.2.png"
            alt="array of integers" /> <img
            src="./figures/07.01.pointer_cast/pointer_cast.3.png"
            alt="array of integers" /> <br></p>
            <p>and for a <code>char</code> array, we get
            (<code>element_size = 1</code>): <img
            src="./figures/07.01.pointer_cast/pointer_cast.5.png"
            alt="array of integers" /> <img
            src="./figures/07.01.pointer_cast/pointer_cast.6.png"
            alt="array of integers" /></p>
            <p><br></p>
            <p>Using this information about <code>element_size</code>,
            we can rewrite the generic bubble sort function as:</p>
            <div class="sourceCode" id="cb56"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Sorting | Generic</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> generic_bubble_sort<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> array<span class="op">,</span> <span class="dt">int</span> array_size<span class="op">,</span> </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="dt">int</span> element_size <span class="op">)</span> </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> array_size<span class="op">-</span><span class="dv">1</span> <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> j <span class="op">&lt;</span> i <span class="op">;</span> <span class="op">++</span>j <span class="op">)</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span> is_greater<span class="op">(</span> array <span class="op">+</span> <span class="op">(</span>j <span class="op">*</span> element_size<span class="op">),</span> array <span class="op">+</span> <span class="op">((</span>j<span class="op">+</span><span class="dv">1</span><span class="op">)</span> <span class="op">*</span> element_size <span class="op">))</span> <span class="op">)</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>                swap<span class="op">(</span> array <span class="op">+</span> <span class="op">(</span>j <span class="op">*</span> element_size<span class="op">),</span> array <span class="op">+</span> <span class="op">((</span>j<span class="op">+</span><span class="dv">1</span><span class="op">)</span> <span class="op">*</span> element_size <span class="op">))</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Now we see the <em>generic</em> version of bubble sort
            taking shape.</p>
            <h3 data-number="3.0.3" id="what-is-generic"><span
            class="header-section-number">3.0.3</span> What is
            “<em>generic</em>”?</h3>
            <p>But we are still missing critical information,
            <em>viz.</em>, what are <code>is_greater()</code> and
            <code>swap()</code>?</p>
            <p>Remember that since the
            <code>generic_bubble_sort()</code> function doesn’t know
            which <em>exact</em> type it is operating on, we need to
            <em>somehow</em> provide it with the <strong>actual</strong>
            functions that will carry out the comparison and swapping,
            depending on the type of the array being passed in. For
            instance, if we are comparing integers, we need a comparator
            and swap that can operate on integers and similarly ones for
            structs, doubles, <em>etc.</em></p>
            <p>Wouldn’t it be great, if we could just <strong>send in
            the specific functions as arguments to
            <code>generic_bubble_sort()</code></strong>, say like,</p>
            <div class="sourceCode" id="cb57"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> generic_bubble_sort<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> array<span class="op">,</span> <span class="dt">int</span> array_size<span class="op">,</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>                          <span class="dt">int</span> element_size<span class="op">,</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                          <span class="op">&lt;</span>SOME_TYPE<span class="op">&gt;</span> is_greater<span class="op">,</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>                          <span class="op">&lt;</span>SOME_TYPE<span class="op">&gt;</span> swap <span class="op">)</span> </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> array_size<span class="op">-</span><span class="dv">1</span> <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> j <span class="op">&lt;</span> i <span class="op">;</span> <span class="op">++</span>j <span class="op">)</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span> is_greater<span class="op">(</span> array <span class="op">+</span> <span class="op">(</span>j <span class="op">*</span> element_size<span class="op">),</span> array <span class="op">+</span> <span class="op">((</span>j<span class="op">+</span><span class="dv">1</span><span class="op">)</span> <span class="op">*</span> element_size <span class="op">))</span> <span class="op">)</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>                swap<span class="op">(</span> array <span class="op">+</span> <span class="op">(</span>j <span class="op">*</span> element_size<span class="op">),</span> array <span class="op">+</span> <span class="op">((</span>j<span class="op">+</span><span class="dv">1</span><span class="op">)</span> <span class="op">*</span> element_size <span class="op">))</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>This is <em>precisely</em> where <strong>function
            pointers</strong> come in.</p>
            <p>We can define <code>is_greater()</code> and
            <code>swap()</code> to be pointers to functions,
            <em>i.e.,</em> to a <strong>type</strong> of function (the
            signatures). Hence, a <em>comparator</em> function pointer
            would look like:</p>
            <div class="sourceCode" id="cb58"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">int</span> <span class="op">(*</span>comparator_function_pointer<span class="op">)(</span> <span class="dt">void</span><span class="op">*</span> l<span class="op">,</span> <span class="dt">void</span><span class="op">*</span> r <span class="op">)</span> <span class="op">;</span></span></code></pre></div>
            <p>Recall that the <code>typedef</code> keyword
            <em>associates a name with a type</em>. In the above
            example, we are saying that
            <code>comparator_function_pointer</code> is now a name that
            refers to the (function) type,
            <code>int (*)( void*, void* )</code>, <em>i.e.,</em> a
            <strong>pointer to a function that takes two arguments, each
            of type <code>void*</code> and returns and
            <code>int</code></strong>.</p>
            <p>Note, that the job of a comparator function is to take
            two values and, * return positive (non-zero) values if
            <code>l &gt; r</code> or * a zero if
            <code>l &lt;= r</code>.</p>
            <p>We can define the <code>swap</code> function pointer in a
            similar manner:</p>
            <div class="sourceCode" id="cb59"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>swap_function_pointer<span class="op">)(</span> <span class="dt">void</span><span class="op">*</span> l<span class="op">,</span> <span class="dt">void</span><span class="op">*</span> r <span class="op">)</span> <span class="op">;</span></span></code></pre></div>
            <p>where, <code>swap_function_pointer</code> is a
            <strong>name</strong> that refers to the (function) type,
            <code>void (*)( void*, void* )</code> since such a function
            doens’t need to return anything, just swap the two elements
            pointed to by the <code>void*</code> arguments.</p>
            <p>Updating our sorting function to use the function
            pointers,</p>
            <div class="sourceCode" id="cb60"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> generic_bubble_sort<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> array<span class="op">,</span> <span class="dt">int</span> array_size<span class="op">,</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>                          <span class="dt">int</span> element_size<span class="op">,</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>                          comparator_function_pointer is_greater<span class="op">,</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>                          swap_function_pointer swap <span class="op">)</span> </span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> array_size<span class="op">-</span><span class="dv">1</span> <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> j <span class="op">&lt;</span> i <span class="op">;</span> <span class="op">++</span>j <span class="op">)</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span> is_greater<span class="op">(</span> array <span class="op">+</span> <span class="op">(</span>j <span class="op">*</span> element_size<span class="op">),</span> array <span class="op">+</span> <span class="op">((</span>j<span class="op">+</span><span class="dv">1</span><span class="op">)</span> <span class="op">*</span> element_size <span class="op">))</span> <span class="op">)</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>                swap<span class="op">(</span> array <span class="op">+</span> <span class="op">(</span>j <span class="op">*</span> element_size<span class="op">),</span> array <span class="op">+</span> <span class="op">((</span>j<span class="op">+</span><span class="dv">1</span><span class="op">)</span> <span class="op">*</span> element_size <span class="op">))</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>So, <code>is_greater</code> is now a function pointer of
            type, <code>comparator_function_pointer</code> and
            <code>swap</code> is a function pointer of type,
            <code>swap_function_pointer</code>.</p>
            <p><strong>NOTE:</strong> function pointers are invoked
            <strong>exactly</strong> like regular functions,
            <em>i.e.,</em> <code>is_greater(...)</code> and
            <code>swap(...)</code>. The above code will work without any
            changes.</p>
            <h3 data-number="3.0.4"
            id="generic-to-concrete-functions"><span
            class="header-section-number">3.0.4</span> Generic to
            <em>concrete</em> functions</h3>
            <p>Eventually, we need to decide what it is that we are
            sorting. Is it an array of <code>int</code>s,
            <code>doubles</code>s, <code>struct</code>s, etc. And at
            that point in time, we will need the actual, **concrete*
            functions for comparing and swapping <code>int</code>s (or
            <code>double</code>s or whatever).</p>
            <p>We we define the two functions (using <code>int</code> as
            an example):</p>
            <div class="sourceCode" id="cb61"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Compare and Swap functions for integers</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> is_greater_than_int<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> l<span class="op">,</span> <span class="dt">void</span><span class="op">*</span> r <span class="op">)</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// cast it from void* to relevant type, int*</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// since we cannot dereference void*</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">*</span> left <span class="op">=</span> l <span class="op">;</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">*</span> right <span class="op">=</span> r <span class="op">;</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// compare and return result</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> <span class="op">*</span>left <span class="op">&gt;</span> <span class="op">*</span>right <span class="op">)</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span> <span class="op">;</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span> </span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>   <span class="co">// Can just use this one line instead but not doing so for clarity</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>   <span class="co">// return ( *l &gt; *r ? 1 : 0 ) ; </span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> swap_int<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> l<span class="op">,</span> <span class="dt">void</span><span class="op">*</span> r <span class="op">)</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// cast it from void* to relevant type, int*</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// since we cannot dereference void*</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">*</span> left <span class="op">=</span> l <span class="op">;</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">*</span> right <span class="op">=</span> r <span class="op">;</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> temp <span class="op">=</span> <span class="op">*</span>left <span class="op">;</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// swap</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>left <span class="op">=</span> <span class="op">*</span>right <span class="op">;</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>right <span class="op">=</span> temp <span class="op">;</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>We can define equivalent functions for
            <code>double</code>,</p>
            <div class="sourceCode" id="cb62"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Compare and Swap functions for doubles </span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> is_greater_than_double<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> l<span class="op">,</span> <span class="dt">void</span><span class="op">*</span> r <span class="op">)</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span><span class="op">*</span> left <span class="op">=</span> l <span class="op">;</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span><span class="op">*</span> right <span class="op">=</span> r <span class="op">;</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> <span class="op">*</span>left <span class="op">&gt;</span> <span class="op">*</span>right <span class="op">)</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span> <span class="op">;</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span> </span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> swap_double<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> l<span class="op">,</span> <span class="dt">void</span><span class="op">*</span> r <span class="op">)</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span><span class="op">*</span> left <span class="op">=</span> l <span class="op">;</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span><span class="op">*</span> right <span class="op">=</span> r <span class="op">;</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> temp <span class="op">=</span> <span class="op">*</span>left <span class="op">;</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>left <span class="op">=</span> <span class="op">*</span>right <span class="op">;</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>right <span class="op">=</span> temp <span class="op">;</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p><strong>NOTE:</strong> the type signatures of the
            concrete functions must <strong>exactly match</strong> that
            of the corresponding function pointers. Otherwise it will
            result in compile time errors.</p>
            <h3 data-number="3.0.5"
            id="putting-it-all-together-using-function-pointers"><span
            class="header-section-number">3.0.5</span> Putting it all
            Together | Using Function Pointers</h3>
            <p>Now we are ready to use the concrete functions and the
            pointers in our code:</p>
            <div class="sourceCode" id="cb63"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> my_array_int<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span> <span class="dv">2341</span><span class="op">,</span> <span class="dv">8632</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">2344</span><span class="op">,</span> <span class="dv">747645</span> <span class="op">}</span> <span class="op">;</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> array_size <span class="op">=</span> <span class="dv">5</span> <span class="op">;</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// calling the INTEGER version with the concrete integer comparator and swap</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    generic_bubble_sort<span class="op">(</span> my_array_int<span class="op">,</span> array_size<span class="op">,</span> </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>                         <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">),</span> <span class="co">/*element size*/</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>                         is_greater_than_int<span class="op">,</span> </span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>                         swap_int <span class="op">)</span> <span class="op">;</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// calling the DOUBLE version with the concrete DOUBLE comparator and swap</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> my_double_array<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">9485.2</span><span class="op">,</span> <span class="fl">34.567</span><span class="op">,</span> <span class="fl">9383.243</span><span class="op">,</span> <span class="fl">44.1</span> <span class="op">}</span> <span class="op">;</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    generic_bubble_sort<span class="op">(</span> my_double_array<span class="op">,</span> array_size<span class="op">,</span> </span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>                         <span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">),</span> <span class="co">/*element size*/</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>                         is_greater_than_double<span class="op">,</span> </span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>                         swap_double <span class="op">)</span> <span class="op">;</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>As we see from the above, we are using the
            <strong>same</strong> <code>generic_bubble_srt</code>
            function to sort both, arrays of <code>int</code> and
            <code>double</code>. The only difference is the different
            <em>concrete</em> versions of the comparator and swap
            functions that we pass to the sorting function.</p>
            <h3 data-number="3.0.6"
            id="why-bother-if-we-need-concrete-functions-anyways"><span
            class="header-section-number">3.0.6</span> Why bother if we
            need <code>concrete</code> functions anyways?</h3>
            <p>Using function pointers allows us to do a few things
            well: 1. <strong>code reuse</strong>: the code for sorting
            doesn’t need to be rewritten each time. In fact, when we
            have larger, more complex, functions, this will be a
            lifesaver as we can implement the main “concept” just once
            and then write “<em>specialized</em>” concrete functions
            (usually much smaller) as needed. 2. <strong>dynamic
            dispatch</strong>: oftentimes, it may not be clear
            <em>which</em> version of the concrete functions are needed,
            <strong>until runtime</strong>! In our example, what if we
            don’t know if we’re given arrays of <code>int</code>s or
            <code>double</code>s until we receive the data at runtime?
            Then we cannot know which concrete function is to be invoked
            while writing the code. Hence, we can pick the appropriate
            function pointer <em>at run time</em> and the code will work
            correctly! 3. <strong>specialization</strong>: different
            data types require different handling. The way we sort
            numbers <em>will not</em> be the same way we sort strings or
            other, more complex, data types (<em>e.g.,</em> user defined
            <code>struct</code>s).</p>
            <h3 data-number="3.0.7"
            id="in-class-exercise-generic-insertion-sort-for-struct"><span
            class="header-section-number">3.0.7</span> In-class Exercise
            | Generic Insertion Sort for <code>struct</code></h3>
            <p>Fill out the missing elements in this code:</p>
            <div class="sourceCode" id="cb64"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define NAME_LENGTH </span><span class="dv">128</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> map<span class="op">{</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> _country<span class="op">[</span>NAME_LENGTH<span class="op">]</span> <span class="op">;</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> _capital<span class="op">[</span>NAME_LENGTH<span class="op">]</span> <span class="op">;</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="op">;</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="co">// DEFINE TWO FUNCTION POINTERS, ONE EACH FOR COMPARE AND SWAP</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="co">// UNCOMMENT THE TWO ARGUMENTS ONCE YOU DEFINE THE FUNCTION POINTERS</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> generic_insertion_sort<span class="op">(</span> <span class="dt">void</span><span class="op">*</span> array<span class="op">,</span> <span class="dt">int</span> array_size<span class="op">,</span> <span class="dt">int</span> element_size</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>                            <span class="co">/*is_greater_than my_comparator,</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a><span class="co">                            swap my_swap*/</span> <span class="op">)</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a><span class="co">// CREATE A NEW STRUCT AND RETURN A POINTER TO IT</span></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> map<span class="op">*</span> create_new_struct<span class="op">(</span><span class="co">/*...*/</span><span class="op">)</span></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a><span class="co">// CREATE THE COMPARATOR AND SWAP FUNCTIONS HERE</span></span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a><span class="co">// FUNCTION TO PRINT THE ARRAY OF STRUCTS AND ITS ELEMENTS</span></span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a><span class="co">// PRINT EACH RECORD ON A NEW LINE AS FOLLOWS:</span></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a><span class="co">// country: USA             capital: Washington D.C.</span></span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a><span class="co">// country: Sierra Leone    capital: Freetown</span></span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> print_array_structs<span class="op">(</span><span class="co">/*...*/</span><span class="op">)</span></span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> </span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> num_countries <span class="op">;</span></span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;number of countries: &quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true" tabindex="-1"></a>    scanf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">&amp;</span>num_countries <span class="op">)</span> <span class="op">;</span></span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// CREATE AN ARRAY OF POINTERS TO STRUCTS</span></span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> map<span class="op">**</span> array_countries <span class="co">/*= ...*/</span> <span class="op">;</span></span>
<span id="cb64-53"><a href="#cb64-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-54"><a href="#cb64-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-55"><a href="#cb64-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-56"><a href="#cb64-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// CREATE num_countries NUMBER OF &quot;COUNTRIES&quot; AND STORE IN THE ARRAY</span></span>
<span id="cb64-57"><a href="#cb64-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ASK USER FOR INPUT ON COUNTRY/CAPITALS</span></span>
<span id="cb64-58"><a href="#cb64-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// YOU CAN PICK YOUR OWN COUNTRY/CAPITAL COMBINATIONS</span></span>
<span id="cb64-59"><a href="#cb64-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-60"><a href="#cb64-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-61"><a href="#cb64-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// PRINT THE ARRAY BEFORE SORT</span></span>
<span id="cb64-62"><a href="#cb64-62" aria-hidden="true" tabindex="-1"></a>    print_array_structs<span class="op">(</span> <span class="co">/*...*/</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb64-63"><a href="#cb64-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-64"><a href="#cb64-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-65"><a href="#cb64-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// SORT THE ARRAY -- FIRST BY COUNTRY NAME</span></span>
<span id="cb64-66"><a href="#cb64-66" aria-hidden="true" tabindex="-1"></a>    generic_insertion_sort<span class="op">(</span> array_countries<span class="op">,</span> num_countries<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> map<span class="op">*)</span> <span class="co">/*,...*/</span><span class="op">)</span> <span class="op">;</span> </span>
<span id="cb64-67"><a href="#cb64-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-68"><a href="#cb64-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">// PRINT THE ARRAY AFTER FIRST SORT</span></span>
<span id="cb64-69"><a href="#cb64-69" aria-hidden="true" tabindex="-1"></a>    print_array_structs<span class="op">(</span> <span class="co">/*...*/</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb64-70"><a href="#cb64-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-71"><a href="#cb64-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-72"><a href="#cb64-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">// SORT THE ARRAY -- SECOND BY CAPITAL NAME</span></span>
<span id="cb64-73"><a href="#cb64-73" aria-hidden="true" tabindex="-1"></a>    generic_insertion_sort<span class="op">(</span> array_countries<span class="op">,</span> num_countries<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> map<span class="op">*)</span> <span class="co">/*,...*/</span><span class="op">)</span> <span class="op">;</span> </span>
<span id="cb64-74"><a href="#cb64-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-75"><a href="#cb64-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">// PRINT THE ARRAY AFTER SECOND SORT</span></span>
<span id="cb64-76"><a href="#cb64-76" aria-hidden="true" tabindex="-1"></a>    print_array_structs<span class="op">(</span> <span class="co">/*...*/</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb64-77"><a href="#cb64-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-78"><a href="#cb64-78" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb64-79"><a href="#cb64-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb64-80"><a href="#cb64-80" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <h1 data-number="4"
            id="c-memory-model-data-structures-and-apis"><span
            class="header-section-number">4</span> C Memory Model,
            Data-structures, and APIs</h1>
            <p>C presents some unique opportunities for how to structure
            your code and data-structures, but also requires that you’re
            careful about how data is passed around a program.</p>
            <h2 data-number="4.1" id="memory-allocation-options"><span
            class="header-section-number">4.1</span> Memory Allocation
            Options</h2>
            <p>In C, when creating a variable, you have the option of
            allocating it in one of multiple different types of
            memory:</p>
            <ul>
            <li>In another existing structure.</li>
            <li>In the heap using <code>malloc</code> or its sibling
            functions.</li>
            <li>In global memory.</li>
            <li>On the stack.</li>
            </ul>
            <p>It might be surprising, but it is quite <em>uncommon</em>
            in programming languages to have this flexibility.</p>
            <h3 data-number="4.1.1" id="internal-allocation"><span
            class="header-section-number">4.1.1</span> Internal
            Allocation</h3>
            <p>What does it look like to do internal allocation of one
            struct or array inside of another? See the following as an
            example.</p>
            <div class="sourceCode" id="cb65"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> bar <span class="op">{</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co">     * `arr` is allocated internally to `bar`, whereas `bytes` is a pointer to</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co">     * a separate allocation. `arr` must have a *fixed size*, and `bytes` does not</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co">     * because its allocation can be as large as you want!</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> arr<span class="op">[</span><span class="dv">64</span><span class="op">];</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> <span class="op">*</span>bytes<span class="op">;</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> foo <span class="op">{</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* The `bar` structure is allocated as *part of* the `struct foo` in `internal` */</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> bar internal<span class="op">;</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* But we can *also* allocate another `bar` separately if we&#39;d prefer */</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> bar <span class="op">*</span>external<span class="op">;</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="co">     * We didn&#39;t have to separately allocate the `struct bar internal` as</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a><span class="co">     * it was allocated with the enclosing `a` allocation. However, we do have to</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="co">     * allocate the `external` allocation. In both cases, we have access to a</span></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="co">     * `struct bar` from within `struct foo`.</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> foo <span class="op">*</span>a <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> foo<span class="op">));</span> <span class="co">/* should check return value */</span></span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>    a<span class="op">-&gt;</span>external   <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> bar<span class="op">));</span> <span class="co">/* and this one ;-( */</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a><span class="co">     * Note the difference in needing to use `-&gt;` when `external` is a pointer</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a><span class="co">     * versus simply using `.` with `internal`.</span></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>    a<span class="op">-&gt;</span>internal<span class="op">.</span>arr<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> a<span class="op">-&gt;</span>external<span class="op">-&gt;</span>arr<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <p>One of the more interesting uses of internal allocation
            is in linked data-structures (e.g. like linked lists). It is
            common in languages like java to implement linked
            data-structures to have “nodes” that reference the data
            being tracked.</p>
            <div class="sourceCode" id="cb67"><pre
            class="sourceCode java"><code class="sourceCode java"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This could be made generic across the data types it could store by instead</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="co">// using `class LinkedList&lt;T&gt;`, but I&#39;m keeping it simple here.</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LinkedListOfStudents <span class="op">{</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Node</span> head<span class="op">;</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> <span class="bu">Node</span> <span class="op">{</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>        Student s<span class="op">;</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Node</span> next<span class="op">;</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Node</span><span class="op">(</span>Student s<span class="op">,</span> <span class="bu">Node</span> next<span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">s</span>    <span class="op">=</span> s<span class="op">;</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">next</span> <span class="op">=</span> next<span class="op">;</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">add</span><span class="op">(</span>Student s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// The program has *previously* allocated `data`.</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Now we have to additionally allocate the `node` separate from the data!</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Node</span> n <span class="op">=</span> <span class="kw">new</span><span class="op">(</span>s<span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="fu">head</span><span class="op">);</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">head</span> <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a><span class="co">// This looks like the following. Note separate allocations for Node and Student</span></span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a><span class="co">// head --&gt; Node------+    ,--&gt;Node-----+</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a><span class="co">//          | s  next |---&#39;    | s next |---...</span></span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a><span class="co">//          +-|-------+        +-|------+</span></span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a><span class="co">//            v                  V</span></span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a><span class="co">//          Student-+           Student-+</span></span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a><span class="co">//          | ...   |           | ...   |</span></span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a><span class="co">//          +-------+           +-------+</span></span></code></pre></div>
            <p>Lets see the same in C.</p>
            <div class="sourceCode" id="cb68"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> linked_list_node <span class="op">{</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>data<span class="op">;</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> linked_list_node <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> linked_list <span class="op">{</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> linked_list_node <span class="op">*</span>head<span class="op">;</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> student <span class="op">{</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// student data here...</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> linked_list_node list<span class="op">;</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>add<span class="op">(</span><span class="kw">struct</span> linked_list <span class="op">*</span>ll<span class="op">,</span> <span class="kw">struct</span> linked_list_node <span class="op">*</span>n<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>data<span class="op">)</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>    n<span class="op">-&gt;</span>next  <span class="op">=</span> ll<span class="op">-&gt;</span>head<span class="op">;</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>    n<span class="op">-&gt;</span>data  <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>    ll<span class="op">-&gt;</span>head <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> linked_list l<span class="op">;</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> student <span class="op">*</span>s <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> student<span class="op">));</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Should check that `s != NULL`... */</span></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>    add<span class="op">(&amp;</span>l<span class="op">,</span> <span class="op">&amp;</span>s<span class="op">-&gt;</span>list<span class="op">,</span> s<span class="op">);</span> <span class="co">/* note that `&amp;s-&gt;list` is the same as `&amp;(s-&gt;list)` */</span></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;student added to list!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a><span class="co"> * This looks something like the following. Linked list is *internal* to student.</span></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a><span class="co"> * head ----&gt; student-+     ,-&gt; student-+</span></span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a><span class="co"> *            | ...   |    ,    | ...   |</span></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a><span class="co"> *            | next  |---&#39;     | next  |--&gt; NULL</span></span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a><span class="co"> *            +-------+         +-------+</span></span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <p>A few interesting things happened here:</p>
            <ol type="1">
            <li>We’re using <code>void *</code> pointers within the
            <code>linked_list_node</code> so that the linked list can
            hold data of <em>any pointer type</em>. You can see that in
            our list implementation, there is nothing that is
            <code>student</code>-specific.</li>
            <li>The <code>list</code> is inline-allocated inside the
            <code>student</code> structure, which completely avoids the
            separate <code>node</code> allocation.</li>
            </ol>
            <p>Most serious data-structure implementations enable this
            inlining of data-structure nodes even without requiring the
            <code>data</code> pointer in the node. We won’t cover that,
            but you can <a
            href="https://github.com/gwsystems/ps/blob/master/ps_list.h">see
            a sample implementation</a>.</p>
            <h3 data-number="4.1.2" id="heap-allocation"><span
            class="header-section-number">4.1.2</span> Heap
            Allocation</h3>
            <p>We’ve already seen <code>malloc</code>,
            <code>calloc</code>, <code>realloc</code>, and
            <code>free</code> which are our interface to the heap. These
            provide the most flexibility, but require that you track the
            memory and <code>free</code> it appropriately<a href="#fn4"
            class="footnote-ref" id="fnref4"
            role="doc-noteref"><sup>4</sup></a></p>
            <h3 data-number="4.1.3" id="global-allocation"><span
            class="header-section-number">4.1.3</span> Global
            Allocation</h3>
            <p>We have already seen global allocations frequently in
            examples so far.</p>
            <div class="sourceCode" id="cb70"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co">/* A globally allocated array! No `malloc` needed! */</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> arr<span class="op">[</span><span class="dv">64</span><span class="op">];</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> foo <span class="op">{</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a<span class="op">,</span> b<span class="op">;</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> foo <span class="op">*</span>next<span class="op">;</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="co">/* A globally allocated structure! */</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> foo s<span class="op">;</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="co">/* Globally allocated *and* initialized integer... */</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> c <span class="op">=</span> <span class="dv">12</span><span class="op">;</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="co">/* ...and array. */</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> d<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">};</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;What is uninitialized global memory set to?</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;Integer: </span><span class="sc">%d\n</span><span class="st">Pointer: </span><span class="sc">%p</span><span class="st"> (as hex: </span><span class="sc">%lx</span><span class="st">)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>           arr<span class="op">[</span><span class="dv">0</span><span class="op">],</span> s<span class="op">.</span>next<span class="op">,</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">long</span><span class="op">)</span>s<span class="op">.</span>next<span class="op">);</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Note that we use `.` to access the fields because `s` is not a pointer! */</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <p>Global variables are either initialized where they are
            defined, or are initialized to <code>0</code>. Note that
            they are intialized to all <code>0</code>s regardless their
            type. This makes more sense than it sounds because pointers
            set to <code>0</code> are <code>NULL</code> (because,
            recall, <code>NULL</code> is just <code>(void *)0</code> –
            see the “hex” output above), and because strings (see later)
            are terminated by <code>\0</code> which is also
            <code>0</code>! Thus, this policy initializes all numerical
            data to <code>0</code>, all pointers to <code>NULL</code>,
            and all strings to <code>""</code>.</p>
            <h3 data-number="4.1.4" id="stack-allocation"><span
            class="header-section-number">4.1.4</span> Stack
            Allocation</h3>
            <p>Variables can also be allocated <em>on the stack</em>.
            This effectively means that as you’re executing in a
            function, variables can be allocated within the
            context/memory of that function. An example that allocates a
            structure and an array on the stack:</p>
            <div class="sourceCode" id="cb72"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ARR_SZ </span><span class="dv">12</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * Find an integer in the array, reset it to `0`, and return its offset.</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * Nothing very interesting here.</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>find_and_reset<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>arr<span class="op">,</span> <span class="dt">int</span> val<span class="op">)</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* find the value */</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ARR_SZ<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>arr<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> val<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>            arr<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> i<span class="op">;</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Couldn&#39;t find it! */</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>fib<span class="op">(</span><span class="dt">int</span> v<span class="op">)</span></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Allocate an array onto the stack */</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fibs<span class="op">[</span>ARR_SZ<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">13</span><span class="op">,</span> <span class="dv">21</span><span class="op">,</span> <span class="dv">34</span><span class="op">,</span> <span class="dv">55</span><span class="op">,</span> <span class="dv">89</span><span class="op">};</span> <span class="co">/* looks like a suspicious sequence... */</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> find_and_reset<span class="op">(</span>fibs<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* should have been set to `0`, so this should return `-1` */</span></span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>find_and_reset<span class="op">(</span>fibs<span class="op">,</span> v<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Should find 8 @ 6: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> fib<span class="op">(</span><span class="dv">8</span><span class="op">));</span></span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* if the array was the same array for these two calls, it would be found at offset -1 (error) */</span></span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Should find 8 @ 6: </span><span class="sc">%d</span><span class="st"> (-1 is wrong here)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> fib<span class="op">(</span><span class="dv">8</span><span class="op">));</span></span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>Should find 8 @ 6: 6
Should find 8 @ 6: 6 (-1 is wrong here)</code></pre>
            <p>Key points to realize:</p>
            <ul>
            <li><code>fibs</code> in <code>fib</code> is allocated
            <em>on the stack</em> and is initialized in
            <code>fib</code>!</li>
            <li>We are passing the array into
            <code>find_and_reset</code> which modifies the array
            directly as it is passed as a pointer.</li>
            <li>The first time that <code>fib</code> is called, it
            creates the <code>arr</code>. After we <em>return</em> from
            <code>fib</code>, the <code>fibs</code> goes away (strictly:
            its memory is reclaimed as part of returning from
            <code>fib</code>).</li>
            <li>The second time we call <code>fib</code>, it effectively
            is a <em>new</em> execution of <code>fib</code>, thus a
            <em>new</em> allocation of <code>fibs</code> that is now
            initialized a second time.</li>
            </ul>
            <h4 data-number="4.1.4.1" id="stack-usage-example"><span
            class="header-section-number">4.1.4.1</span> Stack Usage
            Example</h4>
            <p>How do we think about this? The stack starts out in
            <code>main</code>:</p>
            <pre><code>stack          |
|              |
+-main---------+
|              | &lt;--- main&#39;s local data (note: no local variables)
+--------------+</code></pre>
            <p>What we’re drawing here is a “<em>stack frame</em>” for
            the <code>main</code> function. This includes all of the
            local data allocated within the function, and (at least
            conceptually) also includes the arguments passed into the
            function (<code>main</code> has none). When it calls
            <code>fib</code>, a stack frame is allocated for
            <code>fib</code>, the argument is passed in, and
            <code>fib</code>s variables are allocated:</p>
            <pre><code>stack          |
|              |
+-main---------+
|              |
+-fib----------+
| arg: v       | &lt;--- argument to fib
| fibs[ARR_SZ] | &lt;-+- local variables, allocated here!
| ret          | &lt;-&#39;
+--------------+</code></pre>
            <p><code>fib</code> calls <code>find_and_reset</code>:</p>
            <pre><code>stack          |
|              |
+-main---------+
|              |
+-fib----------+
| v            |
| fibs[ARR_SZ] |&lt;--+
| ret          |   | pointer to fibs passed as argument, and used to update arr[v]
+find_and_reset+   |
| arg: arr     |---+
| arg: val     |
| i            |
+--------------+</code></pre>
            <p>Since <code>find_and_reset</code> updates the array in
            <code>fib</code>’s stack frame, when it returns, the array
            is still properly updated. Importantly, once we return to
            <code>main</code>, we have deallocated all of the variables
            from the previous call to <code>fib</code>…</p>
            <pre><code>stack          |
|              |
+-main---------+
|              | &lt;--- returning to main, deallocates the fibs array in fib
+--------------+</code></pre>
            <p>…thus the next call to <code>fib</code> allocates a
            <em>new</em> set of local variables including
            <code>fibs</code>.</p>
            <pre><code>stack          |
|              |
+-main---------+
|              |
+-fib----------+
| arg: v       |
| fibs[ARR_SZ] | &lt;--- new version of fibs, re-initialized when we fib is called
| ret          |
+--------------+</code></pre>
            <h4 data-number="4.1.4.2"
            id="common-errors-in-stack-allocation"><span
            class="header-section-number">4.1.4.2</span> Common Errors
            in Stack Allocation</h4>
            <p>A few common errors with stack allocation include:</p>
            <ul>
            <li><em>Uninitialized variables.</em> You must
            <em>always</em> initialize all variables allocated on the
            stack, otherwise they can contain seemingly random values
            (see below).</li>
            <li><em>Pointers to stack allocated variables after
            return.</em> After a function returns, its stack allocated
            variables are no longer valid (they were deallocated upon
            <code>return</code>). Any pointers that remain to any of
            those variables are no longer pointing to valid memory!</li>
            </ul>
            <p>We discuss these next.</p>
            <p><strong>Initializing stack-allocated variables.</strong>
            For global memory, we saw that variables, if not
            intentionally initialized, would be set to <code>0</code>.
            This is <em>not</em> the case with stack allocated
            variables. In fact, the answer is “it depends”. If you
            compile your code without optimizations, stack allocated
            variables will be initialized to <code>0</code>; if you
            compile with optimizations, they are <em>not</em>
            initialized. Yikes. Thus, we must assume that they are not
            automatically initialized (similar to the memory returned
            from <code>malloc</code>). An example:</p>
            <div class="sourceCode" id="cb79"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>foo<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* don&#39;t manually initialize anything here */</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> arr<span class="op">[</span><span class="dv">12</span><span class="op">];</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">12</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st">: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> i<span class="op">,</span> arr<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>    foo<span class="op">();</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>Should find 8 @ 6: 6
Should find 8 @ 6: 6 (-1 is wrong here)</code></pre>
            <p>Yikes. We’re getting random values in the array! Where do
            you think these values came from?</p>
            <p><strong>References to stack variables after function
            return.</strong></p>
            <div class="sourceCode" id="cb81"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="op">*</span>ptr<span class="op">;</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="op">*</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>bar<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> a <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">&amp;</span>a<span class="op">;</span>            <span class="co">/* Return the address of a local variable. */</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>foo<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> a <span class="op">=</span> <span class="dv">42</span><span class="op">;</span> <span class="co">/* Allocate `a` on the stack here... */</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    ptr <span class="op">=</span> <span class="op">&amp;</span>a<span class="op">;</span>             <span class="co">/* ...and set the global pointer to point to it... */</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span>               <span class="co">/* ...but then we deallocate `a` when we return. */</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> val<span class="op">;</span></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>    foo<span class="op">();</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Save address of local variable, and dereference it: </span><span class="sc">%lu\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">*</span>ptr<span class="op">);</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span> <span class="co">/* ignore this ;-) magic sprinkles here */</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>    ptr <span class="op">=</span> bar<span class="op">();</span></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Return address of local variable, and dereference it: </span><span class="sc">%lu\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">*</span>ptr<span class="op">);</span></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>Should find 8 @ 6: 6
Should find 8 @ 6: 6 (-1 is wrong here)</code></pre>
            <p>You can see a few interesting facts from the output.</p>
            <ol type="1">
            <li>The value referenced by <code>*ptr</code> after
            <code>foo</code> is a random value, and dereferencing the
            return value from<code>bar</code> causes a segmentation
            fault.</li>
            <li><code>foo</code> and <code>bar</code> contain logic that
            feels pretty identical. In either case, they are taking a
            local variable, and passing its address to <code>main</code>
            where it is used. <code>foo</code> passed it through a
            global variable, and <code>bar</code> simply returns the
            address. Despite this, one of them causes a segmentation
            fault, and the other seems to return a nonsensical value!
            When you try and use stack allocated variables after they
            are been freed (by their function returning), you get
            <em>unpredictable</em> results.</li>
            <li>The C compiler is aggressive about issuing warnings as
            it can tell that bad things are afoot. Warnings are your
            friend and you <em>must</em> do your development with them
            enabled.</li>
            </ol>
            <p>Stack allocation is powerful, can be quite useful.
            However, you have to always be careful that stack allocated
            variables are never added into global data-structures, and
            are never returned.</p>
            <h3 data-number="4.1.5" id="putting-it-all-together"><span
            class="header-section-number">4.1.5</span> Putting it all
            Together</h3>
            <p>Lets look at an example that uses inlined, global, and
            stack allocation. We’ll avoid heap-based allocation to
            demonstrate the less normal memory allocation options in
            C.</p>
            <div class="sourceCode" id="cb83"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;search.h&gt;</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> kv_entry <span class="op">{</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> key<span class="op">;</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>value<span class="op">;</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> kv_store <span class="op">{</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* internal allocation of the key-value store&#39;s entries */</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> kv_entry entries<span class="op">[</span><span class="dv">16</span><span class="op">];</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> num_entries<span class="op">;</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>kv_comp<span class="op">(</span><span class="dt">const</span> <span class="dt">void</span> <span class="op">*</span>a<span class="op">,</span> <span class="dt">const</span> <span class="dt">void</span> <span class="op">*</span>b<span class="op">)</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="kw">struct</span> kv_entry <span class="op">*</span>a_ent <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="kw">struct</span> kv_entry <span class="op">*</span>b_ent <span class="op">=</span> b<span class="op">;</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Compare keys, and return `0` if they are the same */</span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">!(</span>a_ent<span class="op">-&gt;</span>key <span class="op">==</span> b_ent<span class="op">-&gt;</span>key<span class="op">);</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>put<span class="op">(</span><span class="kw">struct</span> kv_store <span class="op">*</span>store<span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">long</span> key<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>value<span class="op">)</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Allocate a structure on the stack! */</span></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> kv_entry ent <span class="op">=</span> <span class="op">{</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>key <span class="op">=</span> key<span class="op">,</span></span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>value <span class="op">=</span> value</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> kv_entry <span class="op">*</span>new_ent<span class="op">;</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Should check if the kv_store has open entries. */</span></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Notice we have to pass the `&amp;ent` as a pointer is expected */</span></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a>    new_ent <span class="op">=</span> lsearch<span class="op">(&amp;</span>ent<span class="op">,</span> store<span class="op">-&gt;</span>entries<span class="op">,</span> <span class="op">&amp;</span>store<span class="op">-&gt;</span>num_entries<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> kv_entry<span class="op">),</span> kv_comp<span class="op">);</span></span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Should check if we found an old entry, and we need to update its value. */</span></span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>new_ent <span class="op">==</span> NULL<span class="op">)</span> <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb83-47"><a href="#cb83-47" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb83-48"><a href="#cb83-48" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb83-49"><a href="#cb83-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Allocated the data-store on the stack, including the array! */</span></span>
<span id="cb83-50"><a href="#cb83-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> kv_store store <span class="op">=</span> <span class="op">{</span> <span class="op">.</span>num_entries <span class="op">=</span> <span class="dv">0</span> <span class="op">};</span></span>
<span id="cb83-51"><a href="#cb83-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-52"><a href="#cb83-52" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> key <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb83-53"><a href="#cb83-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>value <span class="op">=</span> <span class="st">&quot;secret to everything&quot;</span><span class="op">;</span></span>
<span id="cb83-54"><a href="#cb83-54" aria-hidden="true" tabindex="-1"></a>    put<span class="op">(&amp;</span>store<span class="op">,</span> key<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb83-55"><a href="#cb83-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-56"><a href="#cb83-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Validate that the store got modified in the appropriate way */</span></span>
<span id="cb83-57"><a href="#cb83-57" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>store<span class="op">.</span>num_entries <span class="op">==</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb83-58"><a href="#cb83-58" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>store<span class="op">.</span>entries<span class="op">[</span><span class="dv">0</span><span class="op">].</span>key <span class="op">==</span> key<span class="op">);</span></span>
<span id="cb83-59"><a href="#cb83-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-60"><a href="#cb83-60" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%ld</span><span class="st"> is the </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> store<span class="op">.</span>entries<span class="op">[</span><span class="dv">0</span><span class="op">].</span>key<span class="op">,</span> store<span class="op">.</span>entries<span class="op">[</span><span class="dv">0</span><span class="op">].</span>value<span class="op">);</span></span>
<span id="cb83-61"><a href="#cb83-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-62"><a href="#cb83-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb83-63"><a href="#cb83-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>Should find 8 @ 6: 6
Should find 8 @ 6: 6 (-1 is wrong here)</code></pre>
            <p>In this program you might notice that we’ve used <em>no
            dynamic memory allocation at all</em>! The cost of this is
            that we had to create a key-value store of only a fixed size
            (<code>16</code> items, here).</p>
            <h3 data-number="4.1.6" id="comparing-c-to-java"><span
            class="header-section-number">4.1.6</span> Comparing C to
            Java</h3>
            <p>C enables a high-degree of control in which memory
            different variables should be placed. Java traditionally has
            simple rules for which memory is used for variables:</p>
            <ul>
            <li><em><a
            href="https://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html">Primitive
            types</a></em> are stored in objects and on the stack.</li>
            <li><em>Objects</em> are always allocated using
            <code>new</code> in the heap, and references to objects are
            always pointers.</li>
            <li>The heap is managed by the garbage collector, thus
            avoiding the need for <code>free</code>.</li>
            </ul>
            <p>Many aspects of this are absolutely fantastic:</p>
            <ul>
            <li>The programmer doesn’t need to think about how long the
            memory for an object needs to stick around – the garbage
            collector instead manages deallocation.</li>
            <li>The syntax for accessing fields in objects is uniform
            and simple: always use a <code>.</code> to access a field
            (e.g. <code>obj.a</code>) – all object references are
            pointers, so instead of having <code>-&gt;</code>
            everywhere, just replace it with the uniform
            <code>.</code>.</li>
            </ul>
            <p>However, there are significant downsides when the goal is
            to write systems code:</p>
            <ul>
            <li>Some systems don’t have a heap! Many embedded (small)
            systems don’t support dynamic allocation.</li>
            <li>Garbage collection (GC) isn’t free! It has some overhead
            for some applications, can result in larger memory
            consumption (as garbage is waiting to be collected), and can
            causes delays in processing when GC happens. That said,
            modern GC is pretty amazing and does a pretty good job at
            minimizing all of these factors.</li>
            <li>Many data-structures that might be allocated globally or
            on the stack, instead must be allocated on the heap, which
            is slower. Similarly, many objects might want other objects
            to be part of their allocation, but that isn’t possible as
            each must be a separate heap allocation, which adds
            overhead.</li>
            </ul>
            <h2 data-number="4.2" id="strings"><span
            class="header-section-number">4.2</span> Strings</h2>
            <p>String don’t have a dedicated type in C – there is no
            <code>String</code> type. Strings are</p>
            <ol type="1">
            <li>arrays of <code>char</code>s,</li>
            <li>with a null-terminator (<code>\0</code>) character in
            the last array position to denote the termination of the
            string.</li>
            </ol>
            <p>In memory, a simple string has this representation:</p>
            <pre><code>char *str = &quot;hi!&quot;

str ---&gt; +---+---+---+---+
         | h | i | ! |\0 |
         +---+---+---+---+</code></pre>
            <p>Note that <code>\0</code> is a single character even
            though it looks like two. We can see this:</p>
            <div class="sourceCode" id="cb86"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>str <span class="op">=</span> <span class="st">&quot;hi!&quot;</span><span class="op">;</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> str2<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;h&#39;</span><span class="op">,</span> <span class="ch">&#39;i&#39;</span><span class="op">,</span> <span class="ch">&#39;!&#39;</span><span class="op">,</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">};</span>        <span class="co">/* We can allocate strings on the stack! */</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> str<span class="op">[</span>i<span class="op">]</span> <span class="op">!=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span>           <span class="co">/* Loop till we find the null-terminator */</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>str<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> str2<span class="op">[</span>i<span class="op">]);</span>               <span class="co">/* Verify the strings are the same. */</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%c</span><span class="st">&quot;</span><span class="op">,</span> str<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>str<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">==</span> str2<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">&amp;&amp;</span> str<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">==</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">);</span> <span class="co">/* Explicitly check that the null-terminator is there */</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>Should find 8 @ 6: 6
Should find 8 @ 6: 6 (-1 is wrong here)</code></pre>
            <p>So strings aren’t really all that special in C. They’re
            just arrays with a special terminating character, and a
            little bit of syntax support to construct them
            (i.e. <code>"this syntax"</code>). So what’s there to know
            about strings in C?</p>
            <h3 data-number="4.2.1" id="string.h-functions"><span
            class="header-section-number">4.2.1</span>
            <code>string.h</code> Functions</h3>
            <p>Working with strings is <em>not</em> C’s strong point.
            However, you have to handle strings in every language, and C
            provides a number of functions to do so. You can read about
            each of these <code>function</code>s with
            <code>man 3 &lt;function&gt;</code>.</p>
            <h4 data-number="4.2.1.1" id="core-string-operations"><span
            class="header-section-number">4.2.1.1</span> Core String
            Operations</h4>
            <ul>
            <li><code>strlen</code> - How many characters is a string
            (not including the null-terminator)?</li>
            <li><code>strcmp</code> - Compare two strings, return
            <code>0</code> if they are the same, or <code>-1</code> or
            <code>1</code>, depending on which is <a
            href="https://en.wikipedia.org/wiki/Lexicographic_order">lexographically
            less than the other</a>. Similar in purpose to
            <code>equals</code> in Java.</li>
            <li><code>strcpy</code> - Copy into a string the contents of
            another string.</li>
            <li><code>strcat</code> - Concatenate, or append onto the
            end of a string, another string.</li>
            <li><code>strdup</code> - Duplicate a string by
            <code>malloc</code>ing a new string, and copying the string
            into it (you have to <code>free</code> the string
            later!).</li>
            <li><code>snprintf</code> - You’re familiar with
            <code>printf</code>, but <code>snprintf</code> enables you
            to “print” into a string! This gives you a lot of
            flexibility in easily constructing strings. A downside is
            that you don’t really know how big the resulting string is,
            so the <code>n</code> in the name is the maximum length of
            the string you’re creating.</li>
            </ul>
            <div class="sourceCode" id="cb88"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> result<span class="op">[</span><span class="dv">256</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">,</span> <span class="op">};</span>                <span class="co">/* initialize string to be &quot;&quot; */</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>a <span class="op">=</span> <span class="st">&quot;hello&quot;</span><span class="op">,</span> <span class="op">*</span>b <span class="op">=</span> <span class="st">&quot;world&quot;</span><span class="op">;</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> c <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>d<span class="op">;</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>strcmp<span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span>                  <span class="co">/* these strings are different */</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>    strcat<span class="op">(</span>result<span class="op">,</span> a<span class="op">);</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>    strcat<span class="op">(</span>result<span class="op">,</span> <span class="st">&quot; &quot;</span><span class="op">);</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>    strcat<span class="op">(</span>result<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>strcmp<span class="op">(</span>result<span class="op">,</span> <span class="st">&quot;hello world&quot;</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span> <span class="co">/* should have constructed this string properly */</span></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> strdup<span class="op">(</span>result<span class="op">);</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>strcmp<span class="op">(</span>d<span class="op">,</span> result<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span>             <span class="co">/* a duplicate should be equal */</span></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>d<span class="op">);</span></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>    strcpy<span class="op">(</span>result<span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">);</span>                         <span class="co">/* reset the `result` to an empty string */</span></span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> snprintf<span class="op">(</span>result<span class="op">,</span> <span class="dv">255</span><span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st"> and also </span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">,</span> a<span class="op">,</span> b<span class="op">,</span> c<span class="op">);</span></span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\&quot;%s\&quot;</span><span class="st"> has length </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> result<span class="op">,</span> ret<span class="op">);</span></span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>Should find 8 @ 6: 6
Should find 8 @ 6: 6 (-1 is wrong here)</code></pre>
            <p>Many of these functions raise an important question: What
            happens if one of the strings is not large enough to hold
            the data being put into it? If you want to
            <code>strcat</code> a long string into a small character
            array, what happens? This leads us to a simple fact…</p>
            <p><strong>It is <em>easy</em> to use the string functions
            incorrectly.</strong> Many of these functions also have a
            <code>strnX</code> variant where <code>X</code> is the
            operation (<code>strnlen</code>, <code>strncmp</code>,
            etc..). These are safer variants of the string functions.
            The key insight here is that if a string is derived from a
            user, it might not actually be a proper string! It might
            not, for example, have a null-terminator – uh oh! In that
            case, many of the above functions will keep on iterating
            <em>past</em> the end of the buffer</p>
            <div class="sourceCode" id="cb90"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> usr_str<span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> my_str<span class="op">[</span><span class="dv">4</span><span class="op">];</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a><span class="co">     * This use of `strcpy` isn&#39;t bugged as we know the explicit string is 7 zs,</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a><span class="co">     * and 1 null-terminator, which can fit in `usr_str`.</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    strcpy<span class="op">(</span>usr_str<span class="op">,</span> <span class="st">&quot;zzzzzzz&quot;</span><span class="op">);</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a><span class="co">     * Also fine: lets limit the copy to 3 bytes, then add a null-terminator ourself</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a><span class="co">     * (`strlcpy` would do this for us)</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>    strncpy<span class="op">(</span>my_str<span class="op">,</span> usr_str<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>    my_str<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> my_str<span class="op">);</span></span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span>  <span class="co">/* don&#39;t mind me, making sure that your print outs happen */</span></span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a><span class="co">     * However, note that `strlen(usr_str)` is larger than the size of `my_str` (4),</span></span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a><span class="co">     * so we copy *past* the buffer size of `my_str`. This is called a &quot;buffer overflow&quot;.</span></span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>    strcpy<span class="op">(</span>my_str<span class="op">,</span> usr_str<span class="op">);</span></span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>Should find 8 @ 6: 6
Should find 8 @ 6: 6 (-1 is wrong here)</code></pre>
            <h4 data-number="4.2.1.2" id="parsing-strings"><span
            class="header-section-number">4.2.1.2</span> Parsing
            Strings</h4>
            <p>While many of the previous functions have to do with
            creating and modifying strings, computers frequently need to
            “parse”, or try to understand the different parts of, a
            string. Some examples:</p>
            <ul>
            <li>The code we write in <code>.c</code> or
            <code>.java</code> files is just a long string, and the
            programming language needs to <em>parse</em> the string to
            understand what commands you’re trying to issue to the
            computer.</li>
            <li>The shell must <em>parse</em> your commands to determine
            which actions to perform.</li>
            <li>Webpages are simply a collection of <code>html</code>
            code (along with other assets), and a browser needs to
            <em>parse</em> it to determine what to display.</li>
            <li>The markdown text for this lecture is <em>parsed</em> by
            <code>pandoc</code> to generate a <code>pdf</code> and
            <code>html</code>.</li>
            </ul>
            <p>Some of the core functions that help us parse strings
            include:</p>
            <ul>
            <li><code>strtol</code> - Pull an integer out of a string.
            Converts the first part of a string into a
            <code>long int</code>, and also returns an
            <code>endptr</code> which points to the character
            <em>in</em> the string where the conversion into a number
            stopped. If it cannot find an integer, it will return
            <code>0</code>, and <code>endptr</code> is set to point to
            the start of the string.</li>
            <li><code>strtok</code> - Iterate through a string, and find
            the first instance of one of a number of specific
            characters, and return the string leading up to that
            character. This is called multiple times to iterate through
            the string, each time extracting the substring up to the
            specific characters. See the example in the <code>man</code>
            page for <code>strtok</code> for an example.</li>
            <li><code>strstr</code> - Try and find a string (the
            “needle”) in another string (the “haystack”), and return a
            pointer to it (or <code>NULL</code> if you don’t find it).
            As such, it finds a string in another string (thus
            <code>strstr</code>).</li>
            <li><code>sscanf</code> - A versatile function will enables
            a format string (e.g. as used in <code>printf</code>) to
            specify the format of the string, and extract out digits and
            substrings.</li>
            </ul>
            <p>Some examples:</p>
            <div class="sourceCode" id="cb92"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>input <span class="op">=</span> <span class="st">&quot;1 42 the secret to everything&quot;</span><span class="op">;</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>inputdup<span class="op">;</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>substr<span class="op">;</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>substr_saved<span class="op">;</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> <span class="dt">int</span> extracted<span class="op">;</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> sec<span class="op">[</span><span class="dv">32</span><span class="op">];</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    extracted <span class="op">=</span> strtol<span class="op">(</span>input<span class="op">,</span> <span class="op">&amp;</span>substr<span class="op">,</span> <span class="dv">10</span><span class="op">);</span>                               <span class="co">/* pull out the first two integers */</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;extracted </span><span class="sc">%ld</span><span class="st">, remaining string: </span><span class="sc">\&quot;%s\&quot;\n</span><span class="st">&quot;</span><span class="op">,</span> extracted<span class="op">,</span> substr<span class="op">);</span></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    extracted <span class="op">=</span> strtol<span class="op">(</span>substr<span class="op">,</span> <span class="op">&amp;</span>substr<span class="op">,</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;extracted </span><span class="sc">%ld</span><span class="st">, remaining string: </span><span class="sc">\&quot;%s\&quot;\n</span><span class="st">&quot;</span><span class="op">,</span> extracted<span class="op">,</span> substr<span class="op">);</span></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>    substr_saved <span class="op">=</span> substr<span class="op">;</span></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* what happens when we cannot extract a long? */</span></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>    extracted <span class="op">=</span> strtol<span class="op">(</span>substr_saved<span class="op">,</span> <span class="op">&amp;</span>substr<span class="op">,</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>extracted <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> substr_saved <span class="op">==</span> substr<span class="op">);</span>                     <span class="co">/* verify that we couldn&#39;t extract an integer */</span></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>strcmp<span class="op">(</span>strstr<span class="op">(</span>input<span class="op">,</span> <span class="st">&quot;secret&quot;</span><span class="op">),</span> <span class="st">&quot;secret to everything&quot;</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span> <span class="co">/* find secret substring */</span></span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>    sscanf<span class="op">(</span>input<span class="op">,</span> <span class="st">&quot;1 </span><span class="sc">%ld</span><span class="st"> the </span><span class="sc">%s</span><span class="st"> to everything&quot;</span><span class="op">,</span> <span class="op">&amp;</span>extracted<span class="op">,</span> sec<span class="op">);</span>         <span class="co">/* extract out the number and the secret */</span></span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%ld</span><span class="st"> and </span><span class="sc">\&quot;%s\&quot;\n</span><span class="st">&quot;</span><span class="op">,</span> extracted<span class="op">,</span> sec<span class="op">);</span></span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Using strtok to parse through a string finding substrings separated by &#39;h&#39; or &#39;t&#39;:</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>    inputdup <span class="op">=</span> strdup<span class="op">(</span>input<span class="op">);</span>                                            <span class="co">/* strtok will modify the string, lets copy it */</span></span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>substr <span class="op">=</span> strtok<span class="op">(</span>inputdup<span class="op">,</span> <span class="st">&quot;ht&quot;</span><span class="op">);</span> substr <span class="op">!=</span> NULL<span class="op">;</span> substr <span class="op">=</span> strtok<span class="op">(</span>NULL<span class="op">,</span> <span class="st">&quot;ht&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;[</span><span class="sc">%s</span><span class="st">]</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> substr<span class="op">);</span></span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>extracted 1, remaining string: &quot; 42 the secret to everything&quot;
extracted 42, remaining string: &quot; the secret to everything&quot;
42 and &quot;secret&quot;
Using strtok to parse through a string finding substrings separated by &#39;h&#39; or &#39;t&#39;:
[1 42 ]
[e secre]
[ ]
[o every]
[ing]</code></pre>
            <h3 data-number="4.2.2" id="bonus-explicit-strings"><span
            class="header-section-number">4.2.2</span> Bonus: Explicit
            Strings</h3>
            <p>When you use an explicit string
            (e.g. <code>"imma string"</code>) in your code, you’re
            actually asking C to allocate the string in global memory.
            This has some strange side-effects:</p>
            <div class="sourceCode" id="cb94"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> c<span class="op">[</span><span class="dv">5</span><span class="op">];</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>a <span class="op">=</span> <span class="st">&quot;blah&quot;</span><span class="op">;</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>b <span class="op">=</span> <span class="st">&quot;blah&quot;</span><span class="op">;</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>    strncpy<span class="op">(</span>c<span class="op">,</span> a<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%s%s%s\n</span><span class="st">&quot;</span><span class="op">,</span> a<span class="op">,</span> b<span class="op">,</span> c<span class="op">);</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* compare the three pointers */</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%p</span><span class="st"> == </span><span class="sc">%p</span><span class="st"> != </span><span class="sc">%p\n</span><span class="st">&quot;</span><span class="op">,</span> a<span class="op">,</span> b<span class="op">,</span> c<span class="op">);</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>extracted 1, remaining string: &quot; 42 the secret to everything&quot;
extracted 42, remaining string: &quot; the secret to everything&quot;
42 and &quot;secret&quot;
Using strtok to parse through a string finding substrings separated by &#39;h&#39; or &#39;t&#39;:
[1 42 ]
[e secre]
[ ]
[o every]
[ing]</code></pre>
            <p>The C compiler and linker are smart enough to see that if
            you have already used a string with a specific value (in
            this case <code>"clone"</code>), it will avoid allocating a
            copy of that string, and will just reuse the previous value.
            Generally, it doesn’t make much sense to look at the address
            of strings, and certainly you should not compare them. You
            can see in this example how you must compare strings for
            equality using <code>strncmp</code>, and <em>not</em> to
            compare pointers.</p>
            <h2 data-number="4.3" id="api-design-and-concerns"><span
            class="header-section-number">4.3</span> API Design and
            Concerns</h2>
            <p><a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/api_design.html#/">Slides</a></p>
            <p>When programming in C, you’ll see quite a few APIs.
            Throughout the class, we’ll see quite a few APIs, most
            documented in <code>man</code> pages. It takes some practice
            in reading <code>man</code> pages to get what you need from
            them. One of the things that helps the most is to understand
            a few common <em>patterns</em> and <em>requirements</em>
            that you find these APIs, and in C programming in
            general.</p>
            <h3 data-number="4.3.1" id="return-values"><span
            class="header-section-number">4.3.1</span> Return
            Values</h3>
            <p>Functions often need to return multiple values. C does
            not provide a means to return more than one value, thus is
            forced to use pointers. To understand this, lets look at the
            multiple ways that pointers can be used as function
            arguments.</p>
            <div class="sourceCode" id="cb96"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="co"> * `arg` is used to pass an argument that happens to be an array here. In contrast,</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * `ret` is a *second return value*. This function will set the value that `ret` points</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * to -- which happens to be `retval` in the `main` stack frame -- to the value we are</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="co"> * getting from the array.</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>get<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>arg<span class="op">,</span> <span class="dt">int</span> offset<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>ret<span class="op">)</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>arg <span class="op">==</span> NULL<span class="op">)</span> <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>ret <span class="op">=</span> arg<span class="op">[</span>offset<span class="op">];</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a><span class="co"> * Again, the array is passed in as the first argument, but this time it is used to</span></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a><span class="co"> * store the new value.</span></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>set<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>ret_val<span class="op">,</span> <span class="dt">int</span> offset<span class="op">,</span> <span class="dt">int</span> value<span class="op">)</span></span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret_val <span class="op">==</span> NULL<span class="op">)</span> <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>    ret_val<span class="op">[</span>offset<span class="op">]</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a><span class="co"> * `arrdup`&#39;s job is to duplicate an array by allocating and populating</span></span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a><span class="co"> * a new array. It will return `0` or not `0` on success/failure. Thus</span></span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a><span class="co"> * the new array must be returned using pointer arguments. `ret_allocated`</span></span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a><span class="co"> * is a pointer to a pointer to an array in the calling function, and it</span></span>
<span id="cb96-40"><a href="#cb96-40" aria-hidden="true" tabindex="-1"></a><span class="co"> * is used to return the new array.</span></span>
<span id="cb96-41"><a href="#cb96-41" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb96-42"><a href="#cb96-42" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb96-43"><a href="#cb96-43" aria-hidden="true" tabindex="-1"></a>arrdup<span class="op">(</span><span class="dt">int</span> <span class="op">**</span>ret_allocated<span class="op">,</span> <span class="dt">int</span> <span class="op">*</span>args<span class="op">,</span> <span class="dt">size_t</span> args_size<span class="op">)</span></span>
<span id="cb96-44"><a href="#cb96-44" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb96-45"><a href="#cb96-45" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> i<span class="op">;</span></span>
<span id="cb96-46"><a href="#cb96-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>newarr<span class="op">;</span></span>
<span id="cb96-47"><a href="#cb96-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-48"><a href="#cb96-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret_allocated <span class="op">==</span> NULL<span class="op">)</span> <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb96-49"><a href="#cb96-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-50"><a href="#cb96-50" aria-hidden="true" tabindex="-1"></a>    newarr <span class="op">=</span> calloc<span class="op">(</span>args_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span> <span class="co">/* 1 below */</span></span>
<span id="cb96-51"><a href="#cb96-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>newarr <span class="op">==</span> NULL<span class="op">)</span> <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb96-52"><a href="#cb96-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-53"><a href="#cb96-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> args_size<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb96-54"><a href="#cb96-54" aria-hidden="true" tabindex="-1"></a>        newarr<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> args<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb96-55"><a href="#cb96-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-56"><a href="#cb96-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>ret_allocated <span class="op">=</span> newarr<span class="op">;</span> <span class="co">/* 2 and 3 below */</span></span>
<span id="cb96-57"><a href="#cb96-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-58"><a href="#cb96-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb96-59"><a href="#cb96-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb96-60"><a href="#cb96-60" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb96-61"><a href="#cb96-61" aria-hidden="true" tabindex="-1"></a><span class="co"> * Lets draw this one. The stack setup when we call `arrdup`:</span></span>
<span id="cb96-62"><a href="#cb96-62" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb96-63"><a href="#cb96-63" aria-hidden="true" tabindex="-1"></a><span class="co"> * |               |</span></span>
<span id="cb96-64"><a href="#cb96-64" aria-hidden="true" tabindex="-1"></a><span class="co"> * +-main----------+</span></span>
<span id="cb96-65"><a href="#cb96-65" aria-hidden="true" tabindex="-1"></a><span class="co"> * | arr           |&lt;---+</span></span>
<span id="cb96-66"><a href="#cb96-66" aria-hidden="true" tabindex="-1"></a><span class="co"> * | dup           |&lt;-+ |</span></span>
<span id="cb96-67"><a href="#cb96-67" aria-hidden="true" tabindex="-1"></a><span class="co"> * | ...           |  | |</span></span>
<span id="cb96-68"><a href="#cb96-68" aria-hidden="true" tabindex="-1"></a><span class="co"> * +-arrdup--------+  | |</span></span>
<span id="cb96-69"><a href="#cb96-69" aria-hidden="true" tabindex="-1"></a><span class="co"> * | ret_allocated |--+ |</span></span>
<span id="cb96-70"><a href="#cb96-70" aria-hidden="true" tabindex="-1"></a><span class="co"> * | args          |----+</span></span>
<span id="cb96-71"><a href="#cb96-71" aria-hidden="true" tabindex="-1"></a><span class="co"> * | ...           |</span></span>
<span id="cb96-72"><a href="#cb96-72" aria-hidden="true" tabindex="-1"></a><span class="co"> * +---------------+</span></span>
<span id="cb96-73"><a href="#cb96-73" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb96-74"><a href="#cb96-74" aria-hidden="true" tabindex="-1"></a><span class="co"> * `ret_allocated` points to `dup` in `main`.</span></span>
<span id="cb96-75"><a href="#cb96-75" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb96-76"><a href="#cb96-76" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb96-77"><a href="#cb96-77" aria-hidden="true" tabindex="-1"></a><span class="co"> *    3. *ret_allocated = newarr</span></span>
<span id="cb96-78"><a href="#cb96-78" aria-hidden="true" tabindex="-1"></a><span class="co"> *                          ^</span></span>
<span id="cb96-79"><a href="#cb96-79" aria-hidden="true" tabindex="-1"></a><span class="co"> *                          |</span></span>
<span id="cb96-80"><a href="#cb96-80" aria-hidden="true" tabindex="-1"></a><span class="co"> *            ,-------------&#39;</span></span>
<span id="cb96-81"><a href="#cb96-81" aria-hidden="true" tabindex="-1"></a><span class="co"> *           |</span></span>
<span id="cb96-82"><a href="#cb96-82" aria-hidden="true" tabindex="-1"></a><span class="co"> * |         |     |</span></span>
<span id="cb96-83"><a href="#cb96-83" aria-hidden="true" tabindex="-1"></a><span class="co"> * +-main----|-----+</span></span>
<span id="cb96-84"><a href="#cb96-84" aria-hidden="true" tabindex="-1"></a><span class="co"> * | arr     |     |</span></span>
<span id="cb96-85"><a href="#cb96-85" aria-hidden="true" tabindex="-1"></a><span class="co"> * | dup ---&#39;  &lt;------+</span></span>
<span id="cb96-86"><a href="#cb96-86" aria-hidden="true" tabindex="-1"></a><span class="co"> * | ...           |  | -- 2. *ret_allocated</span></span>
<span id="cb96-87"><a href="#cb96-87" aria-hidden="true" tabindex="-1"></a><span class="co"> * +-arrdup--------+  |</span></span>
<span id="cb96-88"><a href="#cb96-88" aria-hidden="true" tabindex="-1"></a><span class="co"> * | ret_allocated ---+</span></span>
<span id="cb96-89"><a href="#cb96-89" aria-hidden="true" tabindex="-1"></a><span class="co"> * | args          |</span></span>
<span id="cb96-90"><a href="#cb96-90" aria-hidden="true" tabindex="-1"></a><span class="co"> * | newarr --------------&gt; 1. calloc(...)</span></span>
<span id="cb96-91"><a href="#cb96-91" aria-hidden="true" tabindex="-1"></a><span class="co"> * +---------------+</span></span>
<span id="cb96-92"><a href="#cb96-92" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb96-93"><a href="#cb96-93" aria-hidden="true" tabindex="-1"></a><span class="co"> * 1. `arrdup` calls `calloc` to allocate on the heap</span></span>
<span id="cb96-94"><a href="#cb96-94" aria-hidden="true" tabindex="-1"></a><span class="co"> * 2. Dereferencing `ret_allocated` gives us access to `dup`</span></span>
<span id="cb96-95"><a href="#cb96-95" aria-hidden="true" tabindex="-1"></a><span class="co"> * 3. thus we can set dup equal to the new heap memory</span></span>
<span id="cb96-96"><a href="#cb96-96" aria-hidden="true" tabindex="-1"></a><span class="co"> *</span></span>
<span id="cb96-97"><a href="#cb96-97" aria-hidden="true" tabindex="-1"></a><span class="co"> * This effectively enables us to return the new memory into the</span></span>
<span id="cb96-98"><a href="#cb96-98" aria-hidden="true" tabindex="-1"></a><span class="co"> * `dup` variable in main.</span></span>
<span id="cb96-99"><a href="#cb96-99" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb96-100"><a href="#cb96-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-101"><a href="#cb96-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-102"><a href="#cb96-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-103"><a href="#cb96-103" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb96-104"><a href="#cb96-104" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb96-105"><a href="#cb96-105" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb96-106"><a href="#cb96-106" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> arr<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">};</span></span>
<span id="cb96-107"><a href="#cb96-107" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>dup<span class="op">;</span></span>
<span id="cb96-108"><a href="#cb96-108" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> retval<span class="op">;</span></span>
<span id="cb96-109"><a href="#cb96-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-110"><a href="#cb96-110" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>get<span class="op">(</span>arr<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="op">&amp;</span>retval<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> retval <span class="op">==</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb96-111"><a href="#cb96-111" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>set<span class="op">(</span>arr<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">4</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb96-112"><a href="#cb96-112" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>get<span class="op">(</span>arr<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="op">&amp;</span>retval<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> retval <span class="op">==</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb96-113"><a href="#cb96-113" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>arrdup<span class="op">(&amp;</span>dup<span class="op">,</span> arr<span class="op">,</span> <span class="dv">4</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb96-114"><a href="#cb96-114" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>get<span class="op">(</span>dup<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="op">&amp;</span>retval<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> retval <span class="op">==</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb96-115"><a href="#cb96-115" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>dup<span class="op">);</span></span>
<span id="cb96-116"><a href="#cb96-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-117"><a href="#cb96-117" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;no errors!&quot;</span><span class="op">);</span></span>
<span id="cb96-118"><a href="#cb96-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-119"><a href="#cb96-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb96-120"><a href="#cb96-120" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>extracted 1, remaining string: &quot; 42 the secret to everything&quot;
extracted 42, remaining string: &quot; the secret to everything&quot;
42 and &quot;secret&quot;
Using strtok to parse through a string finding substrings separated by &#39;h&#39; or &#39;t&#39;:
[1 42 ]
[e secre]
[ ]
[o every]
[ing]</code></pre>
            <!-- COMBINED ERROR NOTES WITH NEW MATERIAL IN ANOTHER FILE BY SIBIN in OCT 2023!

            ### Errors

            The first question is how we can detect that some error occurred within a function we have called?
            We'll separate functions into two different classes:

            1. *Functions that return pointers.*
                Functions that return pointers (e.g. that have declarations of the form `type *fn(...)`) are often relatively straightforward.
                If they return `NULL`, then an error occurred; otherwise the returned pointer can be used.
                `malloc` is an example here.
            2. *Functions that return integers.*
                Integers are used as a relatively flexible indication of the output of a function.
                Is it common for a `-1` to indicate an error.
                Sometimes *any* negative value indicates an error, each negative value designating that a different error occurred.
                Non-negative values indicate success.
                If a function wishes to return a binary success or failure, you'll see that many APIs (counter-intuitively) return `0` for success, and `-1` for failure.

            It is common that you want more information than the return value can give you.
            You want more information about *why* the failure happened so that you can debug more easily.
            The `errno` variable is UNIX's solution to this (see its `man` page), and can be referenced if you include `errno.h`.
            `errno` is simply an integer where specific values represent specific errors.
            You can view these values by looking them up in the source^[For example, in `/usr/include/asm/errno.h`.] or, you can ask the `errno` *program*^[You might need to do `apt-get install moreutils` if you're using your own system.].
            For example:

            ```
            $ errno -l
            EPERM 1 Operation not permitted
            ENOENT 2 No such file or directory
            ESRCH 3 No such process
            EINTR 4 Interrupted system call
            EIO 5 Input/output error
            ...
            ```

            You can look up specific values:

            ```
            $ errno 28
            ENOSPC 28 No space left on device
            ```

            You can imagine how that error might occur.
            What if you're trying to add files on disk, and the disk runs out of room!?

            If you want your program to print a useful error when you encounter such a problem, you can use the `perror` function (see its `man` page for documentation) to print out an error, or `strerror` (via `string.h`) if you just want a string corresponding to the error.

            ```c
            #include <stdlib.h>
            #include <limits.h>
            #include <stdio.h>
            #include <errno.h>
            #include <string.h>

            int
            main(void)
            {
                char *ret;

                printf("Lets get greedy: allocate %ld bytes!\n", LONG_MAX);
                ret = malloc(LONG_MAX);
                if (ret == NULL) {
                    printf("Error: errno value %d and description: %s\n", errno, strerror(errno));
                    fflush(stdout);
                    perror("Error allocating memory");

                    return -1;
                }

                return 0;
            }
            ```

            Program output:
            ```
            extracted 1, remaining string: " 42 the secret to everything"
            extracted 42, remaining string: " the secret to everything"
            42 and "secret"
            Using strtok to parse through a string finding substrings separated by 'h' or 't':
            [1 42 ]
            [e secre]
            [ ]
            [o every]
            [ing]
            ```

            (Note: when you return from a program with a non-zero value, it designates that your *program* had an error.
            This is why we see the `make` error when it runs your program.)

            To understand the return value of UNIX library functions:

            - look at the function return values to understand the type (and identify if it is returning an `int` or a pointer)
            ```
            SYNOPSIS
                   #include <stdlib.h>

                   void *malloc(size_t size);
                   ...
            ```
            - Read through the description of the function(s).
            - Read through the `RETURN VALUE` and `ERRORS` sections of the man page.
            ```
            RETURN VALUE
                   The malloc() and calloc() functions return a pointer to the allocated memory, which is  suitably  aligned  for
                   any  built-in type.  On error, these functions return NULL.  NULL may also be returned by a successful call to
                   malloc() with a size of zero, or by a successful call to calloc() with nmemb or size equal to zero.
            ...
            ERRORS
                   calloc(), malloc(), realloc(), and reallocarray() can fail with the following error:

                   ENOMEM Out  of  memory.
                   ...

            ```

            This explains why we got the error we did.
            -->
            <h3 data-number="4.3.2" id="memory-ownership"><span
            class="header-section-number">4.3.2</span> Memory
            Ownership</h3>
            <p>One of the last, but most challenging aspects of APIs in
            C is that of memory ownership. The big question is: when a
            pointer passed into a function, or returned from a function,
            who is responsible for <code>free</code>ing the memory? This
            is due to a combination of factors, mainly:</p>
            <ol type="1">
            <li>C requires that memory is explicitly <code>free</code>d,
            so someone has to do it, and it should be <code>free</code>d
            <em>only once</em>, and</li>
            <li>pointers are passed around freely and frequently in C,
            so somehow the function caller and callee have to understand
            who “owns” each of those pointers.</li>
            </ol>
            <p>It is easiest to understand this issue through the
            concept of <em>ownership</em>: simply put, the owner of a
            piece of memory is the one that should either free it, or
            pass it to another part of the code that becomes the owner.
            In contrast, a caller can pass a pointer to memory into a
            function allowing it to <em>borrow</em> that memory, but the
            function does <em>not</em> free it, and after it returns it
            should not further access the memory. There are three
            general patterns:</p>
            <ul>
            <li><p>A caller <em>passes a pointer</em> into a function,
            and <em>passes the ownership</em> of that data to the
            function. This is common for data-structures whose job is to
            take a pointer of data to store, and at that point, they own
            the memory. Think: if we <code>enqueue</code> data into a
            queue.</p>
            <p><strong>Examples</strong>: The key-value store’s
            <code>put</code> function owns the passed in data (assuming
            it takes a <code>void *</code>.</p></li>
            <li><p>A function <em>returns a pointer</em> to the function
            caller and <em>passes the ownership</em> to the caller. The
            caller must later <code>free</code> the data. This is also
            common in data-structures when we wish to retrieve the data.
            Think: if we <code>dequeue</code> data from a queue.</p>
            <p><strong>Examples</strong>: <code>strdup</code> creates a
            new string, expecting the caller to free it.</p></li>
            <li><p>A caller <em>passes a pointer</em> into a function,
            but only allows the function to <em>borrow</em> the data.
            Thus the caller still owns the memory (thus is still
            responsible to <code>free</code> the data) after the
            function returns, and the function should <em>not</em>
            maintain any references to the data. Think: most of the
            string functions that take a string as an argument, perform
            some operation on it, and return expecting the caller to
            still <code>free</code> the string.</p>
            <p><strong>Examples</strong>: Most other functions we’ve
            seen borrow pointers, perform operations, and then don’t
            maintain references to them.</p></li>
            <li><p>A function <em>returns a pointer</em> to the function
            caller that enables the caller to <em>borrow</em> the data.
            This requires a difficult constraint: the caller can access
            the data, but must not maintain a pointer to it after the
            function or API (that still owns the data)
            <code>free</code>s it.</p>
            <p><strong>Examples</strong>: The key-value store’s
            <code>get</code> function transfers ownership to the
            caller.</p></li>
            </ul>
            <p>The memory ownership constraints are an agreement between
            the calling function, and a function being called.</p>
            <h2 data-number="4.4" id="exercises-1"><span
            class="header-section-number">4.4</span> Exercises</h2>
            <h3 data-number="4.4.1" id="stack-allocation-1"><span
            class="header-section-number">4.4.1</span> Stack
            Allocation</h3>
            <p>An old interview question:</p>
            <blockquote>
            <p>How can you write a function that determines if the
            execution stack grows upwards (from lower addresses to
            higher), or downwards?</p>
            </blockquote>
            <p>Write this function!</p>
            <h3 data-number="4.4.2"
            id="understanding-memory-ownership"><span
            class="header-section-number">4.4.2</span> Understanding
            Memory Ownership</h3>
            <p>Lets look at a simple key-value store that needs to learn
            to be more careful about memory. Above each function, we
            specify the ownership of pointers being passed – either
            passing ownership, or borrowing the memory. The current
            implementations do <em>not</em> adhere to these
            specifications.</p>
            <div class="sourceCode" id="cb98"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co"> * Lets just use a single key/value as a proxy for an entire kv/store.</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co"> * You can assume that the stored values are strings, so `strdup` can</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * allocate the memory for and copy the values. You absolutely will</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * have to use `strdup` in some of the functions.</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span>   kv_key<span class="op">;</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">char</span> <span class="op">*</span>kv_value<span class="op">;</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co"> * The returned value should not be maintained in the data-structure</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co"> * and should be `free`d by the caller.</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>get_pass_ownership<span class="op">(</span><span class="dt">int</span> key<span class="op">)</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>key <span class="op">!=</span> kv_key<span class="op">)</span> <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> kv_value<span class="op">;</span></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a><span class="co"> * Pointers to the returned value are maintained in this data-structure</span></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a><span class="co"> * and it will be `free`d by the data-structure, not by the caller</span></span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>get_borrow<span class="op">(</span><span class="dt">int</span> key<span class="op">)</span></span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>key <span class="op">!=</span> kv_key<span class="op">)</span> <span class="cf">return</span> NULL<span class="op">;</span></span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> kv_value<span class="op">;</span></span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a><span class="co"> * Pointers to the `value` passed as the second argument are maintained by</span></span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a><span class="co"> * the caller, thus the `value` is borrowed here. The `value` will be `free`d</span></span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a><span class="co"> * by the caller.</span></span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a>set_borrow<span class="op">(</span><span class="dt">int</span> key<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>value<span class="op">)</span></span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* What do we do with `kv_value`? Do we `strdup` anything? */</span></span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a>    kv_key   <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>    kv_value <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a><span class="co"> * Pointers to the `value` passed as the second argument are not maintained by</span></span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a><span class="co"> * the caller, thus the `value` should be `free`d by this data-structure.</span></span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a>set_pass_ownership<span class="op">(</span><span class="dt">int</span> key<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>value<span class="op">)</span></span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* What do we do with `kv_value`? Do we `strdup` anything? */</span></span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a>    kv_key   <span class="op">=</span> key<span class="op">;</span></span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a>    kv_value <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* The values we pass in. */</span></span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>v_p2p <span class="op">=</span> strdup<span class="op">(</span><span class="st">&quot;value1&quot;</span><span class="op">);</span> <span class="co">/* calls `malloc` ! */</span></span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>v_p2b <span class="op">=</span> strdup<span class="op">(</span><span class="st">&quot;value2&quot;</span><span class="op">);</span></span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>v_b2p <span class="op">=</span> strdup<span class="op">(</span><span class="st">&quot;value3&quot;</span><span class="op">);</span></span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>v_b2b <span class="op">=</span> strdup<span class="op">(</span><span class="st">&quot;value4&quot;</span><span class="op">);</span></span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* The return values */</span></span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>r_p2p<span class="op">,</span> <span class="op">*</span>r_p2b<span class="op">,</span> <span class="op">*</span>r_b2p<span class="op">,</span> <span class="op">*</span>r_b2b<span class="op">;</span></span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* p2p: passing ownership on set, passing ownership on get */</span></span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a>    set_pass_ownership<span class="op">(</span><span class="dv">0</span><span class="op">,</span> v_p2p<span class="op">);</span></span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a>    r_p2p <span class="op">=</span> get_pass_ownership<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* The question: should we `free(v_p2p)`?, `free(r_p2p)`? */</span></span>
<span id="cb98-82"><a href="#cb98-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-83"><a href="#cb98-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* p2b: passing ownership on set, borrowing memory for get */</span></span>
<span id="cb98-84"><a href="#cb98-84" aria-hidden="true" tabindex="-1"></a>    set_pass_ownership<span class="op">(</span><span class="dv">0</span><span class="op">,</span> v_p2b<span class="op">);</span></span>
<span id="cb98-85"><a href="#cb98-85" aria-hidden="true" tabindex="-1"></a>    r_p2b <span class="op">=</span> get_borrow<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb98-86"><a href="#cb98-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* The question: should we `free(v_p2b)`?, `free(r_p2b)`? */</span></span>
<span id="cb98-87"><a href="#cb98-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-88"><a href="#cb98-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* b2p: borrowing ownership on set, passing ownership on get */</span></span>
<span id="cb98-89"><a href="#cb98-89" aria-hidden="true" tabindex="-1"></a>    set_borrow<span class="op">(</span><span class="dv">0</span><span class="op">,</span> v_b2p<span class="op">);</span></span>
<span id="cb98-90"><a href="#cb98-90" aria-hidden="true" tabindex="-1"></a>    r_b2p <span class="op">=</span> get_pass_ownership<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb98-91"><a href="#cb98-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* The question: should we `free(v_b2p)`?, `free(r_b2p)`? */</span></span>
<span id="cb98-92"><a href="#cb98-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-93"><a href="#cb98-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* b2b: borrowing ownership on set, borrowing on get */</span></span>
<span id="cb98-94"><a href="#cb98-94" aria-hidden="true" tabindex="-1"></a>    set_borrow<span class="op">(</span><span class="dv">0</span><span class="op">,</span> v_b2b<span class="op">);</span></span>
<span id="cb98-95"><a href="#cb98-95" aria-hidden="true" tabindex="-1"></a>    r_b2b <span class="op">=</span> get_borrow<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb98-96"><a href="#cb98-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* The question: should we `free(v_b2b)`?, `free(r_b2b)`? */</span></span>
<span id="cb98-97"><a href="#cb98-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-98"><a href="#cb98-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>kv_value<span class="op">)</span> free<span class="op">(</span>kv_value<span class="op">);</span></span>
<span id="cb98-99"><a href="#cb98-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-100"><a href="#cb98-100" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Looks like success!...but wait till we valgrind; then ;-(</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb98-101"><a href="#cb98-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-102"><a href="#cb98-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb98-103"><a href="#cb98-103" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>extracted 1, remaining string: &quot; 42 the secret to everything&quot;
extracted 42, remaining string: &quot; the secret to everything&quot;
42 and &quot;secret&quot;
Using strtok to parse through a string finding substrings separated by &#39;h&#39; or &#39;t&#39;:
[1 42 ]
[e secre]
[ ]
[o every]
[ing]</code></pre>
            <p>The above code is hopelessly broken. Run it in valgrind
            to see.</p>
            <p><strong>Tasks:</strong></p>
            <ul>
            <li>In the above code, implement the
            <code>malloc</code>/<code>free</code>/<code>strdup</code>
            operations that are necessary both in the key-value
            implementation, and in the client (<code>main</code>) to
            make both the caller and callee abide by the memory
            ownership constraints.</li>
            <li>In which cases can <em>stack allocation</em> of the
            values be used in <code>main</code>? Why?</li>
            <li>In which cases can <em>stack allocation</em> of the
            values in the key-value store (i.e. in
            <code>get</code>/<code>set</code>) be used? Why?</li>
            </ul>
            <h2 data-number="4.5" id="errors"><span
            class="header-section-number">4.5</span> Errors</h2>
            <p><a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/errors.html#/">Slides</a></p>
            <p>Sometimes, errors happen…</p>
            <ul>
            <li><em>e.g.,</em> system is out of memory</li>
            <li>when we call <sc>malloc</sc></li>
            </ul>
            <p>The first question is how we can detect that some error
            occurred within a function we have called?</p>
            <p><strong>When errors occur</strong></p>
            <ul>
            <li>we want more <strong>context</strong>
            <ul>
            <li>what was the <em>exact</em> error?</li>
            <li><em>where</em> did the error occur?</li>
            </ul></li>
            <li>programmers can make <em>informed</em> choices
            <ul>
            <li>on how to respond</li>
            </ul></li>
            </ul>
            <h3 data-number="4.5.1"
            id="return-vals-indicate-errors"><span
            class="header-section-number">4.5.1</span>
            <strong>return</strong> vals → indicate errors</h3>
            <table>
            <thead>
            <tr class="header">
            <th>functions return</th>
            <th>error indicator</th>
            <th>example</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td>integers</td>
            <td>negative values</td>
            <td><sc>printf()*</sc></td>
            </tr>
            <tr class="even">
            <td>pointers</td>
            <td><sc>NULL</sc></td>
            <td><sc>malloc()</sc></td>
            </tr>
            <tr class="odd">
            <td>structs</td>
            <td>fields in struct</td>
            <td>user defined</td>
            </tr>
            <tr class="even">
            <td></td>
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>[*check out the return value of
            <code>printf()</code>]</p>
            <p>As seen above, we separate functions into two different
            classes:</p>
            <ol type="1">
            <li><em>Functions that return pointers.</em> Functions that
            return pointers (e.g. that have declarations of the form
            <code>type *fn(...)</code>) are often relatively
            straightforward. If they return <code>NULL</code>, then an
            error occurred; otherwise the returned pointer can be used.
            <code>malloc</code> is an example here.</li>
            <li><em>Functions that return integers.</em> Integers are
            used as a relatively flexible indication of the output of a
            function. Is it common for a <code>-1</code> to indicate an
            error. Sometimes <em>any</em> negative value indicates an
            error, each negative value designating that a different
            error occurred. Non-negative values indicate success. If a
            function wishes to return a binary success or failure,
            you’ll see that many APIs (counter-intuitively) return
            <code>0</code> for success, and <code>-1</code> for
            failure.</li>
            </ol>
            <p>It is common that you want more information than a
            <em>single</em> return value can give you. So, we can define
            our own struct,</p>
            <div class="sourceCode" id="cb100"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ret_type<span class="op">{</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a<span class="op">;</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> carray <span class="op">;</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> error_number <span class="op">;</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> error_name<span class="op">[</span><span class="dv">255</span><span class="op">]</span> <span class="op">;</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="op">;</span></span></code></pre></div>
            <h3 data-number="4.5.2"
            id="errno-variable-and-command"><span
            class="header-section-number">4.5.2</span>
            <code>errno</code> variable and command</h3>
            <p>UNIX/C have some mechanisms that actually help (instead
            of defining our own structs). They define a
            <strong>variable</strong>, <code>errno</code>, defined in
            <code>&lt;error.h&gt;</code>.</p>
            <p><code>errno</code> is simply an integer where specific
            values represent specific errors. You can view these values
            by looking them up in the source<a href="#fn5"
            class="footnote-ref" id="fnref5"
            role="doc-noteref"><sup>5</sup></a>.</p>
            <p>Or, you can ask the <code>errno</code> <em>program</em>^
            (yes, the same name, confusing!), the command line utility
            (you might need to do <code>apt-get install moreutils</code>
            to get the <code>errno</code> program to work if you’re
            using your own system) used as follows:</p>
            <div class="sourceCode" id="cb101"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>$ errno <span class="dv">12</span> </span></code></pre></div>
            <p>Output:</p>
            <div class="sourceCode" id="cb102"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>ENOMEM <span class="dv">12</span> Cannot allocate memory</span></code></pre></div>
            <p>You can imagine why this error might occur – your system
            ran out of memory or you asked for too much!</p>
            <p>If we want to see a <strong>full</strong> list of all
            possible <code>errno</code> values and their meanings, we
            do:</p>
            <div class="sourceCode" id="cb103"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>$ errno <span class="op">-</span>l</span></code></pre></div>
            <p>Output (prints <strong>all</strong> of the error numbers
            and codes):</p>
            <div class="sourceCode" id="cb104"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>EPERM <span class="dv">1</span> Operation not permitted</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>ENOENT <span class="dv">2</span> No such file or directory</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>ESRCH <span class="dv">3</span> No such process</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>EINTR <span class="dv">4</span> Interrupted system call</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>EIO <span class="dv">5</span> Input<span class="op">/</span>output error</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>ENXIO <span class="dv">6</span> No such device or address</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>E2BIG <span class="dv">7</span> Argument list too <span class="dt">long</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>ENOEXEC <span class="dv">8</span> Exec format error</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>EBADF <span class="dv">9</span> Bad file descriptor</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>ECHILD <span class="dv">10</span> No child processes</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>EAGAIN <span class="dv">11</span> Resource temporarily unavailable</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>ENOMEM <span class="dv">12</span> Cannot allocate memory</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>EACCES <span class="dv">13</span> Permission denied</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>EFAULT <span class="dv">14</span> Bad address</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>ENOTBLK <span class="dv">15</span> Block device required</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>EBUSY <span class="dv">16</span> Device or resource busy</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>EEXIST <span class="dv">17</span> File exists</span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>EXDEV <span class="dv">18</span> Invalid cross<span class="op">-</span>device link</span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>ENODEV <span class="dv">19</span> No such device</span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>ENOTDIR <span class="dv">20</span> Not a directory</span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>EISDIR <span class="dv">21</span> Is a directory</span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>EINVAL <span class="dv">22</span> Invalid argument</span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>ENFILE <span class="dv">23</span> Too many open files in system</span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>EMFILE <span class="dv">24</span> Too many open files</span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>ENOTTY <span class="dv">25</span> Inappropriate ioctl <span class="cf">for</span> device</span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>ETXTBSY <span class="dv">26</span> Text file busy</span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a>EFBIG <span class="dv">27</span> File too large</span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>ENOSPC <span class="dv">28</span> No space left on device</span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>ESPIPE <span class="dv">29</span> Illegal seek</span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a>EROFS <span class="dv">30</span> Read<span class="op">-</span>only file system</span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>EMLINK <span class="dv">31</span> Too many links</span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a>EPIPE <span class="dv">32</span> Broken pipe</span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a>EDOM <span class="dv">33</span> Numerical argument out of domain</span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a>ERANGE <span class="dv">34</span> Numerical result out of range</span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a>EDEADLK <span class="dv">35</span> Resource deadlock avoided</span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a>ENAMETOOLONG <span class="dv">36</span> File name too <span class="dt">long</span></span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a>ENOLCK <span class="dv">37</span> No locks available</span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a>ENOSYS <span class="dv">38</span> Function not implemented</span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>ENOTEMPTY <span class="dv">39</span> Directory not empty</span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>ELOOP <span class="dv">40</span> Too many levels of symbolic links</span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>EWOULDBLOCK <span class="dv">11</span> Resource temporarily unavailable</span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>ENOMSG <span class="dv">42</span> No message of desired type</span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a>EIDRM <span class="dv">43</span> Identifier removed</span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>ECHRNG <span class="dv">44</span> Channel number out of range</span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a>EL2NSYNC <span class="dv">45</span> Level <span class="dv">2</span> not synchronized</span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a>EL3HLT <span class="dv">46</span> Level <span class="dv">3</span> halted</span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a>EL3RST <span class="dv">47</span> Level <span class="dv">3</span> reset</span>
<span id="cb104-48"><a href="#cb104-48" aria-hidden="true" tabindex="-1"></a>ELNRNG <span class="dv">48</span> Link number out of range</span>
<span id="cb104-49"><a href="#cb104-49" aria-hidden="true" tabindex="-1"></a>EUNATCH <span class="dv">49</span> Protocol driver not attached</span>
<span id="cb104-50"><a href="#cb104-50" aria-hidden="true" tabindex="-1"></a>ENOCSI <span class="dv">50</span> No CSI structure available</span>
<span id="cb104-51"><a href="#cb104-51" aria-hidden="true" tabindex="-1"></a>EL2HLT <span class="dv">51</span> Level <span class="dv">2</span> halted</span>
<span id="cb104-52"><a href="#cb104-52" aria-hidden="true" tabindex="-1"></a>EBADE <span class="dv">52</span> Invalid exchange</span>
<span id="cb104-53"><a href="#cb104-53" aria-hidden="true" tabindex="-1"></a>EBADR <span class="dv">53</span> Invalid request descriptor</span>
<span id="cb104-54"><a href="#cb104-54" aria-hidden="true" tabindex="-1"></a>EXFULL <span class="dv">54</span> Exchange full</span>
<span id="cb104-55"><a href="#cb104-55" aria-hidden="true" tabindex="-1"></a>ENOANO <span class="dv">55</span> No anode</span>
<span id="cb104-56"><a href="#cb104-56" aria-hidden="true" tabindex="-1"></a>EBADRQC <span class="dv">56</span> Invalid request code</span>
<span id="cb104-57"><a href="#cb104-57" aria-hidden="true" tabindex="-1"></a>EBADSLT <span class="dv">57</span> Invalid slot</span>
<span id="cb104-58"><a href="#cb104-58" aria-hidden="true" tabindex="-1"></a>EDEADLOCK <span class="dv">35</span> Resource deadlock avoided</span>
<span id="cb104-59"><a href="#cb104-59" aria-hidden="true" tabindex="-1"></a>EBFONT <span class="dv">59</span> Bad font file format</span>
<span id="cb104-60"><a href="#cb104-60" aria-hidden="true" tabindex="-1"></a>ENOSTR <span class="dv">60</span> Device not a stream</span>
<span id="cb104-61"><a href="#cb104-61" aria-hidden="true" tabindex="-1"></a>ENODATA <span class="dv">61</span> No data available</span>
<span id="cb104-62"><a href="#cb104-62" aria-hidden="true" tabindex="-1"></a>ETIME <span class="dv">62</span> Timer expired</span>
<span id="cb104-63"><a href="#cb104-63" aria-hidden="true" tabindex="-1"></a>ENOSR <span class="dv">63</span> Out of streams resources</span>
<span id="cb104-64"><a href="#cb104-64" aria-hidden="true" tabindex="-1"></a>ENONET <span class="dv">64</span> Machine is not on the network</span>
<span id="cb104-65"><a href="#cb104-65" aria-hidden="true" tabindex="-1"></a>ENOPKG <span class="dv">65</span> Package not installed</span>
<span id="cb104-66"><a href="#cb104-66" aria-hidden="true" tabindex="-1"></a>EREMOTE <span class="dv">66</span> Object is remote</span>
<span id="cb104-67"><a href="#cb104-67" aria-hidden="true" tabindex="-1"></a>ENOLINK <span class="dv">67</span> Link has been severed</span>
<span id="cb104-68"><a href="#cb104-68" aria-hidden="true" tabindex="-1"></a>EADV <span class="dv">68</span> Advertise error</span>
<span id="cb104-69"><a href="#cb104-69" aria-hidden="true" tabindex="-1"></a>ESRMNT <span class="dv">69</span> Srmount error</span>
<span id="cb104-70"><a href="#cb104-70" aria-hidden="true" tabindex="-1"></a>ECOMM <span class="dv">70</span> Communication error on send</span>
<span id="cb104-71"><a href="#cb104-71" aria-hidden="true" tabindex="-1"></a>EPROTO <span class="dv">71</span> Protocol error</span>
<span id="cb104-72"><a href="#cb104-72" aria-hidden="true" tabindex="-1"></a>EMULTIHOP <span class="dv">72</span> Multihop attempted</span>
<span id="cb104-73"><a href="#cb104-73" aria-hidden="true" tabindex="-1"></a>EDOTDOT <span class="dv">73</span> RFS specific error</span>
<span id="cb104-74"><a href="#cb104-74" aria-hidden="true" tabindex="-1"></a>EBADMSG <span class="dv">74</span> Bad message</span>
<span id="cb104-75"><a href="#cb104-75" aria-hidden="true" tabindex="-1"></a>EOVERFLOW <span class="dv">75</span> Value too large <span class="cf">for</span> defined data type</span>
<span id="cb104-76"><a href="#cb104-76" aria-hidden="true" tabindex="-1"></a>ENOTUNIQ <span class="dv">76</span> Name not unique on network</span>
<span id="cb104-77"><a href="#cb104-77" aria-hidden="true" tabindex="-1"></a>EBADFD <span class="dv">77</span> File descriptor in bad state</span>
<span id="cb104-78"><a href="#cb104-78" aria-hidden="true" tabindex="-1"></a>EREMCHG <span class="dv">78</span> Remote address changed</span>
<span id="cb104-79"><a href="#cb104-79" aria-hidden="true" tabindex="-1"></a>ELIBACC <span class="dv">79</span> Can not access a needed shared library</span>
<span id="cb104-80"><a href="#cb104-80" aria-hidden="true" tabindex="-1"></a>ELIBBAD <span class="dv">80</span> Accessing a corrupted shared library</span>
<span id="cb104-81"><a href="#cb104-81" aria-hidden="true" tabindex="-1"></a>ELIBSCN <span class="dv">81</span> <span class="op">.</span>lib section in a<span class="op">.</span>out corrupted</span>
<span id="cb104-82"><a href="#cb104-82" aria-hidden="true" tabindex="-1"></a>ELIBMAX <span class="dv">82</span> Attempting to link in too many shared libraries</span>
<span id="cb104-83"><a href="#cb104-83" aria-hidden="true" tabindex="-1"></a>ELIBEXEC <span class="dv">83</span> Cannot exec a shared library directly</span>
<span id="cb104-84"><a href="#cb104-84" aria-hidden="true" tabindex="-1"></a>EILSEQ <span class="dv">84</span> Invalid or incomplete multibyte or wide character</span>
<span id="cb104-85"><a href="#cb104-85" aria-hidden="true" tabindex="-1"></a>ERESTART <span class="dv">85</span> Interrupted system call should be restarted</span>
<span id="cb104-86"><a href="#cb104-86" aria-hidden="true" tabindex="-1"></a>ESTRPIPE <span class="dv">86</span> Streams pipe error</span>
<span id="cb104-87"><a href="#cb104-87" aria-hidden="true" tabindex="-1"></a>EUSERS <span class="dv">87</span> Too many users</span>
<span id="cb104-88"><a href="#cb104-88" aria-hidden="true" tabindex="-1"></a>ENOTSOCK <span class="dv">88</span> Socket operation on non<span class="op">-</span>socket</span>
<span id="cb104-89"><a href="#cb104-89" aria-hidden="true" tabindex="-1"></a>EDESTADDRREQ <span class="dv">89</span> Destination address required</span>
<span id="cb104-90"><a href="#cb104-90" aria-hidden="true" tabindex="-1"></a>EMSGSIZE <span class="dv">90</span> Message too <span class="dt">long</span></span>
<span id="cb104-91"><a href="#cb104-91" aria-hidden="true" tabindex="-1"></a>EPROTOTYPE <span class="dv">91</span> Protocol wrong type <span class="cf">for</span> socket</span>
<span id="cb104-92"><a href="#cb104-92" aria-hidden="true" tabindex="-1"></a>ENOPROTOOPT <span class="dv">92</span> Protocol not available</span>
<span id="cb104-93"><a href="#cb104-93" aria-hidden="true" tabindex="-1"></a>EPROTONOSUPPORT <span class="dv">93</span> Protocol not supported</span>
<span id="cb104-94"><a href="#cb104-94" aria-hidden="true" tabindex="-1"></a>ESOCKTNOSUPPORT <span class="dv">94</span> Socket type not supported</span>
<span id="cb104-95"><a href="#cb104-95" aria-hidden="true" tabindex="-1"></a>EOPNOTSUPP <span class="dv">95</span> Operation not supported</span>
<span id="cb104-96"><a href="#cb104-96" aria-hidden="true" tabindex="-1"></a>EPFNOSUPPORT <span class="dv">96</span> Protocol family not supported</span>
<span id="cb104-97"><a href="#cb104-97" aria-hidden="true" tabindex="-1"></a>EAFNOSUPPORT <span class="dv">97</span> Address family not supported by protocol</span>
<span id="cb104-98"><a href="#cb104-98" aria-hidden="true" tabindex="-1"></a>EADDRINUSE <span class="dv">98</span> Address already in use</span>
<span id="cb104-99"><a href="#cb104-99" aria-hidden="true" tabindex="-1"></a>EADDRNOTAVAIL <span class="dv">99</span> Cannot assign requested address</span>
<span id="cb104-100"><a href="#cb104-100" aria-hidden="true" tabindex="-1"></a>ENETDOWN <span class="dv">100</span> Network is down</span>
<span id="cb104-101"><a href="#cb104-101" aria-hidden="true" tabindex="-1"></a>ENETUNREACH <span class="dv">101</span> Network is unreachable</span>
<span id="cb104-102"><a href="#cb104-102" aria-hidden="true" tabindex="-1"></a>ENETRESET <span class="dv">102</span> Network dropped connection on reset</span>
<span id="cb104-103"><a href="#cb104-103" aria-hidden="true" tabindex="-1"></a>ECONNABORTED <span class="dv">103</span> Software caused connection abort</span>
<span id="cb104-104"><a href="#cb104-104" aria-hidden="true" tabindex="-1"></a>ECONNRESET <span class="dv">104</span> Connection reset by peer</span>
<span id="cb104-105"><a href="#cb104-105" aria-hidden="true" tabindex="-1"></a>ENOBUFS <span class="dv">105</span> No buffer space available</span>
<span id="cb104-106"><a href="#cb104-106" aria-hidden="true" tabindex="-1"></a>EISCONN <span class="dv">106</span> Transport endpoint is already connected</span>
<span id="cb104-107"><a href="#cb104-107" aria-hidden="true" tabindex="-1"></a>ENOTCONN <span class="dv">107</span> Transport endpoint is not connected</span>
<span id="cb104-108"><a href="#cb104-108" aria-hidden="true" tabindex="-1"></a>ESHUTDOWN <span class="dv">108</span> Cannot send after transport endpoint shutdown</span>
<span id="cb104-109"><a href="#cb104-109" aria-hidden="true" tabindex="-1"></a>ETOOMANYREFS <span class="dv">109</span> Too many references<span class="op">:</span> cannot splice</span>
<span id="cb104-110"><a href="#cb104-110" aria-hidden="true" tabindex="-1"></a>ETIMEDOUT <span class="dv">110</span> Connection timed out</span>
<span id="cb104-111"><a href="#cb104-111" aria-hidden="true" tabindex="-1"></a>ECONNREFUSED <span class="dv">111</span> Connection refused</span>
<span id="cb104-112"><a href="#cb104-112" aria-hidden="true" tabindex="-1"></a>EHOSTDOWN <span class="dv">112</span> Host is down</span>
<span id="cb104-113"><a href="#cb104-113" aria-hidden="true" tabindex="-1"></a>EHOSTUNREACH <span class="dv">113</span> No route to host</span>
<span id="cb104-114"><a href="#cb104-114" aria-hidden="true" tabindex="-1"></a>EALREADY <span class="dv">114</span> Operation already in progress</span>
<span id="cb104-115"><a href="#cb104-115" aria-hidden="true" tabindex="-1"></a>EINPROGRESS <span class="dv">115</span> Operation now in progress</span>
<span id="cb104-116"><a href="#cb104-116" aria-hidden="true" tabindex="-1"></a>ESTALE <span class="dv">116</span> Stale file handle</span>
<span id="cb104-117"><a href="#cb104-117" aria-hidden="true" tabindex="-1"></a>EUCLEAN <span class="dv">117</span> Structure needs cleaning</span>
<span id="cb104-118"><a href="#cb104-118" aria-hidden="true" tabindex="-1"></a>ENOTNAM <span class="dv">118</span> Not a XENIX named type file</span>
<span id="cb104-119"><a href="#cb104-119" aria-hidden="true" tabindex="-1"></a>ENAVAIL <span class="dv">119</span> No XENIX semaphores available</span>
<span id="cb104-120"><a href="#cb104-120" aria-hidden="true" tabindex="-1"></a>EISNAM <span class="dv">120</span> Is a named type file</span>
<span id="cb104-121"><a href="#cb104-121" aria-hidden="true" tabindex="-1"></a>EREMOTEIO <span class="dv">121</span> Remote I<span class="op">/</span>O error</span>
<span id="cb104-122"><a href="#cb104-122" aria-hidden="true" tabindex="-1"></a>EDQUOT <span class="dv">122</span> Disk quota exceeded</span>
<span id="cb104-123"><a href="#cb104-123" aria-hidden="true" tabindex="-1"></a>ENOMEDIUM <span class="dv">123</span> No medium found</span>
<span id="cb104-124"><a href="#cb104-124" aria-hidden="true" tabindex="-1"></a>EMEDIUMTYPE <span class="dv">124</span> Wrong medium type</span>
<span id="cb104-125"><a href="#cb104-125" aria-hidden="true" tabindex="-1"></a>ECANCELED <span class="dv">125</span> Operation canceled</span>
<span id="cb104-126"><a href="#cb104-126" aria-hidden="true" tabindex="-1"></a>ENOKEY <span class="dv">126</span> Required key not available</span>
<span id="cb104-127"><a href="#cb104-127" aria-hidden="true" tabindex="-1"></a>EKEYEXPIRED <span class="dv">127</span> Key has expired</span>
<span id="cb104-128"><a href="#cb104-128" aria-hidden="true" tabindex="-1"></a>EKEYREVOKED <span class="dv">128</span> Key has been revoked</span>
<span id="cb104-129"><a href="#cb104-129" aria-hidden="true" tabindex="-1"></a>EKEYREJECTED <span class="dv">129</span> Key was rejected by service</span>
<span id="cb104-130"><a href="#cb104-130" aria-hidden="true" tabindex="-1"></a>EOWNERDEAD <span class="dv">130</span> Owner died</span>
<span id="cb104-131"><a href="#cb104-131" aria-hidden="true" tabindex="-1"></a>ENOTRECOVERABLE <span class="dv">131</span> State not recoverable</span>
<span id="cb104-132"><a href="#cb104-132" aria-hidden="true" tabindex="-1"></a>ERFKILL <span class="dv">132</span> Operation not possible due to RF<span class="op">-</span>kill</span>
<span id="cb104-133"><a href="#cb104-133" aria-hidden="true" tabindex="-1"></a>EHWPOISON <span class="dv">133</span> Memory page has hardware error</span>
<span id="cb104-134"><a href="#cb104-134" aria-hidden="true" tabindex="-1"></a>ENOTSUP <span class="dv">95</span> Operation not supported</span></code></pre></div>
            <h3 data-number="4.5.3"
            id="additional-helper-functions"><span
            class="header-section-number">4.5.3</span> Additional Helper
            Functions</h3>
            <p>The C standard library includes two additional helper
            functions for dealing with errors:</p>
            <table>
            <colgroup>
            <col style="width: 30%" />
            <col style="width: 33%" />
            <col style="width: 36%" />
            </colgroup>
            <thead>
            <tr class="header">
            <th>function</th>
            <th>operation</th>
            <th>defined in</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>perror()</code></td>
            <td><strong>print</strong> an error to the console,
            corresponding to <sc>errno</sc></td>
            <td><code>error.h</code></td>
            </tr>
            <tr class="even">
            <td><code>strerror()</code></td>
            <td><strong>return</strong> a <strong>string</strong>
            corresponding to <sc>errno</sc></td>
            <td><code>string.h</code></td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>Check out their <code>man</code> pages for more
            information.</p>
            <p>Consider the following example for understanding the use
            of <code>perror()</code> and <code>strerror()</code>:</p>
            <div class="sourceCode" id="cb105"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to error handling in C</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;error.h&gt;</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;limits.h&gt;</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// try to create an array of LONG_MAX size, </span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// i.e. 9223372036854775807 bytes!</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> massive_array <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">*)</span> malloc<span class="op">(</span>LONG_MAX<span class="op">)</span> <span class="op">;</span></span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if array was created</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> <span class="op">!</span>massive_array <span class="op">)</span></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Uh oh! Looks like Array creation failed. </span></span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// print the errno</span></span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span> <span class="st">&quot;errno = </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> errno <span class="op">)</span> <span class="op">;</span></span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Send custom error message and also print system message</span></span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;My Massive Array creation failed!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-30"><a href="#cb105-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-31"><a href="#cb105-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// can set errno explicitly</span></span>
<span id="cb105-32"><a href="#cb105-32" aria-hidden="true" tabindex="-1"></a>    errno <span class="op">=</span> <span class="dv">100</span> <span class="op">;</span></span>
<span id="cb105-33"><a href="#cb105-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> error_string <span class="op">=</span> strerror<span class="op">(</span>errno<span class="op">)</span> <span class="op">;</span></span>
<span id="cb105-34"><a href="#cb105-34" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">errno = </span><span class="sc">%d\t</span><span class="st"> (standard) String = </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> errno<span class="op">,</span> error_string <span class="op">)</span> <span class="op">;</span></span>
<span id="cb105-35"><a href="#cb105-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-36"><a href="#cb105-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// can give it any input, really</span></span>
<span id="cb105-37"><a href="#cb105-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> my_errno <span class="op">=</span> <span class="dv">9999</span> <span class="op">;</span></span>
<span id="cb105-38"><a href="#cb105-38" aria-hidden="true" tabindex="-1"></a>    error_string <span class="op">=</span> strerror<span class="op">(</span> my_errno <span class="op">)</span> <span class="op">;</span></span>
<span id="cb105-39"><a href="#cb105-39" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">my_errno = </span><span class="sc">%d\t</span><span class="st"> (custom) String = </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> my_errno<span class="op">,</span> error_string <span class="op">)</span> <span class="op">;</span></span>
<span id="cb105-40"><a href="#cb105-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-41"><a href="#cb105-41" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">)</span> <span class="op">;</span></span>
<span id="cb105-42"><a href="#cb105-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb105-43"><a href="#cb105-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>extracted 1, remaining string: &quot; 42 the secret to everything&quot;
extracted 42, remaining string: &quot; the secret to everything&quot;
42 and &quot;secret&quot;
Using strtok to parse through a string finding substrings separated by &#39;h&#39; or &#39;t&#39;:
[1 42 ]
[e secre]
[ ]
[o every]
[ing]</code></pre>
            <p><strong>Note:</strong> look up <a
            href="https://www.tutorialspoint.com/c_standard_library/limits_h.htm"><code>&lt;limits.h&gt;</code></a>
            that defines some useful constants such as
            <code>INT_MAX</code>, <code>INT_MIN</code>,
            <code>LONG_MAX</code>, <em>etc.</em></p>
            <p><strong>Note:</strong> when you return from a program
            with a non-zero value, it designates that your
            <em>program</em> had an error. This is why we see the
            <code>make</code> error when it runs your program.</p>
            <h3 data-number="4.5.4"
            id="understand-return-values-of-unix-library-functions"><span
            class="header-section-number">4.5.4</span> Understand Return
            Values of UNIX library functions:</h3>
            <p>Look at the function return values to understand the type
            (and identify if it is returning an <code>int</code> or a
            pointer).</p>
            <pre><code>SYNOPSIS
       #include &lt;stdlib.h&gt;

       void *malloc(size_t size);
       ...</code></pre>
            <ul>
            <li>Read through the description of the function(s).</li>
            <li>Read through the <code>RETURN VALUE</code> and
            <code>ERRORS</code> sections of the man page.</li>
            </ul>
            <pre><code>RETURN VALUE
       The malloc() and calloc() functions return a pointer to the allocated memory, which is  suitably  aligned  for
       any  built-in type.  On error, these functions return NULL.  NULL may also be returned by a successful call to
       malloc() with a size of zero, or by a successful call to calloc() with nmemb or size equal to zero.
...
ERRORS
       calloc(), malloc(), realloc(), and reallocarray() can fail with the following error:

       ENOMEM Out  of  memory.
       ...
</code></pre>
            <p>This explains why we got the error we did.</p>
            <h3 data-number="4.5.5"
            id="in-class-exercise-printing-all-error-codesstrings-in-sequence"><span
            class="header-section-number">4.5.5</span> In-class Exercise
            | Printing <strong>all</strong> error codes/strings in
            sequence</h3>
            <p>Write a <em>function</em> named,
            <code>print_error_codes()</code>, to print <em>all</em> the
            error codes and their corresponding strings <em>in
            sequence</em>, in the following format:</p>
            <pre><code>Error No     String
-------------------
1            Operation not permitted
2            No such file or directory
...</code></pre>
            <h1 data-number="5" id="processes"><span
            class="header-section-number">5</span> Processes</h1>
            <p>Programming is hard. Really hard. When you write a
            program, you have to consider complex logic and the design
            of esoteric data-structures, all while desperately trying to
            avoid errors. It is an exercise that challenges all of our
            logical, creative, and risk management facilities. As such,
            programming is the act of <em>methodically conquering
            complexity</em> with our <em>ability to abstract</em>. We
            walk on the knives-edge of our own abstractions where we can
            barely, just barely, make progress and engineer amazing
            systems.</p>
            <p>Imagine if when programming and debugging, we had to
            consider the actions and faults of <em>all other</em>
            programs running in the system? If your program crashed
            because one of your colleagues’ program had a bug, how could
            you make progress?</p>
            <p>Luckily, we stand on the abstractions of those that came
            before us. A key abstraction provided by systems is that of
            <em>isolation</em> - that one program cannot arbitrarily
            interfere with the execution of another. This isolation is a
            core provision of Operating Systems (OSes), and a core
            abstraction they provide is the <strong>process</strong>. At
            the highest-level, each process can only corrupt its own
            memory, and a process that goes into an infinite loop cannot
            prevent another process for executing.</p>
            <p>A process has a number of properties including:</p>
            <ul>
            <li>It contains the set of memory that is only accessible to
            that process. This memory includes the code, global data,
            stack, and dynamically allocated memory in the
            <em>heap</em>. Different processes have <em>disjoint</em>
            sets of memory, thus no matter how one process alters its
            own memory, it won’t interfere with the data-structures of
            another.</li>
            <li>A number of <em>descriptors</em> identified by integers
            that enable the process to access the “resources” of the
            surrounding system including the file system, networking,
            and communication with other processes. When we
            <code>printf</code>, we interact with the descriptor to
            output to the terminal. The OS prevents processes from
            accessing and changing resources they shouldn’t have access
            to.</li>
            <li>A set of unique identifiers including a process
            identifier (<code>pid</code>).</li>
            <li>The “current working directory” for the process,
            analogous to <code>pwd</code>.</li>
            <li>A owning user (e.g. <code>sibin</code>) for whom the
            process executes on the behalf of.</li>
            <li>Each process has a <em>parent</em> - the process that
            created it, and that has the ability and responsibility
            oversee it (like a normal, human parent).</li>
            <li>Arguments to the process often passed on the command
            line.</li>
            <li>Environment variables that give the process information
            about the system’s configuration.</li>
            </ul>
            <p>Throughout the class we’ll uncover more and more of these
            properties, but in this lecture, we’ll focus on the
            lifecycle of a process, and its relationship to its parent.
            Processes are the abstraction that provide isolation between
            users, and between computations, thus it is the core of the
            <em>security</em> of the system.</p>
            <h2 data-number="5.1"
            id="history-unix-posix-and-linux"><span
            class="header-section-number">5.1</span> History: UNIX,
            POSIX, and Linux</h2>
            <p>UNIX is an old system, having its origins in 1969 at Bell
            Labs when it was created by Ken Thompson and Dennis
            Ritchie<a href="#fn6" class="footnote-ref" id="fnref6"
            role="doc-noteref"><sup>6</sup></a>. Time has shown it is an
            “oldie but goodie” – as most popular OSes are derived from
            it (OSX, Linux, Android, …). In the OS class, you’ll dive
            into an implementation of UNIX very close to what it was in
            those early years! The <a href="figures/unix.pdf">original
            paper</a> is striking in how uninteresting it is to most
            modern readers. UNIX is so profound that it has defined what
            is “normal” in most OSes.</p>
            <blockquote>
            <p>UNIX Philosophy: A core philosophy of UNIX is that
            applications should not be written as huge monolithic
            collections of millions of lines of code, and should instead
            be <em>composed</em> of smaller programs, each focusing on
            “doing one thing well”. Programs focus on inputting text,
            and outputting text. <em>Pipelines</em> of processes take a
            stream of text, and process on it, process after process to
            get an output. The final program is a composition of these
            processes composed to together using pipelines.</p>
            </blockquote>
            <p>In the early years, many different UNIX variants were
            competing for market-share along-side the likes of DOS,
            Windows, OS2, etc… This led to differences between the UNIX
            variants which prevented programmers from effectively
            writing programs that would work across the variants. In
            response to this, in the late 1980s, POSIX standardized many
            aspects of UNIX including command-line programs and the
            standard library APIs. <code>man</code> pages are
            documentation for what is often part of the POSIX
            specification. I’ll use the term UNIX throughout the class,
            but often mean POSIX. You can think of Linux as an
            implementation of POSIX and as a variant of UNIX.</p>
            <p>UNIX has been taken into many different directions.
            Android and iOS layer a mobile runtime on top of UNIX; OSX
            and Ubuntu layer modern graphics and system management on
            top of UNIX, and even Windows Subsystem for Linux (WSL)
            enables you to run a POSIX environment inside of Windows. In
            many ways, UNIX has won. However, it has won be being
            adapted to different domains – you might be a little
            hard-pressed looking at the APIs for some of those systems
            to understand that it is UNIX under the hood. Regardless, in
            this class, we’ll be diving into UNIX and its APIs to better
            understand the core technology underlying most systems we
            use.</p>
            <p>The core UNIX philosophy endures, but has changed shape.
            In addition to the pervasive deployment of UNIX, Python is
            popular as it is has good support to compose together
            disparate services and libraries, and applications are
            frequently compositions of various REST/CRUD webservice
            APIs, and <code>json</code> is the unified language in which
            data is shared. # Processes</p>
            <p><a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/processes.html#/">Slides</a></p>
            <h3 data-number="5.1.1" id="tackling-complexity"><span
            class="header-section-number">5.1.1</span> tackling
            complexity</h3>
            <span class="fragment fade-in">
            <ul>
            <li>
            modern computers → 100s of programs
            </li>
            <li>
            programs can <b>interfere</b> with each other
            </li>
            <li>
            complex!
            </li>
            </ul>
            <p></span></p>
            <p>Consider the following UNIX/Linux command:</p>
            <pre><code>$ ps</code></pre>
            <p>The output looks like:</p>
            <pre><code>    PID TTY          TIME CMD
2384593 pts/15   00:00:00 bash
2384610 pts/15   00:00:00 ps</code></pre>
            <p>This shows that two processes are running, <em>for the
            current user</em>: - <code>bash</code>: the shell/terminal
            that is running (where you are typing yoru commands) -
            <code>ps</code>: the command we just ran to see the lis of
            processes</p>
            <p>We can expand this by providing some
            <strong>flags</strong> to <code>ps</code>,
            <em>e.g.,</em></p>
            <pre><code>$ ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.0 170060 14172 ?        Ss   Oct17   2:48 /sbin/init
root           2  0.0  0.0      0     0 ?        S    Oct17   0:00 [kthreadd]
root           3  0.0  0.0      0     0 ?        I&lt;   Oct17   0:00 [rcu_gp]
root           4  0.0  0.0      0     0 ?        I&lt;   Oct17   0:00 [rcu_par_gp]
root           6  0.0  0.0      0     0 ?        I&lt;   Oct17   0:00 [kworker/0:0H-kblockd]
root           9  0.0  0.0      0     0 ?        I&lt;   Oct17   0:00 [mm_percpu_wq]
root          10  0.0  0.0      0     0 ?        S    Oct17   0:05 [ksoftirqd/0]
root          11  0.1  0.0      0     0 ?        I    Oct17  13:03 [rcu_sched]
root          12  0.0  0.0      0     0 ?        S    Oct17   0:01 [migration/0]
root          13  0.0  0.0      0     0 ?        S    Oct17   0:00 [idle_inject/0]
root          15  0.0  0.0      0     0 ?        S    Oct17   0:00 [cpuhp/0]
root          16  0.0  0.0      0     0 ?        S    Oct17   0:00 [cpuhp/1]
root          17  0.0  0.0      0     0 ?        S    Oct17   0:00 [idle_inject/1]
root          18  0.0  0.0      0     0 ?        S    Oct17   0:03 [migration/1]
root          19  0.0  0.0      0     0 ?        S    Oct17   0:01 [ksoftirqd/1]
root          21  0.0  0.0      0     0 ?        I&lt;   Oct17   0:00 [kworker/1:0H-kblockd]
root          23  0.0  0.0      0     0 ?        S    Oct17   0:00 [cpuhp/2]
root          24  0.0  0.0      0     0 ?        S    Oct17   0:00 [idle_inject/2]
root          25  0.0  0.0      0     0 ?        S    Oct17   0:04 [migration/2]
root          26  0.0  0.0      0     0 ?        S    Oct17   0:01 [ksoftirqd/2]
root          28  0.0  0.0      0     0 ?        I&lt;   Oct17   0:00 [kworker/2:0H-kblockd]
root          29  0.0  0.0      0     0 ?        S    Oct17   0:00 [cpuhp/3]
root          30  0.0  0.0      0     0 ?        S    Oct17   0:00 [idle_inject/3]
root          31  0.0  0.0      0     0 ?        S    Oct17   0:04 [migration/3]
root          32  0.0  0.0      0     0 ?        S    Oct17   0:01 [ksoftirqd/3]
root          34  0.0  0.0      0     0 ?        I&lt;   Oct17   0:00 [kworker/3:0H]
root          35  0.0  0.0      0     0 ?        S    Oct17   0:00 [cpuhp/4]
root          36  0.0  0.0      0     0 ?        S    Oct17   0:00 [idle_inject/4]
root          37  0.0  0.0      0     0 ?        S    Oct17   0:04 [migration/4]
root          38  0.0  0.0      0     0 ?        S    Oct17   0:01 [ksoftirqd/4]
root          40  0.0  0.0      0     0 ?        I&lt;   Oct17   0:00 [kworker/4:0H-kblockd]
root          41  0.0  0.0      0     0 ?        S    Oct17   0:00 [cpuhp/5]
...</code></pre>
            <p><strong>Note:</strong> we see the list of processes for
            <strong>all</strong> users. The above is not a complete
            list, as it would have been really long.</p>
            <p>We can <em>filter</em> out results too…</p>
            <pre><code>[sibin@ubuntu-vlab01 ~] ps aux | grep sibin
root     2384373  0.0  0.0  14984  9936 ?        Ss   17:14   0:00 sshd: sibin [priv]
sibin    2384387  0.0  0.0  18744  9960 ?        Ss   17:14   0:00 /lib/systemd/systemd --user
sibin    2384388  0.0  0.0 172308  6144 ?        S    17:14   0:00 (sd-pam)
sibin    2384397  0.0  0.0 277760 14352 ?        Ssl  17:14   0:00 /usr/bin/pulseaudio --daemonize=no --log-target=journal
sibin    2384399  0.0  0.0 508784 24620 ?        SNsl 17:14   0:00 /usr/libexec/tracker-miner-fs
sibin    2384407  0.0  0.0   8248  5228 ?        Ss   17:14   0:00 /usr/bin/dbus-daemon --session --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only
sibin    2384426  0.0  0.0 237112  7560 ?        Ssl  17:14   0:00 /usr/libexec/gvfsd
sibin    2384431  0.0  0.0 312808  6600 ?        Sl   17:14   0:00 /usr/libexec/gvfsd-fuse /run/user/1003/gvfs -f -o big_writes
sibin    2384439  0.0  0.0 312076  9944 ?        Ssl  17:14   0:00 /usr/libexec/gvfs-udisks2-volume-monitor
sibin    2384450  0.0  0.0 314124  9044 ?        Ssl  17:14   0:00 /usr/libexec/gvfs-afc-volume-monitor
sibin    2384455  0.0  0.0 235512  7096 ?        Ssl  17:14   0:00 /usr/libexec/gvfs-gphoto2-volume-monitor
sibin    2384460  0.0  0.0 233276  6140 ?        Ssl  17:14   0:00 /usr/libexec/gvfs-goa-volume-monitor
sibin    2384464  0.0  0.0 550560 34816 ?        Sl   17:14   0:00 /usr/libexec/goa-daemon
sibin    2384471  0.0  0.0 312152  9144 ?        Sl   17:14   0:00 /usr/libexec/goa-identity-service
sibin    2384477  0.0  0.0 233100  6288 ?        Ssl  17:14   0:00 /usr/libexec/gvfs-mtp-volume-monitor
sibin    2384592  0.0  0.0  15136  6736 ?        S    17:14   0:00 sshd: sibin@pts/15
sibin    2384593  0.0  0.0   9420  6088 pts/15   Ss   17:14   0:00 -bash
sibin    2385179  0.0  0.0   9760  3996 pts/15   R+   17:19   0:00 ps aux
sibin    2385180  0.0  0.0   6432  2620 pts/15   S+   17:19   0:00 grep --color sibin</code></pre>
            <p>The above command (<code>ps aux | grep sibin</code>) is
            sending the output of one command, <code>ps aux</code> to
            the input of another command, <code>grep sibin</code> (using
            a “<em>pipe</em>”). Hence, we are only listing those lines
            from the output of <code>ps aux</code> that has a string
            that matches the word, <code>sibin</code>.</p>
            <p><strong>Note:</strong> neither command/process
            (<code>ps</code>/<code>grep</code>) needs to be aware of
            each other. hey both carry out their normal functionality.
            It if the beauty and elgance of the UNIX design that allows
            this chaining of processes to work as well as it does.
            Technically <em>most</em> UNIX commands/processes can be
            chained together to get very advance functionality from very
            simple components.</p>
            <h2 data-number="5.2" id="process"><span
            class="header-section-number">5.2</span> process</h2>
            <ul>
            <li>process ID <code>pid</code></li>
            <li>memory acessible only to process
            <ul>
            <li>code, global data, stack, heap]</li>
            </ul></li>
            <li>integer descriptors that identify resources
            <ul>
            <li>[file system, networking, communication]</li>
            </ul></li>
            <li>current working directory <code>pwd</code></li>
            <li>owner <code>sibin</code></li>
            <li>parent → creator, responsible for it</li>
            <li>arguments passed from command line</li>
            <li>environment variables → system config information</li>
            </ul>
            <p><img src="./figures/process.png" width="400">``</p>
            <h2 data-number="5.3" id="fork"><span
            class="header-section-number">5.3</span>
            <code>fork()</code></h2>
            <p>Create a new, child, process → from the <strong>state of
            the calling process</strong></p>
            <p>Defined in <code>&lt;unistd.h&gt;</code>.</p>
            <h3 data-number="5.3.1" id="after-fork"><span
            class="header-section-number">5.3.1</span> after
            <code>fork()</code></h3>
            <p><img src="./figures/process.png" width="200">
            <img src="./figures/process.png" width="200"></p>
            <h3 data-number="5.3.2"
            id="process-creationterminationcoordination-api"><span
            class="header-section-number">5.3.2</span> process
            creation/termination/coordination API</h3>
            <p>Let’s take a look at all the function available in
            <code>C</code> for dealing with processes.</p>
            <table>
            <colgroup>
            <col style="width: 46%" />
            <col style="width: 53%" />
            </colgroup>
            <thead>
            <tr class="header">
            <th>name</th>
            <th>action</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>fork</code></td>
            <td>create process</td>
            </tr>
            <tr class="even">
            <td><code>getpid</code></td>
            <td>get ID of process</td>
            </tr>
            <tr class="odd">
            <td><code>getppid</code></td>
            <td>get ID of parent</td>
            </tr>
            <tr class="even">
            <td><code>exit</code></td>
            <td>terminate a process</td>
            </tr>
            <tr class="odd">
            <td><code>wait</code></td>
            <td>parent waiting for child to exit</td>
            </tr>
            <tr class="even">
            <td><code>exec</code></td>
            <td>new program from <em>current process</em> <a href="#fn7"
            class="footnote-ref" id="fnref7"
            role="doc-noteref"><sup>7</sup></a>.</td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <h4 data-number="5.3.2.1" id="process-vs-program"><span
            class="header-section-number">5.3.2.1</span> process vs
            program</h4>
            <ul>
            <li>program → <strong>compiled</strong> version of code</li>
            <li>process → program <strong>executing</strong> in
            memory</li>
            </ul>
            <h3 data-number="5.3.3" id="pdt_t"><span
            class="header-section-number">5.3.3</span>
            <code>pdt_t</code></h3>
            <ul>
            <li>process identifier defined in
            <code>&lt;sys/types.h&gt;</code></li>
            <li>same as a (signed) <code>int</code></li>
            </ul>
            <h3 data-number="5.3.4" id="lets-revisit-fork"><span
            class="header-section-number">5.3.4</span> let’s revisit
            <code>fork()</code></h3>
            <p>A very <em>simple</em> interface, for a very
            <em>complex</em> mechanism!</p>
            <div class="sourceCode" id="cb114"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>pid_t fork<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span></code></pre></div>
            <p>The new (“child”) process get a copy of the resources as
            shown before:</p>
            <p><img src="./figures/process.png" width="200">
            <img src="./figures/process.png" width="200"> <br> <br></p>
            <p><strong>Note:</strong> some important nuances: - the
            child starting executing <strong>from the
            <code>fork()</code> instruction onwards</strong>! - all
            previous instructions don’t matter for the child - the
            parent, on the other hand, will <strong>also continue to
            execute</strong>, in <strong>parallel</strong> with the
            child.</p>
            <p><br></p>
            <div class="sourceCode" id="cb115"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to fork</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;BEFORE calling fork()&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> fork<span class="op">()</span> <span class="op">;</span></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;AFTER calling fork()&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>The output from the above code:</p>
            <pre><code>BEFORE calling fork()AFTER calling fork()

BEFORE calling fork()AFTER calling fork()</code></pre>
            <p>Hold on a second! We said that the child starts executing
            <strong>from the <code>fork()</code> instruction</strong>
            and not before. So, why is the
            <code>BEFORE calling fork()</code> being printed
            <em>twice</em>? We should, ideally, see the following
            behavior: - <em>one</em> instance of
            <code>BEFORE calling fork()</code> → parent only -
            <em>two</em> instances of <code>AFTER calling fork()</code>
            → parent and child</p>
            <blockquote>
            <p>We are seeing a side-effect/vagary of the implementation
            of <code>printf()</code> and really any function that
            outputs to a standard destination <em>e.g.</em>,
            <code>stdio</code> (standard input/output),
            <code>stderr</code> (standard error), <em>etc.</em> These
            output “locations” (rather called, <em>“streams</em>) are
            <strong>buffered</strong>, <em>i.e.,</em> instead of
            immediately writing to the screen (in the case of
            <code>stdio</code>), the string/data are written to
            temporary inernal buffer that is then <em>periodically
            cleansed</em> (<em>i.e.,</em> written out to the screen).
            The buffers are cleared out in the following situations: -
            when the buffer gets full (different systems have varied
            sizes, <em>e.g.,</em> <code>64k</code>) - when the buffer is
            explicitly flushed, <em>e.g.</em>, using <code>stdout</code>
            - when a newline character (<code>\n</code>) is printed</p>
            </blockquote>
            <p>So, in the above code example, while the first
            <code>printf()</code> is written only <em>once</em> (by the
            parent), the <code>printf("\n")</code> statement is present
            in both, parent and child. Remember that when a fork
            happens, the child gets a copy of <em>all</em> resources of
            the parent and that include the output buffer – which, at
            that point, includes the <code>BEFORE calling fork()</code>
            text. After the <code>fork()</code>, there are <em>two</em>
            processes with unflushed output buffers, the parent and the
            child. Hence, the <code>\n</code> causes <em>both</em>
            buffers to be flushed thus resulting in the above
            output.</p>
            <p>There are two ways to fix this problem and get the
            desired behavior: 1. add <code>\n</code> to the end of
            <em>Every</em> <code>printf()</code> 2. force a flush after
            every <code>printf()</code> or perhaps just before every
            <code>fork()</code></p>
            <p>The call to flush a stream is:</p>
            <div class="sourceCode" id="cb117"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> fflush<span class="op">(</span> <span class="dt">FILE</span><span class="op">*</span> stream <span class="op">)</span> <span class="op">;</span> </span></code></pre></div>
            <p>defined in <code>&lt;stdio.h&gt;</code>.</p>
            <p>So, we let’s look at the above code again, this time with
            <code>fflush</code> (since the <code>\n</code> method is
            trivial and is left as an exercise):</p>
            <div class="sourceCode" id="cb118"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to fork</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;BEFORE calling fork()&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">)</span> <span class="op">;</span> <span class="co">// to flush the standard output</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> fork<span class="op">()</span> <span class="op">;</span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;AFTER calling fork()&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>The output is:</p>
            <pre><code>BEFORE calling fork()AFTER calling fork()

AFTER calling fork()</code></pre>
            <p>See <code>man fflush</code> for more information.</p>
            <h3 data-number="5.3.5" id="fork-return-values"><span
            class="header-section-number">5.3.5</span>
            <code>fork()</code> return values</h3>
            <p>Now, let’s look back at the interface for:</p>
            <div class="sourceCode" id="cb120"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>pid_t fork<span class="op">(</span><span class="dt">void</span><span class="op">);</span></span></code></pre></div>
            <p>We see that is returns a <code>pid_t</code>.
            <code>fork()</code> returns <em>two distinct values</em>,
            depending on which process the call is returning to:</p>
            <table>
            <thead>
            <tr class="header">
            <th>return value</th>
            <th>called from</th>
            <th>meaning</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td>actual pid</td>
            <td>parent</td>
            <td>child created</td>
            </tr>
            <tr class="even">
            <td><code>0</code></td>
            <td>child</td>
            <td>inside child</td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <h3 data-number="5.3.6" id="fork-questions"><span
            class="header-section-number">5.3.6</span> <code>fork</code>
            Questions</h3>
            <ol type="1">
            <li><p>How many processes (not including the initial one)
            are created in the following?</p>
            <div class="sourceCode" id="cb121"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    fork<span class="op">();</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    fork<span class="op">();</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
            <li><p>What are the <em>possible outputs</em> for:</p>
            <div class="sourceCode" id="cb122"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>    pid_t parent <span class="op">=</span> getpid<span class="op">();</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    pid_t child<span class="op">;</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>    child <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>getpid<span class="op">()</span> <span class="op">==</span> parent<span class="op">)</span> <span class="op">{</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;p&quot;</span><span class="op">);</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>        wait<span class="op">(</span>NULL<span class="op">);</span> <span class="co">/* why is `NULL` OK here? */</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;w&quot;</span><span class="op">);</span></span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;c&quot;</span><span class="op">);</span></span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
            </ol>
            <h2 data-number="5.4" id="wait"><span
            class="header-section-number">5.4</span>
            <code>wait()</code></h2>
            <p><a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/processes.html#/42">Slides</a></p>
            <p>Parents are responsible for managing their children!</p>
            <p><img src="./figures/jackjack.gif" width="400"></p>
            <p>so, they…<code>wait()</code>!</p>
            <div class="sourceCode" id="cb123"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>pid_t wait<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>wstatus<span class="op">)</span></span></code></pre></div>
            <ul>
            <li>wait for state changes in a <strong>child</strong></li>
            <li>called by a <strong>parent</strong></li>
            <li>parents can wait for,</li>
            <li><em>all</em> children</li>
            <li><em>specific</em> child</li>
            <li>a <em>subset</em> of children</li>
            </ul>
            <p>defined in <code>&lt;sys/wait.h&gt;</code></p>
            <p>A child changes “<em>state</em>” if one of following
            happens: - child <strong>terminated/exited</strong> - child
            was <strong>stopped by a signal</strong> * - child was
            <strong>resumed</strong> by a signal</p>
            <p>[* will discuss signals later]</p>
            <table>
            <thead>
            <tr class="header">
            <th>child status</th>
            <th>action</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td>already changed</td>
            <td><strong>return immediately</strong> to parent</td>
            </tr>
            <tr class="even">
            <td>executing normally</td>
            <td>parent <strong>waits</strong>/<strong>blocks</strong>
            for child</td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <h4 data-number="5.4.0.1" id="wait-return-value"><span
            class="header-section-number">5.4.0.1</span>
            <code>wait()</code> return value</h4>
            <table>
            <thead>
            <tr class="header">
            <th>return value</th>
            <th>meaning</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td>pid via <code>pid_t</code></td>
            <td>pid of terminated child</td>
            </tr>
            <tr class="even">
            <td><code>-1</code></td>
            <td>error</td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <div class="sourceCode" id="cb124"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to fork() and wait()</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>        pid_t child_pid <span class="op">;</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>        pid_t parent <span class="op">;</span></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span> <span class="st">&quot;------------------------------</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span> <span class="st">&quot;:::BEFORE::: </span><span class="op">\</span></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a><span class="st">                 getpid() = </span><span class="sc">%d</span><span class="st"> </span><span class="op">\</span></span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a><span class="st">                 parent = </span><span class="sc">%d</span><span class="st"> </span><span class="op">\</span></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a><span class="st">                 child = </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>             getpid<span class="op">(),</span> child_pid<span class="op">,</span> parent <span class="op">)</span> <span class="op">;</span></span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span> <span class="st">&quot;------------------------------</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// create 5 children</span></span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">5</span> <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb124-28"><a href="#cb124-28" aria-hidden="true" tabindex="-1"></a>                child_pid <span class="op">=</span> fork<span class="op">()</span> <span class="op">;</span></span>
<span id="cb124-29"><a href="#cb124-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-30"><a href="#cb124-30" aria-hidden="true" tabindex="-1"></a>                <span class="co">// make sure the children don&#39;t create more children!</span></span>
<span id="cb124-31"><a href="#cb124-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span><span class="op">(!</span>child_pid<span class="op">)</span></span>
<span id="cb124-32"><a href="#cb124-32" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span> <span class="op">;</span></span>
<span id="cb124-33"><a href="#cb124-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb124-34"><a href="#cb124-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-35"><a href="#cb124-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// wait for the kids</span></span>
<span id="cb124-36"><a href="#cb124-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> wait_status <span class="op">;</span></span>
<span id="cb124-37"><a href="#cb124-37" aria-hidden="true" tabindex="-1"></a>        pid_t wait_result <span class="op">=</span> wait<span class="op">(</span> <span class="op">&amp;</span>wait_status <span class="op">)</span> <span class="op">;</span></span>
<span id="cb124-38"><a href="#cb124-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-39"><a href="#cb124-39" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span> <span class="st">&quot;:::AFTER::: &quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb124-40"><a href="#cb124-40" aria-hidden="true" tabindex="-1"></a>        child_pid <span class="op">?</span> printf<span class="op">(</span> <span class="st">&quot;---PARENT!--- &quot;</span> <span class="op">)</span> <span class="op">:</span> printf<span class="op">(</span> <span class="st">&quot;---CHILD!--- &quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb124-41"><a href="#cb124-41" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span> <span class="st">&quot;getpid() = </span><span class="sc">%d</span><span class="st"> </span><span class="op">\</span></span>
<span id="cb124-42"><a href="#cb124-42" aria-hidden="true" tabindex="-1"></a><span class="st">                 parent = </span><span class="sc">%d</span><span class="st"> </span><span class="op">\</span></span>
<span id="cb124-43"><a href="#cb124-43" aria-hidden="true" tabindex="-1"></a><span class="st">                 child = </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb124-44"><a href="#cb124-44" aria-hidden="true" tabindex="-1"></a>             getpid<span class="op">(),</span> child_pid<span class="op">,</span> parent <span class="op">)</span> <span class="op">;</span></span>
<span id="cb124-45"><a href="#cb124-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-46"><a href="#cb124-46" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb124-47"><a href="#cb124-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb124-48"><a href="#cb124-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p><strong>Note:</strong> the output can
            <strong>vary!</strong> Depends on which process gets to
            writing its buffer first.</p>
            <pre><code>------------------------------
:::BEFORE:::         getpid() = 2492442          parent = 1612788000         child = 374366320
------------------------------
:::AFTER::: ---CHILD!--- getpid() = 2492443          parent = 0          child = 374366320

:::AFTER::: ---CHILD!--- getpid() = 2492444          parent = 0          child = 374366320

:::AFTER::: ---CHILD!--- getpid() = 2492445          parent = 0          child = 374366320

:::AFTER::: ---PARENT!--- getpid() = 2492442         parent = 2492447        child = 374366320
:::AFTER::: ---CHILD!--- getpid() = 2492446          parent = 0          child = 374366320


:::AFTER::: ---CHILD!--- getpid() = 2492447          parent = 0          child = 374366320</code></pre>
            <p>OR</p>
            <pre><code>------------------------------
:::BEFORE:::         getpid() = 2492454          parent = -2016386784        child = 780062336
------------------------------
:::AFTER::: ---CHILD!--- getpid() = 2492455          parent = 0          child = 780062336

:::AFTER::: ---CHILD!--- getpid() = 2492456          parent = 0          child = 780062336

:::AFTER::: ---CHILD!--- getpid() = 2492457          parent = 0          child = 780062336

:::AFTER::: ---CHILD!--- getpid() = 2492458          parent = 0          child = 780062336
:::AFTER::: ---PARENT!--- getpid() = 2492454         parent = 2492459        child = 780062336


:::AFTER::: ---CHILD!--- getpid() = 2492459          parent = 0          child = 780062336</code></pre>
            <p>OR many other combinations. We are seeing the
            <strong>inherent nondeterminism</strong> in parallel
            execution.</p>
            <h3 data-number="5.4.1" id="process-vs-thread"><span
            class="header-section-number">5.4.1</span> process vs
            thread</h3>
            <p>A minor detour. One may ver well be confused about the
            difference between a “process” and a “thread”. The main
            difference is that a process, <em>owns resources</em> while
            a thread is just a <em>unit of execution</em>. This table
            should help clarify the difference:</p>
            <table>
            <thead>
            <tr class="header">
            <th>process</th>
            <th>thread</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td>owns resources</td>
            <td>unit of execution</td>
            </tr>
            <tr class="even">
            <td>isolation</td>
            <td>share memory</td>
            </tr>
            <tr class="odd">
            <td>system call*</td>
            <td>no system call*</td>
            </tr>
            <tr class="even">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>* for creation: <em>i.e.,</em> the creation of a process
            is a <strong>system call</strong>, <em>i.e.,</em> we need to
            ask the operating system to help us since the OS is what
            allocates resources to newly formed procsses. A new thread,
            on the other hand, doesn’t require us to invoke a system
            call and is often created using <em>user-space
            libraries</em> (*e.g., look up <a
            href="https://man7.org/linux/man-pages/man7/pthreads.7.html">pthreads</a>).</p>
            <h2 data-number="5.5" id="exit"><span
            class="header-section-number">5.5</span>
            <code>exit()</code></h2>
            <p><a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/processes-2-exit.html#/">Slides</a></p>
            <p><code>exit</code> is the function that used to terminate
            the current process.</p>
            <div class="sourceCode" id="cb127"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> exit<span class="op">(</span><span class="dt">int</span> status<span class="op">);</span></span></code></pre></div>
            <p>as defined in <code>&lt;stdlib.h</code>. The input
            argument is the <strong>exit status</strong>:</p>
            <table>
            <thead>
            <tr class="header">
            <th>value</th>
            <th>meaning</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>0</code></td>
            <td><code>EXIT_SUCCESS</code></td>
            </tr>
            <tr class="even">
            <td><code>1</code></td>
            <td><code>EXIT_FAILURE</code></td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>And note that <code>exit()</code> does not
            <em>explicitly</em> return any value. All the information is
            passed via the <code>status</code> field.</p>
            <p>The following two pieces of code are identical:</p>
            <div class="sourceCode" id="cb128"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_SUCCESS<span class="op">)</span> <span class="op">;</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <div class="sourceCode" id="cb129"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EXIT_SUCCESS <span class="op">;</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p><br></p>
            <h3 data-number="5.5.1" id="interpreting-exit-status"><span
            class="header-section-number">5.5.1</span> Interpreting
            <code>exit()</code> status</h3>
            <p>Despite <code>wait</code>’s status return value being a
            simple <code>int</code>, the <em>bits</em> of that integer
            mean very specific things. See the <code>man</code> page for
            <code>wait</code> for details, but we can use a set of
            functions (really “macros”) to interpret the status value: -
            <code>WIFEXITED(status)</code> will return <code>0</code> if
            the process didn’t exit (e.g. if it faulted instead), and
            non-<code>0</code> otherwise -
            <code>WEXITSTATUS(status)</code> will get the intuitive
            integer value that was passed to <code>exit</code> (or
            returned from <code>main</code>), but assumes that this
            value is only 8 bits large, max (thus has a maximum value of
            256)</p>
            <p>both defined in <code>&lt;sys/wait.h&gt;</code>.</p>
            <h3 data-number="5.5.2"
            id="relationship-between-wait-and-exit"><span
            class="header-section-number">5.5.2</span> Relationship
            between <code>wait()</code> and <code>exit()</code></h3>
            <p>The relationship between these two calls can be confusing
            but they are <em>closelfy related</em>.</p>
            <ol type="1">
            <li>first <code>fork()</code> creates a new child:</li>
            </ol>
            <figure>
            <img src="./figures/wait_exit2.png" alt="Wait and Exit" />
            <figcaption aria-hidden="true">Wait and Exit</figcaption>
            </figure>
            <ol start="2" type="1">
            <li>if the parent is waiting for the child, then the return
            value of <code>wait()</code> is the <code>pid</code> of that
            child.</li>
            </ol>
            <figure>
            <img src="./figures/wait_exit3.png" alt="Wait and Exit" />
            <figcaption aria-hidden="true">Wait and Exit</figcaption>
            </figure>
            <ol start="3" type="1">
            <li>when the <strong>child</strong> calls
            <code>exit(status)</code> then that status is written into
            the status variable of the <code>wait(&amp;status)</code>
            call.</li>
            </ol>
            <figure>
            <img src="./figures/wait_exit4.png" alt="Wait and Exit" />
            <figcaption aria-hidden="true">Wait and Exit</figcaption>
            </figure>
            <p><strong>Note:</strong> the interface for
            <code>wait()</code>:</p>
            <div class="sourceCode" id="cb130"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>pid_t wait<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>wstatus<span class="op">)</span></span></code></pre></div>
            <p>the input is a <strong>pointer to an integer</strong>.
            Hence, the value passed from <code>exit()</code> is written
            into that integer and is <strong>accessible after the
            <code>wait()</code> call returns</strong>.</p>
            <ol start="4" type="1">
            <li>this goes for <em>any</em> <code>exit()</code> call from
            the child.</li>
            </ol>
            <figure>
            <img src="./figures/wait_exit5.png" alt="Wait and Exit" />
            <figcaption aria-hidden="true">Wait and Exit</figcaption>
            </figure>
            <div class="sourceCode" id="cb131"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to fork(), wait() and exit()</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span><span class="pp">     </span><span class="co">// fork(), getpid()</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span><span class="pp">   </span><span class="co">// wait()</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span><span class="pp">     </span><span class="co">// exit()</span></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#define NUM_CHILDREN </span><span class="dv">5</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>    pid_t pid<span class="op">,</span> child_pid <span class="op">;</span></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// create multiple children </span></span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> NUM_CHILDREN <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a>        pid <span class="op">=</span> fork<span class="op">()</span> <span class="op">;</span></span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span> <span class="op">!</span>pid <span class="op">)</span></span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a>            <span class="co">// we are inside the child</span></span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span> <span class="st">&quot;---CHILD </span><span class="sc">%d</span><span class="st">--- exiting with </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">(),</span> i<span class="op">+</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a>            <span class="co">// both of these terminate immediately AND return the same value</span></span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a>            <span class="co">// identical, really!</span></span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">)</span></span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a>                exit<span class="op">(</span> i<span class="op">+</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> i<span class="op">+</span><span class="dv">1</span> <span class="op">;</span></span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-37"><a href="#cb131-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-38"><a href="#cb131-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Inside the parent, wait until the wait() call returns -1 -&gt; no more children left</span></span>
<span id="cb131-39"><a href="#cb131-39" aria-hidden="true" tabindex="-1"></a><span class="co">     * take the return value from wait(), put it in &quot;child_pid&quot; and compare that to &quot;-1&quot;</span></span>
<span id="cb131-40"><a href="#cb131-40" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb131-41"><a href="#cb131-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> status <span class="op">;</span></span>
<span id="cb131-42"><a href="#cb131-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span> <span class="op">(</span> child_pid <span class="op">=</span> wait<span class="op">(</span> <span class="op">&amp;</span>status <span class="op">)</span> <span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span> <span class="op">)</span></span>
<span id="cb131-43"><a href="#cb131-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb131-44"><a href="#cb131-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// all children are done!</span></span>
<span id="cb131-45"><a href="#cb131-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span> WIFEXITED<span class="op">(</span>status<span class="op">)</span> <span class="op">)</span></span>
<span id="cb131-46"><a href="#cb131-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb131-47"><a href="#cb131-47" aria-hidden="true" tabindex="-1"></a>            <span class="co">// check that the process didn&#39;t terminate with any errors</span></span>
<span id="cb131-48"><a href="#cb131-48" aria-hidden="true" tabindex="-1"></a>            <span class="co">// note that the output of WIFEEXITED is non-zero for normal exit</span></span>
<span id="cb131-49"><a href="#cb131-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-50"><a href="#cb131-50" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span> <span class="st">&quot;Inside :::PARENT::: where child </span><span class="sc">%d</span><span class="st"> exited with status: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb131-51"><a href="#cb131-51" aria-hidden="true" tabindex="-1"></a>                    child_pid<span class="op">,</span> </span>
<span id="cb131-52"><a href="#cb131-52" aria-hidden="true" tabindex="-1"></a>                    <span class="op">(</span><span class="dt">char</span><span class="op">)</span> WEXITSTATUS<span class="op">(</span>status<span class="op">)</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb131-53"><a href="#cb131-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb131-54"><a href="#cb131-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-55"><a href="#cb131-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-56"><a href="#cb131-56" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb131-57"><a href="#cb131-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb131-58"><a href="#cb131-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// exit(EXIT_SUCCESS) ;</span></span>
<span id="cb131-59"><a href="#cb131-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// return EXIT_SUCCESS ;</span></span>
<span id="cb131-60"><a href="#cb131-60" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p><strong>Note:</strong> the output of this is alo
            <strong>non-deterministic</strong> as we can see with
            multiple runs of it:</p>
            <pre><code>---CHILD 2566089--- exiting with 1
---CHILD 2566090--- exiting with 2
---CHILD 2566091--- exiting with 3
---CHILD 2566092--- exiting with 4
Inside :::PARENT::: where child 2566089 exited with status: 1
---CHILD 2566093--- exiting with 5
Inside :::PARENT::: where child 2566090 exited with status: 2
Inside :::PARENT::: where child 2566091 exited with status: 3
Inside :::PARENT::: where child 2566092 exited with status: 4
Inside :::PARENT::: where child 2566093 exited with status: 5</code></pre>
            <pre><code>---CHILD 2568612--- exiting with 1
---CHILD 2568613--- exiting with 2
---CHILD 2568614--- exiting with 3
---CHILD 2568615--- exiting with 4
Inside :::PARENT::: where child 2568612 exited with status: 1
---CHILD 2568616--- exiting with 5
Inside :::PARENT::: where child 2568613 exited with status: 2
Inside :::PARENT::: where child 2568614 exited with status: 3
Inside :::PARENT::: where child 2568615 exited with status: 4
Inside :::PARENT::: where child 2568616 exited with status: 5</code></pre>
            <p>This <em>non-determinism</em> is a product of the
            <em>isolation</em> that is provided by processes. The OS
            switches back and forth between processes frequently (up to
            thousands of time per second!) so that if one goes into an
            infinite loop, others will still make progress. But this
            also means that the OS can choose to run any of the
            processes that are trying to execute at any point in time!
            We cannot predict the order of execution, completion, or
            <code>wait</code> notification. This non-deterministic
            execution is called <em>concurrency</em>. You’ll want to
            keep this in mind as you continue to learn the process APIs,
            and when we talk about IPC, later.</p>
            <h3 data-number="5.5.3" id="life-after-exit"><span
            class="header-section-number">5.5.3</span> life after
            <code>exit()</code>?</h3>
            <p>Remember that when <code>main()</code> returns, it is the
            same as <code>exit()</code> because <strong>main() calls
            exit()</strong>.</p>
            <blockquote>
            <p><strong>Investigating <code>main</code> return →
            <code>exit</code> via <code>gdb</code>.</strong> You can see
            this by diving into any program with <code>gdb -tui</code>,
            breakpointing before the return (e.g. <code>b 5</code>), and
            single-stepping through the program. You’ll want to
            <code>layout asm</code> to drop into “assembly mode”, and
            single step through the assembly and if you want to step
            through it instruction at a time use <code>stepi</code> or
            <code>si</code>. You can see that it ends up calling
            <code>__GI_exit</code>. <code>__GI_*</code> functions are
            glibc internal functions, so we see that <code>libc</code>
            is actually calling <code>main</code>, and when it returns,
            it is then going through its logic for
            <code>exit</code>.</p>
            </blockquote>
            <p><code>C</code> provides you with additional control of
            what happens when you exit from a program. For instance, you
            may need to <em>clean up resources</em>, <em>e.g.,</em>
            release some memory, close some files or network
            connections, write some debug information to a file,
            <em>etc.</em> Hence, the following functions <em>can be</em>
            are called once <code>exit()</code> is invoked: |function|
            defined in | |——–|——–| | <code>on_exit</code>|
            <code>&lt;stdlib.h&gt;</code>| | <code>atexit</code>|
            <code>&lt;stdlib.h&gt;</code>| | <code>_exit</code>|
            <code>&lt;unistd.h&gt;</code>| ||</p>
            <p>Let’s look at these in more details.</p>
            <h4 data-number="5.5.3.1" id="on_exit"><span
            class="header-section-number">5.5.3.1</span>
            <code>on_exit()</code></h4>
            <div class="sourceCode" id="cb134"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>typdef <span class="dt">void</span> <span class="op">(*</span>function<span class="op">)(</span> <span class="dt">int</span> <span class="op">,</span> <span class="dt">void</span> <span class="op">*</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> on_exit<span class="op">(</span> function my_func<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>arg <span class="op">)</span> <span class="op">;</span></span></code></pre></div>
            <ul>
            <li>register a <em>user-defined</em> <strong>function
            pointer</strong></li>
            <li><code>my_func</code></li>
            <li>to be called while exiting from <code>main()</code><br>
            <code>typdef void (*function)( int , void * ) ;</code></li>
            <li>function receives → exit <code>status</code> &amp;
            <code>argument</code></li>
            <li>we can pass data/args to that function</li>
            </ul>
            <h4 data-number="5.5.3.2" id="atexit"><span
            class="header-section-number">5.5.3.2</span>
            <code>atexit()</code></h4>
            <div class="sourceCode" id="cb135"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">(*</span>function<span class="op">)(</span><span class="dt">void</span><span class="op">)</span> <span class="op">;</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> atexit<span class="op">(</span>function my_func<span class="op">);</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>extracted 1, remaining string: &quot; 42 the secret to everything&quot;
extracted 42, remaining string: &quot; the secret to everything&quot;
42 and &quot;secret&quot;
Using strtok to parse through a string finding substrings separated by &#39;h&#39; or &#39;t&#39;:
[1 42 ]
[e secre]
[ ]
[o every]
[ing]</code></pre>
            <ul>
            <li>register a <em>user-defined</em> <strong>function
            pointer</strong></li>
            <li><code>my_func</code></li>
            <li>to be called while exiting from <code>main()</code><br>
            <code>typedef void (*function)(void) ;</code></li>
            <li><strong>much simpler</strong> function/interface →
            <strong>no</strong> args!</li>
            <li><strong>no</strong> data/args passed to that
            function</li>
            </ul>
            <p><strong>Note:</strong> some nuances: 1. neither
            <code>atexit()</code> nor <code>on_exit()</code> immediately
            terminate the process. 2. you can register
            <strong>multiple</strong> functions using either one; these
            are called in <strong>reverse</strong> order of
            registrations 3. <code>atexit()</code> is <em>standard</em>
            <code>c</code>, while <code>on_exit()</code> <em>may
            not</em> be!</p>
            <h4 data-number="5.5.3.3" id="exit-1"><span
            class="header-section-number">5.5.3.3</span>
            <code>_exit()</code></h4>
            <p><code>void _exit(int status);</code></p>
            <ul>
            <li><strong>immediate</strong> termination of process!</li>
            <li>no return value</li>
            <li>output buffers are <strong>not</strong> flushed</li>
            <li><strong>does not</strong> call the funcs registered by
            others</li>
            </ul>
            <div class="sourceCode" id="cb137"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to fork(), wait() and exit()</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span><span class="pp">     </span><span class="co">// fork(), getpid()</span></span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span><span class="pp">   </span><span class="co">// wait()</span></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span><span class="pp">     </span><span class="co">// exit()</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#define NUM_CHILDREN </span><span class="dv">1</span></span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a><span class="co">// function signature to match on_exit()</span></span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cleanup<span class="op">(</span> <span class="dt">int</span> status<span class="op">,</span> <span class="dt">void</span><span class="op">*</span> args <span class="op">)</span></span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span> args <span class="op">)</span> <span class="op">;</span></span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;AFTER Exit(): Doing some cleanup. Freeing memory </span><span class="sc">%hhx</span><span class="st"> status = </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> args<span class="op">,</span> status <span class="op">)</span> <span class="op">;</span></span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> simple_cleanup<span class="op">()</span></span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;Goodbye cruel world!</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb137-26"><a href="#cb137-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb137-27"><a href="#cb137-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-28"><a href="#cb137-28" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb137-29"><a href="#cb137-29" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb137-30"><a href="#cb137-30" aria-hidden="true" tabindex="-1"></a>    pid_t pid<span class="op">,</span> child_pid <span class="op">;</span></span>
<span id="cb137-31"><a href="#cb137-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-32"><a href="#cb137-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">*</span> some_memory <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">*)</span>malloc<span class="op">(</span><span class="dv">1024</span><span class="op">)</span> <span class="op">;</span></span>
<span id="cb137-33"><a href="#cb137-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// register the function and also tell it what to cleanup</span></span>
<span id="cb137-34"><a href="#cb137-34" aria-hidden="true" tabindex="-1"></a>    on_exit<span class="op">(</span> cleanup<span class="op">,</span> some_memory <span class="op">)</span> <span class="op">;</span></span>
<span id="cb137-35"><a href="#cb137-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-36"><a href="#cb137-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// register the simpler atexit function</span></span>
<span id="cb137-37"><a href="#cb137-37" aria-hidden="true" tabindex="-1"></a>    atexit<span class="op">(</span>simple_cleanup<span class="op">)</span> <span class="op">;</span></span>
<span id="cb137-38"><a href="#cb137-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb137-39"><a href="#cb137-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-40"><a href="#cb137-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// create multiple children </span></span>
<span id="cb137-41"><a href="#cb137-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> NUM_CHILDREN <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb137-42"><a href="#cb137-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb137-43"><a href="#cb137-43" aria-hidden="true" tabindex="-1"></a>        pid <span class="op">=</span> fork<span class="op">()</span> <span class="op">;</span></span>
<span id="cb137-44"><a href="#cb137-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span> <span class="op">!</span>pid <span class="op">)</span></span>
<span id="cb137-45"><a href="#cb137-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb137-46"><a href="#cb137-46" aria-hidden="true" tabindex="-1"></a>            <span class="co">// we are inside the child</span></span>
<span id="cb137-47"><a href="#cb137-47" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span> <span class="st">&quot;---CHILD </span><span class="sc">%d</span><span class="st">--- exiting with </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">(),</span> i<span class="op">+</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb137-48"><a href="#cb137-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-49"><a href="#cb137-49" aria-hidden="true" tabindex="-1"></a>            <span class="co">// both of these terminate immediately AND return the same value</span></span>
<span id="cb137-50"><a href="#cb137-50" aria-hidden="true" tabindex="-1"></a>            <span class="co">// identical, really!</span></span>
<span id="cb137-51"><a href="#cb137-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">)</span></span>
<span id="cb137-52"><a href="#cb137-52" aria-hidden="true" tabindex="-1"></a>                exit<span class="op">(</span> i<span class="op">+</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb137-53"><a href="#cb137-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb137-54"><a href="#cb137-54" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> i<span class="op">+</span><span class="dv">1</span> <span class="op">;</span></span>
<span id="cb137-55"><a href="#cb137-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb137-56"><a href="#cb137-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb137-57"><a href="#cb137-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-58"><a href="#cb137-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Inside the parent, wait until the wait() call returns -1 -&gt; no more children left</span></span>
<span id="cb137-59"><a href="#cb137-59" aria-hidden="true" tabindex="-1"></a><span class="co">     * take the return value from wait(), put it in &quot;child_pid&quot; and compare that to &quot;-1&quot;</span></span>
<span id="cb137-60"><a href="#cb137-60" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb137-61"><a href="#cb137-61" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> status <span class="op">;</span></span>
<span id="cb137-62"><a href="#cb137-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span> <span class="op">(</span> child_pid <span class="op">=</span> wait<span class="op">(</span> <span class="op">&amp;</span>status <span class="op">)</span> <span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span> <span class="op">)</span></span>
<span id="cb137-63"><a href="#cb137-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb137-64"><a href="#cb137-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">// all children are done!</span></span>
<span id="cb137-65"><a href="#cb137-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span> WIFEXITED<span class="op">(</span>status<span class="op">)</span> <span class="op">)</span></span>
<span id="cb137-66"><a href="#cb137-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb137-67"><a href="#cb137-67" aria-hidden="true" tabindex="-1"></a>            <span class="co">// check that the process didn&#39;t terminate with any errors</span></span>
<span id="cb137-68"><a href="#cb137-68" aria-hidden="true" tabindex="-1"></a>            <span class="co">// note that the output of WIFEEXITED is non-zero for normal exit</span></span>
<span id="cb137-69"><a href="#cb137-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-70"><a href="#cb137-70" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span> <span class="st">&quot;Inside :::PARENT::: where child </span><span class="sc">%d</span><span class="st"> exited with status: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb137-71"><a href="#cb137-71" aria-hidden="true" tabindex="-1"></a>                    child_pid<span class="op">,</span> </span>
<span id="cb137-72"><a href="#cb137-72" aria-hidden="true" tabindex="-1"></a>                    <span class="op">(</span><span class="dt">char</span><span class="op">)</span> WEXITSTATUS<span class="op">(</span>status<span class="op">)</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb137-73"><a href="#cb137-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb137-74"><a href="#cb137-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb137-75"><a href="#cb137-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-76"><a href="#cb137-76" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb137-77"><a href="#cb137-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb137-78"><a href="#cb137-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">// exit(EXIT_SUCCESS) ;</span></span>
<span id="cb137-79"><a href="#cb137-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// return EXIT_SUCCESS ;</span></span>
<span id="cb137-80"><a href="#cb137-80" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>The output:</p>
            <pre><code>---CHILD 2608965--- exiting with 1
Goodbye cruel world!
AFTER Exit(): Doing some cleanup. Freeing memory a0 status = 1
Inside :::PARENT::: where child 2608965 exited with status: 1

Goodbye cruel world!
AFTER Exit(): Doing some cleanup. Freeing memory a0 status = 0</code></pre>
            <p>But, what happens if we change the following lines?</p>
            <div class="sourceCode" id="cb139"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>    <span class="co">// register the simpler atexit function</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>    atexit<span class="op">(</span>simple_cleanup<span class="op">)</span> <span class="op">;</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">*</span> some_memory <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">*)</span>malloc<span class="op">(</span><span class="dv">1024</span><span class="op">)</span> <span class="op">;</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// register the function and also tell it what to cleanup</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>    on_exit<span class="op">(</span> cleanup<span class="op">,</span> some_memory <span class="op">)</span> <span class="op">;</span></span></code></pre></div>
            <p>The output now looks like (what’s the difference?):</p>
            <pre><code>---CHILD 2609577--- exiting with 1
AFTER Exit(): Doing some cleanup. Freeing memory a0 status = 1
Goodbye cruel world!
Inside :::PARENT::: where child 2609577 exited with status: 1

AFTER Exit(): Doing some cleanup. Freeing memory a0 status = 0
Goodbye cruel world!</code></pre>
            <p>Finally, we change the <code>return (i+1)</code> to
            <code>_exit(i+1)</code> as follows:</p>
            <div class="sourceCode" id="cb141"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">)</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>                exit<span class="op">(</span> i<span class="op">+</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>                <span class="co">// return i+1 ;</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>                _exit<span class="op">(</span>i<span class="op">+</span><span class="dv">1</span><span class="op">)</span> <span class="op">;</span></span></code></pre></div>
            <p>What does the output look like now?</p>
            <pre><code>---CHILD 2610300--- exiting with 1
Inside :::PARENT::: where child 2610300 exited with status: 1

AFTER Exit(): Doing some cleanup. Freeing memory a0 status = 0
Goodbye cruel world!</code></pre>
            <h2 data-number="5.6" id="command-line-arguments"><span
            class="header-section-number">5.6</span> Command Line
            Arguments</h2>
            <p>I think that we likely have a decent intuition about what
            the command-line arguments are`:</p>
            <pre><code>$ ls /bin /sbin</code></pre>
            <p>The <code>ls</code> program takes two arguments,
            <code>/bin</code> and <code>/sbin</code>. How does
            <code>ls</code> access those arguments?</p>
            <p>Lets look at a <em>chain of programs</em> that
            <code>exec</code> each other. The first program (that you
            see here) is called <code>inline_exec_tmp</code>, and the
            programs <code>03/args?.c</code> are subsequently
            executed.</p>
            <figure>
            <img src="figures/exec_chain.png"
            alt="A chain of processes execing each other, and passing arguments. We only print them out in the 3rd program, args2.bin." />
            <figcaption aria-hidden="true">A chain of processes
            <code>exec</code>ing each other, and passing arguments. We
            only print them out in the 3rd program,
            <code>args2.bin</code>.</figcaption>
            </figure>
            <div class="sourceCode" id="cb144"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>prog <span class="op">=</span> <span class="st">&quot;./03/args1.bin&quot;</span><span class="op">;</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>args<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span>prog<span class="op">,</span> <span class="st">&quot;hello&quot;</span><span class="op">,</span> <span class="st">&quot;world&quot;</span><span class="op">,</span> NULL<span class="op">};</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>argc <span class="op">!=</span> <span class="dv">1</span><span class="op">)</span> <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;First program, arg 1: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> argv<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* lets execute args1 with some arguments! */</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>execvp<span class="op">(</span>prog<span class="op">,</span> args<span class="op">))</span> <span class="op">{</span></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;exec&quot;</span><span class="op">);</span></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>First program, arg 1: ./inline_exec_tmp
Inside ./03/args2.bin
arg 0: ./03/args2.bin
arg 1: hello
arg 2: world</code></pre>
            <p><code>args1.c</code> is</p>
            <div class="sourceCode" id="cb146"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>prog <span class="op">=</span> <span class="st">&quot;./03/args2.bin&quot;</span><span class="op">;</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">**</span>args<span class="op">;</span>        <span class="co">/* an array of strings */</span></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Inside </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> argv<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* lets just pass the arguments on through to args2! */</span></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> calloc<span class="op">(</span>argc <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">char</span> <span class="op">*));</span></span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>args<span class="op">);</span></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>    args<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> prog<span class="op">;</span></span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> argc<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>        args<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> argv<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a>    args<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> NULL<span class="op">;</span> <span class="co">/* the arguments need to be `NULL`-terminated */</span></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>execvp<span class="op">(</span>prog<span class="op">,</span> args<span class="op">))</span> <span class="op">{</span></span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;exec&quot;</span><span class="op">);</span></span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-32"><a href="#cb146-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb146-33"><a href="#cb146-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>…and <code>args2.c</code> is</p>
            <div class="sourceCode" id="cb147"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Inside </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> argv<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> argc<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;arg </span><span class="sc">%d</span><span class="st">: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> i<span class="op">,</span> argv<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>So we see the following.</p>
            <ul>
            <li>It is <em>convention</em> that the first argument to a
            program is always the program itself. The shell will
            <em>always</em> ensure that this is the case (NB: the shell
            <code>exec</code>s your programs).</li>
            <li>The rest of the arguments are passed as separate entries
            in the array of arguments.</li>
            <li>The <code>v</code> variants of <code>exec</code> require
            the <code>NULL</code> termination of the argument array,
            something that is easy to mess up!</li>
            </ul>
            <p>Parsing through the command-line arguments can be a
            little annoying, and <code>getopt</code> can help.</p>
            <h2 data-number="5.7" id="environment-variables"><span
            class="header-section-number">5.7</span> Environment
            Variables</h2>
            <p>Environment variables are UNIX’s means of providing
            configuration information to any process that might want it.
            They are a key-value store<a href="#fn8"
            class="footnote-ref" id="fnref8"
            role="doc-noteref"><sup>8</sup></a> that maps an environment
            variable to its value (both are strings).</p>
            <p>Environment variables are used to make configuration
            information accessible to programs. They are used instead of
            command-line arguments when:</p>
            <ul>
            <li>You don’t want the user worrying about passing the
            variable to a program. For example, you don’t want the user
            to have to pass their username along to every program as an
            argument.</li>
            <li>You don’t know which programs are going to use the
            configuration data, but <em>any</em> of them <em>could</em>.
            You don’t want to pass a bunch of command-line variables
            into each program, and expect them to pass them along to
            each child process.</li>
            </ul>
            <p>Example common environment variables include:</p>
            <ul>
            <li><code>PATH</code> - a <code>:</code>-separated list of
            file system paths to use to look for programs when attempt
            to execute a program.</li>
            <li><code>HOME</code> - the current user’s home directory
            (e.g. <code>/home/gparmer</code>).</li>
            <li><code>USER</code> - the username
            (e.g. <code>gparmer</code>).</li>
            <li><code>TEMP</code> - a directory that you can use to
            store temporary files.</li>
            </ul>
            <p>Many programs setup and use their own environment
            variables. Note that environment variables are pretty
            pervasively used – simple libraries exist to access them
            from <code>python</code>, <code>node.js</code>,
            <code>rust</code>, <code>java</code>, etc…</p>
            <p>You can easily access environment variables from the
            command line:</p>
            <pre><code>$ echo $HOME
/home/gparmer
$ export BESTPUP=penny
$ echo $BESTPUP
penny</code></pre>
            <p>Any program executed from that shell, will be able to
            access the “<code>BESTPUP</code>” environment variable. The
            <code>env</code> command dumps out all current environment
            variables.</p>
            <h3 data-number="5.7.1" id="environment-variable-apis"><span
            class="header-section-number">5.7.1</span> Environment
            Variable APIs</h3>
            <p>So how do we access the environment variable key-value
            store in C? The core functions for working with environment
            variables include:</p>
            <ul>
            <li><code>getenv</code> - Get an environment variable’s
            value.</li>
            <li><code>setenv</code> - Set one of environment variable’s
            value (used by the shell to set up children’s
            variables).</li>
            <li><code>clearenv</code> - Reset the entire
            environment.</li>
            <li><code>environ</code> array - This is the array of
            environment variables you’ll see in the <code>man</code>
            pages. You don’t want to access/modify this directly, but
            you can imagine it is used to back all of the previous
            calls.</li>
            </ul>
            <div class="sourceCode" id="cb149"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>u <span class="op">=</span> getenv<span class="op">(</span><span class="st">&quot;USER&quot;</span><span class="op">);</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>h <span class="op">=</span> getenv<span class="op">(</span><span class="st">&quot;HOME&quot;</span><span class="op">);</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>u <span class="op">&amp;&amp;</span> h<span class="op">);</span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;I am </span><span class="sc">%s</span><span class="st">, and I live in </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> u<span class="op">,</span> h<span class="op">);</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>First program, arg 1: ./inline_exec_tmp
Inside ./03/args2.bin
arg 0: ./03/args2.bin
arg 1: hello
arg 2: world</code></pre>
            <p>You can see all of the environmental variables available
            by default with:</p>
            <pre><code>$ env
SHELL=/bin/bash
DESKTOP_SESSION=ubuntu
EDITOR=emacs -nw
PWD=/home/gparmer/repos/gwu-cs-sysprog/22/lectures
LOGNAME=gparmer
HOME=/home/gparmer
USERNAME=gparmer
USER=gparmer
PATH=/home/gparmer/.local/bin::/home/gparmer/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin:/usr/racket/bin/
DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus
...</code></pre>
            <div class="sourceCode" id="cb152"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>u <span class="op">=</span> getenv<span class="op">(</span><span class="st">&quot;USER&quot;</span><span class="op">);</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>u<span class="op">);</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;user: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> u<span class="op">);</span></span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>setenv<span class="op">(</span><span class="st">&quot;USER&quot;</span><span class="op">,</span> <span class="st">&quot;penny&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;attempting setenv&quot;</span><span class="op">);</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fork<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>u <span class="op">=</span> getenv<span class="op">(</span><span class="st">&quot;USER&quot;</span><span class="op">);</span></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>args<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span> <span class="st">&quot;./03/envtest.bin&quot;</span><span class="op">,</span> <span class="st">&quot;USER&quot;</span><span class="op">,</span> NULL <span class="op">};</span></span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* environment is inherited across *both* `fork` and `exec`! */</span></span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;user (forked child): </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> u<span class="op">);</span></span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>        fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>execvp<span class="op">(</span><span class="st">&quot;./03/envtest.bin&quot;</span><span class="op">,</span> args<span class="op">))</span> <span class="op">{</span></span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a>            perror<span class="op">(</span><span class="st">&quot;exec&quot;</span><span class="op">);</span></span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb152-32"><a href="#cb152-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb152-33"><a href="#cb152-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-34"><a href="#cb152-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb152-35"><a href="#cb152-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>First program, arg 1: ./inline_exec_tmp
Inside ./03/args2.bin
arg 0: ./03/args2.bin
arg 1: hello
arg 2: world</code></pre>
            <p><code>03/envtest.c</code> is</p>
            <div class="sourceCode" id="cb154"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>argv<span class="op">[])</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>e <span class="op">=</span> <span class="st">&quot;NOARG&quot;</span><span class="op">;</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>v <span class="op">=</span> <span class="st">&quot;NOVAL&quot;</span><span class="op">;</span></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>argc <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>        e <span class="op">=</span> argv<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> getenv<span class="op">(</span>e<span class="op">);</span></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>v<span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>            v <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Environment variable </span><span class="sc">%s</span><span class="st"> -&gt; </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> e<span class="op">,</span> v<span class="op">);</span></span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>A common use of environment variables is the “home”
            directory in your shell. How is this implemented?</p>
            <pre><code>$ cd ~</code></pre>
            <p>The <code>~</code> means “my home directory”. To
            understand what directory is a user’s home directory, you
            can <code>getenv(HOME)</code>!</p>
            <h3 data-number="5.7.2"
            id="an-aside-creating-processes-with-posix_spawn"><span
            class="header-section-number">5.7.2</span> An Aside:
            Creating Processes with <code>posix_spawn</code></h3>
            <p><code>fork</code> and <code>exec</code> are not the only
            functions to execute a program. <code>posix_spawn</code>
            also enables the creation of a new process that execute a
            given program. <code>posix_spawn</code> performs three
            high-level actions:</p>
            <ol type="1">
            <li><code>fork</code> to create a new process,</li>
            <li>a set of “file actions” that update and modify the
            files/descriptors for the new process, that are specified in
            an array argument to <code>posix_spawn</code>, and</li>
            <li><code>exec</code> to execute a program and pass
            arguments/environmental variables.</li>
            </ol>
            <p>It is strictly <em>more limited</em> in what it can do
            than <code>fork</code> and <code>exec</code>, but this is
            often a feature not a bug. <code>fork</code> is really hard
            to use well, and can be quite confusing to use. It is
            considered by some to be a <a
            href="https://www.microsoft.com/en-us/research/uploads/prod/2019/04/fork-hotos19.pdf">flawed
            API</a>. Thus the focus of <code>posix_spawn</code> on
            specific executing a new program can be quite useful to
            simply programs.</p>
            <h2 data-number="5.8"
            id="representations-of-processes"><span
            class="header-section-number">5.8</span> Representations of
            Processes</h2>
            <p>We’ve seen how to create and manage processes and how to
            execute programs. Amazingly, modern systems have pretty
            spectacular facilities for <em>introspection</em> into
            executing processes. Introspection facilities generally let
            you dive into something as it runs. The most immediate
            example of this is <code>gdb</code> or any debugger that let
            you dive into an implementation. Looking at
            <code>pause.c</code>:</p>
            <div class="sourceCode" id="cb156"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">int</span> global_readonly <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> global <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> stack_allocated<span class="op">;</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>heap <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;pid </span><span class="sc">%d\n</span><span class="st">global (RO):</span><span class="sc">\t%p\n</span><span class="st">global:      </span><span class="sc">\t%p\n</span><span class="st">stack:      </span><span class="sc">\t%p\n</span><span class="st">heap:      </span><span class="sc">\t%p\n</span><span class="st">function:</span><span class="sc">\t%p\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>           getpid<span class="op">(),</span> <span class="op">&amp;</span>global_readonly<span class="op">,</span> <span class="op">&amp;</span>global<span class="op">,</span> <span class="op">&amp;</span>stack_allocated<span class="op">,</span> heap<span class="op">,</span> main<span class="op">);</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>    pause<span class="op">();</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>pid 9310
global (RO):    0x55be6d40b008
global:         0x55be6d40d014
stack:          0x7ffc7abafc7c
heap:           0x55be6da162a0
function:       0x55be6d40a1c9</code></pre>
            <p>Lets take the process identifier, and <em>dive into the
            process!</em> The “<code>proc</code> filesystem” in Linux is
            a part of the file system devoted to representing processes.
            There is a subdirectly in it for each process in the system.
            Lets check out process <code>9310</code>.</p>
            <pre><code>$ cd /proc/9310/
$ ls
arch_status  cgroup      coredump_filter  exe      io         maps       mountstats  oom_adj        patch_state  sched      smaps         statm    timers
attr         clear_refs  cpuset           fd       limits     mem        net         oom_score      personality  schedstat  smaps_rollup  status   timerslack_ns
autogroup    cmdline     cwd              fdinfo   loginuid   mountinfo  ns          oom_score_adj  projid_map   sessionid  stack         syscall  uid_map
auxv         comm        environ          gid_map  map_files  mounts     numa_maps   pagemap        root         setgroups  stat          task     wchan
$ cat maps
55be6d409000-55be6d40a000 r--p 00000000 08:02 1315893                    /home/ycombinator/repos/gwu-cs-sysprog/22/lectures/03/pause.bin
55be6d40a000-55be6d40b000 r-xp 00001000 08:02 1315893                    /home/ycombinator/repos/gwu-cs-sysprog/22/lectures/03/pause.bin
55be6d40b000-55be6d40c000 r--p 00002000 08:02 1315893                    /home/ycombinator/repos/gwu-cs-sysprog/22/lectures/03/pause.bin
55be6d40c000-55be6d40d000 r--p 00002000 08:02 1315893                    /home/ycombinator/repos/gwu-cs-sysprog/22/lectures/03/pause.bin
55be6d40d000-55be6d40e000 rw-p 00003000 08:02 1315893                    /home/ycombinator/repos/gwu-cs-sysprog/22/lectures/03/pause.bin
55be6da16000-55be6da37000 rw-p 00000000 00:00 0                          [heap]
7ff4a127f000-7ff4a12a4000 r--p 00000000 08:02 11797912                   /lib/x86_64-linux-gnu/libc-2.31.so
7ff4a12a4000-7ff4a141c000 r-xp 00025000 08:02 11797912                   /lib/x86_64-linux-gnu/libc-2.31.so
7ff4a141c000-7ff4a1466000 r--p 0019d000 08:02 11797912                   /lib/x86_64-linux-gnu/libc-2.31.so
7ff4a1466000-7ff4a1467000 ---p 001e7000 08:02 11797912                   /lib/x86_64-linux-gnu/libc-2.31.so
7ff4a1467000-7ff4a146a000 r--p 001e7000 08:02 11797912                   /lib/x86_64-linux-gnu/libc-2.31.so
7ff4a146a000-7ff4a146d000 rw-p 001ea000 08:02 11797912                   /lib/x86_64-linux-gnu/libc-2.31.so
7ff4a146d000-7ff4a1473000 rw-p 00000000 00:00 0
7ff4a1495000-7ff4a1496000 r--p 00000000 08:02 11797896                   /lib/x86_64-linux-gnu/ld-2.31.so
7ff4a1496000-7ff4a14b9000 r-xp 00001000 08:02 11797896                   /lib/x86_64-linux-gnu/ld-2.31.so
7ff4a14b9000-7ff4a14c1000 r--p 00024000 08:02 11797896                   /lib/x86_64-linux-gnu/ld-2.31.so
7ff4a14c2000-7ff4a14c3000 r--p 0002c000 08:02 11797896                   /lib/x86_64-linux-gnu/ld-2.31.so
7ff4a14c3000-7ff4a14c4000 rw-p 0002d000 08:02 11797896                   /lib/x86_64-linux-gnu/ld-2.31.so
7ff4a14c4000-7ff4a14c5000 rw-p 00000000 00:00 0
7ffc7ab90000-7ffc7abb1000 rw-p 00000000 00:00 0                          [stack]
7ffc7abe1000-7ffc7abe4000 r--p 00000000 00:00 0                          [vvar]
7ffc7abe4000-7ffc7abe5000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0                  [vsyscall]</code></pre>
            <p>There’s a <strong>lot</strong> going on here. The most
            important parts of the <em>ranges</em> of addresses on the
            left that tell us where we can find the
            <code>pause.bin</code> program’s code, read-only global
            data, global read-writable data, heap, and stack! We also
            see that the number of maps in a very simple process is
            surprisingly large. Let me manually focus in on a few parts
            of this.</p>
            <pre><code>...
55be6d40a000-55be6d40b000 r-xp ... /03/pause.bin &lt;-- &amp;main      (0x55be6d40a1c9)
55be6d40b000-55be6d40c000 r--p ... /03/pause.bin &lt;-- &amp;global_ro (0x55be6d40b008)
...
55be6d40d000-55be6d40e000 rw-p ... /03/pause.bin &lt;-- &amp;global    (0x55be6d40d014)
...
55be6da16000-55be6da37000 rw-p ... [heap]        &lt;-- heap       (0x55be6da162a0)
...
7ff4a14c4000-7ff4a14c5000 rw-p ...
7ffc7ab90000-7ffc7abb1000 rw-p ... [stack]       &lt;-- stack      (0x7ffc7abafc7c)
...</code></pre>
            <p>We can see that each of the variables we’re accessing in
            the program are at addresses that correspond to the
            <em>ranges</em> of memory in the <code>maps</code>. Even
            more, the <code>/proc/9310/mem</code> file contains <em>the
            actual memory for the process</em>! This is really amazing:
            we can watch the memory, even as it changes, as a process
            actually executes. This is how debuggers work!</p>
            <p>As you can see, <em>processes are data</em> too!</p>
            <h2 data-number="5.9" id="process-exercises"><span
            class="header-section-number">5.9</span> Process
            Exercises</h2>
            <h3 data-number="5.9.1"
            id="exercise-1-fibonacci-with-fork"><span
            class="header-section-number">5.9.1</span> Exercise 1:
            fibonacci with <code>fork</code></h3>
            <p>Implement <code>forkonacci</code>! This will solve the
            <code>n</code>th <a
            href="https://en.wikipedia.org/wiki/Fibonacci_number">fibonacci
            number</a>, using <code>fork</code> for the recursion, and a
            combination of <code>exit</code> to “return” and
            <code>wait</code> to retrieve the returned value, instead of
            function calls. The normal recursive implementation:</p>
            <div class="sourceCode" id="cb160"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>fibonacci<span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> n<span class="op">)</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>n <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> n <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="cf">return</span> n<span class="op">;</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fibonacci<span class="op">(</span>n <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">+</span> fibonacci<span class="op">(</span>n <span class="op">-</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>This will work decently for <code>n &lt;= 12</code>, but
            not for <code>n &gt; 12</code>. Why<a href="#fn9"
            class="footnote-ref" id="fnref9"
            role="doc-noteref"><sup>9</sup></a>?</p>
            <h3 data-number="5.9.2"
            id="exercise-2-shell-support-for-environment-variables"><span
            class="header-section-number">5.9.2</span> Exercise 2: Shell
            Support for Environment Variables</h3>
            <p>How do you think that the shell-based support for
            environment variables (<code>export BESTPUP=penny</code>) is
            implemented? Specifically, if we do the following…</p>
            <pre><code>$ export BESTPUP=penny
$ ./03/envtest.bin BESTPUP  // this just prints the environment variable
Environment variable BESTPUP -&gt; penny</code></pre>
            <p>…which process is using which APIs? Put another way, how
            is <code>export</code> implemented?</p>
            <h3 data-number="5.9.3"
            id="exercise-3-process-detective"><span
            class="header-section-number">5.9.3</span> Exercise 3:
            Process Detective</h3>
            <p>The <code>/proc</code> filesystem is a treasure trove of
            information. You can dive into the process with
            <code>pid</code> <code>N</code>’s information in
            <code>/proc/N/</code>. You’ll only have access to the
            informationx for your processes. So how do you find the
            <code>pid</code> of your processes? You can find the
            <code>pid</code> of all of the processes that belong to you
            using
            <code>ps aux | grep gparmer  | awk '{print $2}'</code><a
            href="#fn10" class="footnote-ref" id="fnref10"
            role="doc-noteref"><sup>10</sup></a>, but replacing your
            username for <code>gparmer</code>.</p>
            <p>Choose one of those, and go into its directory in
            <code>/proc</code>. It it doesn’t work, you might have
            chosen a process that has terminated since you find its ID.
            Try again.</p>
            <p>What do you think the following files contain:</p>
            <ul>
            <li><code>cmdline</code></li>
            <li><code>environ</code></li>
            <li><code>status</code></li>
            </ul>
            <p>Some of the files are <em>binary</em>, which means you
            might need to use <code>xxd</code> (a hexdecimal binary view
            program) to look at them. In <code>xxd</code>, pay attention
            to the right column here.</p>
            <h2 data-number="5.10" id="executing-other-processes"><span
            class="header-section-number">5.10</span> Executing Other
            Processes</h2>
            <p><a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/execve.html">Slides</a></p>
            <p><code>fork()</code> only makes clones of <em>itself</em>.
            So, we’re limited to the functions defined in that program.
            A shell can execute <strong>other programs</strong>! Recall
            the difference between a program and process: - program →
            <strong>compiled</strong> version of code - process →
            program <strong>executing</strong> in memory</p>
            <p>So, we want to create a new process and then
            <strong>execute a new program</strong>. This is done via the
            <code>exec()</code> <em>family</em> of calls:</p>
            <div class="sourceCode" id="cb162"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>     <span class="dt">int</span> execl<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg0<span class="op">,</span> <span class="op">...,</span> <span class="co">/*, (char *)0, */</span><span class="op">);</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>     <span class="dt">int</span> execle<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg0<span class="op">,</span> <span class="op">...,</span> <span class="co">/* (char *)0 char *const envp[] */</span><span class="op">);</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>     <span class="dt">int</span> execlp<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg0<span class="op">,</span> <span class="op">...,</span> <span class="co">/*, (char *)0, */</span><span class="op">);</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>     <span class="dt">int</span> execv<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[]);</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>     <span class="dt">int</span> execvp<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[]);</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>     <span class="dt">int</span> execvP<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>search_path<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[]);</span></span></code></pre></div>
            <p>They are defined in <code>&lt;unistd.h&gt;</code>.</p>
            <p>These calls will do the following: - Stop executing in
            the current process. - Reclaim all memory within the current
            process. - Load the target program into the process. - Start
            executing in the target program (i.e. starting normally,
            resulting in <code>main</code> execution).</p>
            <p><strong>Note:</strong> the main insight is that the
            <strong>same process continues execution</strong> but
            <strong>it now executes a new program</strong>.</p>
            <h3 data-number="5.10.1" id="sequence-of-operations"><span
            class="header-section-number">5.10.1</span> Sequence of
            operations</h3>
            <ol type="1">
            <li>initial process executing [parent]</li>
            </ol>
            <p><img src="figures/process.png" width="200"></p>
            <ol start="2" type="1">
            <li><code>fork()</code> a new process [child]:</li>
            </ol>
            <p><img src="figures/process.png" width="200">
            <img src="figures/process.png" width="200"></p>
            <ol start="3" type="1">
            <li>replace <strong>old</strong> code [child]</li>
            </ol>
            <p><img src="figures/process.png" width="200">
            <img src="figures/execve1.png" width="200"></p>
            <ol start="4" type="1">
            <li>with <strong>new</strong> code [child]</li>
            </ol>
            <p><img src="figures/process.png" width="200">
            <img src="figures/execve2.png" width="200"></p>
            <ol start="5" type="1">
            <li>with <strong>new</strong> code [child]</li>
            </ol>
            <p><img src="figures/process.png" width="200">
            <img src="figures/execve3.png" width="200"></p>
            <ol start="6" type="1">
            <li>reclaim resources [child]</li>
            </ol>
            <p><img src="figures/process.png" width="200">
            <img src="figures/execve4.png" width="200"></p>
            <ol start="7" type="1">
            <li>execute <strong>new</strong> program [child | from
            <code>main()</code>]</li>
            </ol>
            <p><img src="figures/process.png" width="200">
            <img src="figures/execve5.png" width="200"></p>
            <p><br></p>
            <p>A few handy side-effects:</p>
            <ul>
            <li>The execution of the new program inherits the process
            identifier (<code>pid_t</code>) and the parent/child
            relationships of the process.</li>
            <li>Comparably, the <em>descriptors</em> are inherited into
            the new program’s execution.</li>
            <li>The environment variables (see section below) pass to
            the new program’s execution.</li>
            <li>Many other process properties are comparably inherited.
            With the exception of the process memory, you can assume, by
            default, that process properties are inherited across an
            <code>exec</code>.</li>
            </ul>
            <p><strong>Good</strong> side effects | Shared Resources</p>
            <p><img src="figures/process.png" width="200">
            <img src="figures/execve6.png" width="200"></p>
            <p><br></p>
            <p><strong>Note:</strong> only memory <strong>not</strong>
            shared | Resources not Shared</p>
            <p><img src="figures/process.png" width="200">
            <img src="figures/execve7.png" width="200"></p>
            <p><br></p>
            <figure>
            <img src="./figures/exec_agentxform.gif"
            alt="Matrix Agent Exec" />
            <figcaption aria-hidden="true">Matrix Agent
            Exec</figcaption>
            </figure>
            <blockquote>
            <p><strong>Detour</strong>: Variadic functions.</p>
            <p>Sometimes, <em>we don’t know how many arguments are
            needed for a function</em>, <em>e.g.</em>,
            <code>printf()</code>. Also, command line functions,
            <em>e.g.,</em> <code>ls</code> vs <code>ls -l</code>. In
            this instance, the shell is calling <code>fork()</code> and
            one of the <code>exec()</code> functions to launch
            <code>ls</code> which starts from…its own
            <code>main()</code>.</p>
            <p>So, how does <code>ls</code> (or any other program) know
            what arguments are passed to it, and more importantly,
            <strong>how many</strong>?</p>
            <p>The <em>actual</em> signature of <code>main()</code> is:
            <code>C DNE int main( int argc, char* argv[] )</code> -
            <code>argc</code> tells us <em>now many</em> arguments have
            been passed and - <code>char* argv[]</code> is the actual
            set of arguments, i.e. <em>an array of strings</em>!</p>
            <p><strong>Note</strong>: the <em>first</em> argument is
            always the <strong>name of the program</strong>! Hence, we
            always have <em>at least one</em> argument.</p>
            </blockquote>
            <div class="sourceCode" id="cb163"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * exec() family of system calls | arguments to main()</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-14"><a href="#cb163-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span> <span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> argv<span class="op">[]</span> <span class="op">)</span> </span>
<span id="cb163-15"><a href="#cb163-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb163-16"><a href="#cb163-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> argc <span class="op">)</span></span>
<span id="cb163-17"><a href="#cb163-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb163-18"><a href="#cb163-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// we get a positive number of arguments</span></span>
<span id="cb163-19"><a href="#cb163-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// note that the first argument is always the name of the program</span></span>
<span id="cb163-20"><a href="#cb163-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// so we ALWAYS have AT LEAST ONE argument</span></span>
<span id="cb163-21"><a href="#cb163-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-22"><a href="#cb163-22" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span> <span class="st">&quot;Command Line Args received:</span><span class="sc">\t</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb163-23"><a href="#cb163-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span> i <span class="op">&lt;</span> argc <span class="op">;</span> <span class="op">++</span>i <span class="op">)</span></span>
<span id="cb163-24"><a href="#cb163-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb163-25"><a href="#cb163-25" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st"> &quot;</span><span class="op">,</span> argv<span class="op">[</span>i<span class="op">]</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb163-26"><a href="#cb163-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb163-27"><a href="#cb163-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> </span>
<span id="cb163-28"><a href="#cb163-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-29"><a href="#cb163-29" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb163-30"><a href="#cb163-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb163-31"><a href="#cb163-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <h2 data-number="5.11" id="exec_-family"><span
            class="header-section-number">5.11</span>
            <code>exec_()</code> family</h2>
            <p>Multiple ways to launch a new program: -
            <code>execl</code> - <code>execlp</code> -
            <code>execle</code> - <code>execv</code> -
            <code>execvp</code></p>
            <p>The naming scheme is quite annoying and hard to remember,
            but the <code>man</code> page has a decent summary. The
            trailing characters correspond to specific operations that
            differ in how the command-line arguments are passed to the
            <code>main</code>:</p>
            <ol type="1">
            <li><code>execl()</code> and <code>execlp()</code>: pass the
            argmuments <em>directly</em> to the <code>exec()</code>
            call:</li>
            </ol>
            <div class="sourceCode" id="cb164"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a> <span class="dt">int</span> execl<span class="op">(</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg<span class="op">,</span> <span class="op">...,</span> <span class="op">(</span><span class="dt">char</span><span class="op">*)</span><span class="dv">0</span> <span class="op">)</span> <span class="op">;</span></span></code></pre></div>
            <p>The program gets the argument via the <code>argc</code>
            and <code>argv</code> method described earlier.</p>
            <p><strong>Note:</strong> the last argument has to be
            <code>(char*)0</code>, <em>i.e.,</em> a <code>NULL</code>.
            This is so that the progam can figure out when the list of
            arguments is done.</p>
            <ol start="2" type="1">
            <li><code>execv()</code> and <code>execvp()</code>: pass
            argmuments in <strong>null terminated array</strong>,
            <code>argv[]</code></li>
            </ol>
            <div class="sourceCode" id="cb165"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execv<span class="op">(</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>path<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[]</span> <span class="op">)</span> <span class="op">;</span></span></code></pre></div>
            <p>The caller <em>actually creates</em> an <strong>array of
            strings</strong> and passes the arguments using that.</p>
            <p><strong>Note:</strong> <em>no <code>NULL</code>
            termination</em> in the function call.</p>
            <ol start="3" type="1">
            <li><code>execle()</code> and <code>execvpe()</code>:
            <strong>environment variables</strong> of caller are
            passed</li>
            </ol>
            <div class="sourceCode" id="cb166"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execle<span class="op">(</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>pathname<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>arg<span class="op">,</span> <span class="op">...</span><span class="co">/*, (char *) NULL, char *const envp[] */</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execvpe<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[],</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> envp<span class="op">[])</span> <span class="op">;</span></span></code></pre></div>
            <p>(<code>l</code> means pass the arguments to this
            <code>exec</code> call to the program, while <code>v</code>
            means pass the arguments as an array of the arguments into
            the <code>exec</code> call), how the program’s path is
            specified (by default, an “absolute path” starting with
            <code>/</code> must be used, but in a <code>v</code>
            variant, the binary is looked up using comparable logic to
            your shell), and how environment variables are passed to the
            program. For now, we’ll simply use <code>execvp</code>, and
            cover the rest in subsequent sections.</p>
            <h3 data-number="5.11.1" id="execve"><span
            class="header-section-number">5.11.1</span>
            <code>execve()</code></h3>
            <p>All of the above are layers on top of
            <code>execve()</code></p>
            <div class="sourceCode" id="cb167"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;unistd.h&quot;</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> execve<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>pathname<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> argv<span class="op">[],</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span><span class="dt">const</span> envp<span class="op">[]);</span></span></code></pre></div>
            <h3 data-number="5.11.2" id="fork-and-exec"><span
            class="header-section-number">5.11.2</span>
            <code>fork()</code> and <code>exec()</code></h3>
            <p>Consider the following piece of code:</p>
            <div class="sourceCode" id="cb168"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * exec() </span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span><span class="pp">     </span><span class="co">// fork(), getpid()</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span><span class="pp">  </span><span class="co">// pid_t</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span><span class="pp">   </span><span class="co">// wait()</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span><span class="pp">     </span><span class="co">// exit()</span></span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a><span class="co">// int main() // not actual signature</span></span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span> <span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> argv<span class="op">[]</span> <span class="op">)</span></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> program <span class="op">=</span> <span class="st">&quot;/bin/ls&quot;</span> <span class="op">;</span></span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> arg1 <span class="op">=</span> <span class="st">&quot;-al&quot;</span> <span class="op">;</span></span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> arg2 <span class="op">=</span> <span class="st">&quot;/home&quot;</span> <span class="op">;</span></span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;BEFORE EXEC!</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret <span class="op">=</span> execl<span class="op">(</span> program<span class="op">,</span> <span class="st">&quot;banana&quot;</span><span class="op">,</span> arg1<span class="op">,</span> arg2<span class="op">,</span> NULL <span class="op">)</span> <span class="op">;</span></span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;AFTER EXEC!</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb168-28"><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p><strong>Note:</strong> the
            <code>printf( "AFTER EXEC!\n" ) ;</code> and further code
            will <strong>never</strong> execute as the code for the
            <em>current</em> process is <strong>completely
            replaced</strong> by the code for the program called using
            <code>execl()</code>, <em>i.e.,</em>
            <code>/bin/ls</code>.</p>
            <p>So, to get the behavior that <em>we want</em>,
            <em>i.e.,</em> for some post-processing/messages,
            <em>etc.</em>, we must first <code>fork()</code> and new
            child process and then run <code>execl()</code> <strong>in
            the child process</strong>!</p>
            <p>Updating the previous code:</p>
            <div class="sourceCode" id="cb169"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * exec() </span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span><span class="pp">     </span><span class="co">// fork(), getpid()</span></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span><span class="pp">  </span><span class="co">// pid_t</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span><span class="pp">   </span><span class="co">// wait()</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span><span class="pp">     </span><span class="co">// exit()</span></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a><span class="co">// int main() // not actual signature</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span> <span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> argv<span class="op">[]</span> <span class="op">)</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> program <span class="op">=</span> <span class="st">&quot;/bin/ls&quot;</span> <span class="op">;</span></span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> arg1 <span class="op">=</span> <span class="st">&quot;-al&quot;</span> <span class="op">;</span></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> arg2 <span class="op">=</span> <span class="st">&quot;/home&quot;</span> <span class="op">;</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;BEFORE EXEC!</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a>    pid_t child <span class="op">=</span> fork<span class="op">()</span> <span class="op">;</span></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> <span class="op">!</span>child<span class="op">)</span></span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// in child process</span></span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> ret <span class="op">=</span> execl<span class="op">(</span> program<span class="op">,</span> <span class="st">&quot;banana&quot;</span><span class="op">,</span> arg1<span class="op">,</span> arg2<span class="op">,</span> NULL <span class="op">)</span> <span class="op">;</span></span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ideally never comes here!</span></span>
<span id="cb169-30"><a href="#cb169-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// as the child process&#39; code has now been replaced</span></span>
<span id="cb169-31"><a href="#cb169-31" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;what happened!&quot;</span><span class="op">)</span> <span class="op">;</span></span>
<span id="cb169-32"><a href="#cb169-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb169-33"><a href="#cb169-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-34"><a href="#cb169-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> status <span class="op">;</span></span>
<span id="cb169-35"><a href="#cb169-35" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> wait<span class="op">(&amp;</span>status<span class="op">)</span> <span class="op">;</span></span>
<span id="cb169-36"><a href="#cb169-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-37"><a href="#cb169-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> WIFEXITED<span class="op">(</span>status<span class="op">)</span> <span class="op">)</span></span>
<span id="cb169-38"><a href="#cb169-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb169-39"><a href="#cb169-39" aria-hidden="true" tabindex="-1"></a>            <span class="co">// the child exited normally</span></span>
<span id="cb169-40"><a href="#cb169-40" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span> <span class="st">&quot;--PARENT--: Child </span><span class="sc">%d</span><span class="st"> exited with status </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb169-41"><a href="#cb169-41" aria-hidden="true" tabindex="-1"></a>                    pid<span class="op">,</span> WEXITSTATUS<span class="op">(</span>status<span class="op">)</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb169-42"><a href="#cb169-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb169-43"><a href="#cb169-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-44"><a href="#cb169-44" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;AFTER EXEC!</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb169-45"><a href="#cb169-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-46"><a href="#cb169-46" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb169-47"><a href="#cb169-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb169-48"><a href="#cb169-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <h3 data-number="5.11.3"
            id="launch-any-child-processes"><span
            class="header-section-number">5.11.3</span> Launch
            <strong>Any</strong> Child Processes</h3>
            <p>If we have <strong>another</strong> program that we’ve
            written, <em>e.g.</em>, <code>child1.c</code>:</p>
            <div class="sourceCode" id="cb170"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * exec() child 1</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> argv<span class="op">[])</span></span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Does nothing. Just prints the arguments passed to this program */</span></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;INSIDE CHILD 1: argc = </span><span class="sc">%d</span><span class="st">, argv[0] = </span><span class="sc">%s</span><span class="st">, argv[1] = </span><span class="sc">%s</span><span class="st">, argv[2] = </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>                                            argc<span class="op">,</span> argv<span class="op">[</span><span class="dv">0</span><span class="op">],</span> argv<span class="op">[</span><span class="dv">1</span><span class="op">],</span> argv<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Once it is compiled and linked and ready as an
            executable, say, <code>child1</code>, we can do:</p>
            <div class="sourceCode" id="cb171"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * exec() </span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span><span class="pp">     </span><span class="co">// fork(), getpid()</span></span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span><span class="pp">  </span><span class="co">// pid_t</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span><span class="pp">   </span><span class="co">// wait()</span></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span><span class="pp">     </span><span class="co">// exit()</span></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a><span class="co">// int main() // not actual signature</span></span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span> <span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> argv<span class="op">[]</span> <span class="op">)</span></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> program <span class="op">=</span> <span class="st">&quot;./child1&quot;</span> <span class="op">;</span></span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> args <span class="op">=</span> <span class="st">&quot;hello&quot;</span> <span class="op">;</span></span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> args2 <span class="op">=</span> <span class="st">&quot;world&quot;</span> <span class="op">;</span></span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-20"><a href="#cb171-20" aria-hidden="true" tabindex="-1"></a>    pid_t child <span class="op">=</span> fork<span class="op">()</span> <span class="op">;</span></span>
<span id="cb171-21"><a href="#cb171-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-22"><a href="#cb171-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> <span class="op">!</span>child<span class="op">)</span></span>
<span id="cb171-23"><a href="#cb171-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb171-24"><a href="#cb171-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// in child process</span></span>
<span id="cb171-25"><a href="#cb171-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> ret <span class="op">=</span> execl<span class="op">(</span> program<span class="op">,</span> <span class="st">&quot;banana&quot;</span><span class="op">,</span> args<span class="op">,</span> args2<span class="op">,</span> NULL <span class="op">)</span> <span class="op">;</span></span>
<span id="cb171-26"><a href="#cb171-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-27"><a href="#cb171-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ideally never comes here!</span></span>
<span id="cb171-28"><a href="#cb171-28" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;what happened!&quot;</span><span class="op">)</span> <span class="op">;</span></span>
<span id="cb171-29"><a href="#cb171-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb171-30"><a href="#cb171-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-31"><a href="#cb171-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> status <span class="op">;</span></span>
<span id="cb171-32"><a href="#cb171-32" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">=</span> wait<span class="op">(&amp;</span>status<span class="op">)</span> <span class="op">;</span></span>
<span id="cb171-33"><a href="#cb171-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-34"><a href="#cb171-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> WIFEXITED<span class="op">(</span>status<span class="op">)</span> <span class="op">)</span></span>
<span id="cb171-35"><a href="#cb171-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb171-36"><a href="#cb171-36" aria-hidden="true" tabindex="-1"></a>            <span class="co">// the child exited normally</span></span>
<span id="cb171-37"><a href="#cb171-37" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span> <span class="st">&quot;--PARENT--: Child </span><span class="sc">%d</span><span class="st"> exited with status </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb171-38"><a href="#cb171-38" aria-hidden="true" tabindex="-1"></a>                    pid<span class="op">,</span> WEXITSTATUS<span class="op">(</span>status<span class="op">)</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb171-39"><a href="#cb171-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb171-40"><a href="#cb171-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-41"><a href="#cb171-41" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb171-42"><a href="#cb171-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb171-43"><a href="#cb171-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <h1 data-number="6" id="process-descriptors"><span
            class="header-section-number">6</span> Process
            Descriptors</h1>
            <p><a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/process_descriptors.html">Slides</a></p>
            <p>We’re going to start discussing how processes can
            <strong>manipulate the resources</strong> it has access
            to.</p>
            <h3 data-number="6.0.1" id="key-mechanisms"><span
            class="header-section-number">6.0.1</span> Key
            Mechanisms</h3>
            <p>for a process to use effectively</p>
            <ul>
            <li>current working directory, <code>pwd</code></li>
            <li>ability to manipulate <strong>descriptors</strong>
            <ul>
            <li>“file descriptors”</li>
            </ul></li>
            <li>controlling “exceptional” control flow, via
            <strong>signals</strong></li>
            </ul>
            <h3 data-number="6.0.2" id="current-working-directory"><span
            class="header-section-number">6.0.2</span> current working
            directory</h3>
            <ul>
            <li>each process has a “working directory”</li>
            <li>base for any relative pathrs</li>
            <li>all file system paths are one of,
            <ul>
            <li>absolute paths → they begin with “/”</li>
            <li>relative paths</li>
            </ul></li>
            </ul>
            <p>Relative paths are quite frequently used when we interact
            with the shell. Every time you type <code>cd blah/</code>,
            you’re saying “please change the current working directory
            to <code>blah/</code>” which is a directory in the current
            working directory.</p>
            <p>A simple API to interact with the current working
            directory: |function| operation | |——–|——–| |
            <code>getcwd</code>| gets the current process’ working dir |
            | <code>chdir</code>| enables process to change dir | ||</p>
            <p>both defined in <code>&lt;unistd.h&gt;</code>.</p>
            <p>A quick listing of the <em>directory structure</em> of
            Linux: <img src="figures/linux-dir.png" height="400"></p>
            <p>Let’s look at a simple code example:</p>
            <div class="sourceCode" id="cb172"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>wd <span class="op">=</span> getcwd<span class="op">(</span>NULL<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>wd<span class="op">);</span></span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Current directory: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> wd<span class="op">);</span></span>
<span id="cb172-12"><a href="#cb172-12" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>wd<span class="op">);</span></span>
<span id="cb172-13"><a href="#cb172-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-14"><a href="#cb172-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>chdir<span class="op">(</span><span class="st">&quot;..&quot;</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb172-15"><a href="#cb172-15" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;chdir&quot;</span><span class="op">);</span></span>
<span id="cb172-16"><a href="#cb172-16" aria-hidden="true" tabindex="-1"></a>        abort<span class="op">();</span></span>
<span id="cb172-17"><a href="#cb172-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb172-18"><a href="#cb172-18" aria-hidden="true" tabindex="-1"></a>    wd <span class="op">=</span> getcwd<span class="op">(</span>NULL<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb172-19"><a href="#cb172-19" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;New current dir: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> wd<span class="op">);</span></span>
<span id="cb172-20"><a href="#cb172-20" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>wd<span class="op">);</span></span>
<span id="cb172-21"><a href="#cb172-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-22"><a href="#cb172-22" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb172-23"><a href="#cb172-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb172-24"><a href="#cb172-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p><br></p>
            <p><strong>Note:</strong> the command <code>cd</code> is
            actually <strong>not</strong> a program, and is instead a
            <em>shell-internal function</em>. Try using the
            <code>which</code> program (used to find the location of a
            <em>known</em> program):</p>
            <pre><code>$ which ls
/bin/ls
$ which pwd
/bin/pwd
$ which cd
$</code></pre>
            <h3 data-number="6.0.3" id="process-descriptors-1"><span
            class="header-section-number">6.0.3</span> Process
            Descriptors</h3>
            <ul>
            <li>each process has a set of
            <strong>descriptors</strong></li>
            <li>associated with a system resource
            <ul>
            <li>integer → passed to a family of APIs</li>
            </ul></li>
            </ul>
            <p><img src="figures/process.png" height="300"></p>
            <p><br></p>
            <p>Most processes have <strong>at least</strong> three:
            |number | descriptor | What it is | |——–|——–|——–|
            |<code>0</code> | <code>STDIN_FILENO</code> | standard
            <strong>input</strong> | |<code>1</code> |
            <code>STDOUT_FILENO</code> | standard
            <strong>output</strong> | |<code>2</code> |
            <code>STDERR_FILENO</code> | standard <strong>error</strong>
            <code>perror()</code>| ||</p>
            <p>defined in <code>unistd.h</code>.</p>
            <h4 data-number="6.0.3.1"
            id="standard-input-output-and-error"><span
            class="header-section-number">6.0.3.1</span> Standard
            <strong>input</strong>, <strong>output</strong> and
            <strong>error</strong></h4>
            <ul>
            <li><em>infinite</em> sequence of bytes or “channels”</li>
            <li>can terminate, if they run out of data
            <ul>
            <li><em>e.g.</em>, reaches end of file</li>
            <li>user hits <code>ctrl-d</code></li>
            </ul></li>
            </ul>
            <p>When we type at the shell, we’re providing a channel of
            data that is sent to the standard input of the active
            process. When a process prints, it sends a sequence of
            characters to the standard output, and because programs can
            loop, that stream can be <strong>infinite</strong>!</p>
            <p><code>STDIN_FILENO</code> = <code>0</code> is the
            <em>standard input</em>, or the main way the process gets
            input from the system. As such, the resource is often the
            terminal if the user directly provides input, or sometimes
            the output of a previous stage in a command-line pipeline.
            <code>STDOUT_FILENO</code> = <code>1</code> is the
            <em>standard output</em>, or the main way the process sends
            its output to the system. When we call <code>printf</code>,
            it will, by default, output using this descriptor.
            <code>STDERR_FILENO</code> = <code>2</code> is the
            <em>standard error</em>, or the main way that the process
            outputs error messages. <code>perror</code> (and other
            error-centric APIs) output to the standard error.</p>
            <p>Each of these descriptors is associated with a
            potentially infinite sequence of bytes, or
            <em>channel</em><a href="#fn11" class="footnote-ref"
            id="fnref11" role="doc-noteref"><sup>11</sup></a>. When we
            type at the shell, we’re providing a channel of data that is
            sent to the standard input of the active process. When a
            process prints, it sends a sequence of characters to the
            standard output, and because programs can loop, that stream
            can be infinite! Channels, however, <em>can</em> terminate
            if they run out of data. This could happen, for example, if
            a channel reading through a file reaches the end of the
            file, or if the user hits <code>cntl-d</code> on their
            terminal to signify “I don’t have any more data”.</p>
            <h3 data-number="6.0.4"
            id="file-descriptor-operations"><span
            class="header-section-number">6.0.4</span> File Descriptor
            Operations</h3>
            <p>Now these are <strong>file descriptors</strong> so we
            treat them as <strong>files</strong>!</p>
            <p>File descriptors are <em>analogous</em> to pointers. The
            descriptors effectively <em>point to channel
            resources</em>.</p>
            <p>Some core operations on files: |operation| interface |
            |———|———–| |<strong>pull</strong> bytes from channel into
            buffer | <code>read</code> | |<strong>send</strong> bytes
            from channel into buffer | <code>write</code>
            |<strong>duplicate</strong> a file descriptor |
            <code>dup/dup2/dup3</code> | |<strong>deallocate</strong> a
            file descriptor | <code>close</code> | ||</p>
            <p><strong>Note:</strong>: - <code>printf()</code> is a
            <code>write</code> to standard out - <code>close</code>
            doesn’t necessarily remove channel - analogous to removing a
            pointer</p>
            <h4 data-number="6.0.4.1" id="dup-vs-dup2-vs-dup3"><span
            class="header-section-number">6.0.4.1</span>
            <code>dup()</code> vs <code>dup2()</code> vs
            <code>dup3()</code></h4>
            <ul>
            <li><code>dup()</code> returns smallest unused number as
            <code>fd</code></li>
            <li><code>dup2()</code> same as dup() but uses given
            <code>fd</code></li>
            <li>if given <code>fd</code> exists, then it is closed,
            <em>atomically</em></li>
            <li><code>dup3()</code> same as <code>dup2()</code> but
            takes flags as input</li>
            </ul>
            <p>Look at the <code>man dup</code> page for more
            information.</p>
            <p>Let’s see some of these calls in action:</p>
            <div class="sourceCode" id="cb174"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>hw <span class="op">=</span> <span class="st">&quot;hello world</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> output<span class="op">[</span><span class="dv">256</span><span class="op">];</span></span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd<span class="op">;</span></span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ssize_t</span> amnt<span class="op">;</span> <span class="co">/* signed size */</span></span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a>    amnt <span class="op">=</span> write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> hw<span class="op">,</span> strlen<span class="op">(</span>hw<span class="op">));</span></span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>amnt <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> <span class="co">/* maybe STDOUT writes to a file with no disk space! */</span></span>
<span id="cb174-17"><a href="#cb174-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* this is *not* an error, so errno not set! */</span></span>
<span id="cb174-18"><a href="#cb174-18" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;Cannot write more data to channel</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb174-19"><a href="#cb174-19" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb174-20"><a href="#cb174-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>amnt <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb174-21"><a href="#cb174-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* normally, the return value tells us how much was written */</span></span>
<span id="cb174-22"><a href="#cb174-22" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>amnt <span class="op">==</span> <span class="op">(</span><span class="dt">ssize_t</span><span class="op">)</span>strlen<span class="op">(</span>hw<span class="op">));</span></span>
<span id="cb174-23"><a href="#cb174-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="co">/* amnt == -1 */</span></span>
<span id="cb174-24"><a href="#cb174-24" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;Error writing to stdout&quot;</span><span class="op">);</span></span>
<span id="cb174-25"><a href="#cb174-25" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb174-26"><a href="#cb174-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb174-27"><a href="#cb174-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-28"><a href="#cb174-28" aria-hidden="true" tabindex="-1"></a>    amnt <span class="op">=</span> write<span class="op">(</span>STDERR_FILENO<span class="op">,</span> hw<span class="op">,</span> strlen<span class="op">(</span>hw<span class="op">));</span></span>
<span id="cb174-29"><a href="#cb174-29" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>amnt <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb174-30"><a href="#cb174-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-31"><a href="#cb174-31" aria-hidden="true" tabindex="-1"></a>    fd <span class="op">=</span> dup<span class="op">(</span>STDOUT_FILENO<span class="op">);</span></span>
<span id="cb174-32"><a href="#cb174-32" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>fd <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb174-33"><a href="#cb174-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-34"><a href="#cb174-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* We can write formatted data out to stdout manually! */</span></span>
<span id="cb174-35"><a href="#cb174-35" aria-hidden="true" tabindex="-1"></a>    snprintf<span class="op">(</span>output<span class="op">,</span> <span class="dv">255</span><span class="op">,</span> <span class="st">&quot;in: </span><span class="sc">%d</span><span class="st">, out: </span><span class="sc">%d</span><span class="st">, err: </span><span class="sc">%d</span><span class="st">, new: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb174-36"><a href="#cb174-36" aria-hidden="true" tabindex="-1"></a>             STDIN_FILENO<span class="op">,</span> STDOUT_FILENO<span class="op">,</span> STDERR_FILENO<span class="op">,</span> fd<span class="op">);</span></span>
<span id="cb174-37"><a href="#cb174-37" aria-hidden="true" tabindex="-1"></a>    output<span class="op">[</span><span class="dv">255</span><span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb174-38"><a href="#cb174-38" aria-hidden="true" tabindex="-1"></a>    amnt <span class="op">=</span> write<span class="op">(</span>fd<span class="op">,</span> output<span class="op">,</span> strlen<span class="op">(</span>output<span class="op">));</span></span>
<span id="cb174-39"><a href="#cb174-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* new file descriptors are supposed to use the lowest unused descriptor! */</span></span>
<span id="cb174-40"><a href="#cb174-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-41"><a href="#cb174-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* make a descriptor available */</span></span>
<span id="cb174-42"><a href="#cb174-42" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>STDIN_FILENO<span class="op">);</span> <span class="co">/* STDIN is no longer really the input! */</span></span>
<span id="cb174-43"><a href="#cb174-43" aria-hidden="true" tabindex="-1"></a>    fd <span class="op">=</span> dup<span class="op">(</span>STDOUT_FILENO<span class="op">);</span></span>
<span id="cb174-44"><a href="#cb174-44" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;New descriptor @ </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> fd<span class="op">);</span></span>
<span id="cb174-45"><a href="#cb174-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-46"><a href="#cb174-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb174-47"><a href="#cb174-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>You can run this, and redirect the standard error to a
            file to see that writing to standard error is a different
            operation than writing to standard output. For example:
            <code>$ prog 2&gt; errors.txt</code> will redirect file
            descriptor <code>2</code> (stderr) to the file.</p>
            <p>Lets focus in a little bit on <code>read</code> and
            <code>write</code>. First, it is notable that the buffer
            they take as an argument (along with its length) is simply
            an array of bytes. It can be a string, or it could be the
            bytes that are part of an encoded video. Put another way, by
            default, <em>channels are just sequences of bytes</em>. It
            is up to our program to interpret those bytes properly.</p>
            <p>Second, we need to understand that the return value for
            <code>read</code>/<code>write</code> has four main,
            interesting conditions:</p>
            <div class="sourceCode" id="cb175"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stddef.h&gt;</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ssize_t</span> amnt<span class="op">;</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>hi <span class="op">=</span> <span class="st">&quot;more complicated than you&#39;d think...&quot;</span><span class="op">;</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ssize_t</span> hi_sz <span class="op">=</span> strlen<span class="op">(</span>hi<span class="op">);</span></span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>    amnt <span class="op">=</span> write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> hi<span class="op">,</span> hi_sz<span class="op">);</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Can often mean that we are not able to write to the resource */</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>amnt <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a><span class="co">         * Keep trying to write, or give up.</span></span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a><span class="co">         * Common return value for `read` when a file has no more data, or a pipe is closed.</span></span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>amnt <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> amnt <span class="op">&lt;</span> hi_sz<span class="op">)</span> <span class="op">{</span></span>
<span id="cb175-22"><a href="#cb175-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb175-23"><a href="#cb175-23" aria-hidden="true" tabindex="-1"></a><span class="co">         * Didn&#39;t write everythign we wanted, better call write again sending</span></span>
<span id="cb175-24"><a href="#cb175-24" aria-hidden="true" tabindex="-1"></a><span class="co">         * data starting at `&amp;hi[amnt]`, of length `hi_sz - amnt`.</span></span>
<span id="cb175-25"><a href="#cb175-25" aria-hidden="true" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb175-26"><a href="#cb175-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>amnt <span class="op">==</span> hi_sz<span class="op">)</span> <span class="op">{</span></span>
<span id="cb175-27"><a href="#cb175-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb175-28"><a href="#cb175-28" aria-hidden="true" tabindex="-1"></a><span class="co">         * Wrote out everything! Wooo!</span></span>
<span id="cb175-29"><a href="#cb175-29" aria-hidden="true" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb175-30"><a href="#cb175-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="co">/* amnt == -1 */</span></span>
<span id="cb175-31"><a href="#cb175-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Could be a genuine error, but not always... */</span></span>
<span id="cb175-32"><a href="#cb175-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>errno <span class="op">==</span> EPIPE <span class="op">||</span> errno <span class="op">==</span> EAGAIN <span class="op">||</span> errno <span class="op">==</span> EINTR <span class="op">||</span> errno <span class="op">==</span> EWOULDBLOCK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb175-33"><a href="#cb175-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">/* conditions we should probably handle properly */</span></span>
<span id="cb175-34"><a href="#cb175-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb175-35"><a href="#cb175-35" aria-hidden="true" tabindex="-1"></a>            <span class="co">/* error in the channel! */</span></span>
<span id="cb175-36"><a href="#cb175-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb175-37"><a href="#cb175-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb175-38"><a href="#cb175-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-39"><a href="#cb175-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb175-40"><a href="#cb175-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>It is common to have a convention on how channel data is
            structured. UNIX pipeline encourage channels to be plain
            text, so that each program can read from their standard
            input, do some processing that can involved filtering out
            data or transforming it, and send the result to the standard
            out. That standard output is sent to the standard input of
            the next process in the pipeline. An example in which we
            print out each unique program that is executing on the
            system:</p>
            <pre><code>$ ps aux | tr -s &#39; &#39; | cut -d &#39; &#39; -f 11 | sort | uniq</code></pre>
            <p>Each of the programs in the pipeline is not configured to
            print out each unique process, and we are able to compose
            them together in a pipeline to accomplish the goal.</p>
            <h2 data-number="6.1" id="pipes"><span
            class="header-section-number">6.1</span> Pipes</h2>
            <p><a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/pipes.html">Slides</a></p>
            <p>Processes have resources</p>
            <p><img src="figures/process.png" height="300"></p>
            <p>Note that descriptors <code>0-2</code> are automatically
            set up: - <code>STDIN_FILENO</code> -
            <code>STDOUT_FILENO</code> - <code>STDERR_FILENO</code></p>
            <p>But how do we <em>create</em> resources? But first off,
            <strong>what</strong> are resources? There are many
            different resources in a UNIX system, but three of the main
            ones:</p>
            <ol type="1">
            <li><code>files</code> and other file-system objects
            (e.g. directories),</li>
            <li><code>sockets</code> that are used to communicate over
            the network, and</li>
            <li>communication facilities like <code>pipe</code>s that
            are used to send data and coordinate between processes.</li>
            </ol>
            <p>Each of these has very different APIs for creating the
            resources. We’ll discuss files later, and will now focus on
            <strong><code>pipe</code>s</strong>.</p>
            <p>We’ve seen pipes before:</p>
            <pre><code>$ ps aux | tr -s &#39; &#39; | cut -d &#39; &#39; -f 11 | sort | uniq</code></pre>
            <p>(look up each of those commands).</p>
            <p>Not what we’re talking about…well, not exactly!</p>
            <h3 data-number="6.1.1" id="unix-pipes"><span
            class="header-section-number">6.1.1</span> unix ‘pipes’</h3>
            <p>(short for “<em>pipelines</em>”)</p>
            <p>A finite <em>channel</em> → a sequence of bytes:</p>
            <p><img src="figures/pipes4.png" height="75"></p>
            <p>A pipe is accessed using <strong>two (file)
            descriptors</strong><a href="#fn12" class="footnote-ref"
            id="fnref12" role="doc-noteref"><sup>12</sup></a>,</p>
            <table>
            <thead>
            <tr class="header">
            <th>descriptor</th>
            <th>function</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>fd[0]</code></td>
            <td>read</td>
            </tr>
            <tr class="even">
            <td><code>fd[1]</code></td>
            <td>write</td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>This can be represented as follows:</p>
            <p><img src="figures/pipes6.png" height="75"></p>
            <p>The sequence of bytes written to the pipe will be
            correspondingly read out <em>in a FIFO</em> manner.</p>
            <h3 data-number="6.1.2" id="pipes-api"><span
            class="header-section-number">6.1.2</span> pipes api</h3>
            <div class="sourceCode" id="cb178"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> pipe<span class="op">(</span> <span class="dt">int</span> pipefd<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">)</span> <span class="op">;</span></span></code></pre></div>
            <p>defined in <code>&lt;unistd.h&gt;</code>.</p>
            <p>The <code>pipe</code> and <code>pipe2</code> functions
            create a pipe resource, and return the two file descriptors
            that reference the readable and writable ends of the
            pipe.</p>
            <p><strong>Return values</strong></p>
            <table>
            <thead>
            <tr class="header">
            <th>value</th>
            <th>meaning</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>0</code></td>
            <td>success</td>
            </tr>
            <tr class="even">
            <td><code>1</code></td>
            <td>failed</td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>We use a familiar interface to send/receive data from a
            pipe, <em>viz.</em>, <code>read()</code> and
            <code>write()</code>.</p>
            <p>Let’s look at a simple example of how to use a
            <code>pipe</code>.</p>
            <div class="sourceCode" id="cb179"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to pipes</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/param.h&gt;</span><span class="pp"> </span><span class="co">/* MIN */</span></span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#define BUFFER_SIZE </span><span class="dv">16</span></span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> from<span class="op">[</span>BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">}</span> <span class="op">;</span></span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> to<span class="op">[</span>BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">}</span> <span class="op">;</span></span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-22"><a href="#cb179-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> pipe_fds<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">;</span> <span class="co">// the two FDs for reading/writing</span></span>
<span id="cb179-23"><a href="#cb179-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-24"><a href="#cb179-24" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span> from<span class="op">,</span> <span class="ch">&#39;x&#39;</span><span class="op">,</span> BUFFER_SIZE<span class="op">-</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb179-25"><a href="#cb179-25" aria-hidden="true" tabindex="-1"></a>    memset <span class="op">(</span>to<span class="op">,</span> <span class="ch">&#39;-&#39;</span><span class="op">,</span> BUFFER_SIZE<span class="op">-</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb179-26"><a href="#cb179-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-27"><a href="#cb179-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> pipe<span class="op">(</span>pipe_fds<span class="op">)</span> <span class="op">)</span></span>
<span id="cb179-28"><a href="#cb179-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb179-29"><a href="#cb179-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// non zero is an error!</span></span>
<span id="cb179-30"><a href="#cb179-30" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;Pipe creation failed!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb179-31"><a href="#cb179-31" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_FAILURE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb179-32"><a href="#cb179-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb179-33"><a href="#cb179-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-34"><a href="#cb179-34" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;BEFORE</span><span class="sc">\n\t</span><span class="st"> from: </span><span class="sc">%s\n\t</span><span class="st"> to: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> from<span class="op">,</span> to <span class="op">)</span> <span class="op">;</span></span>
<span id="cb179-35"><a href="#cb179-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-36"><a href="#cb179-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ssize_t</span> write_return <span class="op">=</span> write<span class="op">(</span> pipe_fds<span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="op">&amp;</span>from<span class="op">,</span> BUFFER_SIZE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb179-37"><a href="#cb179-37" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> write_return <span class="op">==</span> BUFFER_SIZE <span class="op">)</span> <span class="op">;</span> <span class="co">// check how many bytes were written</span></span>
<span id="cb179-38"><a href="#cb179-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-39"><a href="#cb179-39" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ssize_t</span> read_return <span class="op">=</span> read<span class="op">(</span> pipe_fds<span class="op">[</span><span class="dv">0</span><span class="op">],</span> <span class="op">&amp;</span>to<span class="op">,</span> BUFFER_SIZE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb179-40"><a href="#cb179-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-41"><a href="#cb179-41" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;AFTER</span><span class="sc">\n\t</span><span class="st"> from: </span><span class="sc">%s\n\t</span><span class="st"> to: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> from<span class="op">,</span> to <span class="op">)</span> <span class="op">;</span></span>
<span id="cb179-42"><a href="#cb179-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-43"><a href="#cb179-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-44"><a href="#cb179-44" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb179-45"><a href="#cb179-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb179-46"><a href="#cb179-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Output, as expected:</p>
            <pre><code>BEFORE
         from: xxxxxxxxxxxxxxx
         to: ---------------
AFTER
         from: xxxxxxxxxxxxxxx
         to: xxxxxxxxxxxxxxx</code></pre>
            <p>Now, let’s change things a bit. Let’s make the
            <code>from</code> buffer really <strong>LARGE</strong>!</p>
            <div class="sourceCode" id="cb181"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to pipes</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/param.h&gt;</span><span class="pp"> </span><span class="co">/* MIN */</span></span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#define BUFFER_SIZE </span><span class="dv">16</span></span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#define LARGE_BUFFER_SIZE </span><span class="dv">1</span><span class="op">&lt;&lt;</span><span class="dv">18</span></span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb181-21"><a href="#cb181-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> from<span class="op">[</span>LARGE_BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">}</span> <span class="op">;</span></span>
<span id="cb181-22"><a href="#cb181-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> to<span class="op">[</span>BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">}</span> <span class="op">;</span></span>
<span id="cb181-23"><a href="#cb181-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-24"><a href="#cb181-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> pipe_fds<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">;</span> <span class="co">// the two FDs for reading/writing</span></span>
<span id="cb181-25"><a href="#cb181-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-26"><a href="#cb181-26" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span> from<span class="op">,</span> <span class="ch">&#39;x&#39;</span><span class="op">,</span> LARGE_BUFFER_SIZE<span class="op">-</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb181-27"><a href="#cb181-27" aria-hidden="true" tabindex="-1"></a>    memset <span class="op">(</span>to<span class="op">,</span> <span class="ch">&#39;-&#39;</span><span class="op">,</span> BUFFER_SIZE<span class="op">-</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb181-28"><a href="#cb181-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-29"><a href="#cb181-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> pipe<span class="op">(</span>pipe_fds<span class="op">)</span> <span class="op">)</span></span>
<span id="cb181-30"><a href="#cb181-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb181-31"><a href="#cb181-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// non zero is an error!</span></span>
<span id="cb181-32"><a href="#cb181-32" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;Pipe creation failed!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb181-33"><a href="#cb181-33" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_FAILURE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb181-34"><a href="#cb181-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb181-35"><a href="#cb181-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-36"><a href="#cb181-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ssize_t</span> write_return <span class="op">=</span> write<span class="op">(</span> pipe_fds<span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="op">&amp;</span>from<span class="op">,</span> LARGE_BUFFER_SIZE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb181-37"><a href="#cb181-37" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;Here!</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb181-38"><a href="#cb181-38" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> write_return <span class="op">==</span> LARGE_BUFFER_SIZE <span class="op">)</span> <span class="op">;</span> <span class="co">// check how many bytes were written</span></span>
<span id="cb181-39"><a href="#cb181-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-40"><a href="#cb181-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ssize_t</span> read_return <span class="op">=</span> read<span class="op">(</span> pipe_fds<span class="op">[</span><span class="dv">0</span><span class="op">],</span> <span class="op">&amp;</span>to<span class="op">,</span> BUFFER_SIZE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb181-41"><a href="#cb181-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-42"><a href="#cb181-42" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;AFTER</span><span class="sc">\n\t</span><span class="st"> to: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> from<span class="op">,</span> to <span class="op">)</span> <span class="op">;</span></span>
<span id="cb181-43"><a href="#cb181-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-44"><a href="#cb181-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-45"><a href="#cb181-45" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb181-46"><a href="#cb181-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb181-47"><a href="#cb181-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Output is empty and the program <strong>doesn’t
            terminate</strong>. Why? Two reasons:</p>
            <ol type="1">
            <li>the size of a pipe is <strong>limited</strong> (usually
            <code>64k</code> on moder linux)</li>
            <li><code>write()</code> <strong>blocks</strong> until a
            <code>read()</code> clears some space in the pipe
            buffer.</li>
            </ol>
            <p>You can get/set the size of the pipe buffer. See
            <code>man 7 pipe</code> for more details.</p>
            <p>so, what do we need to do? We need to
            <strong>clear</strong> the pipe buffer by using
            <code>read</code>.</p>
            <p>Why does this not work?</p>
            <div class="sourceCode" id="cb182"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to pipes</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/param.h&gt;</span><span class="pp"> </span><span class="co">/* MIN */</span></span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#define BUFFER_SIZE </span><span class="dv">16</span></span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#define LARGE_BUFFER_SIZE </span><span class="dv">1</span><span class="op">&lt;&lt;</span><span class="dv">18</span></span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb182-21"><a href="#cb182-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> from<span class="op">[</span>LARGE_BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">}</span> <span class="op">;</span></span>
<span id="cb182-22"><a href="#cb182-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> to<span class="op">[</span>LARGE_BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">}</span> <span class="op">;</span></span>
<span id="cb182-23"><a href="#cb182-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-24"><a href="#cb182-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> pipe_fds<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">;</span> <span class="co">// the two FDs for reading/writing</span></span>
<span id="cb182-25"><a href="#cb182-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-26"><a href="#cb182-26" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span> from<span class="op">,</span> <span class="ch">&#39;x&#39;</span><span class="op">,</span> LARGE_BUFFER_SIZE<span class="op">-</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb182-27"><a href="#cb182-27" aria-hidden="true" tabindex="-1"></a>    memset <span class="op">(</span>to<span class="op">,</span> <span class="ch">&#39;-&#39;</span><span class="op">,</span> LARGE_BUFFER_SIZE<span class="op">-</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb182-28"><a href="#cb182-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-29"><a href="#cb182-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> pipe<span class="op">(</span>pipe_fds<span class="op">)</span> <span class="op">)</span></span>
<span id="cb182-30"><a href="#cb182-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb182-31"><a href="#cb182-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// non zero is an error!</span></span>
<span id="cb182-32"><a href="#cb182-32" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;Pipe creation failed!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb182-33"><a href="#cb182-33" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_FAILURE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb182-34"><a href="#cb182-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb182-35"><a href="#cb182-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-36"><a href="#cb182-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ssize_t</span> write_return <span class="op">=</span> write<span class="op">(</span> pipe_fds<span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="op">&amp;</span>from<span class="op">,</span> LARGE_BUFFER_SIZE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb182-37"><a href="#cb182-37" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;Here!</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb182-38"><a href="#cb182-38" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> write_return <span class="op">==</span> LARGE_BUFFER_SIZE <span class="op">)</span> <span class="op">;</span> <span class="co">// check how many bytes were written</span></span>
<span id="cb182-39"><a href="#cb182-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-40"><a href="#cb182-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ssize_t</span> read_return <span class="op">=</span> read<span class="op">(</span> pipe_fds<span class="op">[</span><span class="dv">0</span><span class="op">],</span> <span class="op">&amp;</span>to<span class="op">,</span> LARGE_BUFFER_SIZE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb182-41"><a href="#cb182-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-42"><a href="#cb182-42" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb182-43"><a href="#cb182-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb182-44"><a href="#cb182-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Because the <code>write()</code> is <em>still
            blocked</em>! We haven’t cleared the pipe buffer. The
            <code>write()</code> call <em>has not returned</em> and so
            the <code>read()</code> call <em>cannot run</em>!</p>
            <p><strong>Note</strong>: this is not parallel
            execution!</p>
            <p>So, let’s fix it. By writing and reading inside a loop,
            using <strong>smaller chunks</strong> of read/write each
            time.</p>
            <div class="sourceCode" id="cb183"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to pipes</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/param.h&gt;</span><span class="pp"> </span><span class="co">/* MIN */</span></span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#define BUFFER_SIZE </span><span class="dv">16</span></span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#define LARGE_BUFFER_SIZE </span><span class="dv">1</span><span class="op">&lt;&lt;</span><span class="dv">18</span></span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-18"><a href="#cb183-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#define WRITE_CHUNK </span><span class="dv">1</span><span class="op">&lt;&lt;</span><span class="dv">8</span></span>
<span id="cb183-19"><a href="#cb183-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-20"><a href="#cb183-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-21"><a href="#cb183-21" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb183-22"><a href="#cb183-22" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb183-23"><a href="#cb183-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> from<span class="op">[</span>LARGE_BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">}</span> <span class="op">;</span></span>
<span id="cb183-24"><a href="#cb183-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> to<span class="op">[</span>LARGE_BUFFER_SIZE<span class="op">]</span> <span class="op">=</span> <span class="op">{</span><span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">}</span> <span class="op">;</span></span>
<span id="cb183-25"><a href="#cb183-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-26"><a href="#cb183-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> pipe_fds<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">;</span> <span class="co">// the two FDs for reading/writing</span></span>
<span id="cb183-27"><a href="#cb183-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-28"><a href="#cb183-28" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span> from<span class="op">,</span> <span class="ch">&#39;x&#39;</span><span class="op">,</span> LARGE_BUFFER_SIZE<span class="op">-</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-29"><a href="#cb183-29" aria-hidden="true" tabindex="-1"></a>    memset <span class="op">(</span>to<span class="op">,</span> <span class="ch">&#39;-&#39;</span><span class="op">,</span> LARGE_BUFFER_SIZE<span class="op">-</span><span class="dv">1</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-30"><a href="#cb183-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-31"><a href="#cb183-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> buffer_size <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>from<span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-32"><a href="#cb183-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-33"><a href="#cb183-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> pipe<span class="op">(</span>pipe_fds<span class="op">)</span> <span class="op">)</span></span>
<span id="cb183-34"><a href="#cb183-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb183-35"><a href="#cb183-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// non zero is an error!</span></span>
<span id="cb183-36"><a href="#cb183-36" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;Pipe creation failed!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-37"><a href="#cb183-37" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_FAILURE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-38"><a href="#cb183-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb183-39"><a href="#cb183-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-40"><a href="#cb183-40" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> written <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb183-41"><a href="#cb183-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span> buffer_size <span class="op">)</span></span>
<span id="cb183-42"><a href="#cb183-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb183-43"><a href="#cb183-43" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ssize_t</span> write_return<span class="op">,</span> read_return <span class="op">;</span></span>
<span id="cb183-44"><a href="#cb183-44" aria-hidden="true" tabindex="-1"></a>        <span class="dt">size_t</span> write_amount <span class="op">=</span> MIN<span class="op">(</span> buffer_size<span class="op">,</span> WRITE_CHUNK <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-45"><a href="#cb183-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-46"><a href="#cb183-46" aria-hidden="true" tabindex="-1"></a>        write_return <span class="op">=</span> write<span class="op">(</span> pipe_fds<span class="op">[</span><span class="dv">1</span><span class="op">],</span> <span class="op">&amp;</span>from<span class="op">[</span>written<span class="op">],</span> write_amount <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-47"><a href="#cb183-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span> write_return <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">)</span></span>
<span id="cb183-48"><a href="#cb183-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb183-49"><a href="#cb183-49" aria-hidden="true" tabindex="-1"></a>            perror<span class="op">(</span> <span class="st">&quot;Error writing to pipe!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-50"><a href="#cb183-50" aria-hidden="true" tabindex="-1"></a>            exit<span class="op">(</span>EXIT_FAILURE<span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-51"><a href="#cb183-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb183-52"><a href="#cb183-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-53"><a href="#cb183-53" aria-hidden="true" tabindex="-1"></a>        read_return <span class="op">=</span> read<span class="op">(</span> pipe_fds<span class="op">[</span><span class="dv">0</span><span class="op">],</span> <span class="op">&amp;</span>to<span class="op">[</span>written<span class="op">],</span> write_return <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-54"><a href="#cb183-54" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span> read_return <span class="op">==</span> write_return <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-55"><a href="#cb183-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-56"><a href="#cb183-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">// what&#39;s going on here?</span></span>
<span id="cb183-57"><a href="#cb183-57" aria-hidden="true" tabindex="-1"></a>        buffer_size <span class="op">-=</span> write_return <span class="op">;</span></span>
<span id="cb183-58"><a href="#cb183-58" aria-hidden="true" tabindex="-1"></a>        written <span class="op">+=</span> write_return <span class="op">;</span></span>
<span id="cb183-59"><a href="#cb183-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb183-60"><a href="#cb183-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-61"><a href="#cb183-61" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> memcmp<span class="op">(</span> from<span class="op">,</span> to<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>from<span class="op">)</span> <span class="op">)</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-62"><a href="#cb183-62" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;from and to are IDENTICAL!</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-63"><a href="#cb183-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-64"><a href="#cb183-64" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb183-65"><a href="#cb183-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb183-66"><a href="#cb183-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Now, let’s make this more interesting (and actually
            useful)! Let’s send data <strong>between processes</strong>,
            <strong>i.e.,</strong> using <code>fork()</code>!</p>
            <div class="sourceCode" id="cb184"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a><span class="co">/* Large array containing 2^20 characters */</span></span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> from<span class="op">[</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">20</span><span class="op">];</span></span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> to<span class="op">[</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">20</span><span class="op">];</span></span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> pipe_fds<span class="op">[</span><span class="dv">2</span><span class="op">];</span> <span class="co">/* see `man 3 pipe`: `[0]` = read end, `[1]` = write end */</span></span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>    pid_t pid<span class="op">;</span></span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> buf_sz <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>from<span class="op">);</span></span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pipe<span class="op">(</span>pipe_fds<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;pipe creation&quot;</span><span class="op">);</span></span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-22"><a href="#cb184-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* descriptors copied into each process during `fork`! */</span></span>
<span id="cb184-23"><a href="#cb184-23" aria-hidden="true" tabindex="-1"></a>    pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb184-24"><a href="#cb184-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-25"><a href="#cb184-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb184-26"><a href="#cb184-26" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;fork error&quot;</span><span class="op">);</span></span>
<span id="cb184-27"><a href="#cb184-27" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb184-28"><a href="#cb184-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> <span class="co">/* child */</span></span>
<span id="cb184-29"><a href="#cb184-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ssize_t</span> ret_w<span class="op">;</span></span>
<span id="cb184-30"><a href="#cb184-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-31"><a href="#cb184-31" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>pipe_fds<span class="op">[</span><span class="dv">0</span><span class="op">]);</span> <span class="co">/* we aren&#39;t reading! */</span></span>
<span id="cb184-32"><a href="#cb184-32" aria-hidden="true" tabindex="-1"></a>        ret_w <span class="op">=</span> write<span class="op">(</span>pipe_fds<span class="op">[</span><span class="dv">1</span><span class="op">],</span> from<span class="op">,</span> buf_sz<span class="op">);</span></span>
<span id="cb184-33"><a href="#cb184-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ret_w <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb184-34"><a href="#cb184-34" aria-hidden="true" tabindex="-1"></a>            perror<span class="op">(</span><span class="st">&quot;write to pipe&quot;</span><span class="op">);</span></span>
<span id="cb184-35"><a href="#cb184-35" aria-hidden="true" tabindex="-1"></a>            exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb184-36"><a href="#cb184-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb184-37"><a href="#cb184-37" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">((</span><span class="dt">size_t</span><span class="op">)</span>ret_w <span class="op">==</span> buf_sz<span class="op">);</span></span>
<span id="cb184-38"><a href="#cb184-38" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;Child sent whole message!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb184-39"><a href="#cb184-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="co">/* parent */</span></span>
<span id="cb184-40"><a href="#cb184-40" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ssize_t</span> ret_r<span class="op">;</span></span>
<span id="cb184-41"><a href="#cb184-41" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ssize_t</span> rest <span class="op">=</span> buf_sz<span class="op">,</span> offset <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb184-42"><a href="#cb184-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-43"><a href="#cb184-43" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>pipe_fds<span class="op">[</span><span class="dv">1</span><span class="op">]);</span> <span class="co">/* we aren&#39;t writing! */</span></span>
<span id="cb184-44"><a href="#cb184-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>rest <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb184-45"><a href="#cb184-45" aria-hidden="true" tabindex="-1"></a>            ret_r <span class="op">=</span> read<span class="op">(</span>pipe_fds<span class="op">[</span><span class="dv">0</span><span class="op">],</span> <span class="op">&amp;</span>to<span class="op">[</span>offset<span class="op">],</span> rest<span class="op">);</span></span>
<span id="cb184-46"><a href="#cb184-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>ret_r <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb184-47"><a href="#cb184-47" aria-hidden="true" tabindex="-1"></a>                perror<span class="op">(</span><span class="st">&quot;read from pipe&quot;</span><span class="op">);</span></span>
<span id="cb184-48"><a href="#cb184-48" aria-hidden="true" tabindex="-1"></a>                exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb184-49"><a href="#cb184-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb184-50"><a href="#cb184-50" aria-hidden="true" tabindex="-1"></a>            rest   <span class="op">-=</span> ret_r<span class="op">;</span></span>
<span id="cb184-51"><a href="#cb184-51" aria-hidden="true" tabindex="-1"></a>            offset <span class="op">+=</span> ret_r<span class="op">;</span></span>
<span id="cb184-52"><a href="#cb184-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb184-53"><a href="#cb184-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-54"><a href="#cb184-54" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;Parent got the message!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb184-55"><a href="#cb184-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb184-56"><a href="#cb184-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-57"><a href="#cb184-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb184-58"><a href="#cb184-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>First program, arg 1: ./inline_exec_tmp
Inside ./03/args2.bin
arg 0: ./03/args2.bin
arg 1: hello
arg 2: world</code></pre>
            <p>The <em>concurrency</em> of the system enables separate
            processes to be active at the same time, thus for the
            <code>write</code> and <code>read</code> to be transferring
            data through the pipe <em>at the same time</em>. This
            simplifies our code as we don’t need to worry about sending
            chunks of our data.</p>
            <p>Note that we’re <code>close</code>ing the end of the pipe
            that we aren’t using in the corresponding processes. Though
            the file descriptors are identical in each process following
            <code>fork</code>, each process does have a
            <em>separate</em> set of those descriptors. Thus closing in
            one, doesn’t impact the other.</p>
            <p>Remember, processes provide
            <strong>isolation</strong>!</p>
            <h3 data-number="6.1.3" id="the-shell"><span
            class="header-section-number">6.1.3</span> The Shell</h3>
            <p>We can start to understand part of how to a shell might
            be implemented now!</p>
            <p><strong>Setting up pipes.</strong> Lets start with the
            more obvious: for each <code>|</code> in a command, the
            shell will create a new <code>pipe</code>. It is a little
            less obvious to understand how the standard output for one
            process is hooked up through a <code>pipe</code> to the
            standard input of the next process. To do this, the shell
            does the following procedure:</p>
            <ol type="1">
            <li>Create a <code>pipe</code>.</li>
            <li><code>fork</code> the processes (a <code>fork</code> for
            each process in a pipeline).</li>
            <li>In the <em>upstream</em> process
            <code>close(STDOUT_FILENO)</code>, and <code>dup2</code> the
            writable file descriptor in the pipe into
            <code>STDOUT_FILENO</code>.</li>
            <li>In the <em>downstream</em> process
            <code>close(STDIN_FILENO)</code>, and <code>dup2</code> the
            readable file descriptor in the pipe into
            <code>STDIN_FILENO</code>.</li>
            </ol>
            <p>Due to this <em>careful</em> usage of <code>close</code>
            to get rid of the old standard in/out, and <code>dup</code>
            or <code>dup2</code> to methodically replace it with the
            pipe, we can see how the shell sets up the processes in a
            pipeline!</p>
            <p>Lets go over an example of setting up the file
            descriptors for a child process. This does <em>not</em> set
            up the pipe-based communication between <em>two
            children</em>, so is not sufficient for a shell; but it is
            well on the way. Pipes contain arbitrary streams of bytes,
            not just characters. This example will</p>
            <ol type="1">
            <li>setup the input and output of two files to communicate
            over a pipe, and</li>
            <li>send and receive binary data between processes.</li>
            </ol>
            <div class="sourceCode" id="cb186"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> perror_exit<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>s<span class="op">)</span></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>    perror<span class="op">(</span>s<span class="op">);</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fds<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>    pid_t pid<span class="op">;</span></span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* make the pipe before we fork, so we can acccess it in each process */</span></span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pipe<span class="op">(</span>fds<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> perror_exit<span class="op">(</span><span class="st">&quot;Opening pipe&quot;</span><span class="op">);</span></span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a>    pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> perror_exit<span class="op">(</span><span class="st">&quot;Forking process&quot;</span><span class="op">);</span></span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span>       <span class="co">/* child */</span></span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Same as above, but for standard output */</span></span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>STDOUT_FILENO<span class="op">);</span></span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>dup2<span class="op">(</span>fds<span class="op">[</span><span class="dv">1</span><span class="op">],</span> STDOUT_FILENO<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> perror_exit<span class="op">(</span><span class="st">&quot;child dup stdout&quot;</span><span class="op">);</span></span>
<span id="cb186-27"><a href="#cb186-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-28"><a href="#cb186-28" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>fds<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb186-29"><a href="#cb186-29" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>fds<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb186-30"><a href="#cb186-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-31"><a href="#cb186-31" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st"> </span><span class="sc">%c</span><span class="st"> </span><span class="sc">%x</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">42</span><span class="op">,</span> <span class="ch">&#39;+&#39;</span><span class="op">,</span> <span class="dv">42</span><span class="op">);</span></span>
<span id="cb186-32"><a href="#cb186-32" aria-hidden="true" tabindex="-1"></a>        fflush<span class="op">(</span>stdout<span class="op">);</span> <span class="co">/* make sure that we output to the stdout */</span></span>
<span id="cb186-33"><a href="#cb186-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-34"><a href="#cb186-34" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb186-35"><a href="#cb186-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>              <span class="co">/* parent */</span></span>
<span id="cb186-36"><a href="#cb186-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> a<span class="op">,</span> c<span class="op">;</span></span>
<span id="cb186-37"><a href="#cb186-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> b<span class="op">;</span></span>
<span id="cb186-38"><a href="#cb186-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-39"><a href="#cb186-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* close standard in... */</span></span>
<span id="cb186-40"><a href="#cb186-40" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>STDIN_FILENO<span class="op">);</span></span>
<span id="cb186-41"><a href="#cb186-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* ...and replace it with the input side of the pipe */</span></span>
<span id="cb186-42"><a href="#cb186-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>dup2<span class="op">(</span>fds<span class="op">[</span><span class="dv">0</span><span class="op">],</span> STDIN_FILENO<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> perror_exit<span class="op">(</span><span class="st">&quot;parent dup stdin&quot;</span><span class="op">);</span></span>
<span id="cb186-43"><a href="#cb186-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb186-44"><a href="#cb186-44" aria-hidden="true" tabindex="-1"></a><span class="co">         * if we don&#39;t close the pipes, the child will</span></span>
<span id="cb186-45"><a href="#cb186-45" aria-hidden="true" tabindex="-1"></a><span class="co">         * always wait for additional input</span></span>
<span id="cb186-46"><a href="#cb186-46" aria-hidden="true" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb186-47"><a href="#cb186-47" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>fds<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb186-48"><a href="#cb186-48" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>fds<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb186-49"><a href="#cb186-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-50"><a href="#cb186-50" aria-hidden="true" tabindex="-1"></a>        scanf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st"> </span><span class="sc">%c</span><span class="st"> </span><span class="sc">%x</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">&amp;</span>a<span class="op">,</span> <span class="op">&amp;</span>b<span class="op">,</span> <span class="op">&amp;</span>c<span class="op">);</span></span>
<span id="cb186-51"><a href="#cb186-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-52"><a href="#cb186-52" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st"> </span><span class="sc">%c</span><span class="st"> </span><span class="sc">%x</span><span class="st">&quot;</span><span class="op">,</span> a<span class="op">,</span> b<span class="op">,</span> c<span class="op">);</span></span>
<span id="cb186-53"><a href="#cb186-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>wait<span class="op">(</span>NULL<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> perror_exit<span class="op">(</span><span class="st">&quot;parent&#39;s wait&quot;</span><span class="op">);</span></span>
<span id="cb186-54"><a href="#cb186-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-55"><a href="#cb186-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-56"><a href="#cb186-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb186-57"><a href="#cb186-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>First program, arg 1: ./inline_exec_tmp
Inside ./03/args2.bin
arg 0: ./03/args2.bin
arg 1: hello
arg 2: world</code></pre>
            <p><strong>Closing pipes.</strong> <code>read</code>ing from
            a pipe will return that there is no more data on the pipe
            (i.e. return <code>0</code>) <em>only if all
            <code>write</code>-ends of the pipe are
            <code>close</code>d</em>.</p>
            <p>This makes sense because we think of a pipe as a
            potentially infinite stream of bytes, thus the only way the
            system can know that there are no more bytes to be
            <code>read</code>, is if the <code>write</code> end of the
            pipe cannot receive more data, i.e. if it is
            <code>close</code>d.</p>
            <p>This seems simple, in principle, but when implementing a
            shell, you use <code>dup</code> to make multiple copies of
            the <code>write</code> file descriptor. In this case, the
            shell must be very careful to close its own copies because
            <em>if any <code>write</code> end of a pipe is open, the
            reader will not realize when there is no more data
            left</em>. If you implement a shell, and it seems like
            commands are hanging, and not <code>exit</code>ing, this is
            likely why.</p>
            <figure>
            <img src="figures/pipe_proc.png"
            alt="A graphical sequence for the above code. Each image is a snapshot of the system after an operation is preformed. The red portions of each figure show what is changed in each operation. The parent creates a pipe, forks a child, which inherits a copy of all of the file descriptors (including the pipe), the parent and child close their stdin and stdout, respectively, the pipes descriptors are duped into those now vacant descriptors, and the pipe descriptors are closed. Now all processes are in a state where they can use their stdin/stdout/stderr descriptors as normal (scanf, printf), but the standard output from the child will get piped to the standard input of the parent. Shells do a similar set of operations, but in which a child has their standard output piped to the standard input of another child." />
            <figcaption aria-hidden="true">A graphical sequence for the
            above code. Each image is a snapshot of the system after an
            operation is preformed. The red portions of each figure show
            what is changed in each operation. The parent creates a
            pipe, forks a child, which inherits a copy of all of the
            file descriptors (including the pipe), the parent and child
            close their stdin and stdout, respectively, the pipes
            descriptors are <code>dup</code>ed into those now vacant
            descriptors, and the pipe descriptors are closed. Now all
            processes are in a state where they can use their
            stdin/stdout/stderr descriptors as normal
            (<code>scanf</code>, <code>printf</code>), but the standard
            output from the child will get piped to the standard input
            of the parent. Shells do a similar set of operations, but in
            which a child has their standard output piped to the
            standard input of another child.</figcaption>
            </figure>
            <p><strong>Question.</strong> If we wanted to have a parent,
            shell process setup two child connected by <code>|</code>,
            what would the <em>final</em> picture (in the image of the
            pictures above) look like?</p>
            <h2 data-number="6.2" id="signals"><span
            class="header-section-number">6.2</span> Signals</h2>
            <p><a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/signals.html">Slides</a></p>
            <p>We’re used to <em>sequential</em> execution in our
            processes. Each instruction executes after the previous in
            the “instruction stream”. However, systems also require
            <em>exceptional</em> execution patterns. What happens when
            you access memory that doesn’t exist
            (e.g. <code>*(int *)NULL</code>); when you divide by
            <code>0</code>; when a user types <code>cntl-c</code>; when
            a process terminates; or when you make a call to access a
            descriptor which somehow is not accessible outside of the
            call<a href="#fn13" class="footnote-ref" id="fnref13"
            role="doc-noteref"><sup>13</sup></a>?</p>
            <p>Consider the following code where we try to access
            (dereference) address <code>NULL</code>.</p>
            <div class="sourceCode" id="cb188"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to signals</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// some standard errors</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">*</span> a <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">*)</span>NULL <span class="op">;</span></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>a <span class="op">=</span> <span class="dv">10</span> <span class="op">;</span></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>What happens with the following code?</p>
            <div class="sourceCode" id="cb189"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to signals</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// some standard errors</span></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> div <span class="op">=</span> <span class="dv">100</span><span class="op">/</span><span class="dv">0</span> <span class="op">;</span></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb189-13"><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Programs <strong>crash</strong>! Unless you <em>plan</em>
            to “<strong>handle</strong>” it!</p>
            <h3 data-number="6.2.1" id="enter-signals"><span
            class="header-section-number">6.2.1</span> Enter
            ‘<strong>signals</strong>’</h3>
            <p>UNIX’s <strong>signals</strong> provide
            <em>asynchronous</em> execution in a process: - provide
            asynchronous execution - when a signal activates, - a
            “signal handler” function is activated - regardless of what
            was executing!</p>
            <p>Signals can be used for, - dealing with
            <em>exceptions</em>, <em>e.g.,</em> - invalid access →
            <code>*(int *)NULL</code> - divide by <code>0</code> -
            tracking time → <code>ualarm</code> - parent/child
            coordination → <code>SIGTERM</code> - …</p>
            <p>Let’s look at a basic setup for using signals:</p>
            <div class="sourceCode" id="cb190"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;signal.h&gt;</span><span class="pp"> </span><span class="co">/* sigaction and SIG* */</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a><span class="co">// this is the interface for the signal fault handler!</span></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sig_fault_handler<span class="op">(</span><span class="dt">int</span> signal_number<span class="op">,</span> siginfo_t <span class="op">*</span>info<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>context<span class="op">)</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* printf has problems here; see &quot;The Dark Side of Signals&quot; */</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;My downfall is the forbidden fruit at address </span><span class="sc">%p</span><span class="st">.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> info<span class="op">-&gt;</span>si_addr<span class="op">);</span></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Question: what happens if we comment this out? */</span></span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a>    sigset_t masked<span class="op">;</span></span>
<span id="cb190-22"><a href="#cb190-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> sigaction siginfo<span class="op">;</span></span>
<span id="cb190-23"><a href="#cb190-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb190-24"><a href="#cb190-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-25"><a href="#cb190-25" aria-hidden="true" tabindex="-1"></a>    sigemptyset<span class="op">(&amp;</span>masked<span class="op">);</span></span>
<span id="cb190-26"><a href="#cb190-26" aria-hidden="true" tabindex="-1"></a>    sigaddset<span class="op">(&amp;</span>masked<span class="op">,</span> SIGSEGV<span class="op">);</span></span>
<span id="cb190-27"><a href="#cb190-27" aria-hidden="true" tabindex="-1"></a>    siginfo <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> sigaction<span class="op">)</span> <span class="op">{</span></span>
<span id="cb190-28"><a href="#cb190-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_sigaction <span class="op">=</span> sig_fault_handler<span class="op">,</span></span>
<span id="cb190-29"><a href="#cb190-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_mask      <span class="op">=</span> masked<span class="op">,</span></span>
<span id="cb190-30"><a href="#cb190-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_flags     <span class="op">=</span> SA_RESTART <span class="op">|</span> SA_SIGINFO <span class="co">/* we&#39;ll see this later */</span></span>
<span id="cb190-31"><a href="#cb190-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb190-32"><a href="#cb190-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-33"><a href="#cb190-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>sigaction<span class="op">(</span>SIGSEGV<span class="op">,</span> <span class="op">&amp;</span>siginfo<span class="op">,</span> NULL<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb190-34"><a href="#cb190-34" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;sigaction error&quot;</span><span class="op">);</span></span>
<span id="cb190-35"><a href="#cb190-35" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb190-36"><a href="#cb190-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb190-37"><a href="#cb190-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-38"><a href="#cb190-38" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Lets live dangerously</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb190-39"><a href="#cb190-39" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> <span class="op">*(</span><span class="dt">int</span> <span class="op">*)</span>NULL<span class="op">;</span></span>
<span id="cb190-40"><a href="#cb190-40" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;I live!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb190-41"><a href="#cb190-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-42"><a href="#cb190-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb190-43"><a href="#cb190-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>First program, arg 1: ./inline_exec_tmp
Inside ./03/args2.bin
arg 0: ./03/args2.bin
arg 1: hello
arg 2: world</code></pre>
            <p>We can actually execute in the signal handler when we
            access invalid memory! We can write code to execute in
            response to a segmentation fault. This is how Java prints
            out a backtrace.</p>
            <p>Let’s explore the concepts in the above code and the
            <strong>signals interface</strong> in general.</p>
            <h3 data-number="6.2.2" id="signals-interface"><span
            class="header-section-number">6.2.2</span> Signals
            Interface</h3>
            <h4 data-number="6.2.2.1" id="sigset_t"><span
            class="header-section-number">6.2.2.1</span>
            <code>sigset_t</code></h4>
            <ul>
            <li>a bitmap → <strong>one bit per signal</strong></li>
            <li>used to program the <strong>signal mask</strong></li>
            <li>filled with <code>0</code>s or <code>1</code>s</li>
            </ul>
            <p><img src="figures/sigset2.png" height="25"></p>
            <table>
            <thead>
            <tr class="header">
            <th>value</th>
            <th>meaning</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><img src="figures/sigset3.png" height="25"></td>
            <td>signals <strong>can</strong> nest</td>
            </tr>
            <tr class="even">
            <td><img src="figures/sigset4.png" height="25"></td>
            <td>signals <strong>cannot</strong> nest</td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>Essentially….<code>sigset_t</code> tells us…when a signal
            executes, - can <em>others</em> occur? - if so, <em>which
            ones</em>?</p>
            <h4 data-number="6.2.2.2" id="sigset_t-functions"><span
            class="header-section-number">6.2.2.2</span>
            <code>sigset_t</code> functions</h4>
            <p>Defined in <code>&lt;signal.h&gt;</code> to manage the
            <code>sigset_t</code> data structure. |name|function|
            |—-|——–| |<code>sigemptyset</code>| initialize/empty the
            signal set <br> <em>i.e.</em>, “unmask” all|
            |<code>sigfullset</code>| initializefill the signal set <br>
            <em>i.e.</em>, “mask” all|<br />
            |<code>sigaddset</code>|add <em>specific</em> signal to set
            <br> <em>i.e.,</em> “mask” specific one|
            |<code>sigdelset</code>|remove <em>specific</em> signal from
            set <br> <em>i.e.,</em> “mask” specific one|
            |<code>sigismember</code>|checks whether given signal is
            <br> part of the set|</p>
            <h4 data-number="6.2.2.3" id="sig_fault_handler"><span
            class="header-section-number">6.2.2.3</span>
            <code>sig_fault_handler</code></h4>
            <ul>
            <li>the signal <code>"handler"</code></li>
            <li>function that is called <em>asynchronously</em>
            <ul>
            <li>when corresponding event happens</li>
            </ul></li>
            <li><strong>user defined</strong></li>
            </ul>
            <p>In the example of SIGSEGV above, here, the signal handler
            is called whenever we access invalid memory
            (e.g. segmentation fault).</p>
            <h4 data-number="6.2.2.4" id="sigaction"><span
            class="header-section-number">6.2.2.4</span>
            <code>sigaction</code></h4>
            <p>The function that sets up signal handler for a specific
            signal:</p>
            <div class="sourceCode" id="cb192"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;signal.h&quot;</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> sigaction<span class="op">(</span> <span class="dt">int</span> signum<span class="op">,</span> </span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>               <span class="dt">const</span> <span class="kw">struct</span> sigaction <span class="op">*</span><span class="dt">restrict</span> act<span class="op">,</span> </span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>               <span class="kw">struct</span> sigaction <span class="op">*</span><span class="dt">restrict</span> oldact <span class="op">)</span> <span class="op">;</span></span></code></pre></div>
            <h4 data-number="6.2.2.5" id="struct-sigaction"><span
            class="header-section-number">6.2.2.5</span>
            <code>struct sigaction</code></h4>
            <div class="sourceCode" id="cb193"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sigaction <span class="op">{</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>            <span class="dt">void</span>     <span class="op">(*</span>sa_handler<span class="op">)(</span><span class="dt">int</span><span class="op">);</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>            <span class="dt">void</span>     <span class="op">(*</span>sa_sigaction<span class="op">)(</span><span class="dt">int</span><span class="op">,</span> siginfo_t <span class="op">*,</span> <span class="dt">void</span> <span class="op">*);</span></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>            sigset_t   sa_mask<span class="op">;</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span>        sa_flags<span class="op">;</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">void</span>     <span class="op">(*</span>sa_restorer<span class="op">)(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="op">;</span></span></code></pre></div>
            <h4 data-number="6.2.2.6" id="sequence-of-actions"><span
            class="header-section-number">6.2.2.6</span> Sequence of
            Actions</h4>
            <p>…for using signals</p>
            <p><img src="figures/signal_handler9.png" height="300"></p>
            <h3 data-number="6.2.3" id="notable-signals"><span
            class="header-section-number">6.2.3</span> Notable
            Signals</h3>
            <p>There are signals for quite a few events. A list of all
            of the signals is listed in <code>man 7 signal</code> and
            <code>glibc</code> has decent <a
            href="https://www.gnu.org/software/libc/manual/html_node/Signal-Handling.html">documentation</a>.
            Notable signals include: |signal| description | |——–|——–|
            |<code>SIGCHILD</code> | child process terminated |
            |<code>SIGINT</code> | user typed <code>ctrl-c</code> |
            |<code>SIGSTOP/SIGCONT</code> | stop/continue child
            execution | |<code>SIGTSTP</code> | user typed
            <code>ctrl-z</code> | |<code>SIGTPIPE</code> | write to a
            pipe with no reader | |<code>SIGSEGV</code> | invalid memory
            access [segmentation fault] | |<code>SIGTERM/SIGKILL</code>
            | kill a process; SIGTERM can be caught,
            <strong>SIGKILL</strong> not | |<code>SIGHUP</code> | kill
            terminal that created shell | |<code>SIGALRM</code> |
            notification that time has passed |
            |<code>SIGUSR1/SIGUSR2</code> |
            <strong>user-defined</strong> signal handlers | ||</p>
            <p><strong>Note:</strong> <code>SIGKILL/SIGTOP</code> -
            cannot be “caught” - to deal with unresponsive processes -
            SIGCONT → continue process after SIGSTOP</p>
            <p>Each signal has a <em>default behavior</em> that triggers
            if you do not define a handler. These are: * ignore *
            terminate process * stop process from executing * continue
            execution</p>
            <h3 data-number="6.2.4" id="minor-detour-sa_sigaction"><span
            class="header-section-number">6.2.4</span> Minor Detour |
            <code>sa_sigaction</code></h3>
            <p>We have seen (and used) this struct:</p>
            <div class="sourceCode" id="cb194"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> sigaction <span class="op">{</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span>     <span class="op">(*</span>sa_handler<span class="op">)(</span><span class="dt">int</span><span class="op">);</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span>     <span class="op">(*</span>sa_sigaction<span class="op">)(</span><span class="dt">int</span><span class="op">,</span> siginfo_t <span class="op">*,</span> <span class="dt">void</span> <span class="op">*);</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>    sigset_t   sa_mask<span class="op">;</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>        sa_flags<span class="op">;</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span>     <span class="op">(*</span>sa_restorer<span class="op">)(</span><span class="dt">void</span><span class="op">);</span></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>inline_exec_tmp.c:3:35: error: unknown type name &#39;siginfo_t&#39;
    void     (*sa_sigaction)(int, siginfo_t *, void *);
                                  ^
inline_exec_tmp.c:4:5: error: unknown type name &#39;sigset_t&#39;
    sigset_t   sa_mask;
    ^
2 errors generated.
make[1]: *** [inline_exec_tmp] Error 1</code></pre>
            <p>Why <strong>two</strong> function pointers? -
            <code>(*sa_handler)</code> -
            <code>(*sa_sigaction)</code></p>
            <p>One takes <strong>more information</strong> than the
            other</p>
            <div class="sourceCode" id="cb196"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span>     <span class="op">(*</span>sa_handler<span class="op">)(</span><span class="dt">int</span><span class="op">);</span>`</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span>     <span class="op">(*</span>sa_sigaction<span class="op">)(</span><span class="dt">int</span><span class="op">,</span> siginfo_t <span class="op">*,</span> <span class="dt">void</span> <span class="op">*);</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>inline_exec_tmp.c:1:29: error: expected identifier or &#39;(&#39;
void     (*sa_handler)(int);`
                            ^
1 error generated.
make[1]: *** [inline_exec_tmp] Error 1</code></pre>
            <p>choice of which → depends on a <strong>flag</strong> that
            is set.</p>
            <h4 data-number="6.2.4.1" id="flags"><span
            class="header-section-number">6.2.4.1</span> Flags?</h4>
            <p>Provide flags to <code>sa_flags</code> member:</p>
            <table>
            <colgroup>
            <col style="width: 40%" />
            <col style="width: 60%" />
            </colgroup>
            <thead>
            <tr class="header">
            <th>flag</th>
            <th>result</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>SA_SIGINFO</code></td>
            <td>use the <code>*sa_sigaction</code> handler
            (<em>i.e.,</em> take more information)</td>
            </tr>
            <tr class="even">
            <td><code>SA_RESTART</code></td>
            <td>make sure system calls are ‘<em>restartable</em>’</td>
            </tr>
            <tr class="odd">
            <td>(many others)</td>
            <td>…</td>
            </tr>
            <tr class="even">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p><code>man 2 sigaction</code> for more details.</p>
            <h3 data-number="6.2.5" id="signals-further-examples"><span
            class="header-section-number">6.2.5</span> Signals | Further
            Examples</h3>
            <h4 data-number="6.2.5.1"
            id="tracking-time-with-signals"><span
            class="header-section-number">6.2.5.1</span> Tracking Time
            with Signals</h4>
            <p>Now let’s use another signal, <code>SIGALRM</code>. Use
            the following code example:</p>
            <div class="sourceCode" id="cb198"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to signals</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;signal.h&gt;</span></span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb198-12"><a href="#cb198-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb198-13"><a href="#cb198-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-14"><a href="#cb198-14" aria-hidden="true" tabindex="-1"></a><span class="co">// why volatile?</span></span>
<span id="cb198-15"><a href="#cb198-15" aria-hidden="true" tabindex="-1"></a><span class="dt">volatile</span> <span class="dt">int</span> timers <span class="op">=</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb198-16"><a href="#cb198-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-17"><a href="#cb198-17" aria-hidden="true" tabindex="-1"></a><span class="co">// the signal hanlder</span></span>
<span id="cb198-18"><a href="#cb198-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> my_timer_handler<span class="op">(</span> <span class="dt">int</span> signal_number<span class="op">,</span> siginfo_t<span class="op">*</span> info<span class="op">,</span></span>
<span id="cb198-19"><a href="#cb198-19" aria-hidden="true" tabindex="-1"></a>                                            <span class="dt">void</span><span class="op">*</span> context <span class="op">)</span></span>
<span id="cb198-20"><a href="#cb198-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb198-21"><a href="#cb198-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handler for SIGALRM</span></span>
<span id="cb198-22"><a href="#cb198-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-23"><a href="#cb198-23" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;Inside Alarm Handler!</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb198-24"><a href="#cb198-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-25"><a href="#cb198-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">++</span>timers <span class="op">;</span></span>
<span id="cb198-26"><a href="#cb198-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">;</span></span>
<span id="cb198-27"><a href="#cb198-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb198-28"><a href="#cb198-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-29"><a href="#cb198-29" aria-hidden="true" tabindex="-1"></a><span class="co">// the function pointer for the signal handler type</span></span>
<span id="cb198-30"><a href="#cb198-30" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span><span class="op">(*</span>signal_handler_function<span class="op">)(</span> <span class="dt">int</span><span class="op">,</span> siginfo_t<span class="op">*,</span> <span class="dt">void</span><span class="op">*</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb198-31"><a href="#cb198-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-32"><a href="#cb198-32" aria-hidden="true" tabindex="-1"></a><span class="co">// We can use a function to set up the signal, </span></span>
<span id="cb198-33"><a href="#cb198-33" aria-hidden="true" tabindex="-1"></a><span class="co">// hide all the sigset, sigaction stuff using this</span></span>
<span id="cb198-34"><a href="#cb198-34" aria-hidden="true" tabindex="-1"></a><span class="co">// EXPLAIN this function</span></span>
<span id="cb198-35"><a href="#cb198-35" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup_signal<span class="op">(</span> <span class="dt">int</span> signal_number<span class="op">,</span> </span>
<span id="cb198-36"><a href="#cb198-36" aria-hidden="true" tabindex="-1"></a>                   signal_handler_function func<span class="op">,</span></span>
<span id="cb198-37"><a href="#cb198-37" aria-hidden="true" tabindex="-1"></a>                   <span class="dt">int</span> sa_flags <span class="op">)</span></span>
<span id="cb198-38"><a href="#cb198-38" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb198-39"><a href="#cb198-39" aria-hidden="true" tabindex="-1"></a>    sigset_t masked <span class="op">;</span> <span class="co">// bitmask</span></span>
<span id="cb198-40"><a href="#cb198-40" aria-hidden="true" tabindex="-1"></a>    sigemptyset<span class="op">(</span> <span class="op">&amp;</span>masked <span class="op">)</span> <span class="op">;</span> <span class="co">// clear the mask</span></span>
<span id="cb198-41"><a href="#cb198-41" aria-hidden="true" tabindex="-1"></a>    sigaddset<span class="op">(</span> <span class="op">&amp;</span>masked<span class="op">,</span> signal_number <span class="op">)</span> <span class="op">;</span> <span class="co">// set only bit for SIGSEGV</span></span>
<span id="cb198-42"><a href="#cb198-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> sigaction siginfo <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> sigaction<span class="op">){</span></span>
<span id="cb198-43"><a href="#cb198-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_sigaction <span class="op">=</span> func<span class="op">,</span></span>
<span id="cb198-44"><a href="#cb198-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_mask <span class="op">=</span> <span class="op">&amp;</span>masked<span class="op">,</span></span>
<span id="cb198-45"><a href="#cb198-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_flags <span class="op">=</span> sa_flags </span>
<span id="cb198-46"><a href="#cb198-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">;</span> </span>
<span id="cb198-47"><a href="#cb198-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-48"><a href="#cb198-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> sigaction<span class="op">(</span> signal_number<span class="op">,</span> <span class="op">&amp;</span>siginfo<span class="op">,</span> NULL <span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="op">)</span></span>
<span id="cb198-49"><a href="#cb198-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb198-50"><a href="#cb198-50" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;sigaction failed!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb198-51"><a href="#cb198-51" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">)</span> <span class="op">;</span></span>
<span id="cb198-52"><a href="#cb198-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb198-53"><a href="#cb198-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb198-54"><a href="#cb198-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-55"><a href="#cb198-55" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb198-56"><a href="#cb198-56" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb198-57"><a href="#cb198-57" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> t <span class="op">=</span> timers <span class="op">;</span></span>
<span id="cb198-58"><a href="#cb198-58" aria-hidden="true" tabindex="-1"></a>    setup_signal<span class="op">(</span> SIGALRM<span class="op">,</span> my_timer_handler<span class="op">,</span> <span class="op">(</span>SA_RESTART <span class="op">|</span> SA_SIGINFO<span class="op">)</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb198-59"><a href="#cb198-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-60"><a href="#cb198-60" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">;</span></span>
<span id="cb198-61"><a href="#cb198-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-62"><a href="#cb198-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> <span class="op">(</span>pid <span class="op">=</span> fork<span class="op">())</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">)</span></span>
<span id="cb198-63"><a href="#cb198-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb198-64"><a href="#cb198-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Child process</span></span>
<span id="cb198-65"><a href="#cb198-65" aria-hidden="true" tabindex="-1"></a>        pause<span class="op">()</span> <span class="op">;</span></span>
<span id="cb198-66"><a href="#cb198-66" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_SUCCESS <span class="op">)</span> <span class="op">;</span></span>
<span id="cb198-67"><a href="#cb198-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb198-68"><a href="#cb198-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-69"><a href="#cb198-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// We did setup_signal BEFORE fork(). Parent/child both get signal info!</span></span>
<span id="cb198-70"><a href="#cb198-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb198-71"><a href="#cb198-71" aria-hidden="true" tabindex="-1"></a>    ualarm<span class="op">(</span> <span class="dv">1000</span><span class="op">,</span> <span class="dv">1000</span> <span class="op">)</span> <span class="op">;</span> <span class="co">// 1000 us --&gt; 1 ms</span></span>
<span id="cb198-72"><a href="#cb198-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">// alarm(1) ; // same as previous ualarm? SHOW BOTH!</span></span>
<span id="cb198-73"><a href="#cb198-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-74"><a href="#cb198-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>t <span class="op">&lt;</span> <span class="dv">10</span><span class="op">)</span></span>
<span id="cb198-75"><a href="#cb198-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb198-76"><a href="#cb198-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span> timers <span class="op">&gt;</span> t <span class="op">)</span></span>
<span id="cb198-77"><a href="#cb198-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb198-78"><a href="#cb198-78" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span> <span class="st">&quot;Count: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> t <span class="op">)</span> <span class="op">;</span></span>
<span id="cb198-79"><a href="#cb198-79" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> timers <span class="op">;</span></span>
<span id="cb198-80"><a href="#cb198-80" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb198-81"><a href="#cb198-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb198-82"><a href="#cb198-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-83"><a href="#cb198-83" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb198-84"><a href="#cb198-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb198-85"><a href="#cb198-85" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>*Question**: Track and explain the control flow through
            this program.</p>
            <p><code>SIGKILL</code> and <code>SIGSTOP</code> are unique
            in that they <em>cannot be disabled</em>, and handlers for
            them cannot be defined. They enable non-optional control of
            a child by the parent.</p>
            <h4 data-number="6.2.5.2"
            id="parentchild-coordination-with-signals"><span
            class="header-section-number">6.2.5.2</span> Parent/Child
            Coordination with Signals</h4>
            <p>Another example of coordination between parent and child
            processes. We can use signals to get a notification that
            <em>a child has exited</em>! Additionally, we can send the
            <code>SIGTERM</code> signal to terminate a process (this is
            used to implement the <code>kill</code> command line program
            – see <code>man 1 kill</code>).</p>
            <div class="sourceCode" id="cb199"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;signal.h&gt;</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span><span class="pp"> </span><span class="co">/* kill, pause */</span></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sig_handler<span class="op">(</span><span class="dt">int</span> signal_number<span class="op">,</span> siginfo_t <span class="op">*</span>info<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>context<span class="op">)</span></span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span><span class="op">(</span>signal_number<span class="op">)</span> <span class="op">{</span></span>
<span id="cb199-13"><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> SIGCHLD<span class="op">:</span> <span class="op">{</span></span>
<span id="cb199-14"><a href="#cb199-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* see documentation on `siginfo_t` in `man sigaction` */</span></span>
<span id="cb199-15"><a href="#cb199-15" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st">: Child process </span><span class="sc">%d</span><span class="st"> has exited.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">(),</span> info<span class="op">-&gt;</span>si_pid<span class="op">);</span></span>
<span id="cb199-16"><a href="#cb199-16" aria-hidden="true" tabindex="-1"></a>        fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb199-17"><a href="#cb199-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb199-18"><a href="#cb199-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb199-19"><a href="#cb199-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> SIGTERM<span class="op">:</span> <span class="op">{</span></span>
<span id="cb199-20"><a href="#cb199-20" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st">: We&#39;ve been asked to terminate. Exit!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">());</span></span>
<span id="cb199-21"><a href="#cb199-21" aria-hidden="true" tabindex="-1"></a>        fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb199-22"><a href="#cb199-22" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb199-23"><a href="#cb199-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb199-24"><a href="#cb199-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}}</span></span>
<span id="cb199-25"><a href="#cb199-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-26"><a href="#cb199-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb199-27"><a href="#cb199-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb199-28"><a href="#cb199-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-29"><a href="#cb199-29" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup_signal<span class="op">(</span><span class="dt">int</span> signo<span class="op">,</span> <span class="dt">void</span> <span class="op">(*</span>fn<span class="op">)(</span><span class="dt">int</span> <span class="op">,</span> siginfo_t <span class="op">*,</span> <span class="dt">void</span> <span class="op">*))</span></span>
<span id="cb199-30"><a href="#cb199-30" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb199-31"><a href="#cb199-31" aria-hidden="true" tabindex="-1"></a>    sigset_t masked<span class="op">;</span></span>
<span id="cb199-32"><a href="#cb199-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> sigaction siginfo<span class="op">;</span></span>
<span id="cb199-33"><a href="#cb199-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb199-34"><a href="#cb199-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-35"><a href="#cb199-35" aria-hidden="true" tabindex="-1"></a>    sigemptyset<span class="op">(&amp;</span>masked<span class="op">);</span></span>
<span id="cb199-36"><a href="#cb199-36" aria-hidden="true" tabindex="-1"></a>    sigaddset<span class="op">(&amp;</span>masked<span class="op">,</span> signo<span class="op">);</span></span>
<span id="cb199-37"><a href="#cb199-37" aria-hidden="true" tabindex="-1"></a>    siginfo <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> sigaction<span class="op">)</span> <span class="op">{</span></span>
<span id="cb199-38"><a href="#cb199-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_sigaction <span class="op">=</span> fn<span class="op">,</span></span>
<span id="cb199-39"><a href="#cb199-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_mask      <span class="op">=</span> masked<span class="op">,</span></span>
<span id="cb199-40"><a href="#cb199-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_flags     <span class="op">=</span> SA_RESTART <span class="op">|</span> SA_SIGINFO</span>
<span id="cb199-41"><a href="#cb199-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb199-42"><a href="#cb199-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-43"><a href="#cb199-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>sigaction<span class="op">(</span>signo<span class="op">,</span> <span class="op">&amp;</span>siginfo<span class="op">,</span> NULL<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb199-44"><a href="#cb199-44" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;sigaction error&quot;</span><span class="op">);</span></span>
<span id="cb199-45"><a href="#cb199-45" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb199-46"><a href="#cb199-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb199-47"><a href="#cb199-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb199-48"><a href="#cb199-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-49"><a href="#cb199-49" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb199-50"><a href="#cb199-50" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb199-51"><a href="#cb199-51" aria-hidden="true" tabindex="-1"></a>    pid_t pid<span class="op">;</span></span>
<span id="cb199-52"><a href="#cb199-52" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> status<span class="op">;</span></span>
<span id="cb199-53"><a href="#cb199-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-54"><a href="#cb199-54" aria-hidden="true" tabindex="-1"></a>    setup_signal<span class="op">(</span>SIGCHLD<span class="op">,</span> sig_handler<span class="op">);</span></span>
<span id="cb199-55"><a href="#cb199-55" aria-hidden="true" tabindex="-1"></a>    setup_signal<span class="op">(</span>SIGTERM<span class="op">,</span> sig_handler<span class="op">);</span></span>
<span id="cb199-56"><a href="#cb199-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-57"><a href="#cb199-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb199-58"><a href="#cb199-58" aria-hidden="true" tabindex="-1"></a><span class="co">     * The signal infromation is inherited across a fork,</span></span>
<span id="cb199-59"><a href="#cb199-59" aria-hidden="true" tabindex="-1"></a><span class="co">     * and is set the same for the parent and the child.</span></span>
<span id="cb199-60"><a href="#cb199-60" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb199-61"><a href="#cb199-61" aria-hidden="true" tabindex="-1"></a>    pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb199-62"><a href="#cb199-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb199-63"><a href="#cb199-63" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;fork&quot;</span><span class="op">);</span></span>
<span id="cb199-64"><a href="#cb199-64" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb199-65"><a href="#cb199-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb199-66"><a href="#cb199-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-67"><a href="#cb199-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb199-68"><a href="#cb199-68" aria-hidden="true" tabindex="-1"></a>        pause<span class="op">();</span> <span class="co">/* stop execution, wake upon signal */</span></span>
<span id="cb199-69"><a href="#cb199-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-70"><a href="#cb199-70" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb199-71"><a href="#cb199-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb199-72"><a href="#cb199-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-73"><a href="#cb199-73" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st">: Parent asking child (</span><span class="sc">%d</span><span class="st">) to terminate</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">(),</span> pid<span class="op">);</span></span>
<span id="cb199-74"><a href="#cb199-74" aria-hidden="true" tabindex="-1"></a>    kill<span class="op">(</span>pid<span class="op">,</span> SIGTERM<span class="op">);</span> <span class="co">/* send the child the TERM signal */</span></span>
<span id="cb199-75"><a href="#cb199-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-76"><a href="#cb199-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Wait for the sigchild notification of child termination! */</span></span>
<span id="cb199-77"><a href="#cb199-77" aria-hidden="true" tabindex="-1"></a>    pause<span class="op">();</span></span>
<span id="cb199-78"><a href="#cb199-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-79"><a href="#cb199-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* this should return immediately because waited for sigchld! */</span></span>
<span id="cb199-80"><a href="#cb199-80" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>pid <span class="op">==</span> wait<span class="op">(&amp;</span>status<span class="op">));</span></span>
<span id="cb199-81"><a href="#cb199-81" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>WIFEXITED<span class="op">(</span>status<span class="op">));</span></span>
<span id="cb199-82"><a href="#cb199-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-83"><a href="#cb199-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb199-84"><a href="#cb199-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>24570: We&#39;ve been asked to terminate. Exit!
24568: Parent asking child (24570) to terminate
24568: Child process 24570 has exited.</code></pre>
            <p><em>Note:</em> You want to run this a few times on your
            system to see the output. The auto-execution scripts of the
            lectures might cause wonky effects here due to
            concurrency.</p>
            <p>We now see a couple of new features:</p>
            <ul>
            <li>The <code>SIGCHLD</code> signal is activated in the
            parent when a child process exits.</li>
            <li>We can use the <code>kill</code> function to <em>send a
            signal</em> to a another process owned by the same user
            (e.g. <code>gparmer</code>).</li>
            <li>The <code>pause</code> call says to stop execution (to
            pause) until a signal is triggered.</li>
            </ul>
            <figure>
            <img src="./figures/sig_chld.png"
            alt="A high-level overview of the control flow between parent and child in this code." />
            <figcaption aria-hidden="true">A high-level overview of the
            control flow between parent and child in this
            code.</figcaption>
            </figure>
            <p>A couple of additional important functions:</p>
            <ul>
            <li><code>raise</code> will trigger a signal in the current
            process (it is effectively a
            <code>kill(getpid(), ...)</code>).</li>
            <li><code>ualarm</code> will set a recurring
            <code>SIGALRM</code> signal. This can be quite useful if
            your program needs to keep track of time in some way.</li>
            </ul>
            <h3 data-number="6.2.6" id="the-dark-side-of-signals"><span
            class="header-section-number">6.2.6</span> The Dark Side of
            Signals</h3>
            <p><img src="figures/dark_side_vader.jpg" height="300"></p>
            <p>Signals are dangerous mechanisms in some situations. It
            can be difficult to use them properly, and avoid bugs.
            Signals complication data-structures as only functionality
            that is re-eentrant should be used in signal handlers, and
            they complicate the logic around all system calls as they
            can interrupt slow system calls.</p>
            <p><strong>Two</strong> main problems: 1. problems with
            “slow” system calls 2. only “reentrant” data structures</p>
            <h4 data-number="6.2.6.1" id="slow-system-calls"><span
            class="header-section-number">6.2.6.1</span> “Slow” System
            Calls</h4>
            <ul>
            <li>many library calls can <em>block</em>
            <ul>
            <li><em>e.g.</em>, <code>wait</code> or
            <code>read</code></li>
            </ul></li>
            <li>what if → signal sent <em>when blocked?</em></li>
            <li>default → sys call will <strong>return
            immediately</strong></li>
            <li><code>wait</code> → returns even if child didn’t
            <code>exit</code></li>
            <li><code>read</code> → returns despite <strong>not</strong>
            reading data!</li>
            </ul>
            <p>So how do you tell the difference between the blocking
            function returning properly, or returning because it was
            interrupted by a signal? The answer is, of course, in the
            man pages – look at the
            <strong>return</strong>/<code>errno</code> values: -
            function will return <code>-1</code> - errno will be set to
            <code>EINTR</code></p>
            <p>Given this, we see the problem with this design: now the
            programmer must add logic for <em>every single system
            call</em> that can block to check this condition. Yikes<a
            href="#fn14" class="footnote-ref" id="fnref14"
            role="doc-noteref"><sup>14</sup></a>.</p>
            <p>Luckily, UNIX provides a means to disable the
            interruption of blocking calls by setting the
            <code>SA_RESTART</code> flag to the <code>sa_flags</code>
            field of the <code>sigaction</code> struct passed to the
            <code>sigaction</code> call.</p>
            <p><strong>Note:</strong> that the code above already sets
            this as I consider it a default requirement if you’re
            setting up signal handlers.</p>
            <p>The use of <code>SA_RESTART</code> can have interesting
            side effects, especially for <strong>slow</strong> system
            calls! Lets see the explicit interaction with between the
            slow call <code>wait</code>, and the signal handler:</p>
            <div class="sourceCode" id="cb201"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to signals</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;signal.h&gt;</span></span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> my_timer_handler<span class="op">(</span> <span class="dt">int</span> signal_number<span class="op">,</span> siginfo_t<span class="op">*</span> info<span class="op">,</span></span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a>                                            <span class="dt">void</span><span class="op">*</span> context <span class="op">)</span></span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handler for SIGALRM</span></span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-20"><a href="#cb201-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;Inside Alarm Handler!</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb201-21"><a href="#cb201-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-22"><a href="#cb201-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">;</span></span>
<span id="cb201-23"><a href="#cb201-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb201-24"><a href="#cb201-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-25"><a href="#cb201-25" aria-hidden="true" tabindex="-1"></a><span class="co">// the function pointer for the signal handler type</span></span>
<span id="cb201-26"><a href="#cb201-26" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span><span class="op">(*</span>signal_handler_function<span class="op">)(</span> <span class="dt">int</span><span class="op">,</span> siginfo_t<span class="op">*,</span> <span class="dt">void</span><span class="op">*</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb201-27"><a href="#cb201-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-28"><a href="#cb201-28" aria-hidden="true" tabindex="-1"></a><span class="co">// We can use a function to set up the signal, </span></span>
<span id="cb201-29"><a href="#cb201-29" aria-hidden="true" tabindex="-1"></a><span class="co">// hide all the sigset, sigaction stuff using this</span></span>
<span id="cb201-30"><a href="#cb201-30" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup_signal<span class="op">(</span> <span class="dt">int</span> signal_number<span class="op">,</span> </span>
<span id="cb201-31"><a href="#cb201-31" aria-hidden="true" tabindex="-1"></a>                   signal_handler_function func<span class="op">,</span></span>
<span id="cb201-32"><a href="#cb201-32" aria-hidden="true" tabindex="-1"></a>                   <span class="dt">int</span> sa_flags <span class="op">)</span></span>
<span id="cb201-33"><a href="#cb201-33" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb201-34"><a href="#cb201-34" aria-hidden="true" tabindex="-1"></a>    sigset_t masked <span class="op">;</span> <span class="co">// bitmask</span></span>
<span id="cb201-35"><a href="#cb201-35" aria-hidden="true" tabindex="-1"></a>    sigemptyset<span class="op">(</span> <span class="op">&amp;</span>masked <span class="op">)</span> <span class="op">;</span> <span class="co">// clear the mask</span></span>
<span id="cb201-36"><a href="#cb201-36" aria-hidden="true" tabindex="-1"></a>    sigaddset<span class="op">(</span> <span class="op">&amp;</span>masked<span class="op">,</span> signal_number <span class="op">)</span> <span class="op">;</span> <span class="co">// set only bit for given signal</span></span>
<span id="cb201-37"><a href="#cb201-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> sigaction siginfo <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> sigaction<span class="op">){</span></span>
<span id="cb201-38"><a href="#cb201-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_sigaction <span class="op">=</span> func<span class="op">,</span></span>
<span id="cb201-39"><a href="#cb201-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_mask <span class="op">=</span> <span class="op">&amp;</span>masked<span class="op">,</span></span>
<span id="cb201-40"><a href="#cb201-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_flags <span class="op">=</span> sa_flags </span>
<span id="cb201-41"><a href="#cb201-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="op">;</span> </span>
<span id="cb201-42"><a href="#cb201-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-43"><a href="#cb201-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> sigaction<span class="op">(</span> signal_number<span class="op">,</span> <span class="op">&amp;</span>siginfo<span class="op">,</span> NULL <span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="op">)</span></span>
<span id="cb201-44"><a href="#cb201-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb201-45"><a href="#cb201-45" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;sigaction failed!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb201-46"><a href="#cb201-46" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">)</span> <span class="op">;</span></span>
<span id="cb201-47"><a href="#cb201-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb201-48"><a href="#cb201-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb201-49"><a href="#cb201-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-50"><a href="#cb201-50" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb201-51"><a href="#cb201-51" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb201-52"><a href="#cb201-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-53"><a href="#cb201-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// comment out one or the other of this to see the different behaviors</span></span>
<span id="cb201-54"><a href="#cb201-54" aria-hidden="true" tabindex="-1"></a>    setup_signal<span class="op">(</span> SIGALRM<span class="op">,</span> my_timer_handler<span class="op">,</span> <span class="op">(</span>SA_SIGINFO<span class="op">)</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb201-55"><a href="#cb201-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">// setup_signal( SIGALRM, my_timer_handler, (SA_RESTART | SA_SIGINFO) ) ;</span></span>
<span id="cb201-56"><a href="#cb201-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-57"><a href="#cb201-57" aria-hidden="true" tabindex="-1"></a>    pid_t pid <span class="op">;</span></span>
<span id="cb201-58"><a href="#cb201-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-59"><a href="#cb201-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> <span class="op">(</span>pid <span class="op">=</span> fork<span class="op">())</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">)</span></span>
<span id="cb201-60"><a href="#cb201-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb201-61"><a href="#cb201-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Child process</span></span>
<span id="cb201-62"><a href="#cb201-62" aria-hidden="true" tabindex="-1"></a>        pause<span class="op">()</span> <span class="op">;</span> <span class="co">// wait for a signal</span></span>
<span id="cb201-63"><a href="#cb201-63" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_SUCCESS <span class="op">)</span> <span class="op">;</span></span>
<span id="cb201-64"><a href="#cb201-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb201-65"><a href="#cb201-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-66"><a href="#cb201-66" aria-hidden="true" tabindex="-1"></a>    alarm<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb201-67"><a href="#cb201-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-68"><a href="#cb201-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb201-69"><a href="#cb201-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb201-70"><a href="#cb201-70" aria-hidden="true" tabindex="-1"></a>        pid_t ret <span class="op">=</span> wait<span class="op">(</span>NULL<span class="op">)</span> <span class="op">;</span></span>
<span id="cb201-71"><a href="#cb201-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-72"><a href="#cb201-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span> ret <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="op">)</span></span>
<span id="cb201-73"><a href="#cb201-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb201-74"><a href="#cb201-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span> errno <span class="op">==</span> EINTR <span class="op">)</span></span>
<span id="cb201-75"><a href="#cb201-75" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb201-76"><a href="#cb201-76" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Child didn&#39;t exit properly</span></span>
<span id="cb201-77"><a href="#cb201-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-78"><a href="#cb201-78" aria-hidden="true" tabindex="-1"></a>                printf<span class="op">(</span> <span class="st">&quot;System call interrupted by Signal</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb201-79"><a href="#cb201-79" aria-hidden="true" tabindex="-1"></a>                kill<span class="op">(</span> pid<span class="op">,</span> SIGTERM <span class="op">)</span> <span class="op">;</span> <span class="co">// end the child process</span></span>
<span id="cb201-80"><a href="#cb201-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-81"><a href="#cb201-81" aria-hidden="true" tabindex="-1"></a>                <span class="co">// return -1 ;</span></span>
<span id="cb201-82"><a href="#cb201-82" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb201-83"><a href="#cb201-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="cf">if</span><span class="op">(</span> errno <span class="op">==</span> ECHILD <span class="op">)</span></span>
<span id="cb201-84"><a href="#cb201-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb201-85"><a href="#cb201-85" aria-hidden="true" tabindex="-1"></a>                <span class="co">// this code may NEVER execute!</span></span>
<span id="cb201-86"><a href="#cb201-86" aria-hidden="true" tabindex="-1"></a>                printf<span class="op">(</span> <span class="st">&quot;Child exited cleanly</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb201-87"><a href="#cb201-87" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb201-88"><a href="#cb201-88" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb201-89"><a href="#cb201-89" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb201-90"><a href="#cb201-90" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb201-91"><a href="#cb201-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-92"><a href="#cb201-92" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb201-93"><a href="#cb201-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb201-94"><a href="#cb201-94" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>24580: Parent asking child (24581) to terminate
24580: Child process 24581 has exited.
Assertion failed: (WIFEXITED(status)), function main, file inline_exec_tmp.c, line 81.
make[1]: *** [inline_exec] Abort trap: 6</code></pre>
            <p>Comment out one of the other of the
            <code>setup_signal</code> function calls in
            <code>main()</code> to see very different behaviors.</p>
            <h4 data-number="6.2.6.2" id="re-entrant-computations"><span
            class="header-section-number">6.2.6.2</span> Re-entrant
            Computations</h4>
            <p>Signal handlers execute by interrupting the currently
            executing instructions, regardless what computations they
            are performing. Because we don’t really know anything about
            what was executing when a signal handler started, we have to
            an issue. What if an action in the signal handler in some
            way <strong>conflicts with the action it
            interrupted</strong>?</p>
            <p>Consider <code>printf</code>, - copies data into a buffer
            - calls <code>write</code> → send buffer to standard output
            - a signal raised between the two? - signal calls
            printf!</p>
            <p>The data written by the earlier <code>printf()</code>
            will be overwritten/discarded by the later one!</p>
            <p>Any function that has these issues is called <a
            href="https://www.gnu.org/software/libc/manual/html_node/Nonreentrancy.html"><strong>non-reentrant</strong></a>.
            Yikes.</p>
            <p>Consider the following example that overwrites
            <code>errno</code> with (potentially) disastrous
            effects!</p>
            <div class="sourceCode" id="cb203"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;signal.h&gt;</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-9"><a href="#cb203-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> sig_handler<span class="op">(</span><span class="dt">int</span> signal_number<span class="op">,</span> siginfo_t <span class="op">*</span>info<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>context<span class="op">)</span></span>
<span id="cb203-10"><a href="#cb203-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb203-11"><a href="#cb203-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb203-12"><a href="#cb203-12" aria-hidden="true" tabindex="-1"></a><span class="co">     * Reset `errno`! In a real program, this might instead be a call that causes</span></span>
<span id="cb203-13"><a href="#cb203-13" aria-hidden="true" tabindex="-1"></a><span class="co">     * an error setting `errno` to whatever the error is for *that call*.</span></span>
<span id="cb203-14"><a href="#cb203-14" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb203-15"><a href="#cb203-15" aria-hidden="true" tabindex="-1"></a>    errno <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb203-16"><a href="#cb203-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-17"><a href="#cb203-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb203-18"><a href="#cb203-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb203-19"><a href="#cb203-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-20"><a href="#cb203-20" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> setup_signal<span class="op">(</span><span class="dt">int</span> signo<span class="op">)</span></span>
<span id="cb203-21"><a href="#cb203-21" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb203-22"><a href="#cb203-22" aria-hidden="true" tabindex="-1"></a>    sigset_t masked<span class="op">;</span></span>
<span id="cb203-23"><a href="#cb203-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> sigaction siginfo<span class="op">;</span></span>
<span id="cb203-24"><a href="#cb203-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb203-25"><a href="#cb203-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-26"><a href="#cb203-26" aria-hidden="true" tabindex="-1"></a>    sigemptyset<span class="op">(&amp;</span>masked<span class="op">);</span></span>
<span id="cb203-27"><a href="#cb203-27" aria-hidden="true" tabindex="-1"></a>    sigaddset<span class="op">(&amp;</span>masked<span class="op">,</span> signo<span class="op">);</span></span>
<span id="cb203-28"><a href="#cb203-28" aria-hidden="true" tabindex="-1"></a>    siginfo <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> sigaction<span class="op">)</span> <span class="op">{</span></span>
<span id="cb203-29"><a href="#cb203-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_sigaction <span class="op">=</span> sig_handler<span class="op">,</span></span>
<span id="cb203-30"><a href="#cb203-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_mask      <span class="op">=</span> masked<span class="op">,</span></span>
<span id="cb203-31"><a href="#cb203-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_flags     <span class="op">=</span> SA_RESTART <span class="op">|</span> SA_SIGINFO</span>
<span id="cb203-32"><a href="#cb203-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb203-33"><a href="#cb203-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-34"><a href="#cb203-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>sigaction<span class="op">(</span>signo<span class="op">,</span> <span class="op">&amp;</span>siginfo<span class="op">,</span> NULL<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb203-35"><a href="#cb203-35" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;sigaction error&quot;</span><span class="op">);</span></span>
<span id="cb203-36"><a href="#cb203-36" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb203-37"><a href="#cb203-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb203-38"><a href="#cb203-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb203-39"><a href="#cb203-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-40"><a href="#cb203-40" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb203-41"><a href="#cb203-41" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb203-42"><a href="#cb203-42" aria-hidden="true" tabindex="-1"></a>    setup_signal<span class="op">(</span>SIGUSR1<span class="op">);</span></span>
<span id="cb203-43"><a href="#cb203-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-44"><a href="#cb203-44" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>read<span class="op">(</span><span class="dv">400</span><span class="op">,</span> <span class="st">&quot;not going to work&quot;</span><span class="op">,</span> <span class="dv">10</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb203-45"><a href="#cb203-45" aria-hidden="true" tabindex="-1"></a>    raise<span class="op">(</span>SIGUSR1<span class="op">);</span></span>
<span id="cb203-46"><a href="#cb203-46" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;errno should be </span><span class="sc">\&quot;</span><span class="st">Bad file descriptor</span><span class="sc">\&quot;</span><span class="st">, but has value </span><span class="sc">\&quot;%s\&quot;\n</span><span class="st">&quot;</span><span class="op">,</span> strerror<span class="op">(</span>errno<span class="op">));</span></span>
<span id="cb203-47"><a href="#cb203-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-48"><a href="#cb203-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb203-49"><a href="#cb203-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>24593: Parent asking child (24594) to terminate
24593: Child process 24594 has exited.
Assertion failed: (WIFEXITED(status)), function main, file inline_exec_tmp.c, line 81.
make[1]: *** [inline_exec] Abort trap: 6</code></pre>
            <p>The set of functions you <em>can</em> call in a signal
            handler (i.e. that are <em>re-entrant</em>) are listed in
            the manual page: <code>man 7 signal-safety</code>.</p>
            <p>Notably these do <em>not</em> include the likes of -
            <code>printf</code>/<code>snprintf</code> -
            <code>malloc</code> - <code>exit</code> (though
            <code>_exit</code> is fine) - functions that set
            <code>errno</code>! - …</p>
            <p>It is hard to do much in a program of any complexity
            without <code>snprintf</code> (called by
            <code>printf</code>), <code>malloc</code>, or use
            <code>errno</code>. A very common modern way to handle this
            situation is to create a <code>pipe</code> into which the
            signal handlers <code>write</code> a notification (e.g. the
            signal number), while the main flow execution
            <code>read</code>s from the pipe. This enables the main
            execution in our programs to handle these notifications.
            However, this is only really possible and feasible when we
            get to <code>poll</code> later, and can block waiting for
            any of a number of file descriptors, including this
            pipe.</p>
            <p>Note that in <em>most</em> cases, you won’t see a bug due
            to using non-re-entrant functions in your signal handlers.
            These bugs are heavily non-deterministic, and are dependent
            on exactly what instructions were interrupted when the
            signal activated. This may feel like a good thing: buggy
            behavior is very rare! But reality is opposite: rare,
            non-deterministic bugs become <em>very very hard to debug
            and test</em>. Worse, these bugs that pass your testing are
            more likely to happen in customer’s systems that might have
            different concurrency patterns. So it is nearly impossible
            to debug/test for these bugs, and they are more likely to
            cause problems in your customer’s environment. Again,
            yikes.</p>
            <h1 data-number="7" id="files-and-file-handling"><span
            class="header-section-number">7</span> Files and File
            Handling</h1>
            <p><a
            href="https://sibin.github.io/teaching/csci2410-gwu-systems_programming/fall_2023/slides/reveal_slides/files.html">Slides</a></p>
            <p>The filesystem is one of the core abstractions on UNIX
            systems and indeed, on modern OSes. Each file is identified
            by a <em>path</em> through directories.</p>
            <p>Remember the UNIX philosophy: <strong>everything</strong>
            is a file!</p>
            <p>This is a strange statement as it raises the question
            “what wouldn’t normally be a file?” Some examples:</p>
            <table>
            <thead>
            <tr class="header">
            <th>location</th>
            <th>description</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>/proc/*</code></td>
            <td>processes</td>
            </tr>
            <tr class="even">
            <td><code>/dev/*</code></td>
            <td>devices (hard disk, keyboards,…)</td>
            </tr>
            <tr class="odd">
            <td><code>/dev/random</code></td>
            <td>random values</td>
            </tr>
            <tr class="even">
            <td><code>/sys/*</code></td>
            <td>power settings</td>
            </tr>
            <tr class="odd">
            <td><code>/dev/null</code></td>
            <td>“nothing”</td>
            </tr>
            <tr class="even">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p><strong>Note:</strong></p>
            <ul>
            <li>We know of processes as executable instances of programs
            so certainly they cannot be files, right? We’ve seen that
            they are represented by files in <code>/proc/*</code>! These
            files are used to provide “task monitor” type functionality
            (showing running processes) and <code>gdb</code>.</li>
            <li>Devices are the physical parts of our computers like
            screens, keyboards, USB devices, hard-drives, and networks.
            They are all represented by files in <code>/dev/*</code>!
            You can actually <code>cat</code> a file directly to your
            disk<a href="#fn15" class="footnote-ref" id="fnref15"
            role="doc-noteref"><sup>15</sup></a>!</li>
            <li>Want random values? <code>/dev/random</code>.</li>
            <li>Want the complete absence of anything?
            <code>/dev/null</code><a href="#fn16" class="footnote-ref"
            id="fnref16" role="doc-noteref"><sup>16</sup></a>.</li>
            <li>Want to update your power settings? There are files in
            <code>/sys/*</code> for that.</li>
            </ul>
            <p>Remember the high-level directory structure of modern
            Linux:</p>
            <p><img src="figures/linux-dir.png" height="200"></p>
            <h2 data-number="7.1" id="basic-file-access"><span
            class="header-section-number">7.1</span> Basic File
            Access</h2>
            <p>When everything is a file, it can all be manipulated and
            accessed using the exactly same functions and APIs as the
            normal files in the system, <em>e.g.,</em>
            <code>open</code>, <code>close</code>, <code>read</code>,
            <code>write</code>, <em>etc.</em></p>
            <p>This means that all of the shell programs we’ve seen can
            be used not just to operate on files, but also <em>on
            processes</em> or <em>devices</em>!</p>
            <p>Here are the basic APIs for file operations:</p>
            <ol type="1">
            <li><code>open( path, flags, ... )</code>
            <ul>
            <li>open a file → identified by `path</cb></li>
            <li>return → <code>file descriptor</code> → to access
            file</li>
            </ul></li>
            </ol>
            <p>“flags” must be one of</p>
            <ul>
            <li><code>O_RDONLY</code> → only <strong>read</strong> from
            the file</li>
            <li><code>O_WRONLY</code> → only <strong>write</strong> from
            the file</li>
            <li><code>O_CREAT</code> → <strong>create</strong> the file
            if it doesn’t exist</li>
            <li>can use bitwise OR: <code>O_RDONLY | O_CREAT</code></li>
            </ul>
            <p>When using O_CREAT → pass the third arg, “mode”:</p>
            <div class="sourceCode" id="cb205"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>open<span class="op">(</span><span class="st">&quot;my_file_name.txt&quot;</span><span class="op">,</span> O_RDWR <span class="op">|</span> O_CREAT<span class="op">,</span> <span class="bn">0700</span><span class="op">)</span></span></code></pre></div>
            <p>Whenever you see “flags”, you should think of them as a
            set of bits, and each of the options as a single bit. The
            above example will create the file,
            <code>my_file_name.txt</code> if it doesn’t exist already
            and open it for reading and writing.</p>
            <p>Note that when you pass in <code>O_CREAT</code>, you
            should pass in the third argument, the <code>mode</code>
            (for now, just always pass in <code>0700</code>!).</p>
            <ol start="2" type="1">
            <li><code>read</code>, <code>write</code>
            <ul>
            <li>generic functions for
            <ul>
            <li>getting data from,</li>
            <li>sending data to,</li>
            </ul></li>
            <li>“descriptors” → <strong>file descriptors</strong> in
            this case.</li>
            </ul></li>
            </ol>
            <p>We’ve seen them before when using pipes!</p>
            <ol start="3" type="1">
            <li><code>close</code>
            <ul>
            <li>to “close” any descriptor</li>
            <li>akin to a <code>free</code> for descriptors</li>
            </ul></li>
            <li><code>stat</code>
            <ul>
            <li>get information about file pointed by
            <code>path</code></li>
            <li>into the <code>info</code> structure</li>
            <li><code>int stat(path, struct stat *info)</code></li>
            <li><code>fstat</code> → same, but uses <code>fd</code></li>
            </ul></li>
            </ol>
            <div class="sourceCode" id="cb206"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> stat <span class="op">{</span> </span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>    dev_t    st_dev<span class="op">;</span>    <span class="co">/* device inode resides on */</span></span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>    ino_t    st_ino<span class="op">;</span>    <span class="co">/* inode&#39;s number */</span></span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>    mode_t   st_mode<span class="op">;</span>   <span class="co">/* inode protection mode */</span></span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>    nlink_t  st_nlink<span class="op">;</span>  <span class="co">/* number of hard links to the file */</span></span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>    uid_t    st_uid<span class="op">;</span>    <span class="co">/* user-id of owner */</span></span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>    gid_t    st_gid<span class="op">;</span>    <span class="co">/* group-id of owner */</span></span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>    dev_t    st_rdev<span class="op">;</span>   <span class="co">/* device type, for special file inode */</span></span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> timespec st_atimespec<span class="op">;</span>  <span class="co">/* time of last access */</span></span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> timespec st_mtimespec<span class="op">;</span>  <span class="co">/* time of last data modification */</span></span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> timespec st_ctimespec<span class="op">;</span>  <span class="co">/* time of last file status change */</span></span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>    off_t    st_size<span class="op">;</span>   <span class="co">/* file size, in bytes */</span></span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a>    quad_t   st_blocks<span class="op">;</span> <span class="co">/* blocks allocated for file */</span></span>
<span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a>    u_long   st_blksize<span class="op">;</span><span class="co">/* optimal file sys I/O ops blocksize */</span></span>
<span id="cb206-15"><a href="#cb206-15" aria-hidden="true" tabindex="-1"></a>    u_long   st_flags<span class="op">;</span>  <span class="co">/* user defined flags for file */</span></span>
<span id="cb206-16"><a href="#cb206-16" aria-hidden="true" tabindex="-1"></a>    u_long   st_gen<span class="op">;</span>    <span class="co">/* file generation number */</span></span>
<span id="cb206-17"><a href="#cb206-17" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
            <p>The structure is documented in the <code>man</code> page,
            but it includes, for example, the file size. It is defined
            in <code>&lt;sys/stat.h&gt;</code>.</p>
            <ol start="5" type="1">
            <li><code>unlink()</code>
            <ul>
            <li>try and <strong>remove</strong> a file</li>
            <li><em>e.g.,</em> called by the <code>rm</code>
            program</li>
            </ul></li>
            </ol>
            <blockquote>
            <p>It is <em>really</em> important that quite a few
            interesting functions operate on <em>descriptors</em>, which
            might reference pipes, files, the terminal, or other
            resources. This means that processes can operate on
            descriptors and not care what resources back them. This
            enables shells to implement pipelines and the redirection of
            output to files, all without the processes knowing! It
            enables <code>fork</code>ed processes to inherit these
            resources from its parent. In this way, descriptors and the
            functions to operate on them are a <em>polymorphic</em>
            foundation (in the sense of object-oriented polymorphism) to
            accessing the system.</p>
            </blockquote>
            <p>Now, let’s look at an example of basic file
            operations:</p>
            <div class="sourceCode" id="cb207"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to reading and writing on files</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#define TWEET_LEN </span><span class="dv">280</span></span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-18"><a href="#cb207-18" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb207-19"><a href="#cb207-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb207-20"><a href="#cb207-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> tweet<span class="op">[</span>TWEET_LEN<span class="op">]</span> <span class="op">;</span></span>
<span id="cb207-21"><a href="#cb207-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd <span class="op">=</span> open<span class="op">(</span> <span class="st">&quot;./daffodils.txt&quot;</span><span class="op">,</span> O_RDONLY <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-22"><a href="#cb207-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> fd <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="op">)</span></span>
<span id="cb207-23"><a href="#cb207-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb207-24"><a href="#cb207-24" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;File daffodils.txt failed to open!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-25"><a href="#cb207-25" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_FAILURE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-26"><a href="#cb207-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb207-27"><a href="#cb207-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-28"><a href="#cb207-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// what is the size of the file?</span></span>
<span id="cb207-29"><a href="#cb207-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> stat file_info <span class="op">;</span></span>
<span id="cb207-30"><a href="#cb207-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret <span class="op">=</span> fstat<span class="op">(</span> fd<span class="op">,</span> <span class="op">&amp;</span>file_info <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-31"><a href="#cb207-31" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> ret <span class="op">&gt;=</span><span class="dv">0</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-32"><a href="#cb207-32" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;Number of characters in file: </span><span class="sc">%ld\n</span><span class="st">&quot;</span><span class="op">,</span> file_info<span class="op">.</span>st_size <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-33"><a href="#cb207-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb207-34"><a href="#cb207-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read TWEET_LEN number of characters from file</span></span>
<span id="cb207-35"><a href="#cb207-35" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> read<span class="op">(</span> fd<span class="op">,</span> tweet<span class="op">,</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-36"><a href="#cb207-36" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> ret <span class="op">==</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-37"><a href="#cb207-37" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span> STDOUT_FILENO<span class="op">,</span> tweet<span class="op">,</span> TWEET_LEN  <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-38"><a href="#cb207-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-39"><a href="#cb207-39" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> read<span class="op">(</span> fd<span class="op">,</span> tweet<span class="op">,</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-40"><a href="#cb207-40" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> ret <span class="op">==</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-41"><a href="#cb207-41" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span> STDOUT_FILENO<span class="op">,</span> tweet<span class="op">,</span> TWEET_LEN  <span class="op">)</span> <span class="op">;</span></span>
<span id="cb207-42"><a href="#cb207-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-43"><a href="#cb207-43" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>fd<span class="op">)</span> <span class="op">;</span> <span class="co">// close the file.</span></span>
<span id="cb207-44"><a href="#cb207-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-45"><a href="#cb207-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb207-46"><a href="#cb207-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <h2 data-number="7.2" id="moving-around-in-files"><span
            class="header-section-number">7.2</span> Moving Around in
            Files</h2>
            <p>We see something a little strange with files as compared
            to <code>pipe</code>s.</p>
            <p><strong>Files vs Pipes</strong>:</p>
            <table>
            <thead>
            <tr class="header">
            <th>files</th>
            <th>pipes</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td>finite size</td>
            <td>potentially “infinite”</td>
            </tr>
            <tr class="even">
            <td>data is permanent</td>
            <td>temporary → only until read</td>
            </tr>
            <tr class="odd">
            <td><strong>forward/backward</strong></td>
            <td>no movement (FIFO)</td>
            </tr>
            <tr class="even">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>For files, subsequent reads and writes must progress
            through the contents of the file, but we must also to be
            able to go back and read previously read data.</p>
            <p>Lets understand what happens when we <code>read</code> or
            <code>write</code> from a file – we’ll focus only on
            <code>read</code> to start, but both behave similarly.</p>
            <p>First, each <code>fd</code><a href="#fn17"
            class="footnote-ref" id="fnref17"
            role="doc-noteref"><sup>17</sup></a> tracks an
            “<strong>offset</strong>” - offset determines <em>where</em>
            we read/write in file</p>
            <p>Lets go through an example of a file that contains the
            alphabet:</p>
            <p>For freshly opened files → <code>offset = 0</code></p>
            <p><img src="figures/file_offset1.png" height="100"> <br>
            <br></p>
            <p>A <code>read(fd, buf, 10)</code> that returns
            <code>10</code> (saying that <code>10</code> bytes or
            characters <code>a</code> through <code>j</code> was
            successfully read) advances <code>offset</code> by
            <code>10</code>. <br> <br>
            <img src="figures/file_offset2.png" height="100"> <br> <br>
            Thus, an additional read will start reading from the file at
            <code>k</code>. The offset, then, enables subsequent reads
            to iterate through a file’s contents.</p>
            <p><code>write()</code> uses the offset identically.</p>
            <p>There are many cases in which we might want to modify the
            <code>offset</code>. For example, databases want to jump
            around a file to find exactly the interesting records,
            playing audio and video requires us to skip around a file
            finding the appropriate frames. So, we use:</p>
            <div class="sourceCode" id="cb208"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>off_t lseek<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> off_t update<span class="op">,</span> <span class="dt">int</span> whence<span class="op">)</span></span></code></pre></div>
            <p>“<strong>whence</strong>”?</p>
            <p><img src="figures/shakespeare.gif" height="200"></p>
            <p><strong>how</strong> to update the
            <code>offset</code></p>
            <table>
            <thead>
            <tr class="header">
            <th>value</th>
            <th>how updated</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>SEEK_SET</code></td>
            <td><code>offset = update</code></td>
            </tr>
            <tr class="even">
            <td><code>SEEK_CUR</code></td>
            <td><code>offset += update</code></td>
            </tr>
            <tr class="odd">
            <td><code>SEEK_END</code></td>
            <td><code>offset = eof + update</code></td>
            </tr>
            <tr class="even">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p><code>eof</code> → end of file</p>
            <p>Let’s update our previous example to use
            <code>lseek()</code> to reset to the start of the file.</p>
            <div class="sourceCode" id="cb209"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * intro to reading and writing on files</span></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb209-12"><a href="#cb209-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb209-13"><a href="#cb209-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb209-14"><a href="#cb209-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></span>
<span id="cb209-15"><a href="#cb209-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-16"><a href="#cb209-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#define TWEET_LEN </span><span class="dv">280</span></span>
<span id="cb209-17"><a href="#cb209-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-18"><a href="#cb209-18" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb209-19"><a href="#cb209-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb209-20"><a href="#cb209-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> tweet<span class="op">[</span>TWEET_LEN<span class="op">]</span> <span class="op">;</span></span>
<span id="cb209-21"><a href="#cb209-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd <span class="op">=</span> open<span class="op">(</span> <span class="st">&quot;./daffodils.txt&quot;</span><span class="op">,</span> O_RDONLY <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-22"><a href="#cb209-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> fd <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="op">)</span></span>
<span id="cb209-23"><a href="#cb209-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb209-24"><a href="#cb209-24" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;File daffodils.txt failed to open!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-25"><a href="#cb209-25" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_FAILURE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-26"><a href="#cb209-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb209-27"><a href="#cb209-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-28"><a href="#cb209-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// what is the size of the file?</span></span>
<span id="cb209-29"><a href="#cb209-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> stat file_info <span class="op">;</span></span>
<span id="cb209-30"><a href="#cb209-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret <span class="op">=</span> fstat<span class="op">(</span> fd<span class="op">,</span> <span class="op">&amp;</span>file_info <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-31"><a href="#cb209-31" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> ret <span class="op">&gt;=</span><span class="dv">0</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-32"><a href="#cb209-32" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;Number of characters in file: </span><span class="sc">%ld\n</span><span class="st">&quot;</span><span class="op">,</span> file_info<span class="op">.</span>st_size <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-33"><a href="#cb209-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-34"><a href="#cb209-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read TWEET_LEN number of characters from file</span></span>
<span id="cb209-35"><a href="#cb209-35" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> read<span class="op">(</span> fd<span class="op">,</span> tweet<span class="op">,</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-36"><a href="#cb209-36" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> ret <span class="op">==</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-37"><a href="#cb209-37" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span> STDOUT_FILENO<span class="op">,</span> tweet<span class="op">,</span> TWEET_LEN  <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-38"><a href="#cb209-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-39"><a href="#cb209-39" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> read<span class="op">(</span> fd<span class="op">,</span> tweet<span class="op">,</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-40"><a href="#cb209-40" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> ret <span class="op">==</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-41"><a href="#cb209-41" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span> STDOUT_FILENO<span class="op">,</span> tweet<span class="op">,</span> TWEET_LEN  <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-42"><a href="#cb209-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-43"><a href="#cb209-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Reset to the start of the file</span></span>
<span id="cb209-44"><a href="#cb209-44" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> lseek<span class="op">(</span> fd<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> SEEK_SET <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-45"><a href="#cb209-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> ret <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="op">)</span></span>
<span id="cb209-46"><a href="#cb209-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb209-47"><a href="#cb209-47" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;lseek failed!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-48"><a href="#cb209-48" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_FAILURE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-49"><a href="#cb209-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> </span>
<span id="cb209-50"><a href="#cb209-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-51"><a href="#cb209-51" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st"> ------ AFTER LSEEK ---------</span><span class="sc">\n\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-52"><a href="#cb209-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read TWEEDT_LEN number of characters from file</span></span>
<span id="cb209-53"><a href="#cb209-53" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> read<span class="op">(</span> fd<span class="op">,</span> tweet<span class="op">,</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-54"><a href="#cb209-54" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span> ret <span class="op">==</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-55"><a href="#cb209-55" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span> STDOUT_FILENO<span class="op">,</span> tweet<span class="op">,</span> TWEET_LEN  <span class="op">)</span> <span class="op">;</span></span>
<span id="cb209-56"><a href="#cb209-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-57"><a href="#cb209-57" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>fd<span class="op">)</span> <span class="op">;</span> <span class="co">// close the file.</span></span>
<span id="cb209-58"><a href="#cb209-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-59"><a href="#cb209-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb209-60"><a href="#cb209-60" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <h2 data-number="7.3" id="other-ways-to-access-files"><span
            class="header-section-number">7.3</span> Other Ways to
            Access Files</h2>
            <p>So far,</p>
            <ul>
            <li><code>read</code> &amp; <code>write</code> are fine
            interfaces for files</li>
            <li>require many interactions with multiple calls</li>
            </ul>
            <p>There are <em>two</em> additional methods to access
            files:</p>
            <ul>
            <li><strong>memory mapping</strong></li>
            <li><strong>streams</strong></li>
            </ul>
            <h3 data-number="7.3.1" id="memory-mapping-files-mmap"><span
            class="header-section-number">7.3.1</span> Memory Mapping
            Files | <code>mmap()</code></h3>
            <p>UNIX also provides a way to directly “map” a file into a
            process, enabling to appear directly in memory, thus be
            accessible using normal memory accesses.</p>
            <p>This is cool because your changes <em>in memory</em>
            update the file directly!</p>
            <div class="sourceCode" id="cb210"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span>mmap<span class="op">(</span>addr<span class="op">,</span> len<span class="op">,</span> prot<span class="op">,</span> flags<span class="op">,</span> fd<span class="op">,</span> offset<span class="op">)</span></span></code></pre></div>
            <p>defined in <code>&lt;sys/mman.h&gt;</code>.</p>
            <h4 data-number="7.3.1.1" id="mmap-arguments"><span
            class="header-section-number">7.3.1.1</span>
            <code>mmap</code> arguments:</h4>
            <table>
            <thead>
            <tr class="header">
            <th>arg</th>
            <th>description</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>fd</code></td>
            <td>file descriptor to map to memory</td>
            </tr>
            <tr class="even">
            <td><code>addr</code></td>
            <td>address in memory to map</td>
            </tr>
            <tr class="odd">
            <td><code>len</code></td>
            <td>how much of the file to map?</td>
            </tr>
            <tr class="even">
            <td><code>prot</code></td>
            <td><code>PROT_READ</code> or <code>PROT_WRITE</code></td>
            </tr>
            <tr class="odd">
            <td><code>flags</code></td>
            <td>type of mapped object <code>MAP_PRIVATE</code></td>
            </tr>
            <tr class="even">
            <td><code>offset</code></td>
            <td>where in the file to start the mapping</td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p><strong>return value</strong> is the
            <strong>address</strong> at which the file is mapped.</p>
            <p>Overview:</p>
            <p><img src="figures/mmap6.png" height="300"></p>
            <p>Some nuances:</p>
            <ol type="1">
            <li>The <code>flags</code> argument indicates the
            <em>type</em> of mapped object:</li>
            </ol>
            <table>
            <thead>
            <tr class="header">
            <th>flag</th>
            <th>meaning</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>MAP_PRIVATE</code></td>
            <td>changes <strong>not</strong> written to file</td>
            </tr>
            <tr class="even">
            <td><code>MAP_SHARED</code></td>
            <td>changes <strong>written to</strong> file</td>
            </tr>
            <tr class="odd">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>So, if you want you changes to be reflected in the actual
            file, then make sure you set the flag as:
            <code>MAP_SHARED</code>.</p>
            <p>Look at <code>man mmap</code> for more details on the
            <code>prot</code> and <code>flags</code> options.</p>
            <ol start="2" type="1">
            <li><p>Normally, <code>addr</code>, the address in memory at
            which you want to map, is <code>NULL</code>, which means
            “please map it whereever you want”. The <em>return
            value</em> is the address at which the file is mapped, or
            <code>NULL</code> if there was an error (see the
            <code>man</code> page and <code>errno</code>
            values).</p></li>
            <li><p><code>stat</code> is quite useful to find the file’s
            size if you want to map it all in.</p></li>
            <li><p><code>prot</code> enables you to choose some
            properties for the mapping, <em>e.g.</em>,
            <code>PROT_READ</code>, and <code>PROT_WRITE</code> that ask
            the system to map the memory in readable, or writable modes
            respectively (you can choose both with
            <code>PROT_READ | PROT_WRITE</code>). <strong>Note:</strong>
            the type of accesses here must <em>match</em> request
            accesses previously requested in <code>open</code> – for
            example, if we passed <code>O_RDONLY</code> in to
            <code>open</code>, <code>mmap</code> will return an error if
            we ask for <code>PROT_WRITE</code>.</p></li>
            </ol>
            <h4 data-number="7.3.1.2" id="munmap"><span
            class="header-section-number">7.3.1.2</span>
            <code>munmap()</code></h4>
            <ul>
            <li><strong>unmap</strong> a previously mapped file</li>
            <li>deletes “mapping” for <strong>specified address
            range</strong></li>
            </ul>
            <div class="sourceCode" id="cb211"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> munmap<span class="op">(</span><span class="dt">void</span> <span class="op">*</span>addr<span class="op">,</span> <span class="dt">size_t</span> len<span class="op">);</span></span></code></pre></div>
            <p><br></p>
            <p>Consider the following code:</p>
            <div class="sourceCode" id="cb212"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* CSC 2410 Code Sample </span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * accessing files using mmap()</span></span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * Fall 2023</span></span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * (c) Sibin Mohan</span></span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb212-13"><a href="#cb212-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb212-14"><a href="#cb212-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/mman.h&gt;</span></span>
<span id="cb212-15"><a href="#cb212-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb212-16"><a href="#cb212-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb212-17"><a href="#cb212-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></span>
<span id="cb212-18"><a href="#cb212-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-19"><a href="#cb212-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#define TWEET_LEN </span><span class="dv">280</span></span>
<span id="cb212-20"><a href="#cb212-20" aria-hidden="true" tabindex="-1"></a><span class="pp">#define NUM_TWEETS </span><span class="dv">2</span></span>
<span id="cb212-21"><a href="#cb212-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-22"><a href="#cb212-22" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb212-23"><a href="#cb212-23" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb212-24"><a href="#cb212-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd <span class="op">=</span> open<span class="op">(</span> <span class="st">&quot;./daffodils.txt&quot;</span><span class="op">,</span> O_RDONLY <span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-25"><a href="#cb212-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// int fd = open( &quot;./daffodils.txt&quot;, O_RDWR ) ;</span></span>
<span id="cb212-26"><a href="#cb212-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> fd <span class="op">==</span> <span class="op">-</span><span class="dv">1</span> <span class="op">)</span></span>
<span id="cb212-27"><a href="#cb212-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb212-28"><a href="#cb212-28" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;File daffodils.txt failed to open!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-29"><a href="#cb212-29" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-30"><a href="#cb212-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb212-31"><a href="#cb212-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-32"><a href="#cb212-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// char* addr = mmap( NULL, TWEET_LEN, ( PROT_READ | PROT_WRITE ), MAP_SHARED, fd, 0 ) ;</span></span>
<span id="cb212-33"><a href="#cb212-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> addr <span class="op">=</span> mmap<span class="op">(</span> NULL<span class="op">,</span> TWEET_LEN<span class="op">,</span> <span class="op">(</span> PROT_READ <span class="op">|</span> PROT_WRITE <span class="op">),</span> MAP_PRIVATE<span class="op">,</span> fd<span class="op">,</span> <span class="dv">0</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-34"><a href="#cb212-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> addr <span class="op">==</span> NULL <span class="op">)</span></span>
<span id="cb212-35"><a href="#cb212-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb212-36"><a href="#cb212-36" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;nmmap failed!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-37"><a href="#cb212-37" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_FAILURE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-38"><a href="#cb212-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb212-39"><a href="#cb212-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-40"><a href="#cb212-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// write out a tweet length </span></span>
<span id="cb212-41"><a href="#cb212-41" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span> STDOUT_FILENO<span class="op">,</span> addr<span class="op">,</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-42"><a href="#cb212-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-43"><a href="#cb212-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// change the case of &quot;by&quot; to &quot;BY&quot;</span></span>
<span id="cb212-44"><a href="#cb212-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> by <span class="op">=</span> strstr<span class="op">(</span> addr<span class="op">,</span> <span class="st">&quot;by&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-45"><a href="#cb212-45" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>by<span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-46"><a href="#cb212-46" aria-hidden="true" tabindex="-1"></a>    by<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;B&#39;</span> <span class="op">;</span></span>
<span id="cb212-47"><a href="#cb212-47" aria-hidden="true" tabindex="-1"></a>    by<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;Y&#39;</span> <span class="op">;</span></span>
<span id="cb212-48"><a href="#cb212-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-49"><a href="#cb212-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// printf( &quot;%c %c\n&quot;, by[0], by[1] ) ;</span></span>
<span id="cb212-50"><a href="#cb212-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-51"><a href="#cb212-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// write out a tweet length </span></span>
<span id="cb212-52"><a href="#cb212-52" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span> STDOUT_FILENO<span class="op">,</span> addr<span class="op">,</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-53"><a href="#cb212-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-54"><a href="#cb212-54" aria-hidden="true" tabindex="-1"></a>    munmap<span class="op">(</span> addr<span class="op">,</span> TWEET_LEN <span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-55"><a href="#cb212-55" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>fd<span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-56"><a href="#cb212-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-57"><a href="#cb212-57" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb212-58"><a href="#cb212-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span> <span class="op">;</span></span>
<span id="cb212-59"><a href="#cb212-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p><strong>Note:</strong></p>
            <ol type="1">
            <li>will the above code work?</li>
            <li>will the file reflect the changes?</li>
            <li>what happens if the following line is uncommented (and
            the other, corresponding line is commented out?)</li>
            </ol>
            <div class="sourceCode" id="cb213"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> addr <span class="op">=</span> mmap<span class="op">(</span> NULL<span class="op">,</span> TWEET_LEN<span class="op">,</span> <span class="op">(</span> PROT_READ <span class="op">|</span> PROT_WRITE <span class="op">),</span> MAP_SHARED<span class="op">,</span> fd<span class="op">,</span> <span class="dv">0</span> <span class="op">)</span> <span class="op">;</span></span></code></pre></div>
            <ol start="4" type="1">
            <li>how will you fix the (inevitable) problem that
            occurs?</li>
            </ol>
            <h4 data-number="7.3.1.3"
            id="mmap-and-memory-allocation"><span
            class="header-section-number">7.3.1.3</span>
            <code>mmap</code> and memory allocation</h4>
            <ul>
            <li>can use mmap to <strong>allocate memory</strong>!</li>
            <li><code>fd = 0</code></li>
            <li><code>prot = PROT_READ | PROT_WRITE</code></li>
            <li><code>flags = MAP_ANONYMOUS | MAP_PRIVATE</code></li>
            <li>mmap returns → <strong>newly allocated
            memory</strong></li>
            <li><code>malloc()</code> actually calls
            <code>mmap</code>!</li>
            </ul>
            <h3 data-number="7.3.2" id="stream-based-io"><span
            class="header-section-number">7.3.2</span> Stream-Based
            I/O</h3>
            <p>There is actually a <em>third</em> way to access files
            beyond “raw” <code>read</code>/<code>write</code> and
            <code>mmap</code> – streams! <a
            href="https://www.gnu.org/software/libc/manual/html_node/I_002fO-on-Streams.html">Streams</a>
            are an abstraction <em>on top of the</em> “raw” descriptor
            accesses using <code>read</code> and <code>write</code>.</p>
            <p>Streams:</p>
            <ul>
            <li>a <strong>sequence</strong> of characters</li>
            <li>includes functions to
            <ul>
            <li>put characters in one end</li>
            <li>take characters out on one end</li>
            </ul></li>
            </ul>
            <p>Streams are identified by the type <code>FILE *</code>,
            and all the APIs for operating on streams take
            <code>FILE</code>s instead of file descriptors.</p>
            <p>We’ve seen streams before…a lot!</p>
            <ul>
            <li><code>stdin</code>, <code>stdout</code>,
            <code>stderr</code></li>
            <li><code>FILE*</code> names</li>
            <li><code>STDOUT_FILENO</code>, <code>STDIN_FILENO</code>
            and <code>STDERR_FILENO</code></li>
            <li><code>printf()</code> writes to a stream! Hence, it is
            <strong>buffered I/O</strong></li>
            </ul>
            <blockquote>
            <p><strong>Why use Streams?</strong></p>
            <p>From the <a
            href="https://www.gnu.org/software/libc/manual/html_mono/libc.html#Streams-and-File-Descriptors">GNU
            manual</a>: “<em>Streams provide a higher-level interface,
            layered on top of the primitive file descriptor facilities.
            The stream interface treats all kinds of files pretty much
            alike…The main advantage of using the stream interface is
            that the set of functions for performing actual input and
            output operations (as opposed to control operations) on
            streams is much richer and more powerful than the
            corresponding facilities for file descriptors. The file
            descriptor interface provides only simple functions for
            transferring blocks of characters, but the stream interface
            also provides powerful formatted input and output functions
            (<code>printf</code> and <code>scanf</code>) as well as
            functions for character- and line-oriented input and
            output.</em>”</p>
            <p>There is also the issue of <strong>portability</strong>:
            “<em>(raw) file descriptors are not as portable as streams.
            You can expect any system running ISO C to support streams,
            but non-GNU systems may not support file descriptors at all,
            or may only implement a subset of the GNU functions that
            operate on file descriptor</em>”</p>
            </blockquote>
            <p><strong>file</strong> streams →
            opened/read/written/closed as streams</p>
            <h4 data-number="7.3.2.1" id="file-stream-interface"><span
            class="header-section-number">7.3.2.1</span> File Stream
            Interface</h4>
            <table>
            <colgroup>
            <col style="width: 31%" />
            <col style="width: 68%" />
            </colgroup>
            <thead>
            <tr class="header">
            <th>function</th>
            <th>description</th>
            </tr>
            </thead>
            <tbody>
            <tr class="odd">
            <td><code>fopen</code></td>
            <td>same as <code>open</code> → but returns stream</td>
            </tr>
            <tr class="even">
            <td><code>fclose</code></td>
            <td>similar to <code>close</code> but for
            <code>FILE*</code></td>
            </tr>
            <tr class="odd">
            <td><code>fread/ fwrite</code></td>
            <td>similar to <code>read/ write</code></td>
            </tr>
            <tr class="even">
            <td><code>feof</code></td>
            <td>tells us if we are at <strong>end of file</strong></td>
            </tr>
            <tr class="odd">
            <td><code>printf/fprintf</code></td>
            <td>write to a stream <br> [<code>fprintf</code> to
            <strong>any</strong> stream not just
            <code>stdout</code>]</td>
            </tr>
            <tr class="even">
            <td><code>scanf/fscanf</code></td>
            <td>read from a stream <br> [<code>fscanf</code> read from
            <strong>any</strong> stream not just
            <code>stdin</code>]</td>
            </tr>
            <tr class="odd">
            <td><code>fflush</code></td>
            <td>“flush out” buffer associated with <strong>specific
            stream</strong></td>
            </tr>
            <tr class="even">
            <td><code>fileno</code></td>
            <td>get file descriptor, <code>fd</code>, associated with
            stream <code>FILE*</code></td>
            </tr>
            <tr class="odd">
            <td><code>getline</code></td>
            <td>read out <strong>one line</strong> (delineated by
            <code>\n</code>)</td>
            </tr>
            <tr class="even">
            <td></td>
            <td></td>
            </tr>
            </tbody>
            </table>
            <p>Some notes:</p>
            <ol type="1">
            <li>access rights (while opening a file) that we’re asking
            for (reading or writing to the file), are specified in a
            more intuitive <code>mode</code> string, <em>e.g.</em>,
            <code>"r"</code> to read, <code>"r+"</code> for read/write,
            <em>etc.</em></li>
            <li>streams provide the <code>feof</code> function that
            tells us if we are at the end of a file.</li>
            </ol>
            <p>Now, let’s look at our previous example of printing the
            <code>daffodils.txt</code> file in tweet lengths, this time
            using streams:</p>
            <div class="sourceCode" id="cb214"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// why do we need the +1?</span></span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> tweet<span class="op">[</span>TWEET_LEN<span class="op">+</span><span class="dv">1</span><span class="op">]</span> <span class="op">;</span></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">FILE</span><span class="op">*</span> f <span class="op">=</span> fopen<span class="op">(</span> <span class="st">&quot;./daffodils.txt&quot;</span><span class="op">,</span> <span class="st">&quot;r&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span> f <span class="op">==</span> NULL <span class="op">)</span></span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span> <span class="st">&quot;File open failed!&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span> EXIT_FAILURE <span class="op">)</span> <span class="op">;</span></span>
<span id="cb214-14"><a href="#cb214-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb214-15"><a href="#cb214-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-16"><a href="#cb214-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// read TWEET_LEN characters from the file</span></span>
<span id="cb214-17"><a href="#cb214-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret <span class="op">=</span> fread<span class="op">(</span> tweet<span class="op">,</span> TWEET_LEN<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> f <span class="op">)</span> <span class="op">;</span></span>
<span id="cb214-18"><a href="#cb214-18" aria-hidden="true" tabindex="-1"></a>    tweet<span class="op">[</span>TWEET_LEN<span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span> <span class="op">;</span></span>
<span id="cb214-19"><a href="#cb214-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-20"><a href="#cb214-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// write it to stdout</span></span>
<span id="cb214-21"><a href="#cb214-21" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span> stdout<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> tweet <span class="op">)</span> <span class="op">;</span></span>
<span id="cb214-22"><a href="#cb214-22" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">)</span> <span class="op">;</span></span>
<span id="cb214-23"><a href="#cb214-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-24"><a href="#cb214-24" aria-hidden="true" tabindex="-1"></a>    fclose<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb214-25"><a href="#cb214-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-26"><a href="#cb214-26" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="op">)</span> <span class="op">;</span></span>
<span id="cb214-27"><a href="#cb214-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb214-28"><a href="#cb214-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>24607: Parent asking child (24608) to terminate
24607: Child process 24608 has exited.
Assertion failed: (WIFEXITED(status)), function main, file inline_exec_tmp.c, line 81.
make[1]: *** [inline_exec] Abort trap: 6</code></pre>
            <h4 data-number="7.3.2.2" id="streams-as-buffered-io"><span
            class="header-section-number">7.3.2.2</span> Streams as
            buffered I/O</h4>
            <p>So it doesn’t seem like we’re getting much of use out of
            these streams compared to raw descriptors. Streams are an
            <em>optimization</em> over
            <code>read</code>/<code>write</code> as they <em>buffer</em>
            data.</p>
            <p>Buffering essentially means that your
            <code>fwrite</code>s actually write data into a “buffer” in
            memory, and only when either you write out a <code>\n</code>
            or when the buffer gets large enough does a
            <code>write</code> get called to send the data to the
            system.</p>
            <p>Why do this?</p>
            <p>By buffering data in memory rather than making a
            <code>write</code> for each <code>fwrite</code>, we’re
            saving any <strong>overheads</strong> associated with each
            <code>write</code> (to be discussed in a couple of
            weeks).</p>
            <p>However, this means that just because we called
            <code>printf</code>, doesn’t mean it will output
            immediately!</p>
            <p>Lets see this how this works in practice:</p>
            <div class="sourceCode" id="cb216"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;hello world&quot;</span><span class="op">);</span></span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>    _exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span> <span class="co">/* this exits immediately without calling `atexit` functions */</span></span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <p>Well that’s not good!</p>
            <p>The <em>buffered data</em> is copied into each process,
            then it is output when an <code>\n</code> is
            encountered.</p>
            <div class="sourceCode" id="cb218"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;hello &quot;</span><span class="op">);</span></span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="st">&quot;world &quot;</span><span class="op">,</span> <span class="dv">6</span><span class="op">);</span></span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span> <span class="co">/* remember, streams output on \n */</span></span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <p>Both <code>printf</code> and the <code>write</code> are,
            technically, to the standard output, but <code>printf</code>
            is to a <em>stream</em>. The <em>buffered</em>
            <code>printf</code> output is not written out immediately,
            thus ordering can get messed up.</p>
            <p>Yikes.</p>
            <p>Last example of the complexities of streams. What happens
            if you get a <strong>segfault!?</strong> Runtime errors can
            mess up expected behaviors.</p>
            <div class="sourceCode" id="cb220"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a<span class="op">;</span></span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;hello &quot;</span><span class="op">);</span></span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> <span class="op">*(</span><span class="dt">int</span> <span class="op">*)</span>NULL<span class="op">;</span></span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <p>Even though we fault <em>after</em> the
            <code>printf</code>, we don’t see the <code>printf</code>’s
            output!</p>
            <p>We now know why: the <code>printf</code> wrote into a
            buffer, and <strong>didn’t yet <code>write</code> to the
            system</strong>! Thus the segmentation fault, that
            terminates the process, happens <strong>before the buffer is
            actually written!</strong></p>
            <h4 data-number="7.3.2.3" id="flushing-stream-buffers"><span
            class="header-section-number">7.3.2.3</span> Flushing Stream
            Buffers</h4>
            <p>It is imperative that streams give us some means to force
            the buffer to be output! Thus, streams provide a means of
            <em>flushing</em> the stream’s buffers, and sending them out
            to the system (e.g. using <code>write</code>).</p>
            <ul>
            <li><code>fflush</code> - flush out the buffer associated
            with a specific stream.</li>
            </ul>
            <p>Fixing the previous examples:</p>
            <div class="sourceCode" id="cb222"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;hello &quot;</span><span class="op">);</span></span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span> <span class="co">// &quot;flush&quot; out the buffer to standard output</span></span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="st">&quot;world &quot;</span><span class="op">,</span> <span class="dv">6</span><span class="op">);</span></span>
<span id="cb222-10"><a href="#cb222-10" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span> <span class="co">/* remember, streams output on \n */</span></span>
<span id="cb222-11"><a href="#cb222-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-12"><a href="#cb222-12" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;hello world&quot;</span><span class="op">);</span></span>
<span id="cb222-13"><a href="#cb222-13" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb222-14"><a href="#cb222-14" aria-hidden="true" tabindex="-1"></a>    _exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span> <span class="co">/* this exits immediately without calling `atexit` functions */</span></span>
<span id="cb222-15"><a href="#cb222-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-16"><a href="#cb222-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb222-17"><a href="#cb222-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <div class="sourceCode" id="cb224"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;hello world&quot;</span><span class="op">);</span></span>
<span id="cb224-7"><a href="#cb224-7" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span> <span class="co">// &quot;flush&quot; out the buffer to standard output</span></span>
<span id="cb224-8"><a href="#cb224-8" aria-hidden="true" tabindex="-1"></a>    fork<span class="op">();</span></span>
<span id="cb224-9"><a href="#cb224-9" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span> <span class="co">/* remember, streams output on \n */</span></span>
<span id="cb224-10"><a href="#cb224-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-11"><a href="#cb224-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb224-12"><a href="#cb224-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code></code></pre>
            <h4 data-number="7.3.2.4"
            id="other-useful-stream-functions"><span
            class="header-section-number">7.3.2.4</span> Other Useful
            Stream Functions</h4>
            <p>A few other functions for streams that can be useful:</p>
            <ul>
            <li><code>fileno</code>: get the file descriptor number
            associated with a stream. This can be useful if you need to
            use an API that takes a descriptor, rather than a stream
            <code>* FILE</code>.</li>
            <li><code>getline</code>: read out a line (delimited by a
            <code>\n</code>) from a stream. Since reading input, line at
            a time, is a pretty common thing, this is a useful
            function.</li>
            </ul>
            <div class="sourceCode" id="cb226"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb226-7"><a href="#cb226-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb226-8"><a href="#cb226-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">FILE</span> <span class="op">*</span>f <span class="op">=</span> fopen<span class="op">(</span><span class="st">&quot;./05/prufrock.txt&quot;</span><span class="op">,</span> <span class="st">&quot;r&quot;</span><span class="op">);</span></span>
<span id="cb226-9"><a href="#cb226-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> s <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb226-10"><a href="#cb226-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>line <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb226-11"><a href="#cb226-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb226-12"><a href="#cb226-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-13"><a href="#cb226-13" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb226-14"><a href="#cb226-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;The new genre: abridged, tweet-worthy poetry...</span><span class="sc">\n\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb226-15"><a href="#cb226-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> getline<span class="op">(&amp;</span>line<span class="op">,</span> <span class="op">&amp;</span>s<span class="op">,</span> f<span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb226-16"><a href="#cb226-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">%</span> <span class="dv">15</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb226-17"><a href="#cb226-17" aria-hidden="true" tabindex="-1"></a>            fwrite<span class="op">(</span>line<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> strlen<span class="op">(</span>line<span class="op">),</span> stdout<span class="op">);</span></span>
<span id="cb226-18"><a href="#cb226-18" aria-hidden="true" tabindex="-1"></a>            <span class="co">/* same as printf(&quot;%s&quot;, line); */</span></span>
<span id="cb226-19"><a href="#cb226-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb226-20"><a href="#cb226-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb226-21"><a href="#cb226-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>feof<span class="op">(</span>f<span class="op">))</span> <span class="op">{</span></span>
<span id="cb226-22"><a href="#cb226-22" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;getline&quot;</span><span class="op">);</span></span>
<span id="cb226-23"><a href="#cb226-23" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb226-24"><a href="#cb226-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb226-25"><a href="#cb226-25" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>line<span class="op">);</span></span>
<span id="cb226-26"><a href="#cb226-26" aria-hidden="true" tabindex="-1"></a>    fclose<span class="op">(</span>f<span class="op">);</span></span>
<span id="cb226-27"><a href="#cb226-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-28"><a href="#cb226-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb226-29"><a href="#cb226-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>The new genre: abridged, tweet-worthy poetry...

 The Love Song of J. Alfred Prufrock
Of restless nights in one-night cheap hotels
Let fall upon its back the soot that falls from chimneys,
And for a hundred visions and revisions,
Disturb the universe?
Then how should I begin
Of lonely men in shirt-sleeves, leaning out of windows? ...
And I have seen the eternal Footman hold my coat, and snicker,

Am an attendant lord, one that will do
</code></pre>
            <h2 data-number="7.4" id="accessing-directories"><span
            class="header-section-number">7.4</span> Accessing
            Directories</h2>
            <p>Files aren’t the only thing we care to access in the
            system – what about directories! We want to be able to
            create directories, delete them, and be able to read their
            contents. These core operations are what underlies the
            implementation of the <code>ls</code> program, or,
            similarly, what happens when you double-click on a directory
            in a graphical file explorer!</p>
            <ul>
            <li><p><code>opendir</code>, <code>closedir</code> - Open
            (and close) a directory, and return a <em>directory
            stream</em>, a <code>DIR *</code>, to it, which is backed by
            a descriptor. Yes, another descriptor!</p></li>
            <li><p><code>readdir</code> - This takes a
            <code>DIR *</code> to a directory, and returns a structure
            that includes the “current” file or directory in the
            directory. This includes the name of the returned object in
            <code>d_name</code>, and type (in the <code>d_type</code>
            field) which is one of:</p>
            <ul>
            <li><code>DT_BLK</code> - This is a block device.</li>
            <li><code>DT_CHR</code> - This is a character device.</li>
            <li><strong><code>DT_DIR</code> - This is a
            directory.</strong></li>
            <li><code>DT_FIFO</code> - This is a named pipe (FIFO).</li>
            <li><code>DT_LNK</code> - This is a symbolic link.</li>
            <li><strong><code>DT_REG</code> - This is a regular
            file.</strong></li>
            <li><code>DT_SOCK</code> - This is a UNIX domain
            socket.</li>
            <li><code>DT_UNKNOWN</code> - The file type could not be
            determined.</li>
            </ul>
            <p>The two main ones we care about are directories and
            files. Subsequent calls to <code>readdir</code> will return
            the “next” file or directory.</p></li>
            <li><p><code>scandir</code> &amp; <code>glob</code> - Two
            functions that enable you to get directory contents based on
            some simple search patterns and logic. <code>scandir</code>
            lets you pass in a directory stream, and a couple of
            functions that are used to sort directory contents output,
            and filter it (enable you to say that you don’t want to look
            at some directory contents). <code>glob</code>, on the other
            hand, lets you search for “wildcards” designated by
            <code>*</code> to select all files/direcotries that match
            the string.</p></li>
            </ul>
            <div class="sourceCode" id="cb228"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dirent.h&gt;</span></span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> file_size<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>dir<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">);</span></span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-12"><a href="#cb228-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb228-13"><a href="#cb228-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb228-14"><a href="#cb228-14" aria-hidden="true" tabindex="-1"></a>    DIR <span class="op">*</span>d <span class="op">=</span> opendir<span class="op">(</span><span class="st">&quot;./05/&quot;</span><span class="op">);</span></span>
<span id="cb228-15"><a href="#cb228-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> dirent <span class="op">*</span>entry<span class="op">;</span></span>
<span id="cb228-16"><a href="#cb228-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-17"><a href="#cb228-17" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>d<span class="op">);</span></span>
<span id="cb228-18"><a href="#cb228-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-19"><a href="#cb228-19" aria-hidden="true" tabindex="-1"></a>    errno <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb228-20"><a href="#cb228-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">((</span>entry <span class="op">=</span> readdir<span class="op">(</span>d<span class="op">))</span> <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb228-21"><a href="#cb228-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>type<span class="op">;</span></span>
<span id="cb228-22"><a href="#cb228-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-23"><a href="#cb228-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>entry<span class="op">-&gt;</span>d_type <span class="op">==</span> DT_DIR<span class="op">)</span>      type <span class="op">=</span> <span class="st">&quot;Directory&quot;</span><span class="op">;</span></span>
<span id="cb228-24"><a href="#cb228-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>entry<span class="op">-&gt;</span>d_type <span class="op">==</span> DT_REG<span class="op">)</span> type <span class="op">=</span> <span class="st">&quot;File&quot;</span><span class="op">;</span></span>
<span id="cb228-25"><a href="#cb228-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>                              type <span class="op">=</span> <span class="st">&quot;Unknown&quot;</span><span class="op">;</span></span>
<span id="cb228-26"><a href="#cb228-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-27"><a href="#cb228-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>entry<span class="op">-&gt;</span>d_type <span class="op">==</span> DT_DIR <span class="op">||</span> entry<span class="op">-&gt;</span>d_type <span class="op">!=</span> DT_REG<span class="op">)</span> <span class="op">{</span></span>
<span id="cb228-28"><a href="#cb228-28" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%10s</span><span class="st">: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> type<span class="op">,</span> entry<span class="op">-&gt;</span>d_name<span class="op">);</span></span>
<span id="cb228-29"><a href="#cb228-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="co">/* entry-&gt;d_type == DT_REG */</span></span>
<span id="cb228-30"><a href="#cb228-30" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%10s</span><span class="st">: </span><span class="sc">%s</span><span class="st"> (size: </span><span class="sc">%ld</span><span class="st">)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> type<span class="op">,</span> entry<span class="op">-&gt;</span>d_name<span class="op">,</span> file_size<span class="op">(</span><span class="st">&quot;05&quot;</span><span class="op">,</span> entry<span class="op">-&gt;</span>d_name<span class="op">));</span></span>
<span id="cb228-31"><a href="#cb228-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb228-32"><a href="#cb228-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb228-33"><a href="#cb228-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>errno <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb228-34"><a href="#cb228-34" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;Reading directory&quot;</span><span class="op">);</span></span>
<span id="cb228-35"><a href="#cb228-35" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb228-36"><a href="#cb228-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb228-37"><a href="#cb228-37" aria-hidden="true" tabindex="-1"></a>    closedir<span class="op">(</span>d<span class="op">);</span></span>
<span id="cb228-38"><a href="#cb228-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-39"><a href="#cb228-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb228-40"><a href="#cb228-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb228-41"><a href="#cb228-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-42"><a href="#cb228-42" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> file_size<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>dir<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">)</span></span>
<span id="cb228-43"><a href="#cb228-43" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb228-44"><a href="#cb228-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> stat finfo<span class="op">;</span></span>
<span id="cb228-45"><a href="#cb228-45" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> buf<span class="op">[</span><span class="dv">512</span><span class="op">];</span></span>
<span id="cb228-46"><a href="#cb228-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb228-47"><a href="#cb228-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-48"><a href="#cb228-48" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>buf<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">512</span><span class="op">);</span> <span class="co">/* zero out the buffer to add &#39;\0&#39;s */</span></span>
<span id="cb228-49"><a href="#cb228-49" aria-hidden="true" tabindex="-1"></a>    snprintf<span class="op">(</span>buf<span class="op">,</span> <span class="dv">512</span><span class="op">,</span> <span class="st">&quot;./</span><span class="sc">%s</span><span class="st">/</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> dir<span class="op">,</span> file<span class="op">);</span></span>
<span id="cb228-50"><a href="#cb228-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-51"><a href="#cb228-51" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> stat<span class="op">(</span>buf<span class="op">,</span> <span class="op">&amp;</span>finfo<span class="op">);</span></span>
<span id="cb228-52"><a href="#cb228-52" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb228-53"><a href="#cb228-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-54"><a href="#cb228-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> finfo<span class="op">.</span>st_size<span class="op">;</span></span>
<span id="cb228-55"><a href="#cb228-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>The new genre: abridged, tweet-worthy poetry...

 The Love Song of J. Alfred Prufrock
Of restless nights in one-night cheap hotels
Let fall upon its back the soot that falls from chimneys,
And for a hundred visions and revisions,
Disturb the universe?
Then how should I begin
Of lonely men in shirt-sleeves, leaning out of windows? ...
And I have seen the eternal Footman hold my coat, and snicker,

Am an attendant lord, one that will do
</code></pre>
            <p>To make <em>changes</em> in the first system hierarchy,
            we need an additional set of functions.</p>
            <ul>
            <li><code>mkdir(path, mode)</code> - This function is used
            in, for example, the <code>mkdir</code> program. Don’t
            confuse the program you use in the shell, with the function
            you can call from C.</li>
            <li><code>rmdir(path)</code> - Deletes a directory that is
            empty. This means that you have to <code>unlink</code> and
            <code>rmdir</code> the directory’s contents first.</li>
            <li><code>rename(from, to)</code> - Change the name of file
            or directory from <code>from</code> to <code>to</code>. You
            can imagine this is used by the <code>mv</code> command line
            program.</li>
            </ul>
            <div class="sourceCode" id="cb230"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb230-5"><a href="#cb230-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb230-6"><a href="#cb230-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb230-7"><a href="#cb230-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-8"><a href="#cb230-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb230-9"><a href="#cb230-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb230-10"><a href="#cb230-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb230-11"><a href="#cb230-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd<span class="op">;</span></span>
<span id="cb230-12"><a href="#cb230-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-13"><a href="#cb230-13" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> mkdir<span class="op">(</span><span class="st">&quot;05/newdir&quot;</span><span class="op">,</span> <span class="bn">0700</span><span class="op">);</span></span>
<span id="cb230-14"><a href="#cb230-14" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb230-15"><a href="#cb230-15" aria-hidden="true" tabindex="-1"></a>    fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;05/newdir/newfile&quot;</span><span class="op">,</span> O_RDWR <span class="op">|</span> O_CREAT<span class="op">,</span> <span class="bn">0700</span><span class="op">);</span></span>
<span id="cb230-16"><a href="#cb230-16" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>fd <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb230-17"><a href="#cb230-17" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> write<span class="op">(</span>fd<span class="op">,</span> <span class="st">&quot;new contents&quot;</span><span class="op">,</span> <span class="dv">13</span><span class="op">);</span></span>
<span id="cb230-18"><a href="#cb230-18" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">13</span><span class="op">);</span></span>
<span id="cb230-19"><a href="#cb230-19" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> rename<span class="op">(</span><span class="st">&quot;05/newdir&quot;</span><span class="op">,</span> <span class="st">&quot;05/newerdir&quot;</span><span class="op">);</span></span>
<span id="cb230-20"><a href="#cb230-20" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb230-21"><a href="#cb230-21" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> unlink<span class="op">(</span><span class="st">&quot;05/newerdir/newfile&quot;</span><span class="op">);</span></span>
<span id="cb230-22"><a href="#cb230-22" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb230-23"><a href="#cb230-23" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> rmdir<span class="op">(</span><span class="st">&quot;05/newerdir&quot;</span><span class="op">);</span></span>
<span id="cb230-24"><a href="#cb230-24" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb230-25"><a href="#cb230-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-26"><a href="#cb230-26" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;If there were no errors, we</span><span class="sc">\n\t</span><span class="st">&quot;</span></span>
<span id="cb230-27"><a href="#cb230-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;1. created a directory, </span><span class="sc">\n\t</span><span class="st">&quot;</span></span>
<span id="cb230-28"><a href="#cb230-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;2. a file in the directory, </span><span class="sc">\n\t</span><span class="st">&quot;</span></span>
<span id="cb230-29"><a href="#cb230-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;3. change the directory name,</span><span class="sc">\n\t</span><span class="st">&quot;</span></span>
<span id="cb230-30"><a href="#cb230-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;4. removed the file, and</span><span class="sc">\n\t</span><span class="st">&quot;</span></span>
<span id="cb230-31"><a href="#cb230-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;5. removed the directory</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb230-32"><a href="#cb230-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-33"><a href="#cb230-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb230-34"><a href="#cb230-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>The new genre: abridged, tweet-worthy poetry...

 The Love Song of J. Alfred Prufrock
Of restless nights in one-night cheap hotels
Let fall upon its back the soot that falls from chimneys,
And for a hundred visions and revisions,
Disturb the universe?
Then how should I begin
Of lonely men in shirt-sleeves, leaning out of windows? ...
And I have seen the eternal Footman hold my coat, and snicker,

Am an attendant lord, one that will do
</code></pre>
            <h2 data-number="7.5" id="exercises-2"><span
            class="header-section-number">7.5</span> Exercises</h2>
            <p>Write a <code>tree</code> clone, with disk usage
            information. Though it isn’t installed, by default, tree
            outputs the filesystem at a specific directory:</p>
            <pre><code>$ tree .
.
├── 01_lecture.md
├── 02_exercises.md
├── prufrock.txt
└── test_directory
    └── crickets.txt</code></pre>
            <h3 data-number="7.5.1" id="task-1-markdown-tree"><span
            class="header-section-number">7.5.1</span> Task 1: Markdown
            Tree</h3>
            <p>We’ll simplify the output to print out markdown lists
            with either <code>D</code> or <code>F</code> for directories
            or files. If we run the program in the <code>05</code>
            directory:</p>
            <pre><code>$ ./t
- 01_lecture.md (20759)
- 02_exercises.md (1683)
- prufrock.txt (6044)
- test_directory
    - crickets.txt (26)</code></pre>
            <p>Some starter code that focuses on printing out info for a
            single directory.</p>
            <p><strong>Task: Change this code to print out the
            <em>hierarchy</em> of files and directories, rather than
            just the contents of a single directory.</strong></p>
            <div class="sourceCode" id="cb234"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dirent.h&gt;</span></span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a><span class="co">/* helper functions */</span></span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> indent<span class="op">(</span><span class="dt">int</span> n<span class="op">);</span></span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> ignoredir<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>dir<span class="op">);</span></span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> file_size<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>dir<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">);</span></span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-15"><a href="#cb234-15" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb234-16"><a href="#cb234-16" aria-hidden="true" tabindex="-1"></a><span class="co"> * Return the size of the directory (sum of all files inside).</span></span>
<span id="cb234-17"><a href="#cb234-17" aria-hidden="true" tabindex="-1"></a><span class="co"> * The easiest implementation here is recursive where this is called</span></span>
<span id="cb234-18"><a href="#cb234-18" aria-hidden="true" tabindex="-1"></a><span class="co"> * for each directory.</span></span>
<span id="cb234-19"><a href="#cb234-19" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb234-20"><a href="#cb234-20" aria-hidden="true" tabindex="-1"></a><span class="dt">size_t</span></span>
<span id="cb234-21"><a href="#cb234-21" aria-hidden="true" tabindex="-1"></a>print_dir<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>dir<span class="op">,</span> <span class="dt">int</span> depth<span class="op">)</span></span>
<span id="cb234-22"><a href="#cb234-22" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb234-23"><a href="#cb234-23" aria-hidden="true" tabindex="-1"></a>    DIR <span class="op">*</span>d <span class="op">=</span> opendir<span class="op">(</span>dir<span class="op">);</span></span>
<span id="cb234-24"><a href="#cb234-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> dirent <span class="op">*</span>entry<span class="op">;</span></span>
<span id="cb234-25"><a href="#cb234-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-26"><a href="#cb234-26" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>d<span class="op">);</span></span>
<span id="cb234-27"><a href="#cb234-27" aria-hidden="true" tabindex="-1"></a>    errno <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb234-28"><a href="#cb234-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-29"><a href="#cb234-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Go through each dir/file in this directory! */</span></span>
<span id="cb234-30"><a href="#cb234-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">((</span>entry <span class="op">=</span> readdir<span class="op">(</span>d<span class="op">))</span> <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb234-31"><a href="#cb234-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* we&#39;ll ignore . and .. */</span></span>
<span id="cb234-32"><a href="#cb234-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ignoredir<span class="op">(</span>entry<span class="op">-&gt;</span>d_name<span class="op">))</span> <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb234-33"><a href="#cb234-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-34"><a href="#cb234-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* print out the proper indentation */</span></span>
<span id="cb234-35"><a href="#cb234-35" aria-hidden="true" tabindex="-1"></a>        indent<span class="op">(</span>depth<span class="op">);</span></span>
<span id="cb234-36"><a href="#cb234-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>entry<span class="op">-&gt;</span>d_type <span class="op">==</span> DT_DIR<span class="op">)</span> <span class="op">{</span></span>
<span id="cb234-37"><a href="#cb234-37" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">&quot;- D </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> entry<span class="op">-&gt;</span>d_name<span class="op">);</span></span>
<span id="cb234-38"><a href="#cb234-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>entry<span class="op">-&gt;</span>d_type <span class="op">==</span> DT_REG<span class="op">)</span> <span class="op">{</span></span>
<span id="cb234-39"><a href="#cb234-39" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">&quot;- F </span><span class="sc">%s</span><span class="st"> (</span><span class="sc">%ld</span><span class="st">)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> entry<span class="op">-&gt;</span>d_name<span class="op">,</span> file_size<span class="op">(</span>dir<span class="op">,</span> entry<span class="op">-&gt;</span>d_name<span class="op">));</span></span>
<span id="cb234-40"><a href="#cb234-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb234-41"><a href="#cb234-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* we&#39;ll ignore everything that isn&#39;t a file or dir */</span></span>
<span id="cb234-42"><a href="#cb234-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb234-43"><a href="#cb234-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>errno <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb234-44"><a href="#cb234-44" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;Reading directory&quot;</span><span class="op">);</span></span>
<span id="cb234-45"><a href="#cb234-45" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb234-46"><a href="#cb234-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb234-47"><a href="#cb234-47" aria-hidden="true" tabindex="-1"></a>    closedir<span class="op">(</span>d<span class="op">);</span></span>
<span id="cb234-48"><a href="#cb234-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-49"><a href="#cb234-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb234-50"><a href="#cb234-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb234-51"><a href="#cb234-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-52"><a href="#cb234-52" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb234-53"><a href="#cb234-53" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb234-54"><a href="#cb234-54" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb234-55"><a href="#cb234-55" aria-hidden="true" tabindex="-1"></a>    print_dir<span class="op">(</span><span class="st">&quot;./&quot;</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb234-56"><a href="#cb234-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-57"><a href="#cb234-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb234-58"><a href="#cb234-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb234-59"><a href="#cb234-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-60"><a href="#cb234-60" aria-hidden="true" tabindex="-1"></a><span class="co">/* Indent `n` levels */</span></span>
<span id="cb234-61"><a href="#cb234-61" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb234-62"><a href="#cb234-62" aria-hidden="true" tabindex="-1"></a>indent<span class="op">(</span><span class="dt">int</span> n<span class="op">)</span></span>
<span id="cb234-63"><a href="#cb234-63" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb234-64"><a href="#cb234-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++)</span> printf<span class="op">(</span><span class="st">&quot;    &quot;</span><span class="op">);</span></span>
<span id="cb234-65"><a href="#cb234-65" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb234-66"><a href="#cb234-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-67"><a href="#cb234-67" aria-hidden="true" tabindex="-1"></a><span class="co">/* Should we ignore this directory? */</span></span>
<span id="cb234-68"><a href="#cb234-68" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb234-69"><a href="#cb234-69" aria-hidden="true" tabindex="-1"></a>ignoredir<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>dir<span class="op">)</span></span>
<span id="cb234-70"><a href="#cb234-70" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb234-71"><a href="#cb234-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> strcmp<span class="op">(</span>dir<span class="op">,</span> <span class="st">&quot;.&quot;</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> strcmp<span class="op">(</span>dir<span class="op">,</span> <span class="st">&quot;..&quot;</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb234-72"><a href="#cb234-72" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb234-73"><a href="#cb234-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-74"><a href="#cb234-74" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span></span>
<span id="cb234-75"><a href="#cb234-75" aria-hidden="true" tabindex="-1"></a>file_size<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>dir<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>file<span class="op">)</span></span>
<span id="cb234-76"><a href="#cb234-76" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb234-77"><a href="#cb234-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> stat finfo<span class="op">;</span></span>
<span id="cb234-78"><a href="#cb234-78" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> buf<span class="op">[</span><span class="dv">512</span><span class="op">];</span></span>
<span id="cb234-79"><a href="#cb234-79" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb234-80"><a href="#cb234-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-81"><a href="#cb234-81" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>buf<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">512</span><span class="op">);</span> <span class="co">/* zero out the buffer to add &#39;\0&#39;s */</span></span>
<span id="cb234-82"><a href="#cb234-82" aria-hidden="true" tabindex="-1"></a>    snprintf<span class="op">(</span>buf<span class="op">,</span> <span class="dv">512</span><span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st">/</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> dir<span class="op">,</span> file<span class="op">);</span></span>
<span id="cb234-83"><a href="#cb234-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-84"><a href="#cb234-84" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> stat<span class="op">(</span>buf<span class="op">,</span> <span class="op">&amp;</span>finfo<span class="op">);</span></span>
<span id="cb234-85"><a href="#cb234-85" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb234-86"><a href="#cb234-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-87"><a href="#cb234-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> finfo<span class="op">.</span>st_size<span class="op">;</span></span>
<span id="cb234-88"><a href="#cb234-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>The new genre: abridged, tweet-worthy poetry...

 The Love Song of J. Alfred Prufrock
Of restless nights in one-night cheap hotels
Let fall upon its back the soot that falls from chimneys,
And for a hundred visions and revisions,
Disturb the universe?
Then how should I begin
Of lonely men in shirt-sleeves, leaning out of windows? ...
And I have seen the eternal Footman hold my coat, and snicker,

Am an attendant lord, one that will do
</code></pre>
            <h3 data-number="7.5.2"
            id="task-2-file-and-directory-sizes"><span
            class="header-section-number">7.5.2</span> Task 2: File and
            Directory Sizes</h3>
            <p><strong>Task: Add output for the size of files, and the
            size of each directory – the sum of the size of all
            contained directories and files.</strong></p>
            <p>Again, if we run the program in the <code>05</code>
            directory:</p>
            <pre><code>$ ./t
- 01_lecture.md (20759)
- 02_exercises.md (1683)
- prufrock.txt (6044)
- test_directory
    - crickets.txt (26)
    (26)
(28512)</code></pre>
            <p>The <code>test_directory</code> size is the
            <code>(26)</code>, while the <code>./</code> directory has
            size <code>(28512)</code>. Your specific sizes might
            differ.</p>
            <h1 data-number="8"
            id="io-inter-process-communication"><span
            class="header-section-number">8</span> I/O: Inter-Process
            Communication</h1>
            <p>We’ve seen that processes often coordinate through pipes,
            signals, and <code>wait</code>. This is necessary when
            coordinating between parents and children in shells (both on
            the terminal, and GUIs). These are useful when children have
            a common parent (thus can share pipes), and where the parent
            knows that the children want to communicate before they are
            <code>exec</code>ed. Modern systems require a lot of
            flexibility than this. Generally, we want a process to be
            able to decide who to coordinate with as they execute given
            their own goals. For example, the shell – when it executes a
            child – doesn’t know if it wants to have a GUI, thus needs
            to talk to the window server.</p>
            <p>We require more dynamic, more flexible forms of
            coordination between processes. Generally, we call this
            coordination <em>Inter-Process Communication</em> or
            <em>IPC</em>. <em>When do we generally want more flexible
            forms of IPC</em> than pipes, signals, and wait?</p>
            <ol type="1">
            <li>If the parent doesn’t know what other processes with
            which a child wants IPC.</li>
            <li>If the parent didn’t create the other process with which
            a child wants IPC.</li>
            <li>The process with which we want IPC belongs to a
            different user.</li>
            <li>The process with which we want IPC has access to special
            resources in the system (e.g. graphics cards, other
            hardware, or filesystem data).</li>
            </ol>
            <p>Even applications that are implemented as many processes
            often require IPC between those processes.</p>
            <h2 data-number="8.1" id="ipc-example-modern-browsers"><span
            class="header-section-number">8.1</span> IPC Example: Modern
            Browsers</h2>
            <p>Browsers all require a <em>lot</em> of IPC. Each tab is a
            separate process, and there is a single <em>browser
            management</em> process that manages the GUI and other
            browser resources. This is motivated by security concerns: a
            tab that fails or is compromised by an attacker cannot
            access the data of another tab! In the early (first 15-20
            years) of browsers, this wasn’t the case, and you had to be
            careful about opening your banking webpage next to webpages
            that were suspect. The browser management process
            communicates with each of the child tab processes to send
            them user input (mouse clicks, keyboard input), and receive
            a bitmap to display on screen. Lets see this structure:</p>
            <pre><code>$ ps aux | grep firefox
... 8029 ... /usr/lib/firefox/firefox -new-window
... 8151 ... /usr/lib/firefox/firefox -contentproc -childID 1 -isForBrowser ... 8029 ...
...</code></pre>
            <p>I have an embarrassing number of tabs open, so I’ve taken
            the liberty of manually filtering this output. We can see
            that the process with pid <code>8029</code> is the parent,
            browser management process, and the process
            <code>8151</code> is a child managing a tab (note, you can
            see processes arranges as a process tree using
            <code>ps axjf</code>). There are many other children
            processes managing tabs.</p>
            <p>Lets try and figure out how they communicate with each
            other. First, lets look at the file descriptors of the tab’s
            processes (the child).</p>
            <pre><code>$ ls -l /proc/8151/fd/
0 -&gt; /dev/null
1 -&gt; socket:[100774]
...
11 -&gt; /memfd:mozilla-ipc
4 -&gt; socket:[107464]
5 -&gt; socket:[107467]
7 -&gt; pipe:[110438]</code></pre>
            <p>We see that there is no standard input
            (<code>/dev/null</code> is “nothing”), and that there are a
            few means of IPC:</p>
            <ul>
            <li><code>pipe</code> - We know these!</li>
            <li><code>memfd</code> - A Linux-specific way of sharing a
            range of memory between the processes. Stores to the memory
            can be seen by all sharing processes.</li>
            <li><code>socket</code> - Another pipe-line channel in which
            bytes written into the socket can be read out on the other
            side. A key difference is that socket connections between
            processes can be created without requiring the inheritance
            of descriptors via <code>fork</code>.</li>
            </ul>
            <p>Lets look at the browser management process, and see
            what’s going on. Notably, we want to see how the tab’s
            processes communicate with it. Thus, lets look at the
            descriptors for the parent:</p>
            <pre><code>$ ls -l /proc/8029/fd/ | awk &#39;{print $9 $10 $11}&#39;
110 -&gt; /home/ycombinator/.mozilla/.../https+++mail.google.com...data.sqlite
171 -&gt; /home/ycombinator/.mozilla/.../https+++www.youtube.com....data.sqlite
123 -&gt; /home/ycombinator/.mozilla/.../formhistory.sqlite
130 -&gt; /home/ycombinator/.mozilla/.../bookmarks.sqlite
58 -&gt; /home/ycombinator/.mozilla/.../cookies.sqlite
3 -&gt; /dev/dri/renderD128
43 -&gt; /dev/dri/card0
...
100 -&gt; /memfd:mozilla-ipc
60 -&gt; socket:[107464]
64 -&gt; socket:[107467]
82 -&gt; pipe:[110438]</code></pre>
            <p>This is <em>heavily filtered</em>. The first, highlighted
            section shows that the browser management process uses a
            database (<code>sqlite</code>) to access a webpage’s data
            (see <code>gmail</code> and <code>youtube</code>), store
            form histories, bookmarks, and cookies. It also uses the
            <code>dri</code> device is part of the <a
            href="https://en.wikipedia.org/wiki/Direct_Rendering_Infrastructure">Direct
            Rendering Infrastructure</a> which enables it to communicate
            with the X Window Server, and display what we see on screen.
            Finally, we see it uses the same means of IPC as the client,
            and if we carefully look at the <code>[ids]</code> of the
            sockets and pipes, we can see that they match those in the
            child tab process! We can see that the tab has multiple IPC
            channels open with the parent, and can access them with file
            descriptors.</p>
            <h2 data-number="8.2" id="goals-of-ipc-mechanisms"><span
            class="header-section-number">8.2</span> Goals of IPC
            Mechanisms</h2>
            <p>There are multiple IPC mechanisms in the system, and they
            all represent different trade-offs. They might be good for
            some things, and bad at others.</p>
            <ul>
            <li><strong>Transparent IPC.</strong> Do applications need
            to be changed at all to perform IPC? If not, they are
            <em>transparently</em> leveraging IPC. Shell-driven pipes
            have a huge benefit that they enable transparent IPC!</li>
            <li><strong>Named IPC.</strong> If we want multiple process
            to communicate that can’t rely on a comment parent to
            coordinate that communication, they need a means to find an
            “name” the IPC mechanism. Named IPC is in conflict with
            transparent IPC as we likely need to use a specific API to
            access the IPC mechanism.</li>
            <li><strong>Channel-based IPC.</strong> Often we want to
            send <em>messages</em> between processes such that a sent
            message, when received is removed from the channel – once
            read, it won’t be read again. This enables processes to
            receive some request, do some processing on it, then move on
            to the next request.</li>
            <li><strong>Multi-client communication.</strong> We often
            want to create a process that can provide services to
            <em>multiple</em> other “client” processes. Clients request
            service, and the “server” process receives these requests,
            and provides replies.</li>
            </ul>
            <p>Lets assess <code>pipe</code>s in this taxonomy:</p>
            <ul>
            <li>✓ <strong>Transparent IPC.</strong> - Pipes are
            pervasive for a reason! They enable composition of programs
            via pipelines despite the programs not even knowing they are
            in the pipeline!</li>
            <li>✗ <strong>Named IPC.</strong> - Na. The parent has to
            set it all up – lots of <code>dup</code>,
            <code>close</code>, and <code>pipe</code>.</li>
            <li>✓ <strong>Channel-based IPC.</strong> - Data written to
            a pipe is removed by the reader.</li>
            <li>✗ <strong>Multi-client communication.</strong> - Pipes
            are really there to pass a stream of data from one process
            to the other.</li>
            </ul>
            <h2 data-number="8.3" id="files-shared-memory"><span
            class="header-section-number">8.3</span> Files &amp; Shared
            Memory</h2>
            <p>If the goal is to send data from one process to another,
            one option is found in the filesystem (FS): can’t we just
            use files to share? Toward this, we saw in the section on FS
            I/O that we can open a file, and <code>read</code> and
            <code>write</code> (or
            <code>fread</code>/<code>fwrite</code>) from it from
            <em>multiple</em> processes. This will certainly get data
            from one process to the other. However, it has a number of
            shortcomings:</p>
            <ol type="1">
            <li>If you want to pass a potentially infinite stream of
            data between processes (think <code>pipe</code>s), then we’d
            end up with an infinite file. That translates to your disk
            running out of space very quickly, with little benefit.
            Take-away: files are for a finite amount of data, not for an
            infinite stream of data.</li>
            <li>Given this, processes must assume that the file has a
            specific format, and they have indication of if the other
            process has accessed/read data in the file. An example of a
            specific format: maybe the file is treated as a single
            string of a constant length.</li>
            <li>There isn’t any indication about when other processes
            have modified the file, thus the processes might overwrite
            each other’s data<a href="#fn18" class="footnote-ref"
            id="fnref18" role="doc-noteref"><sup>18</sup></a>.</li>
            </ol>
            <p>To emphasize these problems, lets try and implement a
            channel in a file to send data between processes. We just
            want to send a simple string repetitively from one process
            to the other.</p>
            <div class="sourceCode" id="cb240"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></span>
<span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb240-9"><a href="#cb240-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb240-10"><a href="#cb240-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-11"><a href="#cb240-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb240-12"><a href="#cb240-12" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb240-13"><a href="#cb240-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb240-14"><a href="#cb240-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb240-15"><a href="#cb240-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-16"><a href="#cb240-16" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> creat<span class="op">(</span><span class="st">&quot;string_data&quot;</span><span class="op">,</span> <span class="bn">0777</span><span class="op">);</span></span>
<span id="cb240-17"><a href="#cb240-17" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb240-18"><a href="#cb240-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-19"><a href="#cb240-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fork<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb240-20"><a href="#cb240-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>msg<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="st">&quot;penny for pawsident&quot;</span><span class="op">,</span> <span class="st">&quot;america for good doggies&quot;</span><span class="op">};</span></span>
<span id="cb240-21"><a href="#cb240-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;string_data&quot;</span><span class="op">,</span> O_WRONLY<span class="op">);</span></span>
<span id="cb240-22"><a href="#cb240-22" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>fd <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb240-23"><a href="#cb240-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-24"><a href="#cb240-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* send the first message! */</span></span>
<span id="cb240-25"><a href="#cb240-25" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> write<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">[</span><span class="dv">0</span><span class="op">],</span> strlen<span class="op">(</span>msg<span class="op">[</span><span class="dv">0</span><span class="op">])</span> <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb240-26"><a href="#cb240-26" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>ret <span class="op">==</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>strlen<span class="op">(</span>msg<span class="op">[</span><span class="dv">0</span><span class="op">])</span> <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb240-27"><a href="#cb240-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* send the second message! */</span></span>
<span id="cb240-28"><a href="#cb240-28" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> lseek<span class="op">(</span>fd<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> SEEK_SET<span class="op">);</span></span>
<span id="cb240-29"><a href="#cb240-29" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> write<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">[</span><span class="dv">1</span><span class="op">],</span> strlen<span class="op">(</span>msg<span class="op">[</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb240-30"><a href="#cb240-30" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>ret <span class="op">==</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>strlen<span class="op">(</span>msg<span class="op">[</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb240-31"><a href="#cb240-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-32"><a href="#cb240-32" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>fd<span class="op">);</span></span>
<span id="cb240-33"><a href="#cb240-33" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb240-34"><a href="#cb240-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb240-35"><a href="#cb240-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> data<span class="op">[</span><span class="dv">32</span><span class="op">];</span></span>
<span id="cb240-36"><a href="#cb240-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;string_data&quot;</span><span class="op">,</span> O_RDONLY<span class="op">);</span></span>
<span id="cb240-37"><a href="#cb240-37" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>fd <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb240-38"><a href="#cb240-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-39"><a href="#cb240-39" aria-hidden="true" tabindex="-1"></a>        memset<span class="op">(</span>data<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">32</span><span class="op">);</span></span>
<span id="cb240-40"><a href="#cb240-40" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> read<span class="op">(</span>fd<span class="op">,</span> data<span class="op">,</span> <span class="dv">32</span><span class="op">);</span></span>
<span id="cb240-41"><a href="#cb240-41" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>ret <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb240-42"><a href="#cb240-42" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;msg1: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> data<span class="op">);</span></span>
<span id="cb240-43"><a href="#cb240-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-44"><a href="#cb240-44" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> lseek<span class="op">(</span>fd<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> SEEK_SET<span class="op">);</span></span>
<span id="cb240-45"><a href="#cb240-45" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>ret <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb240-46"><a href="#cb240-46" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> read<span class="op">(</span>fd<span class="op">,</span> data<span class="op">,</span> <span class="dv">32</span><span class="op">);</span></span>
<span id="cb240-47"><a href="#cb240-47" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>ret <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb240-48"><a href="#cb240-48" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;msg2: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> data<span class="op">);</span></span>
<span id="cb240-49"><a href="#cb240-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb240-50"><a href="#cb240-50" aria-hidden="true" tabindex="-1"></a>    wait<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb240-51"><a href="#cb240-51" aria-hidden="true" tabindex="-1"></a>    unlink<span class="op">(</span><span class="st">&quot;string_data&quot;</span><span class="op">);</span></span>
<span id="cb240-52"><a href="#cb240-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-53"><a href="#cb240-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb240-54"><a href="#cb240-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>The new genre: abridged, tweet-worthy poetry...

 The Love Song of J. Alfred Prufrock
Of restless nights in one-night cheap hotels
Let fall upon its back the soot that falls from chimneys,
And for a hundred visions and revisions,
Disturb the universe?
Then how should I begin
Of lonely men in shirt-sleeves, leaning out of windows? ...
And I have seen the eternal Footman hold my coat, and snicker,

Am an attendant lord, one that will do
</code></pre>
            <p>You can see that there are some problems here. If we run
            it many times, we can see that sometimes we don’t see any
            messages, sometimes we only see the first, sometimes we only
            see the second, and other times combinations of all three
            options. Thus, they are not useful for channel-based
            communication between multiple processes.</p>
            <p>On the other side, files have a very <em>useful</em>
            properti that we’d like to use in a good solution to IPC:
            they <em>have a location in the FS</em> that the
            communicating processes can both use to find the file, thus
            avoiding the need for a shared parent.</p>
            <ul>
            <li>✗ <strong>Transparent IPC</strong> - We have to open the
            file explicitly.</li>
            <li>✓ <strong>Named IPC.</strong> - Each file has a path in
            the filesystem.</li>
            <li>✗ <strong>Channel-based IPC.</strong> - When we read out
            of a file, the data remains, making it hard to know what
            we’ve read, and what is yet to be written. A stream of
            messages placed into a file also will expend your disk!</li>
            <li>✗ <strong>Multi-client communication.</strong> - It
            isn’t clear how multiple clients can convey separate
            requests, and can receive separate replies from a
            server.</li>
            </ul>
            <blockquote>
            <p>An aside: you can use <code>mmap</code> to map a
            <em>file</em> into the address space, and if you map it
            <code>MAP_SHARED</code> (instead of
            <code>MAP_PRIVATE</code>), then the memory will be shared
            between processes. When one process does a store to the
            memory, the other process will see that store immediately!
            We can use this to pass data between processes, but we still
            have many of the problems above. How do we avoid conflicting
            modifications to the memory, get notifications that
            modifications have been made, and make sure that the data is
            formatted in an organized (finite) manner?</p>
            </blockquote>
            <h2 data-number="8.4" id="named-pipes"><span
            class="header-section-number">8.4</span> Named Pipes</h2>
            <p>The core problem with files is that they aren’t channels
            that remove existing data when it is “consumed”
            (<code>read</code>). But they have the significant up-side
            that they have a “name” in the filesystem that multiple
            otherwise independent processes can use to access the
            communication medium.</p>
            <p>Named pipes or FIFOs are like pipes in that one process
            can write into the FIFO, and another process can read from
            it. Thus, unlike files, they have the desirable property of
            channels in which data read from the channel is consumed.
            However, like files (and unlike pipes) they have a “name” in
            the filesystem – FIFOs appear in the filesystem along-side
            files. The <code>stat</code> function will let you know that
            a file is a FIFO if the <code>st_mode</code> is
            <code>S_IFIFO</code>. Since these pipes appear in the
            filesystem, they are called <strong>named pipes</strong>.
            Two processes that wish to communicate need only both know
            where in the filesystem they agree to find the named
            pipe.</p>
            <p>Lets see an example of using named pipes:</p>
            <div class="sourceCode" id="cb242"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb242-8"><a href="#cb242-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb242-9"><a href="#cb242-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb242-10"><a href="#cb242-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-11"><a href="#cb242-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb242-12"><a href="#cb242-12" aria-hidden="true" tabindex="-1"></a>proc1<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb242-13"><a href="#cb242-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb242-14"><a href="#cb242-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd<span class="op">,</span> ret<span class="op">;</span></span>
<span id="cb242-15"><a href="#cb242-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-16"><a href="#cb242-16" aria-hidden="true" tabindex="-1"></a>    fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;office_hours&quot;</span><span class="op">,</span> O_WRONLY<span class="op">);</span></span>
<span id="cb242-17"><a href="#cb242-17" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>fd <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb242-18"><a href="#cb242-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-19"><a href="#cb242-19" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> write<span class="op">(</span>fd<span class="op">,</span> <span class="st">&quot;halp!&quot;</span><span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb242-20"><a href="#cb242-20" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb242-21"><a href="#cb242-21" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>fd<span class="op">);</span></span>
<span id="cb242-22"><a href="#cb242-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb242-23"><a href="#cb242-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-24"><a href="#cb242-24" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb242-25"><a href="#cb242-25" aria-hidden="true" tabindex="-1"></a>proc2<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb242-26"><a href="#cb242-26" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb242-27"><a href="#cb242-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> msg<span class="op">[</span><span class="dv">6</span><span class="op">];</span></span>
<span id="cb242-28"><a href="#cb242-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd<span class="op">,</span> ret<span class="op">;</span></span>
<span id="cb242-29"><a href="#cb242-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-30"><a href="#cb242-30" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>msg<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">6</span><span class="op">);</span></span>
<span id="cb242-31"><a href="#cb242-31" aria-hidden="true" tabindex="-1"></a>    fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;office_hours&quot;</span><span class="op">,</span> O_RDONLY<span class="op">);</span></span>
<span id="cb242-32"><a href="#cb242-32" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>fd <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb242-33"><a href="#cb242-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-34"><a href="#cb242-34" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> read<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb242-35"><a href="#cb242-35" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb242-36"><a href="#cb242-36" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>fd<span class="op">);</span></span>
<span id="cb242-37"><a href="#cb242-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-38"><a href="#cb242-38" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;What I hear at office hours is </span><span class="sc">\&quot;%s\&quot;</span><span class="st">.&quot;</span><span class="op">,</span> msg<span class="op">);</span></span>
<span id="cb242-39"><a href="#cb242-39" aria-hidden="true" tabindex="-1"></a>    unlink<span class="op">(</span><span class="st">&quot;office_hours&quot;</span><span class="op">);</span></span>
<span id="cb242-40"><a href="#cb242-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb242-41"><a href="#cb242-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-42"><a href="#cb242-42" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb242-43"><a href="#cb242-43" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb242-44"><a href="#cb242-44" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb242-45"><a href="#cb242-45" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb242-46"><a href="#cb242-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-47"><a href="#cb242-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* This is how we create a FIFO. A FIFO version of creat. */</span></span>
<span id="cb242-48"><a href="#cb242-48" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> mkfifo<span class="op">(</span><span class="st">&quot;office_hours&quot;</span><span class="op">,</span> <span class="bn">0777</span><span class="op">);</span></span>
<span id="cb242-49"><a href="#cb242-49" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb242-50"><a href="#cb242-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-51"><a href="#cb242-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fork<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb242-52"><a href="#cb242-52" aria-hidden="true" tabindex="-1"></a>        proc1<span class="op">();</span></span>
<span id="cb242-53"><a href="#cb242-53" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb242-54"><a href="#cb242-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb242-55"><a href="#cb242-55" aria-hidden="true" tabindex="-1"></a>        proc2<span class="op">();</span></span>
<span id="cb242-56"><a href="#cb242-56" aria-hidden="true" tabindex="-1"></a>        wait<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb242-57"><a href="#cb242-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb242-58"><a href="#cb242-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-59"><a href="#cb242-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb242-60"><a href="#cb242-60" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>The new genre: abridged, tweet-worthy poetry...

 The Love Song of J. Alfred Prufrock
Of restless nights in one-night cheap hotels
Let fall upon its back the soot that falls from chimneys,
And for a hundred visions and revisions,
Disturb the universe?
Then how should I begin
Of lonely men in shirt-sleeves, leaning out of windows? ...
And I have seen the eternal Footman hold my coat, and snicker,

Am an attendant lord, one that will do
</code></pre>
            <p>There is one very awkward named pipe behavior. Processes
            attempting to <code>open</code> a named pipe will block (the
            <code>open</code> will not return) until processes have
            opened it separately as both <em>readable</em> and
            <em>writable</em>. This is awkward because how would a
            process <em>know</em> when another process might want to
            communicate with it? If a process gets IPC requests from
            many others (think the browser manager), then it doesn’t
            want to block awaiting a new communication; it wants to
            service the requests of other processes.</p>
            <p>Regardless, we do see named pipes as a cool option: named
            pipes enable us to use the filesystem to identify the pipe
            used for IPC. This enables communicating processes without
            shared parents to leverage IPC. This enables pipes to live
            up to the UNIX motto: <em>everything is a file</em>.</p>
            <h3 data-number="8.4.1"
            id="challenges-with-named-pipes-for-multi-client-communication"><span
            class="header-section-number">8.4.1</span> Challenges with
            Named Pipes for Multi-Client Communication</h3>
            <p>Lets check out an example that demonstrates how using
            named pipes for communication between a single process and
            multiple <em>clients</em> has a number of challenges.</p>
            <div class="sourceCode" id="cb244"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/stat.h&gt;</span></span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-11"><a href="#cb244-11" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb244-12"><a href="#cb244-12" aria-hidden="true" tabindex="-1"></a><span class="co"> * Receive requests, and send them immediately as a response.</span></span>
<span id="cb244-13"><a href="#cb244-13" aria-hidden="true" tabindex="-1"></a><span class="co"> * You can imagine that interesting computation could be done</span></span>
<span id="cb244-14"><a href="#cb244-14" aria-hidden="true" tabindex="-1"></a><span class="co"> * to formulate a response.</span></span>
<span id="cb244-15"><a href="#cb244-15" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb244-16"><a href="#cb244-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb244-17"><a href="#cb244-17" aria-hidden="true" tabindex="-1"></a>instructor<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb244-18"><a href="#cb244-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb244-19"><a href="#cb244-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> req<span class="op">,</span> resp<span class="op">,</span> ret<span class="op">;</span></span>
<span id="cb244-20"><a href="#cb244-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> msg<span class="op">[</span><span class="dv">32</span><span class="op">];</span></span>
<span id="cb244-21"><a href="#cb244-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-22"><a href="#cb244-22" aria-hidden="true" tabindex="-1"></a>    req <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;requests&quot;</span><span class="op">,</span> O_RDONLY<span class="op">);</span></span>
<span id="cb244-23"><a href="#cb244-23" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>req <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb244-24"><a href="#cb244-24" aria-hidden="true" tabindex="-1"></a>    resp <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;responses&quot;</span><span class="op">,</span> O_WRONLY<span class="op">);</span></span>
<span id="cb244-25"><a href="#cb244-25" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>resp <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb244-26"><a href="#cb244-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-27"><a href="#cb244-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb244-28"><a href="#cb244-28" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> read<span class="op">(</span>req<span class="op">,</span> msg<span class="op">,</span> <span class="dv">32</span><span class="op">);</span></span>
<span id="cb244-29"><a href="#cb244-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb244-30"><a href="#cb244-30" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>ret <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb244-31"><a href="#cb244-31" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> write<span class="op">(</span>resp<span class="op">,</span> msg<span class="op">,</span> ret<span class="op">);</span></span>
<span id="cb244-32"><a href="#cb244-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb244-33"><a href="#cb244-33" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>ret <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb244-34"><a href="#cb244-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb244-35"><a href="#cb244-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-36"><a href="#cb244-36" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>req<span class="op">);</span></span>
<span id="cb244-37"><a href="#cb244-37" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>resp<span class="op">);</span></span>
<span id="cb244-38"><a href="#cb244-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb244-39"><a href="#cb244-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-40"><a href="#cb244-40" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb244-41"><a href="#cb244-41" aria-hidden="true" tabindex="-1"></a><span class="co"> * Make a &quot;request&quot; with our pid, and get a response,</span></span>
<span id="cb244-42"><a href="#cb244-42" aria-hidden="true" tabindex="-1"></a><span class="co"> * hopefully also our pid.</span></span>
<span id="cb244-43"><a href="#cb244-43" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb244-44"><a href="#cb244-44" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb244-45"><a href="#cb244-45" aria-hidden="true" tabindex="-1"></a>student<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb244-46"><a href="#cb244-46" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb244-47"><a href="#cb244-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> req<span class="op">,</span> resp<span class="op">,</span> ret<span class="op">;</span></span>
<span id="cb244-48"><a href="#cb244-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> msg<span class="op">[</span><span class="dv">32</span><span class="op">];</span></span>
<span id="cb244-49"><a href="#cb244-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-50"><a href="#cb244-50" aria-hidden="true" tabindex="-1"></a>    req <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;requests&quot;</span><span class="op">,</span> O_WRONLY<span class="op">);</span></span>
<span id="cb244-51"><a href="#cb244-51" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>req <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb244-52"><a href="#cb244-52" aria-hidden="true" tabindex="-1"></a>    resp <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;responses&quot;</span><span class="op">,</span> O_RDONLY<span class="op">);</span></span>
<span id="cb244-53"><a href="#cb244-53" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>resp <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb244-54"><a href="#cb244-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-55"><a href="#cb244-55" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> snprintf<span class="op">(</span>msg<span class="op">,</span> <span class="dv">32</span><span class="op">,</span> <span class="st">&quot;</span><span class="sc">%d</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">());</span></span>
<span id="cb244-56"><a href="#cb244-56" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> write<span class="op">(</span>req<span class="op">,</span> msg<span class="op">,</span> ret<span class="op">);</span></span>
<span id="cb244-57"><a href="#cb244-57" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb244-58"><a href="#cb244-58" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> read<span class="op">(</span>resp<span class="op">,</span> msg<span class="op">,</span> <span class="dv">32</span><span class="op">);</span></span>
<span id="cb244-59"><a href="#cb244-59" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb244-60"><a href="#cb244-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-61"><a href="#cb244-61" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d</span><span class="st">: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">(),</span> msg<span class="op">);</span></span>
<span id="cb244-62"><a href="#cb244-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-63"><a href="#cb244-63" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>req<span class="op">);</span></span>
<span id="cb244-64"><a href="#cb244-64" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>resp<span class="op">);</span></span>
<span id="cb244-65"><a href="#cb244-65" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb244-66"><a href="#cb244-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-67"><a href="#cb244-67" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb244-68"><a href="#cb244-68" aria-hidden="true" tabindex="-1"></a>close_fifos<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb244-69"><a href="#cb244-69" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb244-70"><a href="#cb244-70" aria-hidden="true" tabindex="-1"></a>    unlink<span class="op">(</span><span class="st">&quot;requests&quot;</span><span class="op">);</span></span>
<span id="cb244-71"><a href="#cb244-71" aria-hidden="true" tabindex="-1"></a>    unlink<span class="op">(</span><span class="st">&quot;responses&quot;</span><span class="op">);</span></span>
<span id="cb244-72"><a href="#cb244-72" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb244-73"><a href="#cb244-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-74"><a href="#cb244-74" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb244-75"><a href="#cb244-75" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb244-76"><a href="#cb244-76" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb244-77"><a href="#cb244-77" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">,</span> i<span class="op">;</span></span>
<span id="cb244-78"><a href="#cb244-78" aria-hidden="true" tabindex="-1"></a>    pid_t pids<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb244-79"><a href="#cb244-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-80"><a href="#cb244-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* clients write to this, server reads */</span></span>
<span id="cb244-81"><a href="#cb244-81" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> mkfifo<span class="op">(</span><span class="st">&quot;requests&quot;</span><span class="op">,</span> <span class="bn">0777</span><span class="op">);</span></span>
<span id="cb244-82"><a href="#cb244-82" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb244-83"><a href="#cb244-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* server sends replies to this, clients read */</span></span>
<span id="cb244-84"><a href="#cb244-84" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> mkfifo<span class="op">(</span><span class="st">&quot;responses&quot;</span><span class="op">,</span> <span class="bn">0777</span><span class="op">);</span></span>
<span id="cb244-85"><a href="#cb244-85" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb244-86"><a href="#cb244-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-87"><a href="#cb244-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* create 1 instructor that is lecturing */</span></span>
<span id="cb244-88"><a href="#cb244-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>pids<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> fork<span class="op">())</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb244-89"><a href="#cb244-89" aria-hidden="true" tabindex="-1"></a>        instructor<span class="op">();</span></span>
<span id="cb244-90"><a href="#cb244-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb244-91"><a href="#cb244-91" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb244-92"><a href="#cb244-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Create 2 students &quot;listening&quot; to the lecture */</span></span>
<span id="cb244-93"><a href="#cb244-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">2</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb244-94"><a href="#cb244-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">((</span>pids<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">=</span> fork<span class="op">())</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb244-95"><a href="#cb244-95" aria-hidden="true" tabindex="-1"></a>            student<span class="op">();</span></span>
<span id="cb244-96"><a href="#cb244-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb244-97"><a href="#cb244-97" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb244-98"><a href="#cb244-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb244-99"><a href="#cb244-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-100"><a href="#cb244-100" aria-hidden="true" tabindex="-1"></a>    atexit<span class="op">(</span>close_fifos<span class="op">);</span></span>
<span id="cb244-101"><a href="#cb244-101" aria-hidden="true" tabindex="-1"></a>    sleep<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb244-102"><a href="#cb244-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++)</span> kill<span class="op">(</span>pids<span class="op">[</span>i<span class="op">],</span> SIGTERM<span class="op">);</span></span>
<span id="cb244-103"><a href="#cb244-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>wait<span class="op">(</span>NULL<span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb244-104"><a href="#cb244-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb244-105"><a href="#cb244-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb244-106"><a href="#cb244-106" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>inline_exec_tmp.c:102:26: error: call to undeclared function &#39;kill&#39;; ISO C99 and later do not support implicit function declarations [-Wimplicit-function-declaration]
        for (i = 0; i &lt; 3; i++) kill(pids[i], SIGTERM);
                                ^
1 error generated.
make[1]: *** [inline_exec_tmp] Error 1</code></pre>
            <p>If executed many times, you see the expected result:</p>
            <pre><code>167907: 167907
167908: 167908</code></pre>
            <p>…but also strange results:</p>
            <pre><code>167941: 167940167941</code></pre>
            <p>If this is executed many times, we see a few properties
            of named pipes.</p>
            <ol type="1">
            <li>There isn’t really a way to predict which student sees
            which data – this is determined by the concurrency of the
            system.</li>
            <li>Sometimes a student is “starved” of data
            completely.</li>
            <li>The instructor doesn’t have any control over
            <em>which</em> student should receive which data.</li>
            </ol>
            <figure>
            <img src="./figures/fifo.png"
            alt="Using two named pipes, one per communication direction, to communicate between a server (right) and clients (left). The color of the arrows designates the client for whom the communication is relevant. Note that on the way back to the clients, we “lose” track of which client each reply is for. This simply isn’t tracked with named pipes." />
            <figcaption aria-hidden="true">Using two named pipes, one
            per communication direction, to communicate between a server
            (right) and clients (left). The color of the arrows
            designates the client for whom the communication is
            relevant. Note that on the way back to the clients, we
            “lose” track of which client each reply is for. This simply
            isn’t tracked with named pipes.</figcaption>
            </figure>
            <p><strong>Named pipes summary.</strong> These solve an
            important problem: how can we have multiple processes find a
            “pipe” to use for communication even if they don’t have a
            parent to coordinate that communication? They use a
            filesystem path/name to identify the pipe. However, they are
            not suitable for a single processes (a server) to
            communicate with multiple clients as they don’t enable the
            communication for each client to be separated in the
            server.</p>
            <ul>
            <li>✗ <strong>Transparent IPC.</strong> - we have to use the
            <code>mkfifo</code> API explicitly.</li>
            <li>✓ <strong>Named IPC.</strong> - the named pipe is
            represented as a file in the filesystem.</li>
            <li>✓ <strong>Channel-based IPC.</strong> - read data is
            removed from the pipe.</li>
            <li>✗ <strong>Multi-client communication.</strong> - a
            server cannot tell the difference between clients, nor can
            they send responses to specific clients.</li>
            </ul>
            <h2 data-number="8.5" id="unix-domain-sockets"><span
            class="header-section-number">8.5</span> UNIX Domain
            Sockets</h2>
            <p><em>Sockets</em> are the mechanism provided by UNIX to
            communicate over the <em>network</em>! However, they can
            also be used to communicate between processes on your system
            through <em>UNIX domain sockets</em>.</p>
            <p>A few key concepts for domain sockets:</p>
            <ol type="1">
            <li>They are presented in the filesystem as a file, similar
            to named pipes. This enables them to be accessed by multiple
            communicating processes that don’t necessarily share a
            parent to coordinate that communication.</li>
            <li>Each new <em>client</em> that attempts to connect to a
            <em>server</em> will be represented as a <em>separate
            descriptor</em> in the server, thus enabling the server to
            separate its communication with on, from the other. The goal
            is to create a descriptor for <em>each pair of communicating
            processes</em>.</li>
            <li>Each descriptor to a domain socket is bi-directional –
            it can be <code>read</code> and <code>write</code>n to, thus
            making communication back and forth quite a bit easier.</li>
            </ol>
            <h3 data-number="8.5.1"
            id="domain-sockets-for-multi-client-communication"><span
            class="header-section-number">8.5.1</span> Domain sockets
            for Multi-Client Communication</h3>
            <p>Lets look at an example were we want a server to receive
            a client’s requests as strings, and to reply with those same
            strings. This isn’t useful, per-say, but demonstrates how
            this communication can happen. Notably, we want to enable
            the server to communicate with different clients!</p>
            <ul>
            <li>A <em>server</em> receives IPC requests from
            <em>clients</em>. Note that this is similar to how a server
            on the internet serves webpages to multiple clients (and,
            indeed, the code is similar!).</li>
            <li>The server’s functions include <code>socket</code>,
            <code>bind</code>, and <code>listen</code>.
            <code>socket</code> creates a domain socket file
            descriptor</li>
            <li>The server creates a <em>separate descriptor</em> for
            each client using <code>accept</code>.</li>
            <li>The client’s functions include <code>socket</code> and
            <code>connect</code>.</li>
            </ul>
            <p>Most of these functions are complex and have tons of
            options. Most of them have been distilled into the following
            functions in <code>06/domain_sockets.h</code>:</p>
            <ul>
            <li><code>int domain_socket_server_create(const char *file_name)</code>
            - Create a descriptor to the “server” end of the IPC channel
            identified by <code>file_name</code> in the filesystem,
            similar to the named pipes before.</li>
            <li><code>int domain_socket_client_create(const char *file_name)</code>
            - Create a descriptor to the “client” end of the IPC channel
            identified by a file name. One constraint is that the
            <em>server must create the domain socket first</em>, or else
            this call (the <code>connect</code>) will fail.</li>
            </ul>
            <p>The server’s descriptor is not meant to be used for
            direct communication (i.e. should not be used for
            <code>read</code>, and <code>write</code>). Instead, it is
            used to <em>create new descriptors, one per client</em>!
            With a descriptor per-client, we have the fortunate ability
            to communicate explicitly with each client without the same
            problem of messages getting messed up in named pipes.</p>
            <figure>
            <img src="./figures/domain_sockets.png"
            alt="A sequence of using domain sockets to communicate between multiple clients and a server. (a) The single domain socket that clients can attempt to connect to. (b) The server using accept to create a new descriptor and channel for communication with the red client (thus the “red” channel). (c) Subsequent communication with that client is explicitly through that channel, so the server can send specifically to that client. (d) The server creates a separate channel for communication with the blue client." />
            <figcaption aria-hidden="true">A sequence of using domain
            sockets to communicate between multiple clients and a
            server. (a) The single domain socket that clients can
            attempt to <code>connect</code> to. (b) The server using
            <code>accept</code> to create a new descriptor and channel
            for communication with the red client (thus the “red”
            channel). (c) Subsequent communication with that client is
            explicitly through that channel, so the server can send
            specifically to that client. (d) The server creates a
            <em>separate</em> channel for communication with the blue
            client.</figcaption>
            </figure>
            <h4 data-number="8.5.1.1"
            id="setting-up-domain-sockets"><span
            class="header-section-number">8.5.1.1</span> Setting up
            Domain Sockets</h4>
            <p>Two functions that both take an argument which is the
            domain socket name/path in the file system, and return a
            descriptor to the socket. For the most part, you can just
            use these functions in your code directly by using
            <code>06/domain_sockets.h</code>.</p>
            <div class="sourceCode" id="cb248"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;06/domain_sockets.h&quot;</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a>unlink_domain_socket<span class="op">(</span><span class="dt">int</span> status<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>filename<span class="op">)</span></span>
<span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb248-12"><a href="#cb248-12" aria-hidden="true" tabindex="-1"></a>    unlink<span class="op">(</span>filename<span class="op">);</span></span>
<span id="cb248-13"><a href="#cb248-13" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>filename<span class="op">);</span></span>
<span id="cb248-14"><a href="#cb248-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb248-15"><a href="#cb248-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-16"><a href="#cb248-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_BUF_SZ </span><span class="dv">128</span></span>
<span id="cb248-17"><a href="#cb248-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-18"><a href="#cb248-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb248-19"><a href="#cb248-19" aria-hidden="true" tabindex="-1"></a>server<span class="op">(</span><span class="dt">int</span> num_clients<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>filename<span class="op">)</span></span>
<span id="cb248-20"><a href="#cb248-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb248-21"><a href="#cb248-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> buf<span class="op">[</span>MAX_BUF_SZ<span class="op">];</span></span>
<span id="cb248-22"><a href="#cb248-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> new_client<span class="op">,</span> amnt<span class="op">,</span> i<span class="op">,</span> socket_desc<span class="op">;</span></span>
<span id="cb248-23"><a href="#cb248-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-24"><a href="#cb248-24" aria-hidden="true" tabindex="-1"></a>    socket_desc <span class="op">=</span> domain_socket_server_create<span class="op">(</span>filename<span class="op">);</span></span>
<span id="cb248-25"><a href="#cb248-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>socket_desc <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span> <span class="co">/* should do proper cleanup */</span></span>
<span id="cb248-26"><a href="#cb248-26" aria-hidden="true" tabindex="-1"></a>    on_exit<span class="op">(</span>unlink_domain_socket<span class="op">,</span> strdup<span class="op">(</span>filename<span class="op">));</span></span>
<span id="cb248-27"><a href="#cb248-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-28"><a href="#cb248-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb248-29"><a href="#cb248-29" aria-hidden="true" tabindex="-1"></a><span class="co">     * Service `num_clients` number of clients, one at a time.F</span></span>
<span id="cb248-30"><a href="#cb248-30" aria-hidden="true" tabindex="-1"></a><span class="co">     * For many servers, this might be an infinite loop.</span></span>
<span id="cb248-31"><a href="#cb248-31" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb248-32"><a href="#cb248-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> num_clients<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb248-33"><a href="#cb248-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb248-34"><a href="#cb248-34" aria-hidden="true" tabindex="-1"></a><span class="co">         * We use this new descriptor to communicate with *this* client.</span></span>
<span id="cb248-35"><a href="#cb248-35" aria-hidden="true" tabindex="-1"></a><span class="co">         * This is the key function that enables us to create per-client</span></span>
<span id="cb248-36"><a href="#cb248-36" aria-hidden="true" tabindex="-1"></a><span class="co">         * descriptors. It only returns when a client is ready to communicate.</span></span>
<span id="cb248-37"><a href="#cb248-37" aria-hidden="true" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb248-38"><a href="#cb248-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">((</span>new_client <span class="op">=</span> accept<span class="op">(</span>socket_desc<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb248-39"><a href="#cb248-39" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;Server: New client connected with new file descriptor </span><span class="sc">%d</span><span class="st">.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> new_client<span class="op">);</span></span>
<span id="cb248-40"><a href="#cb248-40" aria-hidden="true" tabindex="-1"></a>        fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb248-41"><a href="#cb248-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-42"><a href="#cb248-42" aria-hidden="true" tabindex="-1"></a>        amnt <span class="op">=</span> read<span class="op">(</span>new_client<span class="op">,</span> buf<span class="op">,</span> MAX_BUF_SZ <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb248-43"><a href="#cb248-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>amnt <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb248-44"><a href="#cb248-44" aria-hidden="true" tabindex="-1"></a>        buf<span class="op">[</span>amnt<span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span> <span class="co">/* ensure null termination of the string */</span></span>
<span id="cb248-45"><a href="#cb248-45" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;Server received message (sz </span><span class="sc">%d</span><span class="st">): </span><span class="sc">\&quot;%s\&quot;</span><span class="st">. Replying!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> amnt<span class="op">,</span> buf<span class="op">);</span></span>
<span id="cb248-46"><a href="#cb248-46" aria-hidden="true" tabindex="-1"></a>        fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb248-47"><a href="#cb248-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-48"><a href="#cb248-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* send the client a reply */</span></span>
<span id="cb248-49"><a href="#cb248-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>write<span class="op">(</span>new_client<span class="op">,</span> buf<span class="op">,</span> amnt<span class="op">)</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb248-50"><a href="#cb248-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* Done with communication with this client */</span></span>
<span id="cb248-51"><a href="#cb248-51" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>new_client<span class="op">);</span></span>
<span id="cb248-52"><a href="#cb248-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb248-53"><a href="#cb248-53" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>socket_desc<span class="op">);</span></span>
<span id="cb248-54"><a href="#cb248-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-55"><a href="#cb248-55" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb248-56"><a href="#cb248-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb248-57"><a href="#cb248-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-58"><a href="#cb248-58" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb248-59"><a href="#cb248-59" aria-hidden="true" tabindex="-1"></a>client<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>filename<span class="op">)</span></span>
<span id="cb248-60"><a href="#cb248-60" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb248-61"><a href="#cb248-61" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> msg<span class="op">[</span>MAX_BUF_SZ<span class="op">];</span></span>
<span id="cb248-62"><a href="#cb248-62" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>  amnt <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> socket_desc<span class="op">;</span></span>
<span id="cb248-63"><a href="#cb248-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-64"><a href="#cb248-64" aria-hidden="true" tabindex="-1"></a>    socket_desc <span class="op">=</span> domain_socket_client_create<span class="op">(</span>filename<span class="op">);</span></span>
<span id="cb248-65"><a href="#cb248-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>socket_desc <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb248-66"><a href="#cb248-66" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;1. Client </span><span class="sc">%d</span><span class="st"> connected to server.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">());</span></span>
<span id="cb248-67"><a href="#cb248-67" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb248-68"><a href="#cb248-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-69"><a href="#cb248-69" aria-hidden="true" tabindex="-1"></a>    snprintf<span class="op">(</span>msg<span class="op">,</span> MAX_BUF_SZ <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="st">&quot;Citizen </span><span class="sc">%d</span><span class="st">: Penny for Pawsident!&quot;</span><span class="op">,</span> getpid<span class="op">());</span></span>
<span id="cb248-70"><a href="#cb248-70" aria-hidden="true" tabindex="-1"></a>    amnt <span class="op">=</span> write<span class="op">(</span>socket_desc<span class="op">,</span> msg<span class="op">,</span> strlen<span class="op">(</span>msg<span class="op">)</span> <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb248-71"><a href="#cb248-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>amnt <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb248-72"><a href="#cb248-72" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;2. Client </span><span class="sc">%d</span><span class="st"> request sent message to server.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">());</span></span>
<span id="cb248-73"><a href="#cb248-73" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb248-74"><a href="#cb248-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-75"><a href="#cb248-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>read<span class="op">(</span>socket_desc<span class="op">,</span> msg<span class="op">,</span> amnt<span class="op">)</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb248-76"><a href="#cb248-76" aria-hidden="true" tabindex="-1"></a>    msg<span class="op">[</span>amnt<span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb248-77"><a href="#cb248-77" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;3. Client </span><span class="sc">%d</span><span class="st"> reply received from server: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">(),</span> msg<span class="op">);</span></span>
<span id="cb248-78"><a href="#cb248-78" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb248-79"><a href="#cb248-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-80"><a href="#cb248-80" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>socket_desc<span class="op">);</span></span>
<span id="cb248-81"><a href="#cb248-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-82"><a href="#cb248-82" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb248-83"><a href="#cb248-83" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb248-84"><a href="#cb248-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-85"><a href="#cb248-85" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb248-86"><a href="#cb248-86" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb248-87"><a href="#cb248-87" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb248-88"><a href="#cb248-88" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>channel_name <span class="op">=</span> <span class="st">&quot;pennys_channel&quot;</span><span class="op">;</span></span>
<span id="cb248-89"><a href="#cb248-89" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> nclients <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb248-90"><a href="#cb248-90" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb248-91"><a href="#cb248-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-92"><a href="#cb248-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fork<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> server<span class="op">(</span>nclients<span class="op">,</span> channel_name<span class="op">);</span></span>
<span id="cb248-93"><a href="#cb248-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* wait for the server to create the domain socket */</span></span>
<span id="cb248-94"><a href="#cb248-94" aria-hidden="true" tabindex="-1"></a>    sleep<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb248-95"><a href="#cb248-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nclients<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb248-96"><a href="#cb248-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>fork<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> client<span class="op">(</span>channel_name<span class="op">);</span></span>
<span id="cb248-97"><a href="#cb248-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb248-98"><a href="#cb248-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* wait for all of the children */</span></span>
<span id="cb248-99"><a href="#cb248-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>wait<span class="op">(</span>NULL<span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb248-100"><a href="#cb248-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-101"><a href="#cb248-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb248-102"><a href="#cb248-102" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>inline_exec_tmp.c:26:2: error: call to undeclared function &#39;on_exit&#39;; ISO C99 and later do not support implicit function declarations [-Wimplicit-function-declaration]
        on_exit(unlink_domain_socket, strdup(filename));
        ^
inline_exec_tmp.c:26:2: note: did you mean &#39;_exit&#39;?
/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include/unistd.h:430:7: note: &#39;_exit&#39; declared here
void     _exit(int) __dead2;
         ^
1 error generated.
make[1]: *** [inline_exec_tmp] Error 1</code></pre>
            <p>The server’s call to <code>accept</code> is the key
            difference of domain sockets from named pipes. It enables us
            to have per-client descriptors we can use to separately
            communicate (via <code>read</code>/<code>write</code>) to
            each client.</p>
            <ul>
            <li>✗ <strong>Transparent IPC.</strong> - We have to
            explicitly use the socket APIs.</li>
            <li>✓ <strong>Named IPC.</strong> - Uses a file name to name
            the domain socket.</li>
            <li>✓ <strong>Channel-based IPC.</strong> - When data is
            read, it is removed from the socket.</li>
            <li>✓ <strong>Multi-client communication.</strong> - The
            server separates each client’s communication into separate
            descriptors.</li>
            </ul>
            <blockquote>
            <p>Aside: Sockets are the main way to communicate over the
            network (i.e. to chat with the Internet). The APIs you’d use
            to create network sockets are the same, it simply requires
            setting up the <code>socket</code> and the
            <code>bind</code>ing of the socket in a network-specific
            manner.</p>
            </blockquote>
            <h2 data-number="8.6" id="ipc-exercises"><span
            class="header-section-number">8.6</span> IPC Exercises</h2>
            <p>Find the programs:</p>
            <ul>
            <li><a
            href="https://github.com/gwu-cs-sysprog/lectures/blob/main/06/domain_socket_server.c"><code>06/domain_socket_server.c</code></a>
            - a sample server.</li>
            <li><a
            href="https://github.com/gwu-cs-sysprog/lectures/blob/main/06/domain_socket_client.c"><code>06/domain_socket_client.c</code></a>
            - a sample client.</li>
            </ul>
            <p>Both require the <a
            href="https://github.com/gwu-cs-sysprog/lectures/blob/main/06/domain_sockets.h"><code>06/domain_sockets.h</code></a>
            header file. You <em>must</em> run the server first to
            create the domain socket “file”. If you run the server, and
            it complains that “server domain socket creation”, then you
            might need to <code>rm</code> the domain socket file on the
            command line first. It already exists from a previous run of
            the server, so the server cannot create it again!</p>
            <p>Your job is to try to figure what in the hey these do!
            Answer the following questions:</p>
            <ul>
            <li>Describe what the server does to handle each client
            request.</li>
            <li>How many clients can the server handle at a time?</li>
            <li>Is the number of clients limited by the server
            <code>wait</code>ing on client/child processes? Recall when
            talking about background tasks in a shell that the
            <code>wait</code> is key to the system’s
            concurrency/behavior.</li>
            <li>Describe what the client does. What data does it send to
            the server?</li>
            <li>Describe the behavior when you use the client with the
            server.</li>
            </ul>
            <p>The programs can be compiled directly with
            <code>gcc</code>
            (e.g. <code>gcc domain_socket_server.c -o server; gcc domain_socket_client.c -o client</code>).
            Use these programs on the command line to send data from the
            client to server.</p>
            <ul>
            <li>How can you use the client and server programs to send
            data between them?</li>
            <li>How can you make multiple clients connect to the
            server?</li>
            </ul>
            <h1 data-number="9"
            id="reinforcing-ideas-assorted-exercises-and-event-notification"><span
            class="header-section-number">9</span> Reinforcing Ideas:
            Assorted Exercises and Event Notification</h1>
            <p>In the following, if you aren’t <em>positive</em> of the
            answer, please run the program! Note that we’re omitting
            error checking in these programs to keep them terse.
            Remember that in your programs, you must check and react to
            all errors. This will require you to use the
            <code>man</code> pages to look up the required
            <code>#include</code>s. If the output doesn’t match a
            high-level intuition, how would you modify the program to
            match the intuition? What are all of the potential output of
            the following programs? Why?</p>
            <h3 data-number="9.0.1" id="fork-and-stream-behavior"><span
            class="header-section-number">9.0.1</span> <code>fork</code>
            and Stream Behavior</h3>
            <div class="sourceCode" id="cb250"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>fork<span class="op">();</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>fork<span class="op">();</span></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a>printf<span class="op">(</span><span class="st">&quot;z&quot;</span><span class="op">);</span></span></code></pre></div>
            <div class="sourceCode" id="cb251"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>printf<span class="op">(</span><span class="st">&quot;z&quot;</span><span class="op">);</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>fork<span class="op">();</span></span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>fork<span class="op">();</span></span></code></pre></div>
            <div class="sourceCode" id="cb252"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>printf<span class="op">(</span><span class="st">&quot;z&quot;</span><span class="op">);</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>fork<span class="op">();</span></span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="st">&quot;.&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span></code></pre></div>
            <h3 data-number="9.0.2" id="wait-behavior"><span
            class="header-section-number">9.0.2</span> Wait
            Behavior</h3>
            <div class="sourceCode" id="cb253"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a>    pid_t child<span class="op">;</span></span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> wait_param <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>     <span class="co">/* or WNOHANG */</span></span>
<span id="cb253-12"><a href="#cb253-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> output_w_write <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">/* or 1 */</span></span>
<span id="cb253-13"><a href="#cb253-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-14"><a href="#cb253-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">2</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb253-15"><a href="#cb253-15" aria-hidden="true" tabindex="-1"></a>        child <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb253-16"><a href="#cb253-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>child <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb253-17"><a href="#cb253-17" aria-hidden="true" tabindex="-1"></a>            sleep<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb253-18"><a href="#cb253-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>output_w_write<span class="op">)</span> write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="st">&quot;.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb253-19"><a href="#cb253-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>                printf<span class="op">(</span><span class="st">&quot;.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb253-20"><a href="#cb253-20" aria-hidden="true" tabindex="-1"></a>            exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb253-21"><a href="#cb253-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb253-22"><a href="#cb253-22" aria-hidden="true" tabindex="-1"></a>        waitpid<span class="op">(</span>child<span class="op">,</span> NULL<span class="op">,</span> wait_param<span class="op">);</span></span>
<span id="cb253-23"><a href="#cb253-23" aria-hidden="true" tabindex="-1"></a>        write<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> <span class="st">&quot;Post-fork</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb253-24"><a href="#cb253-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb253-25"><a href="#cb253-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* ...are we done here? */</span></span>
<span id="cb253-26"><a href="#cb253-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-27"><a href="#cb253-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb253-28"><a href="#cb253-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <ul>
            <li>What if change <code>wait_param</code> to equal
            <code>WNOHANG</code>?</li>
            <li>What if we change <code>output_w_write</code> to
            <code>1</code>?</li>
            <li>Why do we need to reap children? Why would this actually
            matter?</li>
            </ul>
            <h3 data-number="9.0.3" id="read-behavior"><span
            class="header-section-number">9.0.3</span> <code>read</code>
            Behavior</h3>
            <div class="sourceCode" id="cb254"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a>    pid_t child<span class="op">;</span></span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fds<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>msg <span class="op">=</span> <span class="st">&quot;What type of doggo is Penny?</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a>    pipe<span class="op">(</span>fds<span class="op">);</span></span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-15"><a href="#cb254-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>child <span class="op">=</span> fork<span class="op">())</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb254-16"><a href="#cb254-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* recall: `cat` reads its stdin, and outputs it to stdout */</span></span>
<span id="cb254-17"><a href="#cb254-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> <span class="op">*</span>args<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span><span class="st">&quot;cat&quot;</span><span class="op">,</span> NULL<span class="op">};</span></span>
<span id="cb254-18"><a href="#cb254-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-19"><a href="#cb254-19" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>STDIN_FILENO<span class="op">);</span></span>
<span id="cb254-20"><a href="#cb254-20" aria-hidden="true" tabindex="-1"></a>        dup2<span class="op">(</span>fds<span class="op">[</span><span class="dv">0</span><span class="op">],</span> STDIN_FILENO<span class="op">);</span></span>
<span id="cb254-21"><a href="#cb254-21" aria-hidden="true" tabindex="-1"></a>        execvp<span class="op">(</span>args<span class="op">[</span><span class="dv">0</span><span class="op">],</span> args<span class="op">);</span></span>
<span id="cb254-22"><a href="#cb254-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb254-23"><a href="#cb254-23" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span>fds<span class="op">[</span><span class="dv">1</span><span class="op">],</span> msg<span class="op">,</span> strlen<span class="op">(</span>msg<span class="op">));</span></span>
<span id="cb254-24"><a href="#cb254-24" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;100</span><span class="sc">%%</span><span class="st"> good girl.&quot;</span><span class="op">);</span></span>
<span id="cb254-25"><a href="#cb254-25" aria-hidden="true" tabindex="-1"></a>    wait<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb254-26"><a href="#cb254-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-27"><a href="#cb254-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb254-28"><a href="#cb254-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <ul>
            <li>There are <em>multiple</em> bugs here. Find them and
            squish ’em.</li>
            </ul>
            <h3 data-number="9.0.4" id="signals-1"><span
            class="header-section-number">9.0.4</span> Signals</h3>
            <p>What is the following doing?</p>
            <div class="sourceCode" id="cb255"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;execinfo.h&gt;</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;signal.h&gt;</span><span class="pp"> </span><span class="co">/* sigaction and SIG* */</span></span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>bt<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb255-9"><a href="#cb255-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>bt<span class="op">[</span><span class="dv">128</span><span class="op">];</span></span>
<span id="cb255-10"><a href="#cb255-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">**</span>symbs<span class="op">;</span></span>
<span id="cb255-11"><a href="#cb255-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> nfns<span class="op">,</span> i<span class="op">;</span></span>
<span id="cb255-12"><a href="#cb255-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-13"><a href="#cb255-13" aria-hidden="true" tabindex="-1"></a>    nfns <span class="op">=</span> backtrace<span class="op">(</span>bt<span class="op">,</span> <span class="dv">128</span><span class="op">);</span></span>
<span id="cb255-14"><a href="#cb255-14" aria-hidden="true" tabindex="-1"></a>    symbs <span class="op">=</span> backtrace_symbols<span class="op">(</span>bt<span class="op">,</span> nfns<span class="op">);</span></span>
<span id="cb255-15"><a href="#cb255-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nfns<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb255-16"><a href="#cb255-16" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> symbs<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb255-17"><a href="#cb255-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb255-18"><a href="#cb255-18" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>symbs<span class="op">);</span></span>
<span id="cb255-19"><a href="#cb255-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb255-20"><a href="#cb255-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-21"><a href="#cb255-21" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb255-22"><a href="#cb255-22" aria-hidden="true" tabindex="-1"></a>bar<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>val<span class="op">)</span></span>
<span id="cb255-23"><a href="#cb255-23" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb255-24"><a href="#cb255-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>val <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb255-25"><a href="#cb255-25" aria-hidden="true" tabindex="-1"></a>    bt<span class="op">();</span></span>
<span id="cb255-26"><a href="#cb255-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb255-27"><a href="#cb255-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-28"><a href="#cb255-28" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb255-29"><a href="#cb255-29" aria-hidden="true" tabindex="-1"></a>foo<span class="op">(</span><span class="dt">int</span> <span class="op">*</span>val<span class="op">)</span></span>
<span id="cb255-30"><a href="#cb255-30" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb255-31"><a href="#cb255-31" aria-hidden="true" tabindex="-1"></a>    bar<span class="op">(</span>val<span class="op">);</span></span>
<span id="cb255-32"><a href="#cb255-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb255-33"><a href="#cb255-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-34"><a href="#cb255-34" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb255-35"><a href="#cb255-35" aria-hidden="true" tabindex="-1"></a>sig_fault_handler<span class="op">(</span><span class="dt">int</span> signal_number<span class="op">,</span> siginfo_t <span class="op">*</span>info<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span>context<span class="op">)</span></span>
<span id="cb255-36"><a href="#cb255-36" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb255-37"><a href="#cb255-37" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Fault triggered at address </span><span class="sc">%p</span><span class="st">.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> info<span class="op">-&gt;</span>si_addr<span class="op">);</span></span>
<span id="cb255-38"><a href="#cb255-38" aria-hidden="true" tabindex="-1"></a>    bt<span class="op">();</span></span>
<span id="cb255-39"><a href="#cb255-39" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb255-40"><a href="#cb255-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-41"><a href="#cb255-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb255-42"><a href="#cb255-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb255-43"><a href="#cb255-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-44"><a href="#cb255-44" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb255-45"><a href="#cb255-45" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb255-46"><a href="#cb255-46" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb255-47"><a href="#cb255-47" aria-hidden="true" tabindex="-1"></a>    sigset_t masked<span class="op">;</span></span>
<span id="cb255-48"><a href="#cb255-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> sigaction siginfo<span class="op">;</span></span>
<span id="cb255-49"><a href="#cb255-49" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb255-50"><a href="#cb255-50" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> val<span class="op">;</span></span>
<span id="cb255-51"><a href="#cb255-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-52"><a href="#cb255-52" aria-hidden="true" tabindex="-1"></a>    sigemptyset<span class="op">(&amp;</span>masked<span class="op">);</span></span>
<span id="cb255-53"><a href="#cb255-53" aria-hidden="true" tabindex="-1"></a>    sigaddset<span class="op">(&amp;</span>masked<span class="op">,</span> SIGSEGV<span class="op">);</span></span>
<span id="cb255-54"><a href="#cb255-54" aria-hidden="true" tabindex="-1"></a>    siginfo <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> sigaction<span class="op">)</span> <span class="op">{</span></span>
<span id="cb255-55"><a href="#cb255-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_sigaction <span class="op">=</span> sig_fault_handler<span class="op">,</span></span>
<span id="cb255-56"><a href="#cb255-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_mask      <span class="op">=</span> masked<span class="op">,</span></span>
<span id="cb255-57"><a href="#cb255-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sa_flags     <span class="op">=</span> SA_RESTART <span class="op">|</span> SA_SIGINFO <span class="co">/* we&#39;ll see this later */</span></span>
<span id="cb255-58"><a href="#cb255-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb255-59"><a href="#cb255-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-60"><a href="#cb255-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>sigaction<span class="op">(</span>SIGSEGV<span class="op">,</span> <span class="op">&amp;</span>siginfo<span class="op">,</span> NULL<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb255-61"><a href="#cb255-61" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;sigaction error&quot;</span><span class="op">);</span></span>
<span id="cb255-62"><a href="#cb255-62" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb255-63"><a href="#cb255-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb255-64"><a href="#cb255-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-65"><a href="#cb255-65" aria-hidden="true" tabindex="-1"></a>    foo<span class="op">(&amp;</span>val<span class="op">);</span></span>
<span id="cb255-66"><a href="#cb255-66" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;---</span><span class="sc">\n</span><span class="st">Moving on...</span><span class="sc">\n</span><span class="st">---</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb255-67"><a href="#cb255-67" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb255-68"><a href="#cb255-68" aria-hidden="true" tabindex="-1"></a>    foo<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb255-69"><a href="#cb255-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-70"><a href="#cb255-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb255-71"><a href="#cb255-71" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <ul>
            <li>What are the various aspects of the output? What do the
            numbers mean? What do the strings mean?</li>
            <li>Explain what is happening <em>before</em> the “Moving
            on…”.</li>
            <li>Explain what is happening <em>after</em> the “Moving
            on…”.</li>
            <li>There is a lot of information there (lines being output)
            that aren’t useful to the programmer. Make the output more
            useful by printing only the parts of the output that a
            programmer would find useful.</li>
            </ul>
            <h3 data-number="9.0.5"
            id="communication-with-multiple-clients"><span
            class="header-section-number">9.0.5</span> Communication
            with Multiple Clients</h3>
            <p>Communicating with multiple clients is hard. Domain
            sockets are complicated, but there are challenges around
            blocking on <code>read</code>s. What if one client is very
            “slow”, and we block waiting for them?</p>
            <div class="sourceCode" id="cb256"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;06/domain_sockets.h&quot;</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb256-6"><a href="#cb256-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb256-7"><a href="#cb256-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb256-8"><a href="#cb256-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb256-9"><a href="#cb256-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-10"><a href="#cb256-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb256-11"><a href="#cb256-11" aria-hidden="true" tabindex="-1"></a>panic<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>msg<span class="op">)</span></span>
<span id="cb256-12"><a href="#cb256-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb256-13"><a href="#cb256-13" aria-hidden="true" tabindex="-1"></a>    perror<span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb256-14"><a href="#cb256-14" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb256-15"><a href="#cb256-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb256-16"><a href="#cb256-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-17"><a href="#cb256-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb256-18"><a href="#cb256-18" aria-hidden="true" tabindex="-1"></a>client<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>filename<span class="op">,</span> <span class="dt">int</span> slowdown<span class="op">)</span></span>
<span id="cb256-19"><a href="#cb256-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb256-20"><a href="#cb256-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">,</span> socket_desc<span class="op">;</span></span>
<span id="cb256-21"><a href="#cb256-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> b<span class="op">;</span></span>
<span id="cb256-22"><a href="#cb256-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-23"><a href="#cb256-23" aria-hidden="true" tabindex="-1"></a>    socket_desc <span class="op">=</span> domain_socket_client_create<span class="op">(</span>filename<span class="op">);</span></span>
<span id="cb256-24"><a href="#cb256-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>socket_desc <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb256-25"><a href="#cb256-25" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;domain socket client create&quot;</span><span class="op">);</span></span>
<span id="cb256-26"><a href="#cb256-26" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb256-27"><a href="#cb256-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb256-28"><a href="#cb256-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-29"><a href="#cb256-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* delay after creating connection, but before communicating */</span></span>
<span id="cb256-30"><a href="#cb256-30" aria-hidden="true" tabindex="-1"></a>    sleep<span class="op">(</span>slowdown<span class="op">);</span></span>
<span id="cb256-31"><a href="#cb256-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>write<span class="op">(</span>socket_desc<span class="op">,</span> <span class="st">&quot;.&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> panic<span class="op">(</span><span class="st">&quot;client write&quot;</span><span class="op">);</span></span>
<span id="cb256-32"><a href="#cb256-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>read<span class="op">(</span>socket_desc<span class="op">,</span> <span class="op">&amp;</span>b<span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span>   panic<span class="op">(</span><span class="st">&quot;client read&quot;</span><span class="op">);</span></span>
<span id="cb256-33"><a href="#cb256-33" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;c: </span><span class="sc">%c\n</span><span class="st">&quot;</span><span class="op">,</span> b<span class="op">);</span></span>
<span id="cb256-34"><a href="#cb256-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-35"><a href="#cb256-35" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>socket_desc<span class="op">);</span></span>
<span id="cb256-36"><a href="#cb256-36" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb256-37"><a href="#cb256-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb256-38"><a href="#cb256-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-39"><a href="#cb256-39" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb256-40"><a href="#cb256-40" aria-hidden="true" tabindex="-1"></a>client_slow<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>filename<span class="op">)</span></span>
<span id="cb256-41"><a href="#cb256-41" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb256-42"><a href="#cb256-42" aria-hidden="true" tabindex="-1"></a>    client<span class="op">(</span>filename<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb256-43"><a href="#cb256-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb256-44"><a href="#cb256-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-45"><a href="#cb256-45" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb256-46"><a href="#cb256-46" aria-hidden="true" tabindex="-1"></a>client_fast<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>filename<span class="op">)</span></span>
<span id="cb256-47"><a href="#cb256-47" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb256-48"><a href="#cb256-48" aria-hidden="true" tabindex="-1"></a>    client<span class="op">(</span>filename<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb256-49"><a href="#cb256-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb256-50"><a href="#cb256-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-51"><a href="#cb256-51" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb256-52"><a href="#cb256-52" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb256-53"><a href="#cb256-53" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb256-54"><a href="#cb256-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>ds <span class="op">=</span> <span class="st">&quot;domain_socket&quot;</span><span class="op">;</span></span>
<span id="cb256-55"><a href="#cb256-55" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> socket_desc<span class="op">,</span> i<span class="op">;</span></span>
<span id="cb256-56"><a href="#cb256-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-57"><a href="#cb256-57" aria-hidden="true" tabindex="-1"></a>    socket_desc <span class="op">=</span> domain_socket_server_create<span class="op">(</span>ds<span class="op">);</span></span>
<span id="cb256-58"><a href="#cb256-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>socket_desc <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb256-59"><a href="#cb256-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* remove the previous domain socket file if it exists */</span></span>
<span id="cb256-60"><a href="#cb256-60" aria-hidden="true" tabindex="-1"></a>        unlink<span class="op">(</span>ds<span class="op">);</span></span>
<span id="cb256-61"><a href="#cb256-61" aria-hidden="true" tabindex="-1"></a>        socket_desc <span class="op">=</span> domain_socket_server_create<span class="op">(</span>ds<span class="op">);</span></span>
<span id="cb256-62"><a href="#cb256-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>socket_desc <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> panic<span class="op">(</span><span class="st">&quot;server domain socket creation&quot;</span><span class="op">);</span></span>
<span id="cb256-63"><a href="#cb256-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb256-64"><a href="#cb256-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-65"><a href="#cb256-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* </span><span class="al">TODO</span><span class="co">: change this order. What changes? */</span></span>
<span id="cb256-66"><a href="#cb256-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fork<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> client_slow<span class="op">(</span>ds<span class="op">);</span></span>
<span id="cb256-67"><a href="#cb256-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fork<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> client_fast<span class="op">(</span>ds<span class="op">);</span></span>
<span id="cb256-68"><a href="#cb256-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-69"><a href="#cb256-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* handle two clients, one after the other */</span></span>
<span id="cb256-70"><a href="#cb256-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">2</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb256-71"><a href="#cb256-71" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> ret<span class="op">,</span> new_client<span class="op">,</span> i<span class="op">;</span></span>
<span id="cb256-72"><a href="#cb256-72" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> b<span class="op">;</span></span>
<span id="cb256-73"><a href="#cb256-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-74"><a href="#cb256-74" aria-hidden="true" tabindex="-1"></a>        new_client <span class="op">=</span> accept<span class="op">(</span>socket_desc<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb256-75"><a href="#cb256-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>new_client <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> panic<span class="op">(</span><span class="st">&quot;server accept&quot;</span><span class="op">);</span></span>
<span id="cb256-76"><a href="#cb256-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-77"><a href="#cb256-77" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* read from, then write to the client! */</span></span>
<span id="cb256-78"><a href="#cb256-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>read<span class="op">(</span>new_client<span class="op">,</span> <span class="op">&amp;</span>b<span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span>   panic<span class="op">(</span><span class="st">&quot;server read&quot;</span><span class="op">);</span></span>
<span id="cb256-79"><a href="#cb256-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>write<span class="op">(</span>new_client<span class="op">,</span> <span class="st">&quot;*&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> panic<span class="op">(</span><span class="st">&quot;server write&quot;</span><span class="op">);</span></span>
<span id="cb256-80"><a href="#cb256-80" aria-hidden="true" tabindex="-1"></a>        close<span class="op">(</span>new_client<span class="op">);</span></span>
<span id="cb256-81"><a href="#cb256-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb256-82"><a href="#cb256-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-83"><a href="#cb256-83" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>socket_desc<span class="op">);</span></span>
<span id="cb256-84"><a href="#cb256-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* reap all children */</span></span>
<span id="cb256-85"><a href="#cb256-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>wait<span class="op">(</span>NULL<span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">;</span></span>
<span id="cb256-86"><a href="#cb256-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-87"><a href="#cb256-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb256-88"><a href="#cb256-88" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <ul>
            <li>See the TODO in the <code>main</code>. When you change
            the order, what do you see?</li>
            <li>Is there generally a problem when we use both fast and
            slow clients?</li>
            </ul>
            <h2 data-number="9.1"
            id="revisiting-ipc-with-multiple-clients"><span
            class="header-section-number">9.1</span> Revisiting IPC with
            Multiple Clients</h2>
            <h3 data-number="9.1.1" id="system-services"><span
            class="header-section-number">9.1.1</span> System
            Services</h3>
            <p>The <code>systemctl</code> command enables you to
            understand many of the services on the system (of which
            there are many: <code>systemctl --list-units | wc -l</code>
            yields <code>244</code> on my system).</p>
            <pre><code>$ systemctl --list-units
...
  cups.service           loaded active     running   CUPS Scheduler
...
  gdm.service            loaded active     running   GNOME Display Manager
...
  ssh.service            loaded active     running   OpenBSD Secure Shell server
...
  NetworkManager.service loaded active     running   Network Manager
...
  openvpn.service        loaded active     exited    OpenVPN service
...</code></pre>
            <p>I’ve pulled out a few selections that are easier to
            relate to:</p>
            <ul>
            <li>CUPS which is the service used to receive print
            jobs.</li>
            <li><a
            href="https://en.wikipedia.org/wiki/GNOME_Display_Manager">GDM</a>
            which manages your <em>graphical logins</em> on Ubuntu.</li>
            <li>OpenSSH which manages your <em>remote</em> logins
            through <code>ssh</code>.</li>
            <li>NetworkManager that you interact with when you select
            which wifi hotspot to use.</li>
            <li>OpenVPN which handles your VPN logins to the school
            network. You can see that the service is currently “exited”
            as I’m not running VPN now.</li>
            </ul>
            <p>Each of these services communicates with many clients
            using domain sockets.</p>
            <h3 data-number="9.1.2"
            id="understanding-descriptor-events-with-poll"><span
            class="header-section-number">9.1.2</span> Understanding
            Descriptor Events with <code>poll</code></h3>
            <p>Each of these services is a process that any client send
            requests to. We’ve seen that domain sockets can help us to
            talk to many different clients as each is represented with a
            separate file descriptor. How does the service process know
            <em>which of the file descriptors</em> has information
            available on it? Imagine the following case:</p>
            <ol type="1">
            <li>a client, <em>A</em>, connects to a service.</li>
            <li>a client, <em>B</em>, connects to the same service.</li>
            <li><em>B</em> immediately sends a request, while <em>A</em>
            goes into a <code>sleep(100)</code> (or, more realistically,
            simply does some expensive computation).</li>
            </ol>
            <p>If the server issues a <code>read</code> on the
            descriptor for <em>A</em>, it will block for 100 seconds!
            Worse, it won’t service <em>B</em> despite it making a
            request immediately. Why are we waiting for a slow client
            when there is a fast client with data already available?
            Yikes.</p>
            <p>We’d really like a facility that can tell us
            <em>which</em> descriptor’s have data and are ready to be
            read from, and which are ready to be written to! Luckily,
            UNIX comes to the rescue with its <em>event
            notification</em> APIs. These are APIs that let us
            understand when a file descriptor has an <em>event</em>
            (i.e. a client writes to it) and is now readable or
            writable. These include three functions: <code>poll</code>,
            <code>select</code>, and (the more modern)
            <code>epoll</code>. Lets look at how to use
            <code>poll</code>!</p>
            <h3 data-number="9.1.3" id="event-loops-and-poll"><span
            class="header-section-number">9.1.3</span> Event Loops and
            <code>poll</code></h3>
            <p>Lets look at some pseudocode for using
            <code>poll</code>.</p>
            <div class="sourceCode" id="cb258"><pre
            class="sourceCode python"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>fdinfo[NUM_FDS] <span class="op">=</span> {</span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initialized to all fds of interest, listening for read and write events</span></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>    poll(fdinfo, NUM_FDS, <span class="op">-</span><span class="dv">1</span>) <span class="co"># -1 = no timeout</span></span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fdi <span class="kw">in</span> fdinfo:</span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># check and respond to each of the possible events</span></span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fdi.revents <span class="op">&amp;</span> (POLLHUP <span class="op">|</span> POLLERR):</span>
<span id="cb258-9"><a href="#cb258-9" aria-hidden="true" tabindex="-1"></a>            <span class="co"># process closed fds</span></span>
<span id="cb258-10"><a href="#cb258-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fdi.revents <span class="op">&amp;</span> POLLIN:</span>
<span id="cb258-11"><a href="#cb258-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># read off of, or accept on the file desciptor</span></span>
<span id="cb258-12"><a href="#cb258-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fdi.revents <span class="op">&amp;</span> POLLOUT:</span>
<span id="cb258-13"><a href="#cb258-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># write to the file desciptor</span></span></code></pre></div>
            <p>This yields what is called an <em>event loop</em> – we
            loop, each time processing a single event. You see event
            loops in most GUIs (where each event is a key/mouse press),
            and in web programming where javascript callbacks are
            executed by the browser’s event loop. Importantly, <em>we
            only process descriptors that have events, thus can avoid
            blocking on descriptors that don’t have available data!</em>
            This solves our previous problem: a server won’t block
            awaiting communication with a client that is delayed, or
            never writes to a channel, instead only
            <code>read</code>ing/<code>write</code>ing to descriptors
            that are ready.</p>
            <h3 data-number="9.1.4" id="poll-api"><span
            class="header-section-number">9.1.4</span> <code>poll</code>
            API</h3>
            <ul>
            <li><code>int poll(struct pollfd *fds, nfds_t nfds, int timeout)</code>
            - We pass in an array of <code>struct pollfd</code>s of
            length <code>nfds</code>, with each entry corresponding to a
            single file descriptor we want to get information about. The
            <code>timeout</code> is in milliseconds, and enables
            <code>poll</code> to return after that amount of time
            returns even if none of the file descriptors has an event. A
            negative <code>timeout</code> is interpreted as “infinite”,
            while <code>0</code> means that <code>poll</code> will
            return immediately with any current events.</li>
            </ul>
            <p>Lets check out the <code>struct pollfd</code>:</p>
            <div class="sourceCode" id="cb259"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> pollfd <span class="op">{</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>   fd<span class="op">;</span>         <span class="co">/* file descriptor */</span></span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> events<span class="op">;</span>     <span class="co">/* requested events */</span></span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">short</span> revents<span class="op">;</span>    <span class="co">/* returned events */</span></span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
            <p>When we make the <code>poll</code> call, we populate the
            <code>fd</code> and <code>events</code> fields with the file
            descriptors we’re interested in, and which events we’re
            interested in retrieving. <code>events</code> is a “bitmap”
            which means each bit in the value denotes a different type
            of event, and we bitwise <em>or</em> event types together
            when writing them into <code>events</code>. These event
            types include:</p>
            <ul>
            <li><code>POLLIN</code> - is there data available to be
            <code>read</code>? If the file descriptor is the domain
            socket that we use for <code>accept</code>, then this
            <code>POLLIN</code> means that a new client request is ready
            to <code>accept</code>.</li>
            <li><code>POLLOUT</code> - is there data available to be
            <code>write</code>n?</li>
            </ul>
            <p>We can almost always set
            <code>events = POLLIN | POLLOUT</code> as we wait to wait
            for both.</p>
            <p>When <code>poll</code> returns, we determine which events
            happened by looking at the contents of the
            <code>revents</code> field. In addition to
            <code>POLLIN</code> and <code>POLLOUT</code> which tell us
            if data is ready to be <code>read</code> or
            <code>written</code>, we have the following:</p>
            <ul>
            <li><code>POLLHUP</code> - The other side of the pipe closed
            its descriptor! Subsequent <code>read</code>s to the
            descriptor will return <code>0</code>. We can likely
            <code>close</code> our descriptor.</li>
            <li><code>POLLERR</code> - Again, there was some sort of a
            problem with the descriptor, and we should likely
            <code>close</code> it, terminating communication.</li>
            </ul>
            <h3 data-number="9.1.5" id="example-poll-code"><span
            class="header-section-number">9.1.5</span> Example
            <code>poll</code> Code</h3>
            <p>Lets put this all together. For simplicity, in this
            example, we’ll assume that we can always <code>write</code>
            to a descriptor without blocking. This isn’t generally true
            if you’re writing large amounts of data, and in “real code”
            you’d also want to handle <code>POLLOUT</code>
            appropriately.</p>
            <div class="sourceCode" id="cb260"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;06/domain_sockets.h&quot;</span></span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/wait.h&gt;</span></span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb260-9"><a href="#cb260-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;poll.h&gt;</span></span>
<span id="cb260-10"><a href="#cb260-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-11"><a href="#cb260-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb260-12"><a href="#cb260-12" aria-hidden="true" tabindex="-1"></a>panic<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>msg<span class="op">)</span></span>
<span id="cb260-13"><a href="#cb260-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb260-14"><a href="#cb260-14" aria-hidden="true" tabindex="-1"></a>    perror<span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb260-15"><a href="#cb260-15" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb260-16"><a href="#cb260-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb260-17"><a href="#cb260-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-18"><a href="#cb260-18" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb260-19"><a href="#cb260-19" aria-hidden="true" tabindex="-1"></a>client<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>filename<span class="op">)</span></span>
<span id="cb260-20"><a href="#cb260-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb260-21"><a href="#cb260-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">,</span> socket_desc<span class="op">;</span></span>
<span id="cb260-22"><a href="#cb260-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-23"><a href="#cb260-23" aria-hidden="true" tabindex="-1"></a>    sleep<span class="op">(</span><span class="dv">1</span><span class="op">);</span> <span class="co">/* await the domain socket creation by the server */</span></span>
<span id="cb260-24"><a href="#cb260-24" aria-hidden="true" tabindex="-1"></a>    socket_desc <span class="op">=</span> domain_socket_client_create<span class="op">(</span>filename<span class="op">);</span></span>
<span id="cb260-25"><a href="#cb260-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>socket_desc <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb260-26"><a href="#cb260-26" aria-hidden="true" tabindex="-1"></a>        perror<span class="op">(</span><span class="st">&quot;domain socket client create&quot;</span><span class="op">);</span></span>
<span id="cb260-27"><a href="#cb260-27" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb260-28"><a href="#cb260-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb260-29"><a href="#cb260-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-30"><a href="#cb260-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">5</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb260-31"><a href="#cb260-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span> b<span class="op">;</span></span>
<span id="cb260-32"><a href="#cb260-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>write<span class="op">(</span>socket_desc<span class="op">,</span> <span class="st">&quot;.&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> panic<span class="op">(</span><span class="st">&quot;client write&quot;</span><span class="op">);</span></span>
<span id="cb260-33"><a href="#cb260-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>read<span class="op">(</span>socket_desc<span class="op">,</span> <span class="op">&amp;</span>b<span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span>   panic<span class="op">(</span><span class="st">&quot;client read&quot;</span><span class="op">);</span></span>
<span id="cb260-34"><a href="#cb260-34" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;c </span><span class="sc">%d</span><span class="st">: </span><span class="sc">%c\n</span><span class="st">&quot;</span><span class="op">,</span> getpid<span class="op">(),</span> b<span class="op">);</span></span>
<span id="cb260-35"><a href="#cb260-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb260-36"><a href="#cb260-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-37"><a href="#cb260-37" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>socket_desc<span class="op">);</span></span>
<span id="cb260-38"><a href="#cb260-38" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb260-39"><a href="#cb260-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb260-40"><a href="#cb260-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-41"><a href="#cb260-41" aria-hidden="true" tabindex="-1"></a><span class="co">/* we can track max 16 fds */</span></span>
<span id="cb260-42"><a href="#cb260-42" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MAX_FDS </span><span class="dv">16</span></span>
<span id="cb260-43"><a href="#cb260-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-44"><a href="#cb260-44" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span></span>
<span id="cb260-45"><a href="#cb260-45" aria-hidden="true" tabindex="-1"></a>server<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>filename<span class="op">)</span></span>
<span id="cb260-46"><a href="#cb260-46" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb260-47"><a href="#cb260-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> socket_desc<span class="op">,</span> num_fds <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb260-48"><a href="#cb260-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> pollfd poll_fds<span class="op">[</span>MAX_FDS<span class="op">];</span></span>
<span id="cb260-49"><a href="#cb260-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-50"><a href="#cb260-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*** Initialize the domain socket and its pollfd ***/</span></span>
<span id="cb260-51"><a href="#cb260-51" aria-hidden="true" tabindex="-1"></a>    socket_desc <span class="op">=</span> domain_socket_server_create<span class="op">(</span>filename<span class="op">);</span></span>
<span id="cb260-52"><a href="#cb260-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>socket_desc <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb260-53"><a href="#cb260-53" aria-hidden="true" tabindex="-1"></a>        unlink<span class="op">(</span>filename<span class="op">);</span> <span class="co">/* remove the previous domain socket file if it exists */</span></span>
<span id="cb260-54"><a href="#cb260-54" aria-hidden="true" tabindex="-1"></a>        socket_desc <span class="op">=</span> domain_socket_server_create<span class="op">(</span>filename<span class="op">);</span></span>
<span id="cb260-55"><a href="#cb260-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>socket_desc <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> panic<span class="op">(</span><span class="st">&quot;server domain socket creation&quot;</span><span class="op">);</span></span>
<span id="cb260-56"><a href="#cb260-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb260-57"><a href="#cb260-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-58"><a href="#cb260-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Initialize all pollfd structs to 0 */</span></span>
<span id="cb260-59"><a href="#cb260-59" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>poll_fds<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="kw">struct</span> pollfd<span class="op">)</span> <span class="op">*</span> MAX_FDS<span class="op">);</span></span>
<span id="cb260-60"><a href="#cb260-60" aria-hidden="true" tabindex="-1"></a>    poll_fds<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> pollfd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb260-61"><a href="#cb260-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>fd     <span class="op">=</span> socket_desc<span class="op">,</span></span>
<span id="cb260-62"><a href="#cb260-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>events <span class="op">=</span> POLLIN<span class="op">,</span></span>
<span id="cb260-63"><a href="#cb260-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb260-64"><a href="#cb260-64" aria-hidden="true" tabindex="-1"></a>    num_fds<span class="op">++;</span></span>
<span id="cb260-65"><a href="#cb260-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-66"><a href="#cb260-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*** The event loop ***/</span></span>
<span id="cb260-67"><a href="#cb260-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb260-68"><a href="#cb260-68" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> ret<span class="op">,</span> new_client<span class="op">,</span> i<span class="op">;</span></span>
<span id="cb260-69"><a href="#cb260-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-70"><a href="#cb260-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*** Poll; if we don&#39;t get a client for a second, exit ***/</span></span>
<span id="cb260-71"><a href="#cb260-71" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> poll<span class="op">(</span>poll_fds<span class="op">,</span> num_fds<span class="op">,</span> <span class="dv">1000</span><span class="op">);</span></span>
<span id="cb260-72"><a href="#cb260-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ret <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> panic<span class="op">(</span><span class="st">&quot;poll error&quot;</span><span class="op">);</span></span>
<span id="cb260-73"><a href="#cb260-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb260-74"><a href="#cb260-74" aria-hidden="true" tabindex="-1"></a><span class="co">         * If we timeout, break out of the loop.</span></span>
<span id="cb260-75"><a href="#cb260-75" aria-hidden="true" tabindex="-1"></a><span class="co">         * This isn&#39;t what you&#39;d normally do as servers stick around!</span></span>
<span id="cb260-76"><a href="#cb260-76" aria-hidden="true" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb260-77"><a href="#cb260-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>ret <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb260-78"><a href="#cb260-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-79"><a href="#cb260-79" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*** Accept file descriptor has a new client connecting! ***/</span></span>
<span id="cb260-80"><a href="#cb260-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>poll_fds<span class="op">[</span><span class="dv">0</span><span class="op">].</span>revents <span class="op">&amp;</span> POLLIN<span class="op">)</span> <span class="op">{</span></span>
<span id="cb260-81"><a href="#cb260-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">((</span>new_client <span class="op">=</span> accept<span class="op">(</span>socket_desc<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> panic<span class="op">(</span><span class="st">&quot;server accept&quot;</span><span class="op">);</span></span>
<span id="cb260-82"><a href="#cb260-82" aria-hidden="true" tabindex="-1"></a>            <span class="co">/* add a new file descriptor! */</span></span>
<span id="cb260-83"><a href="#cb260-83" aria-hidden="true" tabindex="-1"></a>            poll_fds<span class="op">[</span>num_fds<span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="kw">struct</span> pollfd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb260-84"><a href="#cb260-84" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>fd <span class="op">=</span> new_client<span class="op">,</span></span>
<span id="cb260-85"><a href="#cb260-85" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>events <span class="op">=</span> POLLIN</span>
<span id="cb260-86"><a href="#cb260-86" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb260-87"><a href="#cb260-87" aria-hidden="true" tabindex="-1"></a>            num_fds<span class="op">++;</span></span>
<span id="cb260-88"><a href="#cb260-88" aria-hidden="true" tabindex="-1"></a>            poll_fds<span class="op">[</span><span class="dv">0</span><span class="op">].</span>revents <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb260-89"><a href="#cb260-89" aria-hidden="true" tabindex="-1"></a>            printf<span class="op">(</span><span class="st">&quot;server: created client connection </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> new_client<span class="op">);</span></span>
<span id="cb260-90"><a href="#cb260-90" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb260-91"><a href="#cb260-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*** Communicate with clients! ***/</span></span>
<span id="cb260-92"><a href="#cb260-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> num_fds<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb260-93"><a href="#cb260-93" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>poll_fds<span class="op">[</span>i<span class="op">].</span>revents <span class="op">&amp;</span> <span class="op">(</span>POLLHUP <span class="op">|</span> POLLERR<span class="op">))</span> <span class="op">{</span></span>
<span id="cb260-94"><a href="#cb260-94" aria-hidden="true" tabindex="-1"></a>                printf<span class="op">(</span><span class="st">&quot;server: closing client connection </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> poll_fds<span class="op">[</span>i<span class="op">].</span>fd<span class="op">);</span></span>
<span id="cb260-95"><a href="#cb260-95" aria-hidden="true" tabindex="-1"></a>                poll_fds<span class="op">[</span>i<span class="op">].</span>revents <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb260-96"><a href="#cb260-96" aria-hidden="true" tabindex="-1"></a>                close<span class="op">(</span>poll_fds<span class="op">[</span>i<span class="op">].</span>fd<span class="op">);</span></span>
<span id="cb260-97"><a href="#cb260-97" aria-hidden="true" tabindex="-1"></a>                <span class="co">/* replace the fd to fill the gap */</span></span>
<span id="cb260-98"><a href="#cb260-98" aria-hidden="true" tabindex="-1"></a>                poll_fds<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> poll_fds<span class="op">[</span>num_fds <span class="op">-</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb260-99"><a href="#cb260-99" aria-hidden="true" tabindex="-1"></a>                num_fds<span class="op">--;</span></span>
<span id="cb260-100"><a href="#cb260-100" aria-hidden="true" tabindex="-1"></a>                <span class="co">/* make sure to check the fd we used to fill the gap */</span></span>
<span id="cb260-101"><a href="#cb260-101" aria-hidden="true" tabindex="-1"></a>                i<span class="op">--;</span></span>
<span id="cb260-102"><a href="#cb260-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-103"><a href="#cb260-103" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb260-104"><a href="#cb260-104" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb260-105"><a href="#cb260-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>poll_fds<span class="op">[</span>i<span class="op">].</span>revents <span class="op">&amp;</span> POLLIN<span class="op">)</span> <span class="op">{</span></span>
<span id="cb260-106"><a href="#cb260-106" aria-hidden="true" tabindex="-1"></a>                <span class="dt">char</span> b<span class="op">;</span></span>
<span id="cb260-107"><a href="#cb260-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-108"><a href="#cb260-108" aria-hidden="true" tabindex="-1"></a>                poll_fds<span class="op">[</span>i<span class="op">].</span>revents <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb260-109"><a href="#cb260-109" aria-hidden="true" tabindex="-1"></a>                <span class="co">/* our server is simply sending a &#39;*&#39; for each input character */</span></span>
<span id="cb260-110"><a href="#cb260-110" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>read<span class="op">(</span>poll_fds<span class="op">[</span>i<span class="op">].</span>fd<span class="op">,</span> <span class="op">&amp;</span>b<span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> panic<span class="op">(</span><span class="st">&quot;server read&quot;</span><span class="op">);</span></span>
<span id="cb260-111"><a href="#cb260-111" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>write<span class="op">(</span>poll_fds<span class="op">[</span>i<span class="op">].</span>fd<span class="op">,</span> <span class="st">&quot;*&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> panic<span class="op">(</span><span class="st">&quot;server write&quot;</span><span class="op">);</span></span>
<span id="cb260-112"><a href="#cb260-112" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb260-113"><a href="#cb260-113" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb260-114"><a href="#cb260-114" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb260-115"><a href="#cb260-115" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>socket_desc<span class="op">);</span></span>
<span id="cb260-116"><a href="#cb260-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-117"><a href="#cb260-117" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EXIT_SUCCESS<span class="op">);</span></span>
<span id="cb260-118"><a href="#cb260-118" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb260-119"><a href="#cb260-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-120"><a href="#cb260-120" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb260-121"><a href="#cb260-121" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb260-122"><a href="#cb260-122" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb260-123"><a href="#cb260-123" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>ds <span class="op">=</span> <span class="st">&quot;domain_socket&quot;</span><span class="op">;</span></span>
<span id="cb260-124"><a href="#cb260-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-125"><a href="#cb260-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fork<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> client<span class="op">(</span>ds<span class="op">);</span></span>
<span id="cb260-126"><a href="#cb260-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fork<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> client<span class="op">(</span>ds<span class="op">);</span></span>
<span id="cb260-127"><a href="#cb260-127" aria-hidden="true" tabindex="-1"></a>    server<span class="op">(</span>ds<span class="op">);</span></span>
<span id="cb260-128"><a href="#cb260-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-129"><a href="#cb260-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb260-130"><a href="#cb260-130" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <h1 data-number="10" id="libraries"><span
            class="header-section-number">10</span> Libraries</h1>
            <p>Up till now, we’ve been focusing on UNIX programming
            APIs, and how to interact with various aspects of the
            system. Part of this discussion has been how various
            programs can be orchestrated to cooperate. Pipelines enable
            larger functionalities to be composed out of multiple
            programs in which the output of one goes to the input of the
            next. System servers provide services to clients that use
            IPC to harness their functionality. This enables servers
            that control system resources (like wifi) to let many
            clients have limited and controlled access to those
            resources.</p>
            <p>The next few chapters dive under the hood of processes.
            We’ll investigate</p>
            <ol type="1">
            <li>how programs are represented and how to understand their
            format,</li>
            <li>how programs are organized and can share code, and</li>
            <li>how they interact with the system.</li>
            </ol>
            <p>How do we think about our system’s programs? We’re used
            to writing our own programs, and like to think of the code
            we write being relatively self-contained. In contrast, quite
            a bit of <em>system programming</em> is about providing
            functionality that can be used by <em>any program on the
            system</em>. What if you wanted to implement the world’s
            best key-value store, and wanted to enable anyone to use
            your implementation!?</p>
            <p>We think of these <em>shared</em> functionalities as
            falling into one of two categories:</p>
            <ol type="1">
            <li><em>Libraries</em> that represent bodies of code that
            can be pull into our applications. You’re already quite used
            to these! <code>libc</code> is the core library that
            provides all of the functions that we use when we include
            many of the headers in the class, for example,
            <code>#include &lt;stdlib.h&gt;</code>,
            <code>#include &lt;stdio.h&gt;</code>, or
            <code>#include &lt;string.h&gt;</code>.</li>
            <li><em>Services</em> which track different aspects of the
            system, and provide information to our programs. They tend
            to be programs that are always running on your system, and
            your programs can communicate with them to harness their
            functionality. These include services that receive print
            requests, that service <code>ssh</code> sessions, that
            provide your <code>vpn</code> connection, and that display
            your graphical user interface, and many other functions.
            We’ve already seen many of the IPC and communication
            foundations that make these tick.</li>
            </ol>
            <p>This chapter, we’ll focus on libraries as a foundation
            for sharing software in systems.</p>
            <h2 data-number="10.1"
            id="libraries---goals-and-overview"><span
            class="header-section-number">10.1</span> Libraries - Goals
            and Overview</h2>
            <p>Before we start, consider:</p>
            <ul>
            <li>When you <code>#include</code> a ton of files, do you
            think that all of the related functionality is compiled into
            your program? That would mean that <em>every</em> program
            has the functionality compiled into it.</li>
            <li>If so, how much memory and disk space do you think that
            will take?</li>
            <li>Do you think there are other options? What might they
            be?</li>
            </ul>
            <p>Visually, this is what it would look like to compile with
            “libraries” that are defined as normal <code>*.o</code>
            files.</p>
            <figure>
            <img src="figures/08_naivelib.svg"
            alt="We know how to generate *.o files, and to combine them together as shown here. If some other people’s code that we depend on (e.g. string.h functionality) is provided as *.o files, we could compile with it as such. The questions above should let you think about the trade-offs with this approach." />
            <figcaption aria-hidden="true">We know how to generate
            <code>*.o</code> files, and to combine them together as
            shown here. If some other people’s code that we depend on
            (e.g. <code>string.h</code> functionality) is provided as
            <code>*.o</code> files, we could compile with it as such.
            The questions above should let you think about the
            trade-offs with this approach.</figcaption>
            </figure>
            <p>The <em>goals</em> of libraries are to:</p>
            <ul>
            <li>Enable programs to leverage shared implementations of
            specific functionality (e.g. the contents of
            <code>string.h</code>).</li>
            <li>Provide a uniform set of programming APIs to
            programs.</li>
            <li>Attempt to save memory by making all programs in the
            system as small as possible by not taking memory for all of
            the library code in each program.</li>
            <li>Enable the system to upgrade both libraries and programs
            (for example, if a security compromise is found).</li>
            </ul>
            <p>Libraries are collections of functionality that can be
            used by many different programs. They are code that expand
            the functionality of programs. This differs from services
            which are separate programs. Libraries have two core
            components that mirror what we understand about C:</p>
            <ol type="1">
            <li><em>header files</em> that share the types of the
            library API functions and data, and</li>
            <li>the <em>code to implement</em> those APIs.</li>
            </ol>
            <p>Lets set up some visual nomenclature.</p>
            <figure>
            <img src="figures/08_libfiles.svg"
            alt="We’ll talk about the files that are part of your normal programs (the *.c and *.o on the left), those that are part of the library, and files to represent the library." />
            <figcaption aria-hidden="true">We’ll talk about the files
            that are part of your normal programs (the <code>*.c</code>
            and <code>*.o</code> on the left), those that are part of
            the library, and files to represent the
            library.</figcaption>
            </figure>
            <p>There are two main ways library code is integrated into
            programs:</p>
            <ul>
            <li><strong>Static libraries.</strong> These are added into
            your program <em>when you compile it</em>.</li>
            <li><strong>Shared or dynamic libraries.</strong> These are
            integrated into your program, dynamically, <em>when you run
            the program</em>.</li>
            </ul>
            <p>We’ll discuss each of these in subsequent sections</p>
            <h2 data-number="10.2" id="libraries---header-files"><span
            class="header-section-number">10.2</span> Libraries - Header
            Files</h2>
            <p>We can see most of the header files in
            <code>/usr/include</code>, within which you’ll find some
            familiar files:</p>
            <pre><code>$ ls /usr/include/std*
/usr/include/stdc-predef.h  /usr/include/stdint.h  /usr/include/stdio_ext.h  /usr/include/stdio.h  /usr/include/stdlib.h</code></pre>
            <p>Yes, this means that you have the source code for much of
            the standard library at your fingertips! But how does
            <code>gcc</code> know to find all of these files when we use
            <code>#include &lt;...&gt;</code>? The following
            <code>gcc</code> incantation gives us a good idea:</p>
            <pre><code>$ gcc -xc -E -v -
...
#include &lt;...&gt; search starts here:
 /usr/lib/gcc/x86_64-linux-gnu/9/include
 /usr/local/include
 /usr/include/x86_64-linux-gnu
 /usr/include
End of search list.
</code></pre>
            <p>These are all of the “include paths” that are searched,
            by default, when we do an
            <code>#include &lt;&gt;</code>.</p>
            <blockquote>
            <p>Aside: In <code>Makefiles</code>, we often want to add to
            tell the compiler to look for header files in our own files
            Thus, we update the include paths by adding multiple
            <code>-I&lt;dir&gt;</code> options to the <code>gcc</code>
            command line. We can see how this works:</p>
            <pre><code>$ gcc -I. -xc -E -v -
...
#include &lt;...&gt; search starts here:
.
/usr/lib/gcc/x86_64-linux-gnu/9/include
...</code></pre>
            <p>The include paths are searched in order, so you can see
            that when we explicitly tell <code>gcc</code> to include a
            directory <code>-I.</code> here, we’re asking to to check in
            the current directory (<code>.</code>) first.</p>
            </blockquote>
            <h2 data-number="10.3"
            id="linking-undefined-symbols-to-references-across-objects"><span
            class="header-section-number">10.3</span> Linking Undefined
            Symbols to References Across Objects</h2>
            <p>Before we proceed to figure out how multiple
            <code>*.o</code> <em>objects</em> are combined into an
            executable, lets learn what it means for one object to
            depend on another for some functionality. To understand
            this, we have to understand how object files
            (<code>*.o</code>) and binaries think about symbols and
            linking them together.</p>
            <p>When your program uses a library’s API, the library’s
            code is <em>linked</em> into your program. Linking is the
            act of taking any symbols that are referenced, but not
            defined in your object (<code>*.o</code>) files, and the
            definition of those symbols in the objects that provide
            them. A <em>symbol</em> is a functions or global variable in
            your program. Each symbol has a representation in your
            object files so that they can be referenced across objects.
            We have to understanding the linking operation to dive into
            how libraries can be added into, thus accessible from your
            program. Lets peek into how our objects think about the
            world using a number of programs that can introspect on the
            objects including <code>nm</code>, <code>objdump</code>, and
            <code>readelf</code>.</p>
            <p>As an example, lets look at your <code>ptrie</code>
            implementation. We know that each of the tests (in
            <code>tests/0?-*.c</code>) depends on your ptrie
            implementation in <code>ptrie.c</code>. What does that look
            like?</p>
            <pre><code>$ nm tests/01-add.o
                 U _GLOBAL_OFFSET_TABLE_
000000000000022a T main
                 U printf
                 U ptrie_add
                 U ptrie_allocate
                 U ptrie_free
                 U __stack_chk_fail
0000000000000000 t sunit_execute
0000000000000000 d test
0000000000000184 T test_add
0000000000000144 T test_alloc</code></pre>
            <p>The left column is the address of the symbol, and the
            character in the middle column gives us some information
            about the symbol:</p>
            <ul>
            <li><code>T</code> - this symbol is part of the code of the
            <code>*.o</code> file, and is visible outside of the object
            (i.e. it isn’t <code>static</code>). Capital letters mean
            that the symbol is visible outside the object which simply
            means it can be linked with another object.</li>
            <li><code>t</code> - this symbol is part of the code, but is
            <em>not visible</em> outside of the object (it is
            <code>static</code>).</li>
            <li><code>D</code> - a global variable that is visible.</li>
            <li><code>d</code> - a global variable that is not
            visible.</li>
            <li><code>U</code> - an <em>undefined symbol</em> that must
            be provided by another object file.</li>
            </ul>
            <p>For other symbol types, see <code>man nm</code>.</p>
            <p>We can see what we’d expect: the test defines its own
            functions for (e.g. <code>main</code>,
            <code>test_add</code>), but requires the
            <code>ptrie_*</code> functions and <code>printf</code> to be
            provided by another object file. Now lets check out the
            <code>ptrie</code> objects.</p>
            <pre><code>$nm ptrie.o
...
                 U calloc
                 U free
...
                 U printf
00000000000005ae T ptrie_add
00000000000003fc t ptrie_add_internal
0000000000000016 T ptrie_allocate
0000000000000606 T ptrie_autocomplete
00000000000000f8 T ptrie_free
...
                 U putchar
                 U puts
                 U strcmp
                 U strdup
                 U strlen</code></pre>
            <p>We can see that the <code>ptrie.o</code> object depends
            on other objects for all of the functions we’re using from
            <code>stdio.h</code>, <code>stdlib.h</code>, and
            <code>string.h</code>, provides all of the functions that
            are part of the public API (e.g. <code>ptrie_add</code>),
            and some other symbols
            (e.g. <code>ptrie_add_internal</code>) that <em>cannot be
            linked</em> to other object files.</p>
            <p>After we link the <code>ptrie</code> into the test (with
            <code>gcc ... tests/01_add.o ptrie.o -o tests/01_add.test</code>),</p>
            <pre><code>$ nm tests/01_add.test | grep alloc
                 U calloc@@GLIBC_2.2.5
0000000000001566 T ptrie_allocate
00000000000013ad T test_alloc</code></pre>
            <p>Now we can see that there are no longer any undefined
            references (<code>U</code>) to <code>ptrie_allocate</code>,
            so the test object has now found that symbol within the
            <code>ptrie.o</code> object. Additionally, we can see that
            some symbols (e.g. <code>calloc</code> here) are still
            undefined and have some mysterious <code>@@...</code>
            information associated with them. You might guess that this
            somehow tells us that the function should be provided by the
            standard C library (<code>glibc</code> on Ubuntu).</p>
            <p>Lets see another example visually using the
            <code>libexample/*</code> files:</p>
            <figure>
            <img src="figures/08_objectsymbs.svg"
            alt="The program on the left depends on the functionality of the object on the right, the library. We can see from the nm output that the left has undefined symbols for bar which is defined in the library. On the right, we can see the symbols defined in the object (with T, saying it is part of the text, or code, i.e. a function). Both are compiled together into an executable binary, prog_naive which shows that the reference from prog.o is resolved or linked with the definition in example.o." />
            <figcaption aria-hidden="true">The program on the left
            depends on the functionality of the object on the right, the
            library. We can see from the <code>nm</code> output that the
            left has undefined symbols for <code>bar</code> which is
            defined in the library. On the right, we can see the symbols
            defined in the object (with <code>T</code>, saying it is
            part of the text, or code, i.e. a function). Both are
            compiled together into an executable binary,
            <code>prog_naive</code> which shows that the reference from
            <code>prog.o</code> is <em>resolved</em> or linked with the
            definition in <code>example.o</code>.</figcaption>
            </figure>
            <p><em>Where are we?</em> OK, lets summarize so far. Objects
            can have <em>undefined symbol references</em> that get
            <em>linked</em> to the symbols when combined with the
            objects in which they are defined. How is this linking
            implemented?</p>
            <p><strong>Question: What does a file <em>format</em>
            mean?</strong> <strong>We talk about the format of webpages
            being <code>html</code>, images, being <code>png</code>,
            documents being <code>docx</code> or
            <code>pdf</code>.</strong> <strong>What do these formats
            mean?</strong> <strong>What is the format of object and
            executable binaries?</strong></p>
            <h3 data-number="10.3.1" id="elf-object-format"><span
            class="header-section-number">10.3.1</span> ELF Object
            Format</h3>
            <p>First, we have to understand something that is a little
            <em>amazing</em>: all of our objects and binaries have a
            defined file format called the <a
            href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">Executable
            and Linkable Format</a> (ELF)<a href="#fn19"
            class="footnote-ref" id="fnref19"
            role="doc-noteref"><sup>19</sup></a>.</p>
            <figure>
            <img src="figures/elf.png"
            alt="A representation of the ELF binary program format by Ange_Albertini." />
            <figcaption aria-hidden="true">A representation of the ELF
            binary program format by <a
            href="https://github.com/corkami/pics">Ange_Albertini</a>.</figcaption>
            </figure>
            <p>We can confirm that these files are ELF with</p>
            <pre><code>$ xxd ptrie.o | head -n 1
00000000: 7f45 4c46 0201 0100 0000 0000 0000 0000  .ELF............</code></pre>
            <p><code>xxd</code> dumps out a file in hexadecimal format,
            and <code>head</code> just lets us filter out only the first
            line (i.e. at the head). The first characters in most
            formats often denote the <em>type</em> of file, in this case
            an ELF file.</p>
            <p>This reveals a cool truth: <strong>programs are
            data</strong>, plain and simple. They happen to be data of a
            very specific format, ELF. <code>nm</code>,
            <code>readelf</code>, and <code>objdump</code> are all
            programs that simply understand how to dive into the ELF
            format, parse, and display the information.</p>
            <p>As programs are simply data encapsulated in the ELF
            format, we can start to understand what it means to
            <em>link</em> two objects together.</p>
            <figure>
            <img src="figures/08_linking.svg"
            alt="An example demonstrating what it means to link two objects together. In this case, we can see the ELF object tells us where in the prog.o binary the reference to bar is, and gcc patchs up prog.o as part of linking to reference bar in example.o." />
            <figcaption aria-hidden="true">An example demonstrating what
            it means to <em>link</em> two objects together. In this
            case, we can see the ELF object tells us where in the
            <code>prog.o</code> binary the reference to <code>bar</code>
            is, and gcc patchs up <code>prog.o</code> as part of linking
            to reference <code>bar</code> in
            <code>example.o</code>.</figcaption>
            </figure>
            <p>An in-depth explanation follows. Now we get to an
            interesting part of the ELF objects:</p>
            <pre><code>$ readelf -r tests/01_add.o | grep ptrie
000000000151  001500000004 R_X86_64_PLT32    0000000000000000 ptrie_allocate - 4
000000000179  001600000004 R_X86_64_PLT32    0000000000000000 ptrie_free - 4
000000000191  001500000004 R_X86_64_PLT32    0000000000000000 ptrie_allocate - 4
0000000001dd  001800000004 R_X86_64_PLT32    0000000000000000 ptrie_add - 4
00000000021f  001600000004 R_X86_64_PLT32    0000000000000000 ptrie_free - 4</code></pre>
            <p>The <code>-r</code> flag here outputs the “relocation”
            entries of the elf object.</p>
            <p>This output says that there are number of references to
            the <code>ptrie_*</code> functions in the code, and
            enumerates each of them. You can imagine that these are
            simply all of the places in the code that these functions
            are called. The first column gives us the offset into the
            ELF object where the reference to the function is made – in
            this case where it is called. For example, at the offset
            <code>0x151</code><a href="#fn20" class="footnote-ref"
            id="fnref20" role="doc-noteref"><sup>20</sup></a> into the
            ELF object, we have a call to <code>ptrie_allocate</code>.
            This is important because the <code>tests/01_add.o</code>
            does not know where the <code>ptrie_allocate</code> function
            is yet. It will only know that when it links with the
            <code>ptrie</code> implementation!</p>
            <p>Lets check out what this looks like in the ELF object’s
            code. For this, we’ll use <code>objdump</code>’s ability to
            dump out the “assembly code” for the object file. It also
            will try and print out the C code that corresponds to the
            assembly, which is pretty cool.</p>
            <pre><code>$ objdump -S tests/01_add.o
...
sunit_ret_t
test_alloc(void)
{
 144:   f3 0f 1e fa             endbr64
 148:   55                      push   %rbp
 149:   48 89 e5                mov    %rsp,%rbp
 14c:   48 83 ec 10             sub    $0x10,%rsp
    struct ptrie *pt;

    pt = ptrie_allocate();
 150:   e8 00 00 00 00          callq  155 &lt;test_alloc+0x11&gt;
 155:   48 89 45 f0             mov    %rax,-0x10(%rbp)
...</code></pre>
            <p>I’ve printed out the addresses in the object around
            offset <code>0x151</code> because the first reference to
            <code>ptrie_allocate</code> is made there (see
            <code>readelf</code> output above). We can see an
            instruction to <code>call</code> <code>test_alloc</code>.
            However, you can see that the address that the binary has
            for that function is <code>00 00 00 00</code>, or
            <code>NULL</code>! This is what it means for a function to
            be undefined (recall: the <code>nm</code> output for the
            symbol is <code>U</code>).</p>
            <p>Now we can understand what a <em>linker</em>’s job
            is:</p>
            <blockquote>
            <p><strong>What does a Linker do?</strong> A linker takes
            all of the undefined <em>references</em> to symbols from the
            <em>relocation records</em>, and rewrites the binary to
            populate those references with the address of that symbol
            (here updating <code>00 00 00 00</code> to the actual
            address of <code>test_alloc</code>).</p>
            </blockquote>
            <p>In our <code>Makefile</code>s, we always use
            <code>gcc</code> both for compiling <code>*.c</code> files
            into objects, but also linking objects together into a
            binary.</p>
            <h3 data-number="10.3.2" id="linking-summary"><span
            class="header-section-number">10.3.2</span> Linking
            Summary</h3>
            <p>Lets back up and collect our thoughts.</p>
            <ul>
            <li>Our programs are collections of a number of ELF object
            files.</li>
            <li>We’ve seen that some symbols in an object file are
            <em>undefined</em> if they are functions or variables that
            are not defined in a <code>.c</code> file.</li>
            <li>Though their types are defined in header files, their
            implementation must be found somewhere.</li>
            <li>Each reference to an undefined symbol has a <em>relation
            entry</em> that enables the linker to update the reference
            once it knows the ELF object that provides it.</li>
            <li>When another ELF exports the symbol that is undefined
            elsewhere, they can be <em>linked</em> to turn the function
            calls of undefined functions into function calls, and
            references to global variables be actual pointers to
            memory.</li>
            </ul>
            <p>This is the <em>foundation for creating large programs
            out of small pieces</em>, and to enable some of those pieces
            to be <em>shared between programs</em>.</p>
            <p>We’ll also see that libraries enable an opportunity to
            <em>save memory</em>. For example,</p>
            <ul>
            <li>static libraries enable only the object files that are
            needed by a program to be compiled into it, and</li>
            <li>dynamic libraries enable the code for a library to be
            <em>shared</em> between all processes that execute it in the
            system.</li>
            </ul>
            <h2 data-number="10.4" id="static-libraries"><span
            class="header-section-number">10.4</span> Static
            Libraries</h2>
            <p>A static library is simply a collection of ELF object
            (<code>*.o</code>) files created with <code>gcc -c</code>.
            They are collected together into a static library file that
            has the name <code>lib*.a</code>. You can think of these
            files as a <code>.zip</code> or <code>.tar</code> file
            containing the ELF objects.</p>
            <p>Static libraries of the form <code>lib*.a</code> and are
            created with the <code>ar</code> (archive) program from a
            collection of objects. An example from the
            <code>ptrie</code> library (expanded from its
            <code>Makefile</code>) that creates
            <code>libptrie.a</code>:</p>
            <pre><code>$ ar -crs libptrie.a *.o</code></pre>
            <p>So a static library is just a collection of ELF objects
            created by our compilation process. If we are writing a
            program that wants to <em>use</em> a library, first you make
            sure to include its header file(s). Then, when compiling, we
            have to tell the compiler which library we want to link with
            by using a few compiler flags:</p>
            <pre><code>$ gcc -o tests/01_add.test 01_add.o -L. -lptrie</code></pre>
            <p>The last two flags are the relevant ones:</p>
            <ul>
            <li><code>-L.</code> says “look for static libraries in the
            current directory (i.e. <code>.</code>)” – other directories
            can be included, and a few default directories are used,
            and</li>
            <li><code>-lptrie</code> says “please link me with the
            <code>ptrie</code> library” which should be found in one of
            the given directories and is found in a file called
            <code>libptrie.a</code>.</li>
            </ul>
            <p>Note that the linker already searches a few directories
            for libraries (i.e. default <code>-L</code> paths):</p>
            <pre><code>$ gcc -print-search-dirs | grep libraries | sed &#39;s/libraries: =//&#39; | tr -s &quot;:&quot; &#39;\n&#39;
/usr/lib/gcc/x86_64-linux-gnu/9/
/usr/lib/gcc/x86_64-linux-gnu/9/../../../../x86_64-linux-gnu/lib/x86_64-linux-gnu/9/
/usr/lib/gcc/x86_64-linux-gnu/9/../../../../x86_64-linux-gnu/lib/x86_64-linux-gnu/
/usr/lib/gcc/x86_64-linux-gnu/9/../../../../x86_64-linux-gnu/lib/../lib/
/usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu/9/
/usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu/
/usr/lib/gcc/x86_64-linux-gnu/9/../../../../lib/
/lib/x86_64-linux-gnu/9/
/lib/x86_64-linux-gnu/
/lib/../lib/
/usr/lib/x86_64-linux-gnu/9/
/usr/lib/x86_64-linux-gnu/
/usr/lib/../lib/
/usr/lib/gcc/x86_64-linux-gnu/9/../../../../x86_64-linux-gnu/lib/
/usr/lib/gcc/x86_64-linux-gnu/9/../../../
/lib/
/usr/lib/</code></pre>
            <p>As many of these paths are in directories that any user
            can access, this is how the functionality of these libraries
            can be accessed by any program wishing to use them. As we
            compile our <code>ptrie</code> library as a static library,
            you’ve already seen one example of these in use.</p>
            <figure>
            <img src="figures/08_staticlib.svg"
            alt="How static libraries are created, and interact with our programs. The .a files include all library objects, but only those that are needed by the program are compiled into it.x" />
            <figcaption aria-hidden="true">How static libraries are
            created, and interact with our programs. The <code>.a</code>
            files include all library objects, but only those that are
            needed by the program are compiled into it.x</figcaption>
            </figure>
            <h3 data-number="10.4.1"
            id="saving-memory-with-static-libraries"><span
            class="header-section-number">10.4.1</span> Saving Memory
            with Static Libraries</h3>
            <p>Static libraries do provide some facilities for trying to
            shrink the amount of memory required for library code. If
            this was all done naively, then all of the object files in a
            static library could get loaded into a program with which it
            is linked. This means that for <span
            class="math inline"><em>N</em></span> programs that link
            with a library whose objects take <span
            class="math inline"><em>X</em></span> bytes, we’ll have
            <span class="math inline"><em>N</em> × <em>X</em></span>
            bytes devoted to storing programs on disk, and running the
            programs in memory (if they all run at the same time). Some
            static libraries can be quite large.</p>
            <p>Instead, static libraries are smarter. If a static
            library contains multiple <code>.o</code> files, <em>only
            those object files that define symbols that are undefined in
            the program being linked with, are compiled into the
            program</em>. This means that when designing a static
            library, you often want to break it into multiple
            <code>.o</code> files along the lines of different
            functionalities that separately used by different programs<a
            href="#fn21" class="footnote-ref" id="fnref21"
            role="doc-noteref"><sup>21</sup></a>.</p>
            <figure>
            <img src="figures/08_staticmem.svg"
            alt="A graphical depiction of how library memory gets added into a program using static libraries. The program is only dependent on a single object within the library, so we only need to compile that object into the resulting executable program." />
            <figcaption aria-hidden="true">A graphical depiction of how
            library memory gets added into a program using static
            libraries. The program is only dependent on a single object
            within the library, so we only need to compile that object
            into the resulting executable program.</figcaption>
            </figure>
            <p>Some projects take this quite far. For example <a
            href="https://www.musl-libc.org/">musl libc</a> is a libc
            replacement, and it separates almost every single function
            into a separate object file (i.e. in a separate
            <code>.c</code> file!) so that only the exact functions that
            are called are linked into the program.</p>
            <h2 data-number="10.5" id="shareddynamic-libraries"><span
            class="header-section-number">10.5</span> Shared/Dynamic
            Libraries</h2>
            <p>Shared or dynamic libraries (for brevity, I’ll call them
            only “dynamic libraries”, but both terms are commonly used)
            are linked into a program <em>at runtime</em> when the
            program starts executing as part of <code>exec</code>.</p>
            <p>Recall that even executable binaries might still have
            undefined references to symbols. For example, see
            <code>calloc</code> in the example below:</p>
            <pre><code>$ nm tests/01_add.test | grep calloc
                 U calloc@@GLIBC_2.2.5</code></pre>
            <p>Though we can execute the program
            <code>tests/01_add.test</code>, it has references to
            functions that don’t exist in the program! How can we
            possibly execute a program that has undefined functions;
            won’t the calls to <code>calloc</code> here be
            <code>NULL</code> pointer dereferences?</p>
            <p>To understand how dynamic linking works, lets look at the
            output of a program that tells us about dynamic library
            dependencies, <code>ldd</code>.</p>
            <pre><code>$ ldd tests/01_add.test
        linux-vdso.so.1 (0x00007ffff3734000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fb502adf000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fb502cfa000)</code></pre>
            <p><code>ldd</code> also simply parses through the ELF
            program, and determines which dynamic libraries are required
            by the program. For now, we’ll ignore the
            <code>linux-vdso</code>, but the other two entries are
            interesting. We can see that the C standard library,
            <code>libc</code> is being provided by
            <code>/lib/x86_64-linux-gnu/libc.so.6</code>. These are both
            dynamic libraries, as are most <code>*.so.?*</code> and
            <code>*.so</code> files. If we check out that object we see
            that it provides <code>calloc</code>.</p>
            <pre><code>$ objdump -T /lib/x86_64-linux-gnu/libc.so.6  | grep calloc
000000000009ec90 g    DF .text  0000000000000395  GLIBC_2.2.5 __libc_calloc
000000000009ec90  w   DF .text  0000000000000395  GLIBC_2.2.5 calloc</code></pre>
            <p>So this library provides the symbols we require (i.e. the
            <code>calloc</code> function)!</p>
            <h3 data-number="10.5.1"
            id="compiling-and-executing-with-dynamic-libraries"><span
            class="header-section-number">10.5.1</span> Compiling and
            Executing with Dynamic Libraries</h3>
            <p>If we want our program to use a dynamic library, we have
            to compile it quite similarly to when we wanted to use
            static libraries:</p>
            <pre><code>$ gcc -o dyn_prog *.o -L. -lptrie</code></pre>
            <p>So everything is somewhat normal here; we’re saying “look
            for the library in this directory”, and compile me with the
            <code>ptrie</code> library. To create the dynamic
            library:</p>
            <pre><code>$ gcc -Wall -Wextra -fpic -I. -c -o ptrie.o ptrie.c
$ gcc -shared -o libptrie.so ptrie.o</code></pre>
            <p>The first line is the normal way to create an object file
            from C, but includes a new flag, <code>-fpic</code>. This
            tells the compiler to generate <a
            href="https://en.wikipedia.org/wiki/Position-independent_code">“Position
            Independent Code”, or PIC</a>, which is code that can,
            seemingly magically, be executed when the code is loaded
            into any address! The dynamic library cannot assume which
            addresses it will be loaded into as many dynamic libraries
            might be loaded into an executable, thus the PIC
            requirement.</p>
            <p>The second line creates the dynamic (shared) library. By
            convention, all dynamic libraries end with <code>.so</code>
            which you can think of as “shared object”. This is the line
            that is dynamic-library equivalent to the <code>ar</code>
            command for static libraries.</p>
            <p>Now we have a binary that has been told were the library
            is; lets execute it!</p>
            <pre><code>$ ./dyn_prog
./dyn_prog: error while loading shared libraries: libptrie.so: cannot open shared object file: No such file or directory</code></pre>
            <p>Whaaaaaa? If we dive in a little bit, we can see:</p>
            <pre><code>$ nm ./dyn_prog | grep ptrie_alloc
                 U ptrie_alloc</code></pre>
            <p>But I thought that we wanted all symbols to be defined
            when we create a binary? Why is the library’s
            <code>ptrie_alloc</code> not linked into the program? We can
            see that not all symbols are defined in a program when we
            are using dynamic libraries as they are <em>linked when we
            try and run the program</em>!</p>
            <p>We now can see the main practical difference between
            static and dynamic libraries:</p>
            <ul>
            <li>Static libraries are compiled into the program when you
            compile with the <code>-lptrie</code> directive.</li>
            <li>Dynamic libraries not <em>not</em> compiled into the
            program, and are instead <em>linked</em> into the program
            when it is executed (i.e. at the time of
            <code>exec</code>).</li>
            </ul>
            <p>We can start to see why the program wont execute when we
            look at its dynamic library dependencies:</p>
            <pre><code>$ ldd ./dyn_prog
        linux-vdso.so.1 (0x00007ffdf3ca0000)
        libptrie.so =&gt; not found
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007ff9921e8000)
        /lib64/ld-linux-x86-64.so.2 (0x00007ff9923f8000)</code></pre>
            <p>It isn’t finding <code>libptrie.so</code>!</p>
            <p>To execute the program, we have to properly set an
            <em>environment variable</em> that will tell the program,
            when it is executed, where to look for the dynamic
            library:</p>
            <pre><code>$ LD_LIBRARY_PATH=./:$LD_LIBRARY_PATH ./dyn_prog
...success...</code></pre>
            <p>This is some strange shell syntax.
            <code>LD_LIBRARY_PATH=./:$LD_LIBRARY_PATH</code> essentially
            says “The environment variable called
            <code>LD_LIBRARY_PATH</code> should be updated to prepend
            the diretory <code>./</code> onto the front of it. This is
            conceptually similar to something like
            <code>lib_path = "./:" + lib_path</code> in a language that
            supports string concatenation. When <code>./dyn_prog</code>
            is executed, the updated <code>LD_LIBRARY_PATH</code>
            environment variable is visible in that program using the
            normal <code>getenv</code>. So there is some part of the
            initialization of <code>./dyn_prog</code> that looks at this
            environment variable to figure out where to look for the
            dynamic library.</p>
            <p>To confirm why we can now execute the program, we can
            again look at the library dependencies:</p>
            <pre><code>$ LD_LIBRARY_PATH=./:$LD_LIBRARY_PATH ldd prog_dynamic
        linux-vdso.so.1 (0x00007ffc939f8000)
        libptrie.so =&gt; ./libptrie.so (0x00007f70d316f000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f70d2f66000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f70d3236000)</code></pre>
            <p>If we expand the <code>LD_LIBRARY_PATH</code> to include
            the current directory, the program can find the library.</p>
            <p>If we want to see the <a
            href="https://stackoverflow.com/questions/9922949/how-to-print-the-ldlinker-search-path">default
            paths</a> that are searched for dynamic libraries:</p>
            <pre><code>$ ldconfig -v 2&gt;/dev/null | grep -v ^$&#39;\t&#39;
/usr/local/lib:
/lib/x86_64-linux-gnu:
/lib32:
/libx32:
/lib:</code></pre>
            <p>In fact, <code>ldconfig -v</code> will also print out all
            of the potential default dynamic libraries we can link
            with.</p>
            <figure>
            <img src="figures/08_dynamiclib.svg"
            alt="Using dynamic libraries to compile a program. Additional flags are required when compiling the library files (for PIC), and we must tell the system that the library is dynamic when compiling using the -shared flag. But even then, the executable doesn’t have the library functionality linked into it. Only when we execute the program does ld dynamically link in the library. For ld to know where to look for te library, we also have to tell it additional paths in which to look using an environment variable." />
            <figcaption aria-hidden="true">Using dynamic libraries to
            compile a program. Additional flags are required when
            compiling the library files (for PIC), and we must tell the
            system that the library is dynamic when compiling using the
            <code>-shared</code> flag. But even then, the executable
            doesn’t have the library functionality linked into it. Only
            when we execute the program does <code>ld</code> dynamically
            link in the library. For <code>ld</code> to know where to
            look for te library, we also have to tell it additional
            paths in which to look using an environment
            variable.</figcaption>
            </figure>
            <h3 data-number="10.5.2"
            id="exec-with-dynamic-linking"><span
            class="header-section-number">10.5.2</span>
            <code>exec</code> with Dynamic Linking</h3>
            <p>How does the <code>libc.so</code> library get linked into
            our program? Diving in a little bit further, we see that
            <code>ld</code> is our program’s “interpreter”:</p>
            <pre><code>$ readelf --program-headers tests/01_add.test
Elf file type is DYN (Shared object file)
Entry point 0x1180
There are 13 program headers, starting at offset 64

Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  PHDR           0x0000000000000040 0x0000000000000040 0x0000000000000040
                 0x00000000000002d8 0x00000000000002d8  R      0x8
  INTERP         0x0000000000000318 0x0000000000000318 0x0000000000000318
                 0x000000000000001c 0x000000000000001c  R      0x1
      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
  LOAD           0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x00000000000008e8 0x00000000000008e8  R      0x1000
  LOAD           0x0000000000001000 0x0000000000001000 0x0000000000001000
                 0x0000000000000e55 0x0000000000000e55  R E    0x1000
...</code></pre>
            <p>A lot is going on here, but we see the reference to
            <code>ld-linux-x86-64.so.2</code> that we saw previously in
            the <code>ldd</code> output. We can now see that the library
            (that I’ll call simply <code>ld</code>) is a “program
            interpreter” (see
            “<code>Requesting program interpreter: /lib64/ld-linux-x86-64.so.2</code>”)
            for our program<a href="#fn22" class="footnote-ref"
            id="fnref22" role="doc-noteref"><sup>22</sup></a>. This is
            the core of understanding how our program can execute while
            having undefined references to functions provided by another
            library.</p>
            <p>When we call <code>exec</code>, we believe that the
            program we execute takes over the current process and starts
            executing. This is not true! Instead, if a program
            interpreter is defined for our program (as we see: it is),
            the interpreter program’s memory is loaded along side our
            program, but then the interpreter is executed instead of our
            program! It is given access to our program’s ELF object, and
            <code>ld</code>’s job is to finish linking and loading our
            program. We have to add <code>./</code> to the
            <code>LD_LIBRARY_PATH</code> to make the program execute
            because <strong><code>ld</code> reads that environment
            variable when it is trying to link and load in your
            program</strong>!</p>
            <h3 data-number="10.5.3"
            id="diving-into-dynamic-linking-at-exec"><span
            class="header-section-number">10.5.3</span> Diving into
            Dynamic Linking at <code>exec</code></h3>
            <p>But wait. Why does <code>exec</code> end up loading
            <code>ld</code>, which then loads our program? Why load
            <code>ld</code> to link our program instead of just running
            our program? Because <code>ld</code> <em>also</em> loads and
            links all of the dynamic libraries (<code>.so</code>s) that
            our program depends on!!!</p>
            <p>We can confirm that <code>ld</code> is loaded into our
            program by executing it in <code>gdb</code>, blocking it on
            breakpoint, and outputting its memory maps
            (<code>cat /proc/262648/maps</code> on my system):</p>
            <pre><code>555555554000-555555555000 r--p 00000000 08:02 527420                     /home/gparmer/repos/gwu-cs-sysprog/22/hw_solns/02/tests/01_add.test
555555555000-555555556000 r-xp 00001000 08:02 527420                     /home/gparmer/repos/gwu-cs-sysprog/22/hw_solns/02/tests/01_add.test
555555556000-555555557000 r--p 00002000 08:02 527420                     /home/gparmer/repos/gwu-cs-sysprog/22/hw_solns/02/tests/01_add.test
555555557000-555555558000 r--p 00002000 08:02 527420                     /home/gparmer/repos/gwu-cs-sysprog/22/hw_solns/02/tests/01_add.test
555555558000-555555559000 rw-p 00003000 08:02 527420                     /home/gparmer/repos/gwu-cs-sysprog/22/hw_solns/02/tests/01_add.test
7ffff7dbe000-7ffff7de3000 r--p 00000000 08:02 2235639                    /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7de3000-7ffff7f5b000 r-xp 00025000 08:02 2235639                    /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7f5b000-7ffff7fa5000 r--p 0019d000 08:02 2235639                    /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fa5000-7ffff7fa6000 ---p 001e7000 08:02 2235639                    /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fa6000-7ffff7fa9000 r--p 001e7000 08:02 2235639                    /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fa9000-7ffff7fac000 rw-p 001ea000 08:02 2235639                    /usr/lib/x86_64-linux-gnu/libc-2.31.so
7ffff7fac000-7ffff7fb2000 rw-p 00000000 00:00 0
7ffff7fc9000-7ffff7fcd000 r--p 00000000 00:00 0                          [vvar]
7ffff7fcd000-7ffff7fcf000 r-xp 00000000 00:00 0                          [vdso]
7ffff7fcf000-7ffff7fd0000 r--p 00000000 08:02 2235423                    /usr/lib/x86_64-linux-gnu/ld-2.31.so
7ffff7fd0000-7ffff7ff3000 r-xp 00001000 08:02 2235423                    /usr/lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ff3000-7ffff7ffb000 r--p 00024000 08:02 2235423                    /usr/lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffc000-7ffff7ffd000 r--p 0002c000 08:02 2235423                    /usr/lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffd000-7ffff7ffe000 rw-p 0002d000 08:02 2235423                    /usr/lib/x86_64-linux-gnu/ld-2.31.so
7ffff7ffe000-7ffff7fff000 rw-p 00000000 00:00 0
7ffffffde000-7ffffffff000 rw-p 00000000 00:00 0                          [stack]
ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0                  [vsyscall]</code></pre>
            <p>Recall that this dumps all of the memory segments of the
            process.</p>
            <p>There are two important observations:</p>
            <ul>
            <li><code>/usr/lib/x86_64-linux-gnu/libc-2.31.so</code> is
            present in the process so somehow got linked and loaded into
            the process.</li>
            <li><code>/usr/lib/x86_64-linux-gnu/ld-2.31.so</code> is
            also present in the process; indeed it was the first code to
            execute in the process!</li>
            </ul>
            <h3 data-number="10.5.4" id="dynamic-loading-summary"><span
            class="header-section-number">10.5.4</span> Dynamic Loading
            Summary</h3>
            <p>Lets summarize the algorithm for executing a dynamically
            loaded program.</p>
            <ol type="1">
            <li><p><code>exec</code> is called to execute a new
            program.</p></li>
            <li><p>The program’s ELF file is parsed, and if a “program
            interpreter” is set, the interpreter is instead
            executed.</p></li>
            <li><p>In most cases, the interpreter is <code>ld</code>,
            and it is loaded into the process along with the target
            program.</p></li>
            <li><p>Execution is started at <code>ld</code>, and it:</p>
            <ol type="1">
            <li>Loads all of the dynamic libraries required by the
            program, looking at the <code>LD_LIBRARY_PATH</code>
            environment variable to help look for them.</li>
            <li>Links the program such that all of its references to
            library symbols (i.e. <code>calloc</code> above) are set to
            point to library functions.</li>
            <li>Executes the initialization procedures (and eventually
            <code>main</code>) of our program.</li>
            </ol></li>
            </ol>
            <p>This is all quite complex. Why would we ever want all of
            this complexity over the simplicity of static libraries?</p>
            <h3 data-number="10.5.5"
            id="saving-memory-with-dynamic-libraries"><span
            class="header-section-number">10.5.5</span> Saving Memory
            with Dynamic Libraries</h3>
            <p>First, lets look at how much memory a library takes
            up.</p>
            <pre><code>$ ls -lh /usr/lib/x86_64-linux-gnu/libc-2.31.so
-rwxr-xr-x 1 root root 2.0M Dec 16  2020 /usr/lib/x86_64-linux-gnu/libc-2.31.so</code></pre>
            <p>So <code>libc</code> takes around 2MiB. Other libraries
            take quite a bit more:</p>
            <ul>
            <li>Graphics card drivers
            (e.g. <code>libradeonsi_dri.so</code> is 23 MiB)</li>
            <li>Databases clients (e.g. <code>libmysqlclient.so</code>
            is 7.2 MiB)</li>
            <li>Languages (e.g. firefox’s javascript engine,
            <code>libmozjs.so</code> is 11 MiB, and webkit’s
            <code>libjavascriptcoregtk.so</code> is 26 MiB)</li>
            <li>…</li>
            </ul>
            <p>If <span class="math inline"><em>N</em></span> programs
            must load in multiple libraries (totaling, say, <span
            class="math inline"><em>X</em></span> MiB), then <span
            class="math inline"><em>N</em> × <em>X</em></span> MiB is
            consumed. For context, my system is currently running 269
            programs (<code>ps aux | wc -l</code>), so this memory can
            add up!</p>
            <p>Dynamic libraries enable us to do a lot better. The
            contents memory for the library is the same regardless the
            process it is present in, and an Operating System has a neat
            trick: it can make the same memory appear in multiple
            processes if it is identical <em>and</em> cannot be
            modified<a href="#fn23" class="footnote-ref" id="fnref23"
            role="doc-noteref"><sup>23</sup></a>. As such, dynamic
            libraries typically only require memory for each library
            <em>once</em> in the system (only <span
            class="math inline"><em>X</em></span>), as opposed for each
            process.</p>
            <figure>
            <img src="figures/08_dynamicmem.svg"
            alt="A graphical depiction of how library memory gets added into a program using dynamic libraries. The libraries are only linked into the processes when they are executed. When that happens, the same memory for the library is mmaped into each process, thus the system only requires memory for a single copy of the library." />
            <figcaption aria-hidden="true">A graphical depiction of how
            library memory gets added into a program using dynamic
            libraries. The libraries are only linked into the processes
            when they are executed. When that happens, the same memory
            for the library is <code>mmap</code>ed into each process,
            thus the system only requires memory for a <em>single</em>
            copy of the library.</figcaption>
            </figure>
            <h2 data-number="10.6"
            id="static-vs.-dynamic-library-memory-usage-summary"><span
            class="header-section-number">10.6</span> Static vs. Dynamic
            Library Memory Usage Summary</h2>
            <p>When a program is linked with a static library, the
            result is relatively small as only the objects in the
            library that are necessary are linked into the program. When
            executed as a process, the memory consumed will only include
            the necessary objects of the library. In contrast, a program
            that uses a dynamic library links in the entire library at
            runtime into a process. Thus, for a <em>single process</em>,
            a static library approach is almost always going to be more
            memory-efficient.</p>
            <p>However, in a system with <em>many</em> executing
            processes, the per-library memory, rather than per-process
            memory, will result in significantly less memory
            consumption. Requiring only a <em>single copy</em> of a
            <em>larger</em> dynamic library shared between all
            processes, uses less memory than <em>multiple copies</em> of
            <em>smaller</em> compilations of the library in each
            program.</p>
            <h1 data-number="11"
            id="organizing-software-with-dynamic-libraries-exercises-and-programming"><span
            class="header-section-number">11</span> Organizing Software
            with Dynamic Libraries: Exercises and Programming</h1>
            <p>Lets dive a little deeper into how software is structured
            on our system, and the trade-offs that different libraries
            make in the system.</p>
            <h2 data-number="11.1"
            id="exercise-understanding-library-memory-consumption"><span
            class="header-section-number">11.1</span> Exercise:
            Understanding Library Memory Consumption</h2>
            <p>Lets investigate the <code>libexample</code> from the
            figures in last week’s lectures. See the <a
            href="https://github.com/gwu-cs-sysprog/lectures/tree/main/08/libexample"><code>08/libexample/</code>
            directory</a> for examples of using normal linking
            (<code>make naive</code>), static library linking
            (<code>make static</code>), and dynamic library linking
            (<code>make dynamic</code>). The source includes:</p>
            <ul>
            <li><code>prog</code> and <code>prog2</code> that are
            programs that use libraries.</li>
            <li><code>example.c</code> is a single file that creates the
            first library which generates <code>libexample.a</code> and
            <code>libexample.so</code>.</li>
            <li><code>example2.c</code> and <code>example2b.c</code> are
            the files that create the second library which generates
            <code>libexample2.a</code> and
            <code>libexample2.so</code>.</li>
            </ul>
            <p>Each of the library objects uses around <em>750KB</em> of
            memory. To help you set the <code>LD_LIBRARY_PATH</code> to
            execute the dynamic libraries, you can run the dynamic
            library examples using</p>
            <pre><code>$ ./run_dyn.sh ./prog_dynamic</code></pre>
            <ol type="1">
            <li>Use <code>nm</code> and <code>ldd</code> to understand
            which libraries and object files within those libraries each
            of the programs require.</li>
            <li>Use <code>ls -lh</code> to see the size of each of the
            resulting executable programs. Explain the differences in
            sizes.</li>
            </ol>
            <h2 data-number="11.2" id="library-trade-offs"><span
            class="header-section-number">11.2</span> Library
            Trade-offs</h2>
            <ul>
            <li><em>Question:</em> What types of systems might want to
            always use only static libraries?</li>
            <li><em>Question:</em> What types of systems might want to
            always use only dynamic libraries?</li>
            <li><em>Question:</em> OSX uses dynamically linked libraries
            for a few common and frequently used libraries (like
            <code>libc</code>), and static libraries for the rest.
            Why?</li>
            </ul>
            <h2 data-number="11.3"
            id="programming-dynamic-libraries"><span
            class="header-section-number">11.3</span> Programming
            Dynamic Libraries</h2>
            <p>We saw how libraries enable the sharing of functionality
            between programs. Static libraries are convenient, and only
            required objects are linked with your program at compile
            time. In contrast, dynamic libraries are linked at runtime
            <em>before</em> the <code>main</code> of your program
            executes.</p>
            <h3 data-number="11.3.1"
            id="plugins-and-dynamic-library-apis"><span
            class="header-section-number">11.3.1</span> Plugins and
            Dynamic Library APIs</h3>
            <p>In addition to enabling shared library code, dynamic
            libraries also enable explicit means to load libraries
            programmatically. Namely, UNIX provdes an API that enables
            your process to <em>load</em> a dynamic library into itself.
            This is kinda crazy: a running process with a set of code
            and data can add a library with more code and data into
            itself dynamically. This effectively means that your program
            can change its own code as it executes by adding and
            removing dynamic libraries. Being able to load library code
            into your process as your program executes (at runtime) is
            an instance of <em>self-modifying code</em>, and it enables
            a few very cool features including:</p>
            <ul>
            <li><em>dynamic update of services</em> in which new
            versions of key computations in a service can be dynamically
            loaded in (and old versions eventually removed),</li>
            <li><em>plugin architectures</em> enable different
            interesting functionalities to be loaded into a process to
            provide unique functionalities – some of the most popular
            image and video processing programs
            (e.g. <code>ffmpeg</code>) enable different formats to be
            handled with separate dynamic libraries, thus enabling the
            processing of any image or video by simply loading a new
            library, and</li>
            <li><em>languages</em>, such as <code>python</code>,
            dynamically load libraries (many or most are written in C)
            into a process when the python code <code>import</code>s
            them. Since the <code>import</code>s are part of the code,
            the corresponding dynamic libraries must be loaded by the
            python runtime dynamically. This enables your dynamic (slow)
            python code to load and leverage fast C libraries.</li>
            </ul>
            <figure>
            <img src="figures/09_dl_uses.svg"
            alt="Example programmatic uses of dynamic libraries." />
            <figcaption aria-hidden="true">Example programmatic uses of
            dynamic libraries.</figcaption>
            </figure>
            <p>This API is provided by the linker (<code>ld.so</code>)
            that loaded the elf object for the currently executing
            process. What does the API that enables this dynamic loading
            look like?</p>
            <ul>
            <li><code>handle = dlopen(file_path, flags)</code> - Open
            and load in a dynamic library. This returns a handle to the
            library that you should pass into the latter functions. You
            can read about the <code>flags</code> in
            <code>man dlopen</code>. Unless otherwise noted, I’d
            recommend using <code>RTLD_NOW | RTLD_LOCAL</code><a
            href="#fn24" class="footnote-ref" id="fnref24"
            role="doc-noteref"><sup>24</sup></a>. Returns
            <code>NULL</code> if it cannot find the dynamic
            library.</li>
            <li><code>dlclose(handle)</code> - Close and unload a
            library that was previously loaded.</li>
            <li><code>symb_ptr = dlsym(handle, symbol)</code> - pass in
            a <code>symbol</code> which is a string holding a function
            or variable name in the dynamic library. It should return a
            pointer to that symbol, which you can then call (if it is a
            function pointer), or dereference if it is a variable.</li>
            </ul>
            <div class="sourceCode" id="cb288"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dlfcn.h&gt;</span></span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb288-7"><a href="#cb288-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb288-8"><a href="#cb288-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>handle<span class="op">;</span></span>
<span id="cb288-9"><a href="#cb288-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">typedef</span> <span class="dt">int</span> <span class="op">*(*</span>bar_fn_t<span class="op">)(</span><span class="dt">int</span> a<span class="op">);</span></span>
<span id="cb288-10"><a href="#cb288-10" aria-hidden="true" tabindex="-1"></a>    bar_fn_t bar<span class="op">;</span></span>
<span id="cb288-11"><a href="#cb288-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>ret<span class="op">;</span></span>
<span id="cb288-12"><a href="#cb288-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-13"><a href="#cb288-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Open a dynamic library: the example is in ../08/libexample/ */</span></span>
<span id="cb288-14"><a href="#cb288-14" aria-hidden="true" tabindex="-1"></a>    handle <span class="op">=</span> dlopen<span class="op">(</span><span class="st">&quot;08/libexample/libexample.so&quot;</span><span class="op">,</span> RTLD_NOW <span class="op">|</span> RTLD_LOCAL<span class="op">);</span></span>
<span id="cb288-15"><a href="#cb288-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>handle<span class="op">)</span> <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb288-16"><a href="#cb288-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-17"><a href="#cb288-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb288-18"><a href="#cb288-18" aria-hidden="true" tabindex="-1"></a><span class="co">     * Lets find the function &quot;bar&quot; in that dynamic library.</span></span>
<span id="cb288-19"><a href="#cb288-19" aria-hidden="true" tabindex="-1"></a><span class="co">     * We know that `bar` is the function: int *bar(int a)</span></span>
<span id="cb288-20"><a href="#cb288-20" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb288-21"><a href="#cb288-21" aria-hidden="true" tabindex="-1"></a>    bar <span class="op">=</span> dlsym<span class="op">(</span>handle<span class="op">,</span> <span class="st">&quot;bar&quot;</span><span class="op">);</span></span>
<span id="cb288-22"><a href="#cb288-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>bar<span class="op">)</span> <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb288-23"><a href="#cb288-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-24"><a href="#cb288-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* bar allocates an int, populates it with the argument + 2 and returns it */</span></span>
<span id="cb288-25"><a href="#cb288-25" aria-hidden="true" tabindex="-1"></a>    ret <span class="op">=</span> bar<span class="op">(</span><span class="dv">40</span><span class="op">);</span></span>
<span id="cb288-26"><a href="#cb288-26" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">*</span>ret<span class="op">);</span></span>
<span id="cb288-27"><a href="#cb288-27" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>ret<span class="op">);</span></span>
<span id="cb288-28"><a href="#cb288-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-29"><a href="#cb288-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb288-30"><a href="#cb288-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>42</code></pre>
            <p>As <code>dlsym</code> returns a pointer to the symbol
            passed in (as a string), it means that you end up seeing a
            <em>lot</em> of function pointers when you’re using plugin
            infrastructures. See (a) in the image below.</p>
            <p>We can also use <code>dlsym</code> to ask for a symbol in
            <em>any of the installed libraries</em>. To do so, we pass
            in the “special pseudo-handles” <code>RTLD_DEFAULT</code> or
            <code>RTLD_NEXT</code>.</p>
            <div class="sourceCode" id="cb290"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define </span><span class="ot">_GNU_SOURCE</span><span class="pp"> </span><span class="co">/* added this due to `man 3 dlsym` */</span></span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb290-4"><a href="#cb290-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dlfcn.h&gt;</span></span>
<span id="cb290-5"><a href="#cb290-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb290-6"><a href="#cb290-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb290-7"><a href="#cb290-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-8"><a href="#cb290-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb290-9"><a href="#cb290-9" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb290-10"><a href="#cb290-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb290-11"><a href="#cb290-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">typedef</span> <span class="dt">int</span> <span class="op">(*</span>write_fn_t<span class="op">)(</span><span class="dt">int</span> fd<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">size_t</span> s<span class="op">);</span></span>
<span id="cb290-12"><a href="#cb290-12" aria-hidden="true" tabindex="-1"></a>    write_fn_t w<span class="op">;</span></span>
<span id="cb290-13"><a href="#cb290-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>buf <span class="op">=</span> <span class="st">&quot;Look at me! Diving into your dynamic libraries...pulling out the symbols</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb290-14"><a href="#cb290-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-15"><a href="#cb290-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Now lets find `write`! */</span></span>
<span id="cb290-16"><a href="#cb290-16" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> dlsym<span class="op">(</span>RTLD_DEFAULT<span class="op">,</span> <span class="st">&quot;write&quot;</span><span class="op">);</span></span>
<span id="cb290-17"><a href="#cb290-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>w<span class="op">)</span> <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb290-18"><a href="#cb290-18" aria-hidden="true" tabindex="-1"></a>    w<span class="op">(</span>STDOUT_FILENO<span class="op">,</span> buf<span class="op">,</span> strlen<span class="op">(</span>buf<span class="op">));</span></span>
<span id="cb290-19"><a href="#cb290-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-20"><a href="#cb290-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb290-21"><a href="#cb290-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>42</code></pre>
            <p>Though this example doesn’t have much of a point, as we
            can directly call <code>write</code>, thus have to go
            through the symbol we retrieved from <code>dlsym</code>, See
            (b) in the image below.</p>
            <figure>
            <img src="figures/09_dl_api.svg"
            alt="Three programmatic means to interact with dynamic libraries." />
            <figcaption aria-hidden="true">Three programmatic means to
            interact with dynamic libraries.</figcaption>
            </figure>
            <h3 data-number="11.3.2"
            id="interposing-libraries-on-library-apis"><span
            class="header-section-number">11.3.2</span> Interposing
            Libraries on Library APIs</h3>
            <p>One powerful mechanism that dynamic libraries enable is
            to <em>interpose</em> on library function calls. Your
            program might believe that it calls <code>malloc</code> when
            it invokes the function “malloc”, but you can orchestrate it
            so that it instead calls a <code>malloc</code> in your
            library! You can then, if you choose, invoke the normal
            library calls, thus why this is known as
            <em>interposing</em> on the library calls. But how?</p>
            <p>The environment variable <code>LD_PRELOAD</code> can be
            used to specify a dynamic library to load into the process
            to <em>interpose</em> on any library calls. A trivial use of
            this might be to <em>log</em> (i.e. write out to a file) all
            of a set of library calls. We’ll use it to add intelligence
            on the memory allocation paths.</p>
            <p>When we use <code>LD_PRELOAD=lib</code>, the symbols in
            the dynamic library that we specify in <code>lib</code> have
            priority over those of other libraries. Thus, if we include
            a <code>malloc</code> function definition, when the
            application calls <code>malloc</code>, it will call
            <em>our</em> malloc! In the image above, (c) demonstrates
            using <code>LD_PRELOAD</code>.</p>
            <p>In <a
            href="https://github.com/gwu-cs-sysprog/lectures/tree/main/09/malloclog/"><code>malloclog</code></a>,
            we can see a library that interposes on <code>malloc</code>
            and <code>free</code>, and prints information to standard
            error. This includes the following:</p>
            <div class="sourceCode" id="cb292"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">void</span> <span class="op">*(*</span>malloc_fn_t<span class="op">)(</span><span class="dt">size_t</span> s<span class="op">);</span></span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> malloc_fn_t malloc_fn<span class="op">;</span></span>
<span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a><span class="co">/* This `malloc` will override libc&#39;s `malloc` */</span></span>
<span id="cb292-5"><a href="#cb292-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span></span>
<span id="cb292-6"><a href="#cb292-6" aria-hidden="true" tabindex="-1"></a>malloc<span class="op">(</span><span class="dt">size_t</span> sz<span class="op">)</span></span>
<span id="cb292-7"><a href="#cb292-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb292-8"><a href="#cb292-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span>mem<span class="op">;</span></span>
<span id="cb292-9"><a href="#cb292-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-10"><a href="#cb292-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* if we don&#39;t yet know where libc&#39;s malloc is, look it up! */</span></span>
<span id="cb292-11"><a href="#cb292-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>malloc_fn <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb292-12"><a href="#cb292-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb292-13"><a href="#cb292-13" aria-hidden="true" tabindex="-1"></a><span class="co">         * Lets find the `malloc` function in libc! The `RTLD_NEXT`s</span></span>
<span id="cb292-14"><a href="#cb292-14" aria-hidden="true" tabindex="-1"></a><span class="co">         * specify that we don&#39;t want to find our *own* `malloc`, we&#39;d like to</span></span>
<span id="cb292-15"><a href="#cb292-15" aria-hidden="true" tabindex="-1"></a><span class="co">         * search starting with the *next* library.</span></span>
<span id="cb292-16"><a href="#cb292-16" aria-hidden="true" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb292-17"><a href="#cb292-17" aria-hidden="true" tabindex="-1"></a>        malloc_fn <span class="op">=</span> dlsym<span class="op">(</span>RTLD_NEXT<span class="op">,</span> <span class="st">&quot;malloc&quot;</span><span class="op">);</span></span>
<span id="cb292-18"><a href="#cb292-18" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">(</span>malloc_fn<span class="op">);</span></span>
<span id="cb292-19"><a href="#cb292-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb292-20"><a href="#cb292-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* call libc&#39;s `malloc` here! */</span></span>
<span id="cb292-21"><a href="#cb292-21" aria-hidden="true" tabindex="-1"></a>    mem <span class="op">=</span> malloc_fn<span class="op">(</span>sz<span class="op">);</span></span>
<span id="cb292-22"><a href="#cb292-22" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;malloc(</span><span class="sc">%ld</span><span class="st">) -&gt; </span><span class="sc">%p\n</span><span class="st">&quot;</span><span class="op">,</span> sz<span class="op">,</span> mem<span class="op">);</span></span>
<span id="cb292-23"><a href="#cb292-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-24"><a href="#cb292-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mem<span class="op">;</span></span>
<span id="cb292-25"><a href="#cb292-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>We do the same for <code>free</code>, and should do the
            same also for <code>calloc</code> and other memory
            allocation functions.</p>
            <p><strong>Question:</strong> Why can’t we just call
            <code>malloc</code> directly instead of doing this complex
            thing with <code>dlsym</code>?</p>
            <p>We can use it on a simple program that simply calls
            <code>malloc</code> and <code>free</code> on the allocated
            memory. To test this out, in <a
            href="https://github.com/gwu-cs-sysprog/lectures/tree/main/09/malloclog/"><code>malloclog</code></a>:</p>
            <pre><code>$ make
$ LD_PRELOAD=./libmalloclog.so ./main.bin
malloc(4) -&gt; 0x55fe6cd492a0
free(0x55fe6cd492a0)
...</code></pre>
            <p>This shows us that dynamic libraries are
            <em>programmable</em> and that we can use them in
            interesting ways to coordinate between libraries, provide
            new functionalities, and to interpose on functionalities.
            For example, many of the largest companies use
            <code>LD_PRELOAD</code> to swap out the <code>malloc</code>
            implementation for one that is higher performance.</p>
            <p><strong>Questions:</strong></p>
            <ul>
            <li>What else can you think to do with the ability to
            interpose on <em>any</em> library functions?</li>
            <li>How might we implement some of the <code>valgrind</code>
            functionality using the ability to interpose on library
            functions?</li>
            </ul>
            <p>Note that running a program that uses
            <code>LD_PRELOAD</code> environment variables are more
            difficult to use in <code>gdb</code>. The <a
            href="https://github.com/gwu-cs-sysprog/lectures/tree/main/09/malloclog/ldpreload_w_gdb.sh"><code>ldpreload_w_gdb.sh</code></a>
            script demonstrates how to use both technologies
            together.</p>
            <h1 data-number="12"
            id="system-calls-and-memory-management"><span
            class="header-section-number">12</span> System Calls and
            Memory Management</h1>
            <p>We’ve talked about the many resources that are provided
            by the <em>system</em>. These include files, pipes, and
            domain sockets. But we’ve been vague about what the system
            is. Though we’ll leave the details for a later course, lets
            dive in to what constitutes the “system” a little bit.</p>
            <h2 data-number="12.1" id="system-calls"><span
            class="header-section-number">12.1</span> System Calls</h2>
            <p>We’ve claimed many times that <em>the system</em>
            provides pipes, domain sockets, files, the file system, etc…
            What is “the system”? First, lets start from what we know:
            is this system just a dynamic library? To some extent this
            makes sense.</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li>The dynamic libraries we’ve seen provide many of the
            functions we’ve used, so why <em>couldn’t</em> they provide
            <em>all</em> of the functionality we require!? For example,
            why can’t <code>read</code>, <code>open</code>, etc… all be
            simply provided solely by dynamic libraries?</li>
            </ul>
            <p>A few observations:</p>
            <ol type="1">
            <li>Dynamic libraries are loaded into a process, but
            <em>what provides the process itself</em>?</li>
            <li>Some resources, like <code>pipe</code>s, <em>involve
            multiple processes</em>, thus there must be something in the
            system beyond specific processes.</li>
            <li><em>Hardware is limited</em> – a system only has a
            limited amount of DRAM (memory) – and something has to
            determine how to hand it out to processes.</li>
            </ol>
            <figure>
            <img src="figures/10_kernel_syscalls.svg"
            alt="The OS kernel’s relationship to processes and libraries. Each OS has a kernel, in this case the Linux Kernel. The kernel provides resources such as file systems, channels (domain sockets, pipes, etc…), and it implements processes (including fork, exec, wait, etc…). The kernel is separated from processes so that a failure in a process won’t spread beyond the process. This means that when a process wants to interact with the kernel, it must make a special system call. This behaves like a function call, but it maintains isolation of the kernel from the process. This is a system with four processes. The second is making a write system call, the third is using printf which is implemented in libc as part of the stream API in stdio.h. The stream implementation makes a write system call to send the data to the kernel (e.g. to display on our terminal). On the far right, we can see a process that doesn’t even have any libraries and makes system calls directly." />
            <figcaption aria-hidden="true">The OS kernel’s relationship
            to processes and libraries. Each OS has a kernel, in this
            case the Linux Kernel. The kernel provides resources such as
            file systems, channels (domain sockets, <code>pipe</code>s,
            etc…), and it implements processes (including
            <code>fork</code>, <code>exec</code>, <code>wait</code>,
            etc…). The kernel is separated from processes so that a
            failure in a process won’t spread beyond the process. This
            means that when a process wants to interact with the kernel,
            it must make a special <em>system call</em>. This behaves
            like a function call, but it maintains isolation of the
            kernel from the process. This is a system with four
            processes. The second is making a <code>write</code> system
            call, the third is using <code>printf</code> which is
            implemented in <code>libc</code> as part of the stream API
            in <code>stdio.h</code>. The stream implementation makes a
            <code>write</code> system call to send the data to the
            kernel (e.g. to display on our terminal). On the far right,
            we can see a process that doesn’t even have any libraries
            and makes system calls directly.</figcaption>
            </figure>
            <p>The <em>system</em>, as we’ve discussed it so far, is
            called the <em>kernel</em>. One of the main components of
            every operating system is the kernel. Every process in the
            system uses the kernel’s functionality. It provides the
            logic for <em>most</em> of the calls we’ve learned in the
            class, <code>fork</code>, <code>exec</code>,
            <code>pipe</code>, <code>read</code>, <code>write</code>,
            <code>open</code>, <code>creat</code>, etc… and also most of
            the resources we’ve discussed including channels, domain
            sockets, pipes, files, and the filesystem. It is some of the
            most trusted code on the system. If it has a bug, the whole
            system can crash – or worse!</p>
            <p>We have to be able to call functions in the kernel from
            any process. This means we want to make what seem like
            function calls to the kernel. And we want to make sure that
            the faults of one process don’t spread to another! This
            means that somehow the kernel must be isolated from each
            process.</p>
            <p><strong>System calls</strong> are the mechanism that
            behaves like a function call (and looks like one to us!),
            but that switches over to the kernel. System calls are a
            special instruction in the instruction set architecture
            (Intel x86 or ARM) that triggers the switch to the kernel.
            When the kernel’s done with its functionality, it can return
            (via a special instruction) to the process.</p>
            <p>So system calls <em>behave</em> like function calls, but
            inherently involves <em>switches</em> from the process and
            to the kernel and back.</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li>So why does UNIX decide what functionality to put in a
            library, and what to put in the kernel?</li>
            </ul>
            <h3 data-number="12.1.1"
            id="system-calls-and-processes"><span
            class="header-section-number">12.1.1</span> System Calls and
            Processes</h3>
            <p>In UNIX, system calls are available in
            <code>unistd.h</code>, so whenever you include that file to
            use a function, you know the function is likely a direct
            system call! You can also tell if a UNIX function is a
            system call by looking at the <em>sections</em> of
            <code>man</code> (from <code>man man</code>):</p>
            <pre><code>MANUAL SECTIONS
    The standard sections of the manual include:

    1      User Commands
    2      System Calls
    3      C Library Functions
    4      Devices and Special Files
    5      File Formats and Conventions
    6      Games et. al.
    7      Miscellanea
    8      System Administration tools and Daemons</code></pre>
            <p><strong>Questions:</strong></p>
            <ul>
            <li><p>Do <code>man write</code>. What is this documentation
            for?</p></li>
            <li><p>Do <code>man 2 write</code>. What is this
            documentation for? What does the <code>2</code> mean?</p>
            <p>You can always tell which section you’re looking at in
            the header line of the <code>man</code> output:
            <code>WRITE(2)</code> shows that we’re reading about
            <code>write</code> in the “System Calls” section.</p></li>
            <li><p>Is <code>malloc</code> a system call or a C Library
            Function?</p></li>
            </ul>
            <p>We know what a system call looks like, as we’ve used them
            many times throughout the class. Lets look at the various
            ways to make the same system call. First, the normal
            way:</p>
            <div class="sourceCode" id="cb295"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="st">&quot;hello world</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">12</span><span class="op">);</span></span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-8"><a href="#cb295-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb295-9"><a href="#cb295-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>42</code></pre>
            <p>The C standard library even provides you a “generic” way
            to invoke <em>any</em> system call. The <code>syscall</code>
            function lets you make an integer-identified system call.
            Each system call on the system is identified with a unique
            integer. In this case, we’ll use <code>SYS_write</code>.</p>
            <div class="sourceCode" id="cb297"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/syscall.h&gt;</span></span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb297-6"><a href="#cb297-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb297-7"><a href="#cb297-7" aria-hidden="true" tabindex="-1"></a>    syscall<span class="op">(</span>SYS_write<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="st">&quot;hello world</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="dv">12</span><span class="op">);</span></span>
<span id="cb297-8"><a href="#cb297-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-9"><a href="#cb297-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb297-10"><a href="#cb297-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>42</code></pre>
            <p>Lets look at a few of these integer values to see what’s
            happening here:</p>
            <div class="sourceCode" id="cb299"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/syscall.h&gt;</span></span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;write: </span><span class="sc">%d\n</span><span class="st">read:  </span><span class="sc">%d\n</span><span class="st">open:  </span><span class="sc">%d\n</span><span class="st">close: </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb299-8"><a href="#cb299-8" aria-hidden="true" tabindex="-1"></a>        SYS_write<span class="op">,</span> SYS_read<span class="op">,</span> SYS_open<span class="op">,</span> SYS_close<span class="op">);</span></span>
<span id="cb299-9"><a href="#cb299-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-10"><a href="#cb299-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb299-11"><a href="#cb299-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>42</code></pre>
            <p>Note, these integer values are <em>not</em> related to
            descriptors (e.g. <code>STDIN_FILENO == 0</code>). The
            system calls in Linux (and in all operating systems!) are
            each assigned an integer with which to identify them. You
            can see all of the <a
            href="https://filippo.io/linux-syscall-table/">system calls
            and their integer numbers</a>, and some documentation in <a
            href="https://manpages.debian.org/unstable/manpages-dev/syscalls.2.en.html"><code>man syscalls</code>
            (link)</a>.</p>
            <p><strong>Exercise:</strong></p>
            <ul>
            <li>Find three interesting system calls that you didn’t know
            about.</li>
            </ul>
            <p>OK, now lets do a little more of a deep-dive. You won’t
            be familiar with the Intel’s/AMD’s x86-64 assembly language
            that follows, but the comments on the right give you the
            jist.</p>
            <div class="sourceCode" id="cb301"><pre
            class="sourceCode asm"><code class="sourceCode fasm"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a>.<span class="bu">data</span>                <span class="co">; Add some global variables - our &quot;hello world&quot; message</span></span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a><span class="fu">msg:</span></span>
<span id="cb301-3"><a href="#cb301-3" aria-hidden="true" tabindex="-1"></a>    .ascii <span class="st">&quot;hello world\n&quot;</span></span>
<span id="cb301-4"><a href="#cb301-4" aria-hidden="true" tabindex="-1"></a>    len <span class="op">=</span> <span class="op">.</span> <span class="op">-</span> msg    <span class="co">; magic length computation &quot;here&quot; - start of `msg`</span></span>
<span id="cb301-5"><a href="#cb301-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-6"><a href="#cb301-6" aria-hidden="true" tabindex="-1"></a>.text                <span class="co">; The code starts here!</span></span>
<span id="cb301-7"><a href="#cb301-7" aria-hidden="true" tabindex="-1"></a>    .global _start</span>
<span id="cb301-8"><a href="#cb301-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-9"><a href="#cb301-9" aria-hidden="true" tabindex="-1"></a><span class="fu">_start:</span>              <span class="co">; Note: the %rxx values are registers, $x are constants</span></span>
<span id="cb301-10"><a href="#cb301-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>  <span class="op">$</span><span class="bn">1</span><span class="op">,</span>   <span class="op">%</span><span class="kw">rax</span> <span class="co">; Syscall&#39;s integer value, 1 == write, now set up the arguments...</span></span>
<span id="cb301-11"><a href="#cb301-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>  <span class="op">$</span><span class="bn">1</span><span class="op">,</span>   <span class="op">%</span><span class="kw">rdi</span> <span class="co">; Arg 1: file descriptor 1</span></span>
<span id="cb301-12"><a href="#cb301-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>  <span class="op">$</span>msg<span class="op">,</span> <span class="op">%</span><span class="kw">rsi</span> <span class="co">; Arg 2: the string!</span></span>
<span id="cb301-13"><a href="#cb301-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>  <span class="op">$</span>len<span class="op">,</span> <span class="op">%</span><span class="kw">rdx</span> <span class="co">; Arg 3: the length of the string</span></span>
<span id="cb301-14"><a href="#cb301-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">syscall</span>          <span class="co">; Kick off the system call instruction!</span></span>
<span id="cb301-15"><a href="#cb301-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-16"><a href="#cb301-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span>  <span class="op">$</span><span class="bn">60</span><span class="op">,</span>  <span class="op">%</span><span class="kw">rax</span> <span class="co">; System call #60 == exit</span></span>
<span id="cb301-17"><a href="#cb301-17" aria-hidden="true" tabindex="-1"></a>    xorq  <span class="op">%</span><span class="kw">rdi</span><span class="op">,</span> <span class="op">%</span><span class="kw">rdi</span> <span class="co">; Arg 1: xor(x, x) == 0, pass NULL as argument!</span></span>
<span id="cb301-18"><a href="#cb301-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">syscall</span></span></code></pre></div>
            <p>We compile this assembly with <code>make</code> (in
            <code>10/</code>). Program output:</p>
            <pre><code>hello world</code></pre>
            <p>We can see that the requirements of making a system call
            are quite minimal! A special instruction (on x86-64,
            <code>syscall</code>) provides the magical incantation to
            make what feels like a function call <em>to the
            kernel</em>.</p>
            <p>How does this work? Recall that ELF, the file format for
            objects and programs includes many pieces of information
            necessary to execute the program. Among them, the
            <em>starting or entry address</em> which is the initial
            instruction to start executing when the program runs.</p>
            <pre><code>$ readelf -a ./asm_syscall  | grep &quot;Entry&quot;
  Entry point address:               0x401000
$ readelf -a ./asm_syscall  | grep &quot;401000&quot;
  Entry point address:               0x401000
...
     6: 0000000000401000     0 NOTYPE  GLOBAL DEFAULT    1 _start</code></pre>
            <p>We can see that the “entry point address” for the binary
            is <code>0x401000</code>, and we can see that the
            <code>_start</code> symbol has that address. The
            <code>exec</code> logic of the kernel will set the program
            to start executing at that <code>_start</code> address.</p>
            <p>Note that this same analysis rings true for the normal C
            system call code above (not only for the assembly)! The
            <code>_start</code> function is where all execution starts
            in each program. This explains why our program above labels
            its code with <code>_start</code>!</p>
            <h2 data-number="12.2" id="observing-system-calls"><span
            class="header-section-number">12.2</span> Observing System
            Calls</h2>
            <p>The <code>strace</code> program lets us monitor the
            system calls a program makes. Running int on the assembly
            program above:</p>
            <pre><code>$ strace ./asm_syscall
execve(&quot;./asm_syscall&quot;, [&quot;./asm_syscall&quot;], 0x7fff3c06ae10 /* 50 vars */) = 0
write(1, &quot;hello world\n&quot;, 12hello world
)           = 12
exit(0)                                 = ?
+++ exited with 0 +++</code></pre>
            <p>This likely has what you’d expect: We see the
            <code>exec</code> that kicks off the program, the
            <code>write</code>, and, finally, the <code>exit</code>.
            You’d likely expect the same from the normal C program that
            also writes out <code>hello world</code>.</p>
            <pre><code>$ trace ./normal_syscall
execve(&quot;./normal_syscall&quot;, [&quot;./normal_syscall&quot;], 0x7ffc036c1520 /* 50 vars */) = 0
brk(NULL)                               = 0x5638ed59d000
arch_prctl(0x3001 /* ARCH_??? */, 0x7ffd8bfb49c0) = -1 EINVAL (Invalid argument)
access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, &quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3
fstat(3, {st_mode=S_IFREG|0644, st_size=138102, ...}) = 0
mmap(NULL, 138102, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7efddf831000
close(3)                                = 0
openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3
read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360A\2\0\0\0\0\0&quot;..., 832) = 832
pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784
pread64(3, &quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;, 32, 848) = 32
pread64(3, &quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\237\333t\347\262\27\320l\223\27*\202C\370T\177&quot;..., 68, 880) = 68
fstat(3, {st_mode=S_IFREG|0755, st_size=2029560, ...}) = 0
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7efddf82f000
pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784
pread64(3, &quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;, 32, 848) = 32
pread64(3, &quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\237\333t\347\262\27\320l\223\27*\202C\370T\177&quot;..., 68, 880) = 68
mmap(NULL, 2037344, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7efddf63d000
mmap(0x7efddf65f000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x22000) = 0x7efddf65f000
mmap(0x7efddf7d7000, 319488, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19a000) = 0x7efddf7d7000
mmap(0x7efddf825000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7efddf825000
mmap(0x7efddf82b000, 13920, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7efddf82b000
close(3)                                = 0
arch_prctl(ARCH_SET_FS, 0x7efddf830540) = 0
mprotect(0x7efddf825000, 16384, PROT_READ) = 0
mprotect(0x5638eb775000, 4096, PROT_READ) = 0
mprotect(0x7efddf880000, 4096, PROT_READ) = 0
munmap(0x7efddf831000, 138102)          = 0
write(1, &quot;hello world\n&quot;, 12hello world
)           = 12
exit_group(0)                           = ?
+++ exited with 0 +++</code></pre>
            <p>Whaaaaa!? If you look carefully, at the bottom we see the
            expected output. But we also see a <em>lot</em> of system
            calls previous to that. Between when we start execution at
            <code>_start</code>, and when we execute in
            <code>main</code>, quite a lot happens.</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li>What do you think is causing all of these system calls?
            What is the program doing before running
            <code>main</code>?</li>
            </ul>
            <figure>
            <img src="figures/10_bootup_syscalls.svg"
            alt="Why are there so many system calls in a simple C program? Lets compare what happens in the C versus assembly programs. The process on the left is normal_syscall above, while asm_syscall is on the right. The assembly system call avoids much of the C runtime support, thus starts execution at _start, and makes system calls directly. In contrast, the C program starts execution in the dynamic linker ld (i.e. at _start in ld) – step (1). ld links in the libc dynamic library (2), then executes _start in our program (3). Our program actually calls libc (4) before executing main to do library initialization, which then calls main. After main returns (5), it returns into libc, which then terminates our program with the _exit system call. So why are there so many system calls made in the C program? There’s a lot of execution that happens outside of our logic! Most of the system calls are from ld." />
            <figcaption aria-hidden="true">Why are there so many system
            calls in a simple C program? Lets compare what happens in
            the C versus assembly programs. The process on the left is
            <code>normal_syscall</code> above, while
            <code>asm_syscall</code> is on the right. The assembly
            system call avoids much of the C runtime support, thus
            starts execution at <code>_start</code>, and makes system
            calls directly. In contrast, the C program starts execution
            in the dynamic linker <code>ld</code> (i.e. at
            <code>_start</code> in <code>ld</code>) – step (1).
            <code>ld</code> links in the <code>libc</code> dynamic
            library (2), then executes <code>_start</code> in our
            program (3). Our program actually calls <code>libc</code>
            (4) before executing <code>main</code> to do library
            initialization, which then calls <code>main</code>. After
            <code>main</code> returns (5), it returns into
            <code>libc</code>, which then terminates our program with
            the <code>_exit</code> system call. So why are there so many
            system calls made in the C program? There’s a lot of
            execution that happens outside of our logic! Most of the
            system calls are from <code>ld</code>.</figcaption>
            </figure>
            <h2 data-number="12.3" id="system-call-overhead"><span
            class="header-section-number">12.3</span> System Call
            Overhead</h2>
            <p>There are many reasons why some functionality might be in
            a library, and accessed via function calls, or in the
            kernel, and accessed with system calls.</p>
            <p>Lets look at an example of memory allocation. We can, of
            course, use <code>malloc</code> and <code>free</code> to
            allocate and free memory. But we can also call
            <code>mmap</code> and <code>munmap</code> that make
            <em>system calls</em> to allocate and free memory.</p>
            <p><strong>Questions:</strong></p>
            <ul>
            <li>Which will be <em>faster</em>,
            <code>malloc</code>/<code>free</code> or
            <code>mmap</code>/<code>munmap</code>?</li>
            <li>How much overhead would you <em>guess</em> a system call
            has?</li>
            </ul>
            <div class="sourceCode" id="cb306"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;10/timer.h&quot;</span></span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb306-5"><a href="#cb306-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/mman.h&gt;</span></span>
<span id="cb306-6"><a href="#cb306-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb306-7"><a href="#cb306-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-8"><a href="#cb306-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ITER </span><span class="dv">256</span></span>
<span id="cb306-9"><a href="#cb306-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-10"><a href="#cb306-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb306-11"><a href="#cb306-11" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb306-12"><a href="#cb306-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb306-13"><a href="#cb306-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb306-14"><a href="#cb306-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> start<span class="op">,</span> end<span class="op">;</span></span>
<span id="cb306-15"><a href="#cb306-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">*</span>mem<span class="op">;</span></span>
<span id="cb306-16"><a href="#cb306-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-17"><a href="#cb306-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* How many cycles does `write` take? */</span></span>
<span id="cb306-18"><a href="#cb306-18" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> cycles<span class="op">();</span></span>
<span id="cb306-19"><a href="#cb306-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ITER<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb306-20"><a href="#cb306-20" aria-hidden="true" tabindex="-1"></a>        mem <span class="op">=</span> malloc<span class="op">(</span><span class="dv">256</span><span class="op">);</span></span>
<span id="cb306-21"><a href="#cb306-21" aria-hidden="true" tabindex="-1"></a>        mem<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb306-22"><a href="#cb306-22" aria-hidden="true" tabindex="-1"></a>        free<span class="op">(</span>mem<span class="op">);</span></span>
<span id="cb306-23"><a href="#cb306-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb306-24"><a href="#cb306-24" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> cycles<span class="op">();</span></span>
<span id="cb306-25"><a href="#cb306-25" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">malloc + free overhead (cycles): </span><span class="sc">%lld\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">(</span>end <span class="op">-</span> start<span class="op">)</span> <span class="op">/</span> ITER<span class="op">);</span></span>
<span id="cb306-26"><a href="#cb306-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-27"><a href="#cb306-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* How many cycles does `fwrite` take? */</span></span>
<span id="cb306-28"><a href="#cb306-28" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> cycles<span class="op">();</span></span>
<span id="cb306-29"><a href="#cb306-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ITER<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb306-30"><a href="#cb306-30" aria-hidden="true" tabindex="-1"></a>        mem <span class="op">=</span> mmap<span class="op">(</span>NULL<span class="op">,</span> <span class="dv">256</span><span class="op">,</span> PROT_READ <span class="op">|</span> PROT_WRITE<span class="op">,</span> MAP_ANONYMOUS <span class="op">|</span> MAP_PRIVATE<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb306-31"><a href="#cb306-31" aria-hidden="true" tabindex="-1"></a>        mem<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">42</span><span class="op">;</span></span>
<span id="cb306-32"><a href="#cb306-32" aria-hidden="true" tabindex="-1"></a>        munmap<span class="op">(</span>mem<span class="op">,</span> <span class="dv">256</span><span class="op">);</span></span>
<span id="cb306-33"><a href="#cb306-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb306-34"><a href="#cb306-34" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> cycles<span class="op">();</span></span>
<span id="cb306-35"><a href="#cb306-35" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">mmap + munmap overhead (cycles): </span><span class="sc">%lld\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">(</span>end <span class="op">-</span> start<span class="op">)</span> <span class="op">/</span> ITER<span class="op">);</span></span>
<span id="cb306-36"><a href="#cb306-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-37"><a href="#cb306-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb306-38"><a href="#cb306-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>
malloc + free overhead (cycles): 148

mmap + munmap overhead (cycles): 2942</code></pre>
            <blockquote>
            <p>What is a “cycle”? When you read that you have a 3GHz,
            that essentially says that the internal “clock” that drives
            the logic in the processor cycles by at 3 billion cycles per
            second. That’s a <em>lot</em>. Each cycle is 1/3 a
            nanosecond. A cycle is the smallest unit of measurement on a
            processor, and the <code>cycles</code> function we implement
            here gives us how many cycles have elapsed since the system
            boots.</p>
            </blockquote>
            <p>We can also look at the output APIs like
            <code>write</code> and compare them to the stream APIs that
            buffer their output.</p>
            <p><strong>Questions:</strong></p>
            <ul>
            <li>If we write a byte to a file using <code>write</code> or
            to a stream (via a <code>FILE</code>) using
            <code>fwrite</code>, what performance would you expect?</li>
            <li>How about if we did an <code>fflush</code> after the
            <code>fwrite</code>?</li>
            </ul>
            <div class="sourceCode" id="cb308"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;10/timer.h&quot;</span></span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb308-5"><a href="#cb308-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-6"><a href="#cb308-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ITER </span><span class="dv">256</span></span>
<span id="cb308-7"><a href="#cb308-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-8"><a href="#cb308-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb308-9"><a href="#cb308-9" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb308-10"><a href="#cb308-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb308-11"><a href="#cb308-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb308-12"><a href="#cb308-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> start<span class="op">,</span> end<span class="op">;</span></span>
<span id="cb308-13"><a href="#cb308-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-14"><a href="#cb308-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* How many cycles does `write` take? */</span></span>
<span id="cb308-15"><a href="#cb308-15" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> cycles<span class="op">();</span></span>
<span id="cb308-16"><a href="#cb308-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ITER<span class="op">;</span> i<span class="op">++)</span> write<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="st">&quot; &quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb308-17"><a href="#cb308-17" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> cycles<span class="op">();</span></span>
<span id="cb308-18"><a href="#cb308-18" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">write overhead (cycles): </span><span class="sc">%lld\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">(</span>end <span class="op">-</span> start<span class="op">)</span> <span class="op">/</span> ITER<span class="op">);</span></span>
<span id="cb308-19"><a href="#cb308-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-20"><a href="#cb308-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* How many cycles does `fwrite` take? */</span></span>
<span id="cb308-21"><a href="#cb308-21" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> cycles<span class="op">();</span></span>
<span id="cb308-22"><a href="#cb308-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ITER<span class="op">;</span> i<span class="op">++)</span> fwrite<span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> stdout<span class="op">);</span></span>
<span id="cb308-23"><a href="#cb308-23" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> cycles<span class="op">();</span></span>
<span id="cb308-24"><a href="#cb308-24" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">fwrite (stream) overhead (cycles): </span><span class="sc">%lld\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">(</span>end <span class="op">-</span> start<span class="op">)</span> <span class="op">/</span> ITER<span class="op">);</span></span>
<span id="cb308-25"><a href="#cb308-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-26"><a href="#cb308-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* How many cycles does `fwrite + fflush` take? */</span></span>
<span id="cb308-27"><a href="#cb308-27" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> cycles<span class="op">();</span></span>
<span id="cb308-28"><a href="#cb308-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ITER<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb308-29"><a href="#cb308-29" aria-hidden="true" tabindex="-1"></a>        fwrite<span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> stdout<span class="op">);</span></span>
<span id="cb308-30"><a href="#cb308-30" aria-hidden="true" tabindex="-1"></a>        fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb308-31"><a href="#cb308-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb308-32"><a href="#cb308-32" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> cycles<span class="op">();</span></span>
<span id="cb308-33"><a href="#cb308-33" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">fwrite + fflush overhead (cycles): </span><span class="sc">%lld\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="op">(</span>end <span class="op">-</span> start<span class="op">)</span> <span class="op">/</span> ITER<span class="op">);</span></span>
<span id="cb308-34"><a href="#cb308-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-35"><a href="#cb308-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb308-36"><a href="#cb308-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>
malloc + free overhead (cycles): 126

mmap + munmap overhead (cycles): 2448</code></pre>
            <h2 data-number="12.4"
            id="library-vs.-kernel-trade-offs-in-memory-allocation"><span
            class="header-section-number">12.4</span> Library vs. Kernel
            Trade-offs in Memory Allocation</h2>
            <p>We’ve seen that</p>
            <ol type="1">
            <li>the kernel is there to facilitate access to hardware
            resources (memory, processing, etc…),</li>
            <li>the kernel provides processes (<code>fork</code>,
            <code>exec</code>) and inter-process interactions
            (<code>wait</code>, <code>pipe</code>, etc…) as these
            functionalities require implementation beyond any single
            process,</li>
            <li>functions in dynamic libraries are much faster to invoke
            as system calls have significant overhead.</li>
            </ol>
            <p>This leads us to the conclusion that for performance,
            we’d like to implement as many functions as possible in
            libraries, and to rely on the kernel when processes require
            modifications (<code>exec</code>, <code>fork</code>), when
            there are multiple processes involved (IPC), or when the
            finite resources of the system must be split up between
            processes (<code>open</code>, <code>creat</code>,
            <code>sbrk</code>).</p>
            <p>Here, we’re going to dive into the design of the
            <em>memory management</em> functionalities in UNIX to better
            understand the trade-offs. Specifically, <em>how does
            <code>malloc</code> and <code>free</code> work</em>!?</p>
            <h3 data-number="12.4.1"
            id="library-tracking-of-memory"><span
            class="header-section-number">12.4.1</span> Library Tracking
            of Memory</h3>
            <p>So <code>malloc</code>, <code>calloc</code>,
            <code>realloc</code>, and <code>free</code> are implemented
            in a library (in <code>libc</code>), and when we request
            memory from them, they might call <code>sbrk</code> (or
            <code>mmap</code> on some systems) to get memory from the
            kernel, but from that point on, they will manage that memory
            themselves. What does this mean? When the <em>heap</em>
            doesn’t have enough free memory to satisfy a
            <code>malloc</code> request, we call the kernel to
            <em>expand the heap</em>. To do so, we ask the kernel for
            memory via <code>sbrk</code> or <code>mmap</code>, and we
            generally get a large chunk of memory. For example, we might
            ask <code>sbrk</code> for 64KB of memory with
            <code>mem = sbrk(1 &lt;&lt; 16)</code><a href="#fn25"
            class="footnote-ref" id="fnref25"
            role="doc-noteref"><sup>25</sup></a>. Then it is
            <code>malloc</code>’s job to split up that memory into the
            smaller chunks that we’ll return in each subsequent call to
            <code>malloc</code>. When memory is <code>free</code>d, it
            is returned to the pool of memory which we’ll consider for
            future allocations. Because we’re <em>reusing</em> freed
            memory, we’re avoiding system calls when the heap contains
            enough <code>free</code>d memory to satisfy a request.</p>
            <figure>
            <img src="figures/10_mem_splitting.svg"
            alt="In (a), we see the heap with red rectangles that designate allocated memory. (b) we get a malloc request. First we check to see if there is any span of unallocated memory we can use to satisfy the request. (c) shows what we must avoid: the overlapping of two different allocations. As we cannot find a sufficient span of memory to satisfy the malloc request, in (d), we expand the heap using sbrk. (e) shows how we can satisfy the request from the newly expanded heap memory." />
            <figcaption aria-hidden="true">In (a), we see the heap with
            red rectangles that designate allocated memory. (b) we get a
            <code>malloc</code> request. First we check to see if there
            is any span of unallocated memory we can use to satisfy the
            request. (c) shows what we must avoid: the overlapping of
            two different allocations. As we cannot find a sufficient
            span of memory to satisfy the <code>malloc</code> request,
            in (d), we expand the heap using <code>sbrk</code>. (e)
            shows how we can satisfy the request from the newly expanded
            heap memory.</figcaption>
            </figure>
            <p>This is what it means that our
            <code>malloc</code>/<code>free</code> code in the
            <code>libc</code> library need to track the memory in the
            heap. We need to track <em>where allocated memory is
            located</em> and <em>where freed spans of memory are
            located</em>, to enable intelligent allocation decisions for
            future <code>malloc</code> calls.</p>
            <p><strong>Questions:</strong></p>
            <ul>
            <li>What data-structures should we use to track
            allocated/freed memory?</li>
            <li>Do you foresee any challenges in using data-structures
            to track memory?</li>
            </ul>
            <h3 data-number="12.4.2" id="malloc-data-structures"><span
            class="header-section-number">12.4.2</span> Malloc
            Data-structures</h3>
            <p>The <code>malloc</code> and <code>free</code>
            implementation must track which chunks of memory are
            allocated, and which are freed, but it cannot use
            <code>malloc</code> to allocate data-structures. That would
            result in <code>malloc</code> calling itself recursively,
            and infinitely! If <code>malloc</code> requires memory
            allocation for its tracking data-structures, who tracks the
            memory for the tracking data-structures? Yikes.</p>
            <p>We solve this problem by allocating the tracking
            data-structures along with the actual memory allocation
            itself. That is to say, we allocate a <em>header</em> that
            is a struct defined by <code>malloc</code> that is
            <em>directly before</em> an actual memory allocation.
            Because the header is part of the same contiguous memory
            chunk, we allocate the header at the same time as we
            allocate memory! When memory is freed, we use the header to
            track the chunk of memory (the header plus the free memory
            directly following the header) in a linked list of free
            chunks of memory called a <em>freelist</em>.</p>
            <figure>
            <img src="figures/10_malloc.svg"
            alt="Memory allocations through various sets of details. The red boxes are allocated memory, white box is memory that we’ve retrieved in the heap from sbrk, the green boxes are the headers data-structures that track free chunks of memory we can use for future allocations, and they are arranged in a linked list called freelist, and orange boxes are headers for allocated chunks of memory thta track how large that allocation is so that when we free it, we know large the chunk of freed memory will be." />
            <figcaption aria-hidden="true">Memory allocations through
            various sets of details. The red boxes are allocated memory,
            white box is memory that we’ve retrieved in the heap from
            <code>sbrk</code>, the green boxes are the <em>headers</em>
            data-structures that track free chunks of memory we can use
            for future allocations, and they are arranged in a linked
            list called <em>freelist</em>, and orange boxes are headers
            for allocated chunks of memory thta track how large that
            allocation is so that when we <code>free</code> it, we know
            large the chunk of freed memory will be.</figcaption>
            </figure>
            <ul>
            <li><ol type="a">
            <li>the heap with some memory allocated, and some free spans
            of memory.</li>
            </ol></li>
            <li><ol start="2" type="a">
            <li>we need to make a data-structure to track where the free
            spans of memory are, so we add a structure into each of the
            free chunks, and use it to construct a linked list of the
            free chunks.</li>
            </ol></li>
            <li><ol start="3" type="a">
            <li>When we <code>malloc</code>, we can find the free chunk
            large enough for the allocation, remove it from the
            freelist, …</li>
            </ol></li>
            <li><ol start="4" type="a">
            <li>…and return it!</li>
            </ol></li>
            <li><ol start="5" type="a">
            <li>If we want to free that memory, we must understand
            somehow (i.e. must have a structure that tracks) the size of
            the allocation, so that we can add it back onto the
            freelist.</li>
            </ol></li>
            <li><ol start="6" type="a">
            <li>We can track the size of each allocation in a
            <em>header</em> directly before the memory we return. We are
            tracking the memory in the same contiguous span of memory we
            use for the allocation!</li>
            </ol></li>
            <li><ol start="7" type="a">
            <li>So when we free, we’re just adding that memory back onto
            the freelist.</li>
            </ol></li>
            <li><ol start="8" type="a">
            <li>If we ever receive a <code>malloc</code> request that
            can’t be satisfied by the freelist, <em>only then</em> do we
            make a system call to allocate more heap.</li>
            </ol></li>
            </ul>
            <h3 data-number="12.4.3" id="exercise-smalloc"><span
            class="header-section-number">12.4.3</span> Exercise:
            <code>smalloc</code></h3>
            <p>Look at the <a
            href="https://github.com/gwu-cs-sysprog/lectures/blob/main/10/smalloc.c"><code>10/smalloc.c</code>
            (link)</a> file for a simple implementation of a
            <code>malloc</code>/<code>free</code> that assumes <em>only
            allocations of a specific size</em>. This means that we
            don’t need to track the sizes of allocations and free chunks
            in the headers, simplifying our implementation. Build, and
            run the program:</p>
            <pre><code>$ make
$ ./smalloc.bin</code></pre>
            <p>It currently implements this simple <code>malloc</code>!
            Read through the <code>smalloc</code> and <code>sfree</code>
            functions, and the <code>main</code>. Answer
            <code>QUESTION 1-3</code>. Then, move on to
            <code>QUESTION 4</code>. In <code>expand_heap</code>, we
            make the system call to allocate more memory from the system
            with <code>sbrk</code>. We need to set up that newly
            allocated heap memory to include memory chunks that we can
            allocate with <code>smalloc</code>. Answering how this is
            done is the core of <code>QUESTION 4</code>.</p>
            <h1 data-number="13"
            id="unix-security-users-groups-and-filesystem-permissions"><span
            class="header-section-number">13</span> UNIX Security:
            Users, Groups, and Filesystem Permissions</h1>
            <blockquote>
            <p><strong>This material adapted from Prof. Aviv’s <a
            href="https://classes.adamaviv.com/ic221/s18/units/01/unit.html#org26c0ea7">material</a>.</strong></p>
            </blockquote>
            <p>We’ve seen how the filesystem is used to store and name
            files and channels, and we’ve seen the APIs to access
            directories and files. If everyone had access to every
            else’s files, then there would be no way to secure your
            information. Thus, the kernel provides means to control
            different user’s <em>access</em> to different files and
            directories. This means that I cannot access your files, and
            vice-versa!</p>
            <p>To understand the core concept of <em>access control</em>
            in UNIX, we have to understand</p>
            <ol type="1">
            <li>how UNIX thinks about, implements, and organizes users
            and groups of users,</li>
            <li>how files and directories provide various access
            permissions to different users and how to alter those
            permissions, and</li>
            <li>how services, even when executed by a user, can have
            heightened access to system resources.</li>
            </ol>
            <h2 data-number="13.1"
            id="file-and-directory-permissions"><span
            class="header-section-number">13.1</span> File and Directory
            Permissions</h2>
            <p>The filesystem stores files and directories are somehow
            associated with each of us, separately. Lets check out the
            properties of a file that are returned by running
            <code>ls -l</code>:</p>
            <pre><code>.- Directory?
|    .-------Permissions                   .- Directory Name
| ___|___     .----- Owner                 |
v/       \    V     ,---- Group            V
drwxr-x--x 4 aviv scs 4096 Dec 17 15:14 im_a_directory
-rw------- 1 aviv scs 400  Dec 19  2013 .ssh/id_rsa.pub
                       ^   \__________/    ^
File Size -------------&#39;       |           &#39;- File Name
  in bytes                     |
                               |
   Last Modified --------------&#39;</code></pre>
            <p>An example from the class’ server where we create a file,
            a directory, and see the results:</p>
            <pre><code>$ echo hi &gt; file.txt
$ mkdir hello
$ ls -l
-rw-r--r-- 1 gparmer dialout    3 Mar 18 12:19 file.txt
drwxr-xr-x 2 gparmer dialout 4096 Mar 18 12:20 hello</code></pre>
            <p>We see that each file and directory has a owner and group
            associated with it.</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li>What do you think this means? Why do files have owners
            and groups?</li>
            </ul>
            <h3 data-number="13.1.1"
            id="file-ownership-and-groups"><span
            class="header-section-number">13.1.1</span> File Ownership
            and Groups</h3>
            <p>The <em>owner</em> of a file is the <em>user</em> that is
            directly responsible for the file and has special status
            with respect to the file permissions. Users can also be
            collected together into a set called a <em>group</em>, a
            collection of users who posses the same permissions. A file
            is associated with a group. A file’s or directory’s owners
            and groups have different permissions to access the file.
            Before we dive into that, lets understand how to understand
            users and groups.</p>
            <p>You all are already aware of your username. You can get
            your username with the <code>whoami</code> command:</p>
            <pre><code>$ whoami
gparmer</code></pre>
            <p>To have UNIX tell you your username and connection
            information on this machine, use the command,
            <code>who</code>:</p>
            <pre><code>$ who
gparmer  pts/1        2022-03-18 12:12 (128.164...)</code></pre>
            <p>The first part of the output is the username. The rest of
            the information in the output refers to the terminal you’re
            using (it is a “pseudo-terminal device”, something that
            pretends it is a typewriter from the 60s), the time the
            terminal was created, and from which host you are
            connected.</p>
            <p>You can determine which groups you are in using the
            groups command.</p>
            <pre><code>$ groups
dialout CS_Admins</code></pre>
            <p>On the class’ server, I’m in the <code>dialout</code> and
            <code>CS_Admins</code> groups. On my work computer, I’m in a
            few more groups:</p>
            <pre><code>$ groups
ycombinator adm cdrom sudo dip plugdev lpadmin sambashare</code></pre>
            <p>The good news is that I can use my <code>cdrom</code>.
            Fantastic. It will pair well with my pseudo-typewriter.
            Cool.</p>
            <h3 data-number="13.1.2" id="file-permissions"><span
            class="header-section-number">13.1.2</span> File
            Permissions</h3>
            <p>The <em>permissions</em> associated with each
            file/directory specify who should be able to have the
            following access:</p>
            <ul>
            <li><code>r</code> - the ability to <em>read</em> the file,
            or <em>read the contents</em> of a directory.</li>
            <li><code>w</code> - the ability to <em>write</em> to the
            file, or update the contents of a directory.</li>
            <li><code>x</code> - the ability to <em>execute</em> a file
            (i.e. a program), or <code>chdir</code> into a
            directory.</li>
            </ul>
            <p>We think about different users as having different sets
            of these permissions to access files and directories. When
            we see the permissions string for a file, we see three sets
            of these <code>rwx</code> permissions:</p>
            <pre><code>-rw-r--r-- 1 gparmer dialout    3 Mar 18 12:19 file.txt</code></pre>
            <p>Here we have three sets of permissions <code>rw-</code>
            (read and write), <code>r--</code> (read only), and
            <code>r--</code> (read only). These three sets of
            permissions each specify the access permissions for the
            <em>owner</em>, the <em>group</em>, and everyone else’s
            <em>global</em> permissions.</p>
            <pre><code> .-- Directory Bit
|
|       ,--- Global Permission (i.e. &quot;every else&quot;)
v      / \
-rwxr-xr-x
 \_/\_/
  |  `--Group Permission
  |
   `-- Owner Permission</code></pre>
            <p>Given this, now we can understand the permissions for
            each file in:</p>
            <pre><code>ls -l 11/perm_example/
total 0
-rw-r--r-- 1 gparmer gparmer 0 Mar 25 18:43 bar
-rw-rw-r-- 1 gparmer gparmer 0 Mar 25 18:43 baz
-rwx------ 1 gparmer gparmer 0 Mar 25 18:42 foo</code></pre>
            <p><em>Question:</em></p>
            <ul>
            <li><em>Who</em> has <em>what access permissions</em> to
            which files?</li>
            </ul>
            <h3 data-number="13.1.3"
            id="numerical-representation-of-permissions"><span
            class="header-section-number">13.1.3</span> Numerical
            Representation of Permissions</h3>
            <p>Each permission has a <em>numerical representation</em>.
            We represent it in <em>octal</em>, which is a fancy way to
            say that we think of each digit of our numerical
            representation as being between <code>0-7</code> – it is
            “base 8” (in contrast to the normal digits numbers we use
            every day that are “base 10”). Thus, each of the three sets
            of permissions is <code>3</code> bits.</p>
            <p>Each of the three permissions, <code>r</code>,
            <code>w</code>, and <code>x</code> correspond to the
            most-significant to the least significant bits in each octal
            digit. For example:</p>
            <pre><code>rwx -&gt; 1 1 1 -&gt; 7
r-x -&gt; 1 0 1 -&gt; 5
--x -&gt; 0 0 1 -&gt; 1
rw- -&gt; 1 1 0 -&gt; 6</code></pre>
            <p>On the left we see a permission, its bit representation,
            and the associated octal digit. The shorthand, you can think
            of this is this:</p>
            <ul>
            <li><code>r = 4</code> as it is represented with the most
            significant bit</li>
            <li><code>w = 2</code> as the second bit</li>
            <li><code>x = 1</code> as it is the least significant
            bit</li>
            </ul>
            <p>Thus the octal digit is simply the addition of each of
            these numeric values for each access right. We can combine
            these digits to encapsulate permissions for the owner,
            group, and everyone else:</p>
            <pre><code>-rwxrwxrwx -&gt; 111 111 111 -&gt; 7 7 7
-rwxrw-rw- -&gt; 111 110 110 -&gt; 7 6 6
-rwxr-xr-x -&gt; 111 101 101 -&gt; 7 5 5</code></pre>
            <p>So now we know how to interpret, and understand these
            permission values, and how to represent them as digits.</p>
            <h3 data-number="13.1.4"
            id="updating-filedirectory-permissions"><span
            class="header-section-number">13.1.4</span> Updating
            File/Directory Permissions</h3>
            <p>To change a file permission, you use the
            <code>chmod</code> command, or the <code>chmod</code> system
            call. In each, we specify the file to update, and the new
            permissions in octal. Lets play around with permission and
            see their impact:</p>
            <pre><code>$ gcc helloworld.c -o helloworld.bin
$ ls -l helloworld.bin
-rwxrwxr-x 1 gparmer gparmer 41488 Mar 22 08:52 helloworld.bin
$ ./helloworld.bin
hello world!</code></pre>
            <p>I can execute the program, and I could read the program,
            for example using <code>nm</code>. I could even overwrite
            the file.</p>
            <blockquote>
            <p>Note: on the server, the default permissions are more
            restrictive –
            <code>-rwxr-xr-x 1 gparmer dialout 16464 Mar 25 19:16 helloworld.bin</code>.
            We don’t want anyone other than us writing to the file on a
            shared server!</p>
            </blockquote>
            <p>What if I removed all permissions for everyone but the
            owner, and even removed my own ability to execute?</p>
            <pre><code>$ chmod 600 helloworld.bin
$ ls -l helloworld.bin
-rw------- 1 gparmer gparmer 41488 Mar 22 08:52 helloworld.bin
$ ./helloworld.bin
-bash: ./helloworld.bin: Permission denied</code></pre>
            <p>We removed our own ability to execute the file, so we no
            longer can! Note that permission <code>6</code> is
            <code>4 + 2</code> which is <code>r</code> + <code>w</code>.
            If I wanted on the system to be able to execute the
            program:</p>
            <pre><code>$ chmod 711 helloworld.bin
$ ls -l helloworld.bin
-rwx--x--x 1 gparmer gparmer 41488 Mar 22 08:52 helloworld.bin
$ ./helloworld.bin
hello world!</code></pre>
            <p>Recall, <code>7 = 4 + 2 + 1</code> which is
            <code>r</code> + <code>w</code> + <code>x</code>. We can see
            that we’ve given everyone on the system execute permissions,
            so the file is again about to execute! Any other user on the
            system would also be able to execute the program.</p>
            <p><strong>Questions:</strong></p>
            <ul>
            <li>How do you think permissions change access to
            directories? Try out setting the permissions of a directory
            (recall <code>mkdir</code>), and seeing what accesses cannot
            be made if permissions are removed.</li>
            <li>You and a classmate should sit down together, and use
            <code>chmod</code> to concretely understand when you can
            access each other’s files. Remember, you can find out where
            your files are with <code>pwd</code>, what groups you’re in
            with <code>groups</code>. Which files can another user can
            access at that path with sufficient permissions? You can use
            the <code>/tmp/</code> directory to store files that you can
            both mutually access, permissions allowing.</li>
            </ul>
            <h3 data-number="13.1.5"
            id="changing-filedirectory-owner-and-group"><span
            class="header-section-number">13.1.5</span> Changing
            File/Directory Owner and Group</h3>
            <p>We’ve seen that each file and directory is associated
            with a user, and with a group. Which means that, of course,
            we can change those settings! Two commands (and their
            corresponding system call: <code>chown</code>):</p>
            <ul>
            <li><code>chown &lt;user&gt; &lt;file/directory&gt;</code> -
            change owner of the file/directory to the user</li>
            <li><code>chgrp &lt;group&gt; &lt;file/directory&gt;</code>
            - change group of the file to the group</li>
            </ul>
            <p>UNIX limits who is able to execute these operations.</p>
            <ul>
            <li>Only a <em>superuser</em> called <code>root</code> is
            allowed to <code>chown</code> a file or directory.
            <code>root</code> is special in that they are able to change
            the permissions of any file/directory, and most of the most
            sensitive files on the system are owned by root. For
            example, the devices (think, hard-drives holding the
            filesystem, monitors, and network devices) are only
            accessible by <code>root</code> (check out
            <code>/dev/*</code>).</li>
            <li>Only the <em>owner</em> of a file (and
            <code>root</code>) is allowed to change the group of a file,
            and only to a group that user is in (recall
            <code>groups</code>).</li>
            </ul>
            <p>We can see this:</p>
            <pre><code>$ chown root helloworld.bin
chown: changing ownership of &#39;helloworld.bin&#39;: Operation not permitted</code></pre>
            <p><strong>Question:</strong></p>
            <ul>
            <li>Why do you think we aren’t allowed to change the owner
            of a file, nor change the group to one in which we don’t
            belong?</li>
            </ul>
            <h2 data-number="13.2"
            id="security-and-programming-with-users-and-groups"><span
            class="header-section-number">13.2</span> Security and
            Programming with Users and Groups</h2>
            <p>We’ve seen that a lot of UNIX security centers around
            users, groups, and the corresponding permissions associated
            with files and directories. When a process is
            <code>fork</code>ed, it <em>inherits</em> the user and group
            of the parent process. Thus, when you’re typing at a shell,
            the <em>shell process</em> is what really is executing as
            your user id, and when you create programs, they inherit
            your user id. These are the core of the security primitives,
            so lets dive into a little more detail.</p>
            <h4 data-number="13.2.0.1"
            id="apis-for-accessing-a-programs-privilege-settings"><span
            class="header-section-number">13.2.0.1</span> APIs for
            Accessing a Program’s Privilege Settings</h4>
            <p>If every process has a user and group, we must be able to
            access them, right? There are two basic system calls for
            retrieving user and group information within a program.</p>
            <ul>
            <li><code>uid_t getuid(void)</code> - Returns the real user
            id of the calling process.</li>
            <li><code>gid_t getgid(void)</code> - Returns the real group
            id of the calling process.</li>
            </ul>
            <p>Let’s look at an example program.</p>
            <div class="sourceCode" id="cb326"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-5"><a href="#cb326-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb326-6"><a href="#cb326-6" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span> argv<span class="op">[])</span></span>
<span id="cb326-7"><a href="#cb326-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb326-8"><a href="#cb326-8" aria-hidden="true" tabindex="-1"></a>    uid_t uid<span class="op">;</span></span>
<span id="cb326-9"><a href="#cb326-9" aria-hidden="true" tabindex="-1"></a>    gid_t gid<span class="op">;</span></span>
<span id="cb326-10"><a href="#cb326-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-11"><a href="#cb326-11" aria-hidden="true" tabindex="-1"></a>    uid <span class="op">=</span> getuid<span class="op">();</span></span>
<span id="cb326-12"><a href="#cb326-12" aria-hidden="true" tabindex="-1"></a>    gid <span class="op">=</span> getgid<span class="op">();</span></span>
<span id="cb326-13"><a href="#cb326-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-14"><a href="#cb326-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;uid=</span><span class="sc">%d</span><span class="st"> gid=</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> uid<span class="op">,</span> gid<span class="op">);</span></span>
<span id="cb326-15"><a href="#cb326-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb326-16"><a href="#cb326-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb326-17"><a href="#cb326-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Program output:</p>
            <pre><code>
malloc + free overhead (cycles): 127

mmap + munmap overhead (cycles): 2515</code></pre>
            <p>Every user has different identifiers as does each group.
            If another user where to run the same program, they’d get a
            different value.</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li>In groups, one of you compile this program, and the
            other run it! Use <code>chmod</code> to make sure that they
            can! What do you observe?</li>
            <li>If the kernel thinks of users as numeric identifiers,
            how does <code>whoami</code> print out a <em>human-readable
            string</em>? Use <code>strace whoami</code> to come up with
            a strong guess.</li>
            <li>How do we get human-readable groups with
            <code>groups</code> (investigate with
            <code>strace groups</code>)?</li>
            </ul>
            <p>Interestingly, whomever <em>executes</em> the program
            will have their uid/gid printed out; it won’t use the
            uid/gid of the owner of the program. Remember, that we
            inherit the uid/gid on fork, thus when the shell runs the
            program, it uses our shell’s (thus our) uid/gid.</p>
            <h3 data-number="13.2.1" id="user-and-group-strings"><span
            class="header-section-number">13.2.1</span> User and Group
            Strings</h3>
            <p>If the UNIX programmatic APIs provide access to user and
            group <em>identifiers</em> (i.e. integers), how is it that
            we can see strings corresponding to these numeric values?
            The mapping of the identifiers to strings are defined in two
            places. The first is a file called <code>/etc/passwd</code>
            which manages all the users of the system. Here is the
            <code>/etc/passwd</code> entry on my local system (the
            server uses another means to store user info):</p>
            <pre><code>$ cat /etc/passwd | grep gparmer
gparmer:x:1000:1000:Gabe Parmer,,,:/home/ycombinator:/bin/bash
   |    |   |     |      |                 |             |
   V    |   V     |      V                 V             V
 user   | user id |  human-readable id  home directory  shell to use upon login
        V         V
    password    group id</code></pre>
            <p>We can lookup our username and associate it with a
            numerical user id, and a group id for that user. These
            numbers are what the system uses to track users, but UNIX
            nicely converts these numbers into names for our
            convenience. The file additionally holds the path to the
            user’s home directory, and their shell. These are used upon
            the user logging in: the login logic will switch to the
            user’s home directory, and execute their shell. The
            <code>password</code> entry is deprecated. The translation
            between userid and username is in the password file. The
            translation between groupid and group name is in the group
            file, <code>/etc/group</code>. Here is the entry for the
            administrators on the class’ server:</p>
            <pre><code>$ grep CS_Admins /etc/group
CS_Admins:x:1004:aaviv,timwood,gparmer,...</code></pre>
            <p>There you can see that the users <code>aaviv</code>,
            <code>timwood</code>, and <code>gparmer</code> are all in
            the group of administrators.</p>
            <p>All of this information, including identifiers, and
            human-readable strings can be retrieved with
            <code>id</code>.</p>
            <pre><code>$ id
uid=1000(gparmer) gid=1000(gparmer) groups=1000(gparmer),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),120(lpadmin),131(lxd),132(sambashare)</code></pre>
            <p><strong>Question:</strong> Take a moment to explore these
            files and the commands. See what groups you are in.</p>
            <h2 data-number="13.3"
            id="application-specific-privileges-using-set-user-idset-group-id"><span
            class="header-section-number">13.3</span>
            Application-Specific Privileges using
            set-user-id/set-group-id</h2>
            <p>Systems that support multiple users are quite complex.
            They have services used by many users, but that must be
            protected from the potentially accidental or malicious
            actions of users. These programs require more privileges
            than a user to do their job. A few examples:</p>
            <ul>
            <li><em>Logging</em> is a very important functionality in
            systems. It enables services to log actions that are taken,
            for example, users logging in to <code>ssh</code> and
            clients connecting to webservers. The logs are stored in
            files (often in <code>/var/log/</code>), and users must
            <em>not</em> be able to directly modify (and potentially
            corrupt) the logs. But they must be able to append to the
            logs. How can we support this contradiction when a logging
            process will run with our user id when we execute it!?</li>
            <li><em>Coordinating actions</em> such as running commands
            regularly, or at specific points in time. The programs
            <code>at</code> and <code>cron</code> enable exactly this!
            They require adding entries into system files
            (e.g. <code>crontab</code>) to record the actions, but one
            user must not corrupt the entires of another user. Again, we
            want to both be able to add entries to the files, but cannot
            modify the file!</li>
            </ul>
            <p>We already know one way to solve this problem. We can
            write a service, and have clients <em>request</em> (e.g. via
            IPC and domain sockets) it perform actions on our behalf. So
            long as a service runs as a different user, its files will
            be in accessible from clients.</p>
            <p>However, there is another way to solve the above
            contradictions. We really want a program to run with a
            <em>different</em> user’s permissions – those that go beyond
            our own. We want the <em>logger</em> to run with the
            permissions of the logging user, and we want
            <code>cron</code> to run with the permissions of the
            <code>cron</code> service. This is possible with the
            set-uid-bits (and set-gid-bits).</p>
            <p>The <code>set-*-bits</code> can be seen in the
            <code>man chmod</code> manual page. We’re used to
            permissions being three digits (for the owner, the group,
            and everyone else), but it can be specified as <em>four</em>
            digits. The most significant digit can be set on executable
            binaries, and will result in the binary executing with the
            owner’s uid/gid.</p>
            <p>That is, we previously assumed a permission string
            contained 3 octal digits, but really there are 4 octal
            digits. The missing octal digit is that for the set-bits.
            There are three possible set-bit settings and they are
            combined in the same way as other permissions:</p>
            <ul>
            <li><code>4</code> - <em>set-user-id</em>: sets the
            program’s effective user id to the owner of the program</li>
            <li><code>2</code> - <em>set-group-id</em>: sets the
            program’s effective group id to the group of the
            program</li>
            <li><code>1</code> - <em>the sticky bit</em>: which, when
            set on a directory, prevents others from deleting files from
            that directory. We won’t cover the stick bit.</li>
            </ul>
            <p>These bits are used in much the same way as the other
            permission modes. For example, we can change the permission
            of our get_uidgid program from before like so:</p>
            <pre><code>chmod 6751 get_uidgid</code></pre>
            <p>And we can interpet the octals like so:</p>
            <pre><code>set      group
bits user |  other
  |   |   |   |
  V   V   V   V
 110 111 101 001
  6   7   5   1</code></pre>
            <p>When we look at the <code>ls -l</code> output of the
            program, the permission string reflects these settings with
            an “s” in the execute part of the string for user and
            group.</p>
            <pre><code>$ ls -l get_uidgid
-rwsr-s--x 1 aviv scs 8778 Mar 30 16:45 get_uidgid</code></pre>
            <h4 data-number="13.3.0.1"
            id="real-vs.-effective-capabilities"><span
            class="header-section-number">13.3.0.1</span> Real
            vs. Effective Capabilities</h4>
            <p>With the set-bits, when the program runs, the
            capabilities of the program are effectively that of the
            owner and group of the <em>program</em>. However, the real
            user id and real group id remain that of the user who ran
            the program. This brings up the concept of
            <em>effective</em> vs. <em>real</em> identifiers:</p>
            <ul>
            <li><em>real user id</em> (or <em>group id</em>): the
            identifier of the actual user who executed a program.</li>
            <li><em>effective user id</em> (or <em>group id</em>): the
            idenifier for the capabilities or permissions settings of an
            executing program.</li>
            </ul>
            <p>The system calls <code>getuid</code> and
            <code>getgid</code> return the <em>real</em> user and group
            identifiers, but we can also retrieve the <em>effective</em>
            user and group identifiers with</p>
            <ul>
            <li><code>uid_t geteuid(void)</code> - return the effective
            user identifier for the calling process.</li>
            <li><code>gid_t getegid(void)</code> - return the effective
            group identifer for the calling process.</li>
            </ul>
            <p>We now have enough to test <em>set-x-bit</em> programs
            using a the following program that prints both the real and
            effective user/group identities.</p>
            <div class="sourceCode" id="cb334"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb334-3"><a href="#cb334-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb334-4"><a href="#cb334-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-5"><a href="#cb334-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb334-6"><a href="#cb334-6" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb334-7"><a href="#cb334-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb334-8"><a href="#cb334-8" aria-hidden="true" tabindex="-1"></a>    uid_t uid<span class="op">,</span>euid<span class="op">;</span></span>
<span id="cb334-9"><a href="#cb334-9" aria-hidden="true" tabindex="-1"></a>    gid_t gid<span class="op">,</span>egid<span class="op">;</span></span>
<span id="cb334-10"><a href="#cb334-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-11"><a href="#cb334-11" aria-hidden="true" tabindex="-1"></a>    uid <span class="op">=</span> getuid<span class="op">();</span></span>
<span id="cb334-12"><a href="#cb334-12" aria-hidden="true" tabindex="-1"></a>    gid <span class="op">=</span> getgid<span class="op">();</span></span>
<span id="cb334-13"><a href="#cb334-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot; uid=</span><span class="sc">%d</span><span class="st">  gid=</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span>  uid<span class="op">,</span>  gid<span class="op">);</span></span>
<span id="cb334-14"><a href="#cb334-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-15"><a href="#cb334-15" aria-hidden="true" tabindex="-1"></a>    euid <span class="op">=</span> geteuid<span class="op">();</span></span>
<span id="cb334-16"><a href="#cb334-16" aria-hidden="true" tabindex="-1"></a>    egid <span class="op">=</span> getegid<span class="op">();</span></span>
<span id="cb334-17"><a href="#cb334-17" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;euid=</span><span class="sc">%d</span><span class="st"> egid=</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> euid<span class="op">,</span> egid<span class="op">);</span></span>
<span id="cb334-18"><a href="#cb334-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-19"><a href="#cb334-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb334-20"><a href="#cb334-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>As the owner of the file, after compilation, the
            permissions can be set to add set-user-id:</p>
            <pre><code>$ gcc 11/get_uidgid.c -o get_uidgid
$ chmod 6755 get_uidgid
$ ls -l get_uidgid
-rwsr-sr-x   1 gparmer        gparmer     16880 2022-03-29 08:30 get_uidgid</code></pre>
            <p>Notice the <code>s</code> values to denote the
            <code>set-*-bits</code>.</p>
            <p>Lets test this set uid stuff!</p>
            <pre><code>$ cp get_uidgid /tmp/
$ chmod 4755 /tmp/get_uidgid</code></pre>
            <p>Now you should all have access to the file, with it being
            set as set-uid.</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li><p>Compile and run the <code>get_uidgid</code> program.
            What would you expect to happen? What do you observe? Recall
            that you can use <code>id</code> to print out both of your
            ids and groups.</p></li>
            <li><p>Run the <code>get_uidgid</code> program I placed in
            <code>/tmp/</code>. What is the expected output? What do you
            observe?</p></li>
            <li><p>What happens if we enable a program to create files
            while using the <code>set-*-id</code> bits? Lets use the
            following program that will create a file named after each
            command line arguments.</p>
            <div class="sourceCode" id="cb337"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb337-3"><a href="#cb337-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb337-4"><a href="#cb337-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb337-5"><a href="#cb337-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb337-6"><a href="#cb337-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb337-7"><a href="#cb337-7" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span> argv<span class="op">[])</span></span>
<span id="cb337-8"><a href="#cb337-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb337-9"><a href="#cb337-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">,</span> fd<span class="op">;</span></span>
<span id="cb337-10"><a href="#cb337-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb337-11"><a href="#cb337-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> argc<span class="op">;</span> i<span class="op">++){</span></span>
<span id="cb337-12"><a href="#cb337-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* create an empty file */</span></span>
<span id="cb337-13"><a href="#cb337-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">((</span>fd <span class="op">=</span> open<span class="op">(</span>argv<span class="op">[</span>i<span class="op">],</span>O_CREAT<span class="op">,</span><span class="bn">0666</span><span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">){</span></span>
<span id="cb337-14"><a href="#cb337-14" aria-hidden="true" tabindex="-1"></a>            close<span class="op">(</span>fd<span class="op">);</span></span>
<span id="cb337-15"><a href="#cb337-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb337-16"><a href="#cb337-16" aria-hidden="true" tabindex="-1"></a>            perror<span class="op">(</span><span class="st">&quot;open&quot;</span><span class="op">);</span></span>
<span id="cb337-17"><a href="#cb337-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb337-18"><a href="#cb337-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb337-19"><a href="#cb337-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb337-20"><a href="#cb337-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb337-21"><a href="#cb337-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>Run the following program in your home directory (can
            also be found in <code>create_files.c</code>), passing as
            arguments the names of files you want to create:
            <code>./create_files blah</code> will create a file
            <code>blah</code>. Check out the owner of the files
            (<code>ls -l blah</code>). I’ve also set up the file as
            <strong>setuid</strong> on the server in
            <code>/tmp/create_files</code>. Try running the
            following</p>
            <pre><code>$ /tmp/create_files /tmp/blah
$ ls -l /tmp/blah
...
$ /tmp/create_files ~/blah
...</code></pre>
            <p>What do you think the output for the first
            <code>...</code> will be – who is the owner of the file? The
            second? What are the outputs, and why?</p></li>
            </ul>
            <h4 data-number="13.3.0.2"
            id="programmatically-downgradingupgrading-capabilities"><span
            class="header-section-number">13.3.0.2</span>
            Programmatically Downgrading/Upgrading Capabilities</h4>
            <p>The set-bits automatically start a program with the
            effective user or group id set; however, there are times
            when we might want to <em>downgrade privilege</em> or change
            permission dynamically. There are two system calls to change
            user/group settings of an executing process:</p>
            <ul>
            <li><code>setuid(uid_t uid)</code> - change the effective
            user id of a process to uid</li>
            <li><code>setgid(gid_t gid)</code> - change the effective
            group id of a proces to gid</li>
            </ul>
            <p>The requirements of <code>setuid()</code> (for all users
            other than root) is that the effective user id can be
            changed to the <em>real user id of the program</em> or to an
            <em>effective user id as described in the set-bits</em>. The
            root user, however, can <em>downgrade to any user id</em>
            and upgrade back to the root user. For <code>setgid()</code>
            the user can chance the group id to any group the user
            belongs to or as allowed by the set-group-id bit.</p>
            <p>Now we can look at a program that downgrades and upgrades
            a program dynamically:</p>
            <div class="sourceCode" id="cb339"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb339-3"><a href="#cb339-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb339-4"><a href="#cb339-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-5"><a href="#cb339-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb339-6"><a href="#cb339-6" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb339-7"><a href="#cb339-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb339-8"><a href="#cb339-8" aria-hidden="true" tabindex="-1"></a>    uid_t uid<span class="op">,</span> euid<span class="op">;</span></span>
<span id="cb339-9"><a href="#cb339-9" aria-hidden="true" tabindex="-1"></a>    gid_t gid<span class="op">,</span> egid<span class="op">;</span></span>
<span id="cb339-10"><a href="#cb339-10" aria-hidden="true" tabindex="-1"></a>    uid_t saved_euid<span class="op">;</span></span>
<span id="cb339-11"><a href="#cb339-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-12"><a href="#cb339-12" aria-hidden="true" tabindex="-1"></a>    uid <span class="op">=</span> getuid<span class="op">();</span></span>
<span id="cb339-13"><a href="#cb339-13" aria-hidden="true" tabindex="-1"></a>    gid <span class="op">=</span> getgid<span class="op">();</span></span>
<span id="cb339-14"><a href="#cb339-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot; uid=</span><span class="sc">%d</span><span class="st">  gid=</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span>  uid<span class="op">,</span>  gid<span class="op">);</span></span>
<span id="cb339-15"><a href="#cb339-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-16"><a href="#cb339-16" aria-hidden="true" tabindex="-1"></a>    euid <span class="op">=</span> geteuid<span class="op">();</span></span>
<span id="cb339-17"><a href="#cb339-17" aria-hidden="true" tabindex="-1"></a>    egid <span class="op">=</span> getegid<span class="op">();</span></span>
<span id="cb339-18"><a href="#cb339-18" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;euid=</span><span class="sc">%d</span><span class="st"> egid=</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> euid<span class="op">,</span> egid<span class="op">);</span></span>
<span id="cb339-19"><a href="#cb339-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-20"><a href="#cb339-20" aria-hidden="true" tabindex="-1"></a>    saved_euid<span class="op">=</span>euid<span class="op">;</span></span>
<span id="cb339-21"><a href="#cb339-21" aria-hidden="true" tabindex="-1"></a>    setuid<span class="op">(</span>uid<span class="op">);</span></span>
<span id="cb339-22"><a href="#cb339-22" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;---- setuid(</span><span class="sc">%d</span><span class="st">) ----</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>uid<span class="op">);</span></span>
<span id="cb339-23"><a href="#cb339-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-24"><a href="#cb339-24" aria-hidden="true" tabindex="-1"></a>    uid <span class="op">=</span> getuid<span class="op">();</span></span>
<span id="cb339-25"><a href="#cb339-25" aria-hidden="true" tabindex="-1"></a>    gid <span class="op">=</span> getgid<span class="op">();</span></span>
<span id="cb339-26"><a href="#cb339-26" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot; uid=</span><span class="sc">%d</span><span class="st">  gid=</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span>  uid<span class="op">,</span>  gid<span class="op">);</span></span>
<span id="cb339-27"><a href="#cb339-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-28"><a href="#cb339-28" aria-hidden="true" tabindex="-1"></a>    euid <span class="op">=</span> geteuid<span class="op">();</span></span>
<span id="cb339-29"><a href="#cb339-29" aria-hidden="true" tabindex="-1"></a>    egid <span class="op">=</span> getegid<span class="op">();</span></span>
<span id="cb339-30"><a href="#cb339-30" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;euid=</span><span class="sc">%d</span><span class="st"> egid=</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> euid<span class="op">,</span> egid<span class="op">);</span></span>
<span id="cb339-31"><a href="#cb339-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-32"><a href="#cb339-32" aria-hidden="true" tabindex="-1"></a>    setuid<span class="op">(</span>saved_euid<span class="op">);</span></span>
<span id="cb339-33"><a href="#cb339-33" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;---- setuid(</span><span class="sc">%d</span><span class="st">) ----</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>saved_euid<span class="op">);</span></span>
<span id="cb339-34"><a href="#cb339-34" aria-hidden="true" tabindex="-1"></a>    uid <span class="op">=</span> getuid<span class="op">();</span></span>
<span id="cb339-35"><a href="#cb339-35" aria-hidden="true" tabindex="-1"></a>    gid <span class="op">=</span> getgid<span class="op">();</span></span>
<span id="cb339-36"><a href="#cb339-36" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot; uid=</span><span class="sc">%d</span><span class="st">  gid=</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span>  uid<span class="op">,</span>  gid<span class="op">);</span></span>
<span id="cb339-37"><a href="#cb339-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-38"><a href="#cb339-38" aria-hidden="true" tabindex="-1"></a>    euid <span class="op">=</span> geteuid<span class="op">();</span></span>
<span id="cb339-39"><a href="#cb339-39" aria-hidden="true" tabindex="-1"></a>    egid <span class="op">=</span> getegid<span class="op">();</span></span>
<span id="cb339-40"><a href="#cb339-40" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;euid=</span><span class="sc">%d</span><span class="st"> egid=</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> euid<span class="op">,</span> egid<span class="op">);</span></span>
<span id="cb339-41"><a href="#cb339-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-42"><a href="#cb339-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb339-43"><a href="#cb339-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p><strong>Question:</strong></p>
            <ul>
            <li>What do think will happen if you have a peer run it on
            the server after you set the <code>set-uid</code> bit?</li>
            </ul>
            <h2 data-number="13.4"
            id="applications-of-identify-and-permission-management"><span
            class="header-section-number">13.4</span> Applications of
            Identify and Permission Management</h2>
            <h3 data-number="13.4.1"
            id="logging-events-selectively-increasing-access-rights"><span
            class="header-section-number">13.4.1</span> Logging Events:
            Selectively Increasing Access Rights</h3>
            <p>We previously covered the general desire to have a log in
            the system of the events for different activities. For
            example, logging when each user logs in, when clients make
            web requests of an http server, etc…</p>
            <p>We might support two high-level operations:</p>
            <ol type="1">
            <li>adding a logging event, and</li>
            <li>reading the log.</li>
            </ol>
            <p>If we don’t care to censor the log, we can support the
            second very easily by, for example, making the log file’s
            group the <code>log</code> group, and giving read
            (<code>4</code>) permissions to the log for anyone in that
            group. Now any user in the <code>log</code>group can read
            the log.</p>
            <p>However, to support adding logging events to the log, we
            might use the set-uid-bit to ensure that a <code>log</code>
            program runs with the effictive user-id of the logger user.
            Thus, it will be able to append to the log in a
            straightforward manner.</p>
            <h3 data-number="13.4.2"
            id="logging-in-carefully-decreasing-access-rights"><span
            class="header-section-number">13.4.2</span> Logging In:
            Carefully Decreasing Access Rights</h3>
            <p>One example of how you might want to use the identity
            management APIs is when logging in. The process of logging
            in requires that the <code>login</code> program access
            sensitive files that include (encrypted) user passwords
            (<code>/etc/shadow</code>). Understandably, users don’t
            generally have access to these files. Thus, the act of
            logging in requires programs running as <code>root</code> to
            read in username and password. Only if they match the proper
            values for a user, will the login logic then change uid/gid
            to the corresponding user and group id, and execute a shell
            for the user (as the user). See the figure for more
            details.</p>
            <figure>
            <img src="figures/login.svg"
            alt="The login procedure on a system. On a system that uses a nameserver like systemd, it will ensure that terminals are available (either attached to the keyboard/monitor, or remote) by executing the getty (link), or “get tty” program (or ssh for remote, or gdm for graphical) which makes available a terminal for a user to interact with. getty executes the login (link) program that reads the username and password from the user. If it is unable to find a match, it exits, letting systemd start again. If the username and password match what is in the /etc/passwd and /etc/shadow (password) files, it will change the user and group ids to those for the user in the /etc/passwd file, change to the home directory specified in that same file, and exec the corresponding shell." />
            <figcaption aria-hidden="true">The login procedure on a
            system. On a system that uses a nameserver like
            <code>systemd</code>, it will ensure that terminals are
            available (either attached to the keyboard/monitor, or
            remote) by executing the <a
            href="https://github.com/mirror/busybox/blob/master/loginutils/getty.c"><code>getty</code>
            (link)</a>, or “get tty” program (or <code>ssh</code> for
            remote, or <code>gdm</code> for graphical) which makes
            available a terminal for a user to interact with.
            <code>getty</code> executes the <a
            href="https://github.com/mirror/busybox/blob/master/loginutils/login.c"><code>login</code>
            (link)</a> program that reads the username and password from
            the user. If it is unable to find a match, it exits, letting
            <code>systemd</code> start again. If the username and
            password match what is in the <code>/etc/passwd</code> and
            <code>/etc/shadow</code> (password) files, it will change
            the user and group ids to those for the user in the
            <code>/etc/passwd</code> file, change to the home directory
            specified in that same file, and <code>exec</code> the
            corresponding shell.</figcaption>
            </figure>
            <h3 data-number="13.4.3"
            id="sudo-and-su-increasing-access-rights"><span
            class="header-section-number">13.4.3</span>
            <code>sudo</code> and <code>su</code>: Increasing Access
            Rights</h3>
            <p>There are many times in systems that we want to
            <em>increase</em> the privileges of a human. For example,
            for security, it is often <em>not possible</em> to login as
            <em>root</em>. But it is certainly true that sometimes
            humans need to be able to run commands as root. For example,
            updating some software, installing new software, creating
            new users, and many other operations, all require
            <em>root</em>.</p>
            <p>To control who is able to execute commands as
            <em>root</em>, the <code>sudo</code> and <code>su</code>
            programs enable restricted access to root privileges.
            Specifically, <code>sudo</code> and <code>su</code> will
            execute a command as a <em>specified user</em> or <em>switch
            to a specified user</em>. By default, these commands execute
            as the root user, and you need to know the root password or
            have sudo access to use them.</p>
            <p>We can see this as the case if I were to run the
            <code>get_euidegid</code> program using <code>sudo</code>.
            First notice that it is no longer set-group or set-user:</p>
            <pre><code>$ sudo ./get_euidegid
[sudo] password for gparmer:
 uid=0  gid=0
euid=0 egid=0</code></pre>
            <p>After sudo authenticated me, the program’s effective and
            real user identification becomes 0 which is the uid/gid for
            the root user.</p>
            <h4 data-number="13.4.3.1" id="sudoers"><span
            class="header-section-number">13.4.3.1</span> sudoers</h4>
            <p>Who has permission to run <code>sudo</code> commands?
            This is important because on many modern unix systems, like
            ubuntu, there is no default root password.</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li>Why don’t we just have a <code>root</code> account with
            a password instead of having <code>sudo</code> and
            <code>su</code>?</li>
            </ul>
            <p>Instead certain users are deemed to be sudoers or
            privileged users. These are set in a special configuraiton
            file called the <code>/etc/sudoers</code>.</p>
            <pre><code>aviv@saddleback: lec-23-demo $ cat /etc/sudoers
cat: /etc/sudoers: Permission denied
aviv@saddleback: lec-23-demo $ sudo cat /etc/sudoers
#
# This file MUST be edited with the &#39;visudo&#39; command as root.
#
# Please consider adding local content in /etc/sudoers.d/ instead of
# directly modifying this file.
#
# See the man page for details on how to write a sudoers file.
#
Defaults    env_reset
Defaults    mail_badpass
Defaults    secure_path=&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;

# Host alias specification

# User alias specification

# Cmnd alias specification

# User privilege specification
root    ALL=(ALL:ALL) ALL

# Members of the admin group may gain root privileges
%admin ALL=(ALL) ALL

# Allow members of group sudo to execute any command
%sudo   ALL=(ALL:ALL) ALL

# See sudoers(5) for more information on &quot;#include&quot; directives:

#includedir /etc/sudoers.d</code></pre>
            <p>Notice that only root has access to read this file, and
            since I am a <code>sudoer</code> on the system I can get
            access to it. If you look carefully, you can perform a basic
            parse of the settings. The root user has full
            <code>sudo</code> permissions, and other sudoer’s are
            determine based on group membership. Users in the
            <code>sudo</code> or <code>admin</code> group may run
            commands as <code>root</code>, and I am a member of the
            <code>sudo</code> group:</p>
            <pre><code>$ id
uid=1000(gparmer) gid=1000(gparmer) groups=1000(gparmer),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),120(lpadmin),131(lxd),132(sambashare)</code></pre>
            <p><strong>Question:</strong></p>
            <ul>
            <li>How do you think that <code>sudo</code> is implemented?
            What mechanisms from this week’s lecture is it using to
            provide the requested functionality?</li>
            </ul>
            <h4 data-number="13.4.3.2" id="assignment-submission"><span
            class="header-section-number">13.4.3.2</span> Assignment
            Submission</h4>
            <p>What if we implemented an assignment submission program
            that copied a student’s directory into the instructor’s home
            directory? For example, if you wanted to submit the
            directory of code at <code>my_hw/</code> for homework
            <code>HW1</code>,</p>
            <pre><code>$ ./3410_submit HW1 my_hw</code></pre>
            <p>This program, run by you, has your user and group
            permissions, but it is able to take your submission and
            copy/save those submissions to my home directory, with my
            permissions at a location where you do not have access to
            write. How is that possible?</p>
            <p>Naively, we’d have a problem:</p>
            <ul>
            <li>The submission program is written and provided by the
            instructor.</li>
            <li>The students would be executing the program, thus it
            would execute with their identity.</li>
            <li>We don’t want the submitted data to be visible to
            <em>any</em> students.</li>
            <li><em>However</em>, if the students run the submission
            program, it will run as their uid/gid, and 1. it won’t have
            access to the instructor’s home directory, and 2. any files
            it creates (during the copy) will belong to the user.</li>
            </ul>
            <p>Yikes.</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li>How could we go about implementing a homework submission
            program?</li>
            </ul>
            <h1 data-number="14"
            id="security-attacks-on-system-programs"><span
            class="header-section-number">14</span> Security: Attacks on
            System Programs</h1>
            <blockquote>
            <p><strong>This material adapted from Prof. Aviv’s <a
            href="https://classes.adamaviv.com/ic221/s18/units/07/unit.html#org67f4730">material</a>.</strong></p>
            </blockquote>
            <p>It is an unfortunate truth of security that all programs
            have faults because humans have faults — human’s write
            programs. As such, we will take some time to understand the
            kinds of mistakes you, me, and all programmers may make that
            can lead to security violations.</p>
            <p>This is a broad topic area, and we only have a small
            amount of time to talk about it. We will focus on three
            classes of attack that are very common for the kinds of
            programs we’ve been writing in this course.</p>
            <ul>
            <li><em>Path Lookup Attacks</em>: Where the attacker
            leverages path lookup to compromise an executable or
            library</li>
            <li><em>Injection Attacks</em>: Where an attacker can inject
            code, usually in the form of bash, into a program that will
            get run.</li>
            <li><em>Overflow Attacks</em>: Where the attack overflows a
            buffer to alter program state.</li>
            </ul>
            <p>In isolation, each of these attacks can just make a
            program misbehave; however, things get interesting when an
            attack can lead to <em>privilege escalation</em>. Privilege
            escalation enables a user to maliciously access resources
            (e.g. files) normally unavailable to the user, by exploiting
            a program with heightened privilege (e.g. due to
            <code>setuid</code> bits, or explicit id upgrades) to
            perform arbitrary tasks. The ultimate goal of an attacker is
            to achieve privilege escalation to <code>root</code>, which
            essentially gives them access to all system resources.</p>
            <blockquote>
            <p>You might think that the kernel has more privilege than
            the <code>root</code> user. However, the <code>root</code>
            user is given access to the <code>/dev/mem</code>
            pseudo-device that is “all of memory” including all of the
            kernel’s memory, and <code>root</code> has the ability to
            insert dynamic libraries (called “kernel modules”) into the
            kernel to dynamically update kernel code! Being
            <code>root</code> truly is a super-power!</p>
            </blockquote>
            <p>Each of these topics are quite nuanced, and the hope is
            to give you a general overview so you can explore the topic
            more on your own.</p>
            <h2 data-number="14.1" id="path-attacks"><span
            class="header-section-number">14.1</span> Path Attacks</h2>
            <p>We’ve been using path lookup throughout the class.
            Perhaps the best example is when we are in the shell and
            type a command:</p>
            <pre><code>$ cat Makefile
BINS=$(patsubst %.c,%,$(wildcard *.c))

all: $(BINS)

%: %.c
        gcc -o $@ $&lt;

clean:
        rm -rf $(BINS)</code></pre>
            <p>The command <code>cat</code> is run, but the program that
            is actually cat’s the file exists in a different place in
            the file system. We can find that location using the
            <code>which</code> command:</p>
            <pre><code>$ which cat
/bin/cat</code></pre>
            <p>So when we type <code>cat</code>, the shell look for the
            <code>cat</code> binary, finds it in <code>/bin/cat</code>,
            and executes that. Recall when we discussed environment
            variables that binaries are found by looking in all of the
            directories in the <code>PATH</code> enviroment
            variable.</p>
            <pre><code>$ echo $PATH
/home/gparmer/.local/bin/:/home/gparmer/.local/bin:/home/gparmer/.cargo/bin:/home/gparmer/.local/bin/:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/home/gparmer/local/bin:/usr/racket/bin/:/home/gparmer/local/bin:/usr/racket/bin/</code></pre>
            <p>Lets look at that by converting the <code>:</code>, which
            separate the directories, with newlines:</p>
            <pre><code>$ echo $PATH | tr : &quot;\n&quot;
/home/gparmer/.local/bin/
/home/gparmer/.local/bin
/home/gparmer/.cargo/bin
/home/gparmer/.local/bin/
/usr/local/sbin
/usr/local/bin
/usr/sbin
/usr/bin
/sbin
/bin
/usr/games
/usr/local/games
/snap/bin
/home/gparmer/local/bin
/usr/racket/bin/
/home/gparmer/local/bin
/usr/racket/bin/</code></pre>
            <p>Each of the directories listed is searched, in order,
            until the command’s program is found.</p>
            <p>Environment variables are <em>global variables</em> set
            across programs that provide information about the current
            environment. The <code>PATH</code> environment variable is a
            perfect example of this, and the customizability of the
            environment variables. If you look at the directories along
            my path, I have a bin directory Win my home directory so I
            can load custom binaries. The fact that I can customize the
            <code>PATH</code> in this way can lead to some interesting
            security situations.</p>
            <h3 data-number="14.1.1" id="system"><span
            class="header-section-number">14.1.1</span>
            <code>system()</code></h3>
            <p>To help this conversation, we need to introduce two
            library functions that work much like <code>execvp()</code>
            with a <code>fork()</code>, like we’ve done all along, but
            more compact. Here’s an abridged description in the manual
            page:</p>
            <pre><code>NAME
       system - execute a shell command

SYNOPSIS
       #include &lt;stdlib.h&gt;

       int system(const char *command);

DESCRIPTION

       system() executes a command specified in command by calling
       /bin/sh -c command, and returns after the command has been
       completed.  During execution of the command, SIGCHLD will be
       blocked, and SIGINT and SIGQUIT will be ignored.</code></pre>
            <p>That is, the <code>system()</code> function will run an
            arbitrary shell command, inheriting all of the file
            descriptors of the caller of <code>system</code>. Let’s look
            at a very simple example, a “hello world” that uses two
            commands.</p>
            <div class="sourceCode" id="cb349"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb349-5"><a href="#cb349-5" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb349-6"><a href="#cb349-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb349-7"><a href="#cb349-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb349-8"><a href="#cb349-8" aria-hidden="true" tabindex="-1"></a><span class="co">     * Execute `cat`. It inherits the stdin/stdout/stderr</span></span>
<span id="cb349-9"><a href="#cb349-9" aria-hidden="true" tabindex="-1"></a><span class="co">     * of the current process.</span></span>
<span id="cb349-10"><a href="#cb349-10" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb349-11"><a href="#cb349-11" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;cat&quot;</span><span class="op">);</span></span>
<span id="cb349-12"><a href="#cb349-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-13"><a href="#cb349-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb349-14"><a href="#cb349-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <pre><code>$ echo &quot;Hello World&quot; | ./system_cat
Hello World</code></pre>
            <p>The <code>system_cat</code> program runs cat with
            <code>system()</code>, thus it will print whatever it reads
            from stdin to the screen (recall: <code>cat</code>
            essentially echos stdin to stdout). It turns out, that this
            program, despite its simplicity, actually has a relatively
            bad security flaw. Let’s quickly consider what might happen
            if we were to <em>change the <code>PATH</code> value</em> to
            include our local directory:</p>
            <pre><code>$ export PATH=.:$PATH
$ echo $PATH
./:/home/gparmer/.local/bin/:/home/gparmer/.local/bin:/home/gparmer/.cargo/bin:/home/gparmer/.local/bin/:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/home/gparmer/local/bin:/usr/racket/bin/:/home/gparmer/local/bin:/usr/racket/bin/
$ echo $PATH | tr : &quot;\n&quot; | head -n 2
./
/home/gparmer/.local/bin</code></pre>
            <p>The <code>export</code> builtin command in our shell
            updates an environment variable. We see that at the start of
            the <code>PATH</code> variable is now the current directory!
            <code>system</code> (and <code>execvp</code>) will look for
            the program in the <em>current directory</em> before the
            others. So now the local directory is on the path, thus if I
            were to create a program named cat, then that cat would run
            instead of the one you would expect. For example, here is
            such a program (in <code>fake_cat.c</code>):</p>
            <div class="sourceCode" id="cb352"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb352-2"><a href="#cb352-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-3"><a href="#cb352-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb352-4"><a href="#cb352-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb352-5"><a href="#cb352-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb352-6"><a href="#cb352-6" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;echo &#39;Goodbye World&#39;&quot;</span><span class="op">);</span></span>
<span id="cb352-7"><a href="#cb352-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-8"><a href="#cb352-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb352-9"><a href="#cb352-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>This is our <em>imposter</em> program! In this case it is
            innocuous, but you can imagine it being more nefarious. To
            do this, we’ll make a <em>new</em> <code>cat</code> command
            in the current directory.</p>
            <pre><code>$ echo &quot;Hello World&quot; | ./system_cat
$ cp fake_cat cat
$ echo &quot;Hello World&quot; | ./system_cat
Goodbye World</code></pre>
            <p>This is not just a problem with the <code>system()</code>
            command, but also <code>execvp()</code>, which will also
            look up commands along the path.</p>
            <div class="sourceCode" id="cb354"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb354-2"><a href="#cb354-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-3"><a href="#cb354-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb354-4"><a href="#cb354-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb354-5"><a href="#cb354-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb354-6"><a href="#cb354-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> args<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span> <span class="st">&quot;cat&quot;</span><span class="op">,</span> NULL <span class="op">};</span></span>
<span id="cb354-7"><a href="#cb354-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-8"><a href="#cb354-8" aria-hidden="true" tabindex="-1"></a>    execvp<span class="op">(</span>args<span class="op">[</span><span class="dv">0</span><span class="op">],</span> args<span class="op">);</span></span>
<span id="cb354-9"><a href="#cb354-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-10"><a href="#cb354-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb354-11"><a href="#cb354-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <pre><code>$ rm ./cat
$ echo &quot;Hello World&quot; | ./execvp_cat
Hello World
$ cp fake_cat cat
$ echo &quot;Hello World&quot; | ./execvp_cat
Goodbye World</code></pre>
            <p><strong>Question:</strong></p>
            <ul>
            <li>Explain what has happened here to your teammates.</li>
            <li>How do you think we can prevent the intended execution
            of our program from being taken over so easily?</li>
            </ul>
            <h4 data-number="14.1.1.1" id="fixing-path-attacks"><span
            class="header-section-number">14.1.1.1</span> Fixing Path
            Attacks</h4>
            <p>How do we fix this? There are two solutions:</p>
            <ol type="1">
            <li>Always use full paths. Don’t specify a command to run by
            its name, instead describe exactly which program is to be
            executed.</li>
            <li>Fix the path before executing using
            <code>setenv()</code></li>
            </ol>
            <p>You can actually control the current <code>PATH</code>
            setting during execution. To do this you can set the
            enviorment variables using <code>setenv()</code> and
            <code>getenv()</code></p>
            <div class="sourceCode" id="cb356"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb356-2"><a href="#cb356-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb356-3"><a href="#cb356-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb356-4"><a href="#cb356-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb356-5"><a href="#cb356-5" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb356-6"><a href="#cb356-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb356-7"><a href="#cb356-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* ensure the enviorment only has the path we want and overwrite */</span></span>
<span id="cb356-8"><a href="#cb356-8" aria-hidden="true" tabindex="-1"></a>    setenv<span class="op">(</span><span class="st">&quot;PATH&quot;</span><span class="op">,</span><span class="st">&quot;/bin&quot;</span><span class="op">,</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb356-9"><a href="#cb356-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb356-10"><a href="#cb356-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> args<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span> <span class="st">&quot;cat&quot;</span><span class="op">,</span> NULL <span class="op">};</span></span>
<span id="cb356-11"><a href="#cb356-11" aria-hidden="true" tabindex="-1"></a>    execvp<span class="op">(</span>args<span class="op">[</span><span class="dv">0</span><span class="op">],</span> args<span class="op">);</span></span>
<span id="cb356-12"><a href="#cb356-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb356-13"><a href="#cb356-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb356-14"><a href="#cb356-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <pre><code>$ rm ./cat
$ echo &quot;Hello World&quot; | ./setenv_cat
Hello World
$ cp fake_cat cat
$ echo &quot;Hello World&quot; | ./setenv_cat
Hello World</code></pre>
            <p>Success! Because we used a controlled and known
            <code>PATH</code>, we can avoid the attacker-chosen
            <code>cat</code> from executing.</p>
            <h3 data-number="14.1.2"
            id="path-attacks-with-set-user-id-bits-for-privilege-escalation"><span
            class="header-section-number">14.1.2</span> Path Attacks
            with Set-user-id Bits for Privilege Escalation</h3>
            <p>The previous examples were <em>bad</em> as we made the
            program execute different than the programmer intended. But
            we didn’t necessarily see the risk of <em>privilege
            escalation</em> yet. So let’s see what happens when we
            introduce <code>set-uid</code> to the mix. This time, I’ve
            set the program system_cat to be set-user-id in a place that
            others can run it:</p>
            <pre><code>$ chmod 4775 system_cat
$ ls -l system_cat
-rwsrwxr-x 1 gparmer gparmer 16704 Apr  4 13:01 system_cat</code></pre>
            <p>Now lets imagine there is another user on the system
            <code>hacker-mchackyface</code>, and as that user we update
            the <code>PATH</code>…</p>
            <pre><code>$ export PATH=.:$PATH
</code></pre>
            <p>…and do something this time that is not so innocuous.
            Lets run a shell after <em>changing our real user id to that
            of <code>gparmer</code></em>. Yikes.</p>
            <div class="sourceCode" id="cb360"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb360-2"><a href="#cb360-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb360-3"><a href="#cb360-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb360-4"><a href="#cb360-4" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb360-5"><a href="#cb360-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb360-6"><a href="#cb360-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> args<span class="op">[]={</span><span class="st">&quot;/bin/sh&quot;</span><span class="op">,</span>NULL<span class="op">};</span></span>
<span id="cb360-7"><a href="#cb360-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb360-8"><a href="#cb360-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* set our real uid to our effective uid */</span></span>
<span id="cb360-9"><a href="#cb360-9" aria-hidden="true" tabindex="-1"></a>    setreuid<span class="op">(</span>geteuid<span class="op">(),</span>geteuid<span class="op">());</span></span>
<span id="cb360-10"><a href="#cb360-10" aria-hidden="true" tabindex="-1"></a>    execvp<span class="op">(</span>args<span class="op">[</span><span class="dv">0</span><span class="op">],</span>args<span class="op">);</span></span>
<span id="cb360-11"><a href="#cb360-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb360-12"><a href="#cb360-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb360-13"><a href="#cb360-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>This time when we run the system_cat program, it will run
            bash as the set-user-id user. Now we’ve just escalated
            privilege.</p>
            <pre><code>$ whoami
hacker-mchackyface
$ ./system_cat
$ whoami  &lt;---- new shell!
gparmer
$</code></pre>
            <p>Uh oh. Now user <code>hacker-mchackyface</code> has
            escalated their privilege to that of user
            <code>gparmer</code>!</p>
            <p><strong>Path Attacks Summary:</strong> Multiple UNIX APIs
            rely on the <code>PATH</code> environment variable to help
            us find a program we want to execute. The attacker can
            modify <code>PATH</code> by adding their attack path, and
            ensure that a program with the same name as the target is in
            that path. This will lead to the program executing the
            attacker’s code! Should this attack exist in a program that
            is <code>set-uid</code>, the attacker can now execute the
            program at the higher privilege.</p>
            <h3 data-number="14.1.3" id="ld_preload-attacks"><span
            class="header-section-number">14.1.3</span>
            <code>LD_PRELOAD</code> Attacks?</h3>
            <p>We might be clever, and think that we can use
            <code>LD_PRELOAD</code> to take over some of the library
            APIs with our own code! Fortunately, this doesn’t work. The
            dynamic linker (<code>ld.so</code>) will only use the
            <code>LD_PRELOAD</code> environment variable if the real
            user id is the same as the effective user id! A simple
            solution to a threatening problem.</p>
            <h2 data-number="14.2" id="injection-attacks"><span
            class="header-section-number">14.2</span> Injection
            Attacks</h2>
            <p>Now, lets consider a situation where you use
            <code>system()</code> in a safer way. You call all programs
            with absolute path, or update and control <code>PATH</code>
            before using it. Unfortunately, <em>even that is not
            enough</em>. You must also consider <em>injection
            attacks</em> which is when the attacker can inject code that
            will run. In our case, the injected code will be bash.</p>
            <p>Consider this program which prompts the user for a file
            to cat out.</p>
            <div class="sourceCode" id="cb362"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb362-4"><a href="#cb362-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-5"><a href="#cb362-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-6"><a href="#cb362-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb362-7"><a href="#cb362-7" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb362-8"><a href="#cb362-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb362-9"><a href="#cb362-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> cmd<span class="op">[</span><span class="dv">1024</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;/bin/cat ./&quot;</span><span class="op">;</span> <span class="co">/* will append to this string */</span></span>
<span id="cb362-10"><a href="#cb362-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> input<span class="op">[</span><span class="dv">40</span><span class="op">];</span></span>
<span id="cb362-11"><a href="#cb362-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-12"><a href="#cb362-12" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;What input do you want to &#39;cat&#39; (choose from below)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb362-13"><a href="#cb362-13" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;/bin/ls&quot;</span><span class="op">);</span> <span class="co">/* show available files */</span></span>
<span id="cb362-14"><a href="#cb362-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-15"><a href="#cb362-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;input &gt; &quot;</span><span class="op">);</span></span>
<span id="cb362-16"><a href="#cb362-16" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span> <span class="co">/* force stdout to print */</span></span>
<span id="cb362-17"><a href="#cb362-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-18"><a href="#cb362-18" aria-hidden="true" tabindex="-1"></a>    scanf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span>input<span class="op">);</span><span class="co">/* read input */</span></span>
<span id="cb362-19"><a href="#cb362-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-20"><a href="#cb362-20" aria-hidden="true" tabindex="-1"></a>    strcat<span class="op">(</span>cmd<span class="op">,</span>input<span class="op">);</span> <span class="co">/* create the command */</span></span>
<span id="cb362-21"><a href="#cb362-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-22"><a href="#cb362-22" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Executing: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> cmd<span class="op">);</span></span>
<span id="cb362-23"><a href="#cb362-23" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span> <span class="co">/* force stdout to print */</span></span>
<span id="cb362-24"><a href="#cb362-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-25"><a href="#cb362-25" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span>cmd<span class="op">);</span></span>
<span id="cb362-26"><a href="#cb362-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-27"><a href="#cb362-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb362-28"><a href="#cb362-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>If we were to run this program, it hopefully does what
            you’d expect:</p>
            <pre><code>$ ./inject_system
What input do you want to &#39;cat&#39; (choose from below)
01_lecture.md  cat  execvp_cat  execvp_cat.c  fake_cat  fake_cat.c  inject_system  inject_system.c  Makefile  setenv_cat  setenv_cat.c  system_cat  system_cat.c
input &gt; Makefile
Executing: /bin/cat ./Makefile
BINS=$(patsubst %.c,%,$(wildcard *.c))

all: $(BINS)

%: %.c
        gcc -o $@ $&lt;

clean:
        rm -rf $(BINS)</code></pre>
            <p>Ok, now consider if we were to provide input that doesn’t
            fit this model. What if we were to provide <em>shell
            commands as input</em> instead of simply the file name?</p>
            <pre><code>$ ./inject_system
What input do you want to &#39;cat&#39; (choose from below)
01_lecture.md  cat  execvp_cat  execvp_cat.c  fake_cat  fake_cat.c  inject_system  inject_system.c  Makefile  setenv_cat  setenv_cat.c  system_cat  system_cat.c
input &gt; ;echo
Executing: /bin/cat ./;echo
/bin/cat: ./: Is a directory

$</code></pre>
            <p>The input we provided was <code>;echo</code> the
            semi-colon closes off a bash command allowing a new one to
            start. Specifically, the programmer thought that the command
            to be executed would <em>only take the shape</em>
            <code>/bin/cat ./&lt;file&gt;</code> for some user-specified
            <code>&lt;file&gt;</code>. Instead, we make the command
            execute <code>/bin/cat ./;echo</code>! Notice that there is
            an extra new line printed, that was the echo printing. This
            is pretty innocuous; can we get this program to run
            something more interesting?</p>
            <p>We still have the <code>cat</code> program we wrote that
            prints “Goodbye World” and the <code>PATH</code> is set up
            to look in the local directory. Setting that up, we get the
            following result:</p>
            <pre><code>$ ./inject_system
What input do you want to &#39;cat&#39; (choose from below)
01_lecture.md  cat  execvp_cat  execvp_cat.c  fake_cat  fake_cat.c  inject_system  inject_system.c  Makefile  setenv_cat  setenv_cat.c  system_cat  system_cat.c
input &gt; ;cat
Executing: /bin/cat ./;cat
/bin/cat: ./: Is a directory
Goodbye World</code></pre>
            <p>At this point, we own this program (<code>pwn</code> in
            the parlance) – we can essentially get it to execute
            whatever we want. If the program were <code>set-uid</code>,
            we could escalate our privilege.</p>
            <p><strong>Injection Attacks Summary:</strong> When the user
            can enter commands that are passed to functions that will
            execute them, we must be exceedingly careful about
            <em>sanitizing</em> the input. For shell commands, this
            often means avoiding <code>;</code> and <code>|</code> in
            inputs. Interestingly, one of the most common attacks on
            webpages is <strong>SQL injection</strong>. When user input
            is used to create SQL commands, an attacker might add
            <code>;</code> followed by additional queries. For example,
            we might append <code>; DROP TABLE USERS</code> to
            destructively harm the database!</p>
            <figure>
            <img src="figures/sql_injection.png"
            alt="SQL injection can be weaponized in many different ways." />
            <figcaption aria-hidden="true">SQL injection can be
            weaponized in many different ways.</figcaption>
            </figure>
            <h2 data-number="14.3" id="overflow-attacks"><span
            class="header-section-number">14.3</span> Overflow
            Attacks</h2>
            <p>Two attacks down, moving onto the third. Let’s now assume
            that the programmer has wised up to the two previous
            attacks. Now we are using full paths to executables and we
            are scrubbing the input to remove any potential bash
            commands prior to execution. The result is the following
            program:</p>
            <div class="sourceCode" id="cb366"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb366-2"><a href="#cb366-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb366-3"><a href="#cb366-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb366-4"><a href="#cb366-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-5"><a href="#cb366-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb366-6"><a href="#cb366-6" aria-hidden="true" tabindex="-1"></a>main<span class="op">(</span><span class="dt">void</span><span class="op">)</span></span>
<span id="cb366-7"><a href="#cb366-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb366-8"><a href="#cb366-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> cmd<span class="op">[</span><span class="dv">1024</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;/bin/cat ./&quot;</span><span class="op">;</span> <span class="co">/* will append to this string */</span></span>
<span id="cb366-9"><a href="#cb366-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> input<span class="op">[</span><span class="dv">40</span><span class="op">];</span></span>
<span id="cb366-10"><a href="#cb366-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">;</span></span>
<span id="cb366-11"><a href="#cb366-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-12"><a href="#cb366-12" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;What input do you want to &#39;cat&#39; (choose from below)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb366-13"><a href="#cb366-13" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;/bin/ls&quot;</span><span class="op">);</span> <span class="co">/* show available files */</span></span>
<span id="cb366-14"><a href="#cb366-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-15"><a href="#cb366-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;input &gt; &quot;</span><span class="op">);</span></span>
<span id="cb366-16"><a href="#cb366-16" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span> <span class="co">/* force stdout to print */</span></span>
<span id="cb366-17"><a href="#cb366-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-18"><a href="#cb366-18" aria-hidden="true" tabindex="-1"></a>    scanf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span>input<span class="op">);</span><span class="co">/* read input */</span></span>
<span id="cb366-19"><a href="#cb366-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-20"><a href="#cb366-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* clean input before passing to /bin/cat */</span></span>
<span id="cb366-21"><a href="#cb366-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">40</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb366-22"><a href="#cb366-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>input<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> <span class="ch">&#39;;&#39;</span> <span class="op">||</span> input<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> <span class="ch">&#39;|&#39;</span> <span class="op">||</span> input<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> <span class="ch">&#39;$&#39;</span> <span class="op">||</span> input<span class="op">[</span>i<span class="op">]</span> <span class="op">==</span> <span class="ch">&#39;&amp;&#39;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb366-23"><a href="#cb366-23" aria-hidden="true" tabindex="-1"></a>            input<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span> <span class="co">/* change all ;,|,$,&amp; to a NULL */</span></span>
<span id="cb366-24"><a href="#cb366-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb366-25"><a href="#cb366-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb366-26"><a href="#cb366-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-27"><a href="#cb366-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* concatenate the two strings */</span></span>
<span id="cb366-28"><a href="#cb366-28" aria-hidden="true" tabindex="-1"></a>    strcat<span class="op">(</span>cmd<span class="op">,</span>input<span class="op">);</span></span>
<span id="cb366-29"><a href="#cb366-29" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Executing: </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> cmd<span class="op">);</span></span>
<span id="cb366-30"><a href="#cb366-30" aria-hidden="true" tabindex="-1"></a>    fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb366-31"><a href="#cb366-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-32"><a href="#cb366-32" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span>cmd<span class="op">);</span></span>
<span id="cb366-33"><a href="#cb366-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-34"><a href="#cb366-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb366-35"><a href="#cb366-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <pre><code>$ ./overflow_system
What input do you want to &#39;cat&#39; (choose from below)
cat    execvp_cat    inject_system    inject_system.c~  Makefile  overflow_system    overflow_system.c~  run_foo.c  setenv_cat    setenv_cat.c~  system_cat    #system-ex.c#
cat.c  execvp_cat.c  inject_system.c  input.txt     mal-lib   overflow_system.c  run_foo         run_foo.o  setenv_cat.c  shared-lib     system_cat.c
input &gt; ;cat
Executing: /bin/cat ./
/bin/cat: ./: Is a directory</code></pre>
            <p>This time, no dice, but the jig is not up yet. There is
            an <em>overflow attack</em>.</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li>Inspect the program. What happens when we increase the
            size of the string input into the program?</li>
            <li>At any point does the program start to do “bad
            things”?</li>
            </ul>
            <p>To increase the input side programatically, we’ll use a
            small trick to print a bunch of <code>A</code>s:</p>
            <pre><code>$ python -c &quot;print &#39;A&#39;*10&quot;
AAAAAAAAAA
$ python -c &quot;print &#39;A&#39;*30&quot;
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
$ python -c &quot;print &#39;A&#39;*50&quot;
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</code></pre>
            <p>This produces strings of varying lengths <code>10</code>,
            <code>30</code>, and <code>50</code>. Those strings can be
            sent to the target program using a pipe. And we can see the
            result:</p>
            <pre><code>$ python -c &quot;print &#39;A&#39;*10&quot; | ./inject_system
What input do you want to &#39;cat&#39; (choose from below)
01_lecture.md  cat  execvp_cat  execvp_cat.c  fake_cat  fake_cat.c  inject_system  inject_system.c  Makefile  overflow_system.c  setenv_cat  setenv_cat.c  system_cat  system_cat.c
input &gt; Executing: /bin/cat ./AAAAAAAAAA
/bin/cat: ./AAAAAAAAAA: No such file or directory
$ python -c &quot;print &#39;A&#39;*30&quot; | ./inject_system
What input do you want to &#39;cat&#39; (choose from below)
01_lecture.md  cat  execvp_cat  execvp_cat.c  fake_cat  fake_cat.c  inject_system  inject_system.c  Makefile  overflow_system.c  setenv_cat  setenv_cat.c  system_cat  system_cat.c
input &gt; Executing: /bin/cat ./AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
/bin/cat: ./AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA: No such file or directory
$ python -c &quot;print &#39;A&#39;*50&quot; | ./inject_system
What input do you want to &#39;cat&#39; (choose from below)
01_lecture.md  cat  execvp_cat  execvp_cat.c  fake_cat  fake_cat.c  inject_system  inject_system.c  Makefile  overflow_system.c  setenv_cat  setenv_cat.c  system_cat  system_cat.c
input &gt; Executing: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
sh: 1: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA: not found</code></pre>
            <p>Something changes at when the input string is
            <code>50</code> bytes long. We overflow the buffer for the
            input.</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li>Inspect the code, or run the program above, and deduce
            what values of the string length cause the first failure to
            execute <code>/bin/cat</code>.</li>
            </ul>
            <p>Recall that the input buffer is only <code>40</code>
            bytes and size, and it is placed adjacent to the cmd
            buffer:</p>
            <pre><code>char cmd[1024] = &quot;/bin/cat ./&quot;; /* will append to this string */
char input[40];</code></pre>
            <p>When the <code>input</code> buffer overflows, we begin to
            write <code>A</code>s to <code>cmd</code> which replaces
            <code>/bin/cat</code> with whatever string is written at
            that location! Yikes. Finally, we concatenate
            <code>cmd</code> with input, resulting in a long string of
            <code>A</code>s for the command being executed by
            <code>system()</code>.</p>
            <p>How do we leverage this error to pwn this program? The
            program is trying to execute a command that is
            <code>AAA...</code> and we can control the
            <code>PATH</code>. Lets get dangerous. Let’s create such a
            program named <code>AAA...</code>, so that it is executed
            when we overflow!</p>
            <pre><code>$ cp cat AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
$ ./AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Goodbye World</code></pre>
            <p>Now when we execute the overflow, we get our desired
            “Goodbye World” result:</p>
            <pre><code>python -c &quot;print &#39;A&#39;*50&quot; | ./inject_system
What input do you want to &#39;cat&#39; (choose from below)
01_lecture.md                                          cat           fake_cat       inject_system.c    setenv_cat    system_cat.c
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA     execvp_cat    fake_cat.c     Makefile           setenv_cat.c
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA  execvp_cat.c  inject_system  overflow_system.c  system_cat
input &gt; Executing: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Goodbye World</code></pre>
            <p>Uh-oh: we’re executing attacker-controlled code
            again!</p>
            <p><strong>Question:</strong></p>
            <ul>
            <li>How would you fix this bug?</li>
            <li>How should we generally fix overflow bugs?</li>
            </ul>
            <p>The most direct way is to always “bound check” accesses
            to strings, just like Java and Python do. For example,
            always use library functions like <code>strncp()</code> or
            <code>strncat()</code> that we can use to prevent
            <code>input</code> from overflowing, but that is even
            sometimes not sufficient. This can all get quite complex.
            This is an introduction to this issue, and not the final
            say.</p>
            <h1 data-number="15" id="the-android-unix-personality"><span
            class="header-section-number">15</span> The Android UNIX
            Personality</h1>
            <p>Find the <a
            href="./slides/android_slides.html">slides</a>.</p>
            <h1 data-number="16" id="unix-containers"><span
            class="header-section-number">16</span> UNIX Containers</h1>
            <p>Find the <a
            href="./slides/container_slides.html">slides</a>.</p>
            <h1 data-number="17"
            id="appendix-c-programming-conventions"><span
            class="header-section-number">17</span> Appendix: C
            Programming Conventions</h1>
            <p>C gives you quite a bit of freedom in how you write your
            code. Conventions are <em>necessary</em> in C because they
            bring order to the unrestricted freedom that allows code
            that is too complicated to debug, too clever to understand,
            and completely unmaintainable. Conventions are a set of
            rules that we follow that inherently <em>limit</em> the way
            in which we write code. The intention is to put <a
            href="https://en.wikipedia.org/wiki/Guard_rail">guard
            rails</a> onto our development process and to only deviate
            from the conventions in exceptional cases. An important
            aspect of this is that once you understand the conventions,
            it is <em>drastically easier to read the code</em> because
            you only have to consider how convention-based code is
            written. This means that there is a significant importance
            to uniformly applying conventions. Because of this, it is
            less important if one likes the conventions, than it is to
            adhere to them for uniformity.</p>
            <p>Put another way, it is easy for <em>any</em> programmer
            to code themself into a corner where the program is more
            complex than our brains can handle. Being an experienced
            programmer is <em>much less</em> about being able to handle
            more complexity, and much more about understanding that you
            need to spend significant development time
            <em>simplifying</em> your code. Conventions are a set of
            codified simplifications, in some sense. They provide your a
            set of rules (that you don’t need to think about, you just
            do) to simplify the structure of your code.</p>
            <p>OK, onward to conventions!</p>
            <h2 data-number="17.1" id="naming-conventions"><span
            class="header-section-number">17.1</span> Naming
            Conventions</h2>
            <p>There are many potential naming conventions, for example,
            <a href="https://en.wikipedia.org/wiki/Camel_case">camel
            case</a>, <a
            href="https://en.wikipedia.org/wiki/Snake_case">snake
            case</a>, and <a
            href="https://en.wikipedia.org/wiki/Hungarian_notation">hungarian
            notiation</a>. Some are antiquated (hungarian), but most are
            a matter of taste and convention.</p>
            <blockquote>
            <p><strong>Convention.</strong> Most C uses lower-case
            <code>snake_case</code> for variables, types, and functions,
            capital <code>SNAKE_CASE</code> for constants and
            macros.</p>
            </blockquote>
            <p>Stick to this convention. A new convention will likely
            not feel “right” because it is new and different. Remember
            that they are subjective, but the aim to apply them
            uniformly.</p>
            <p>For names that are visible across <code>.c</code> files
            (i.e. functions in a <code>.h</code> file), use names that
            are the shortest they can be to convey the functionality.
            Within functions, names can be short, and here there are a
            few conventions as well:</p>
            <ul>
            <li><code>ret</code> is a variable that stores a return
            value (i.e. a value that will later be used as in
            <code>return ret;</code>).</li>
            <li><code>i</code>, <code>j</code>, <code>k</code>,
            <code>l</code> are iterator variables.</li>
            </ul>
            <h2 data-number="17.2" id="namespacing"><span
            class="header-section-number">17.2</span> Namespacing</h2>
            <p>When you create a global variable, type, or function,
            you’re creating a symbol that can be accessed for any
            <code>.c</code> file. This has a significant downside: if
            you choose a name that is already used in a library, or that
            is common, you might get a linker error along the lines
            of:</p>
            <pre><code>multiple definition of `foo&#39;; /tmp/ccrvA8in.o:a.c:(.text+0x0): first defined here
...
collect2: error: ld returned 1 exit status</code></pre>
            <p>This means that the naming choices each application and
            library makes can easily cause such a problem.</p>
            <blockquote>
            <p><strong>Convention.</strong> Thus, the convention is that
            you should “namespace” your functions and variables by
            pre-pending them with a functionality-specific prefix. For
            example, a key-value store might have all of its types,
            variables, and functions prefixed with <code>kv_</code>, for
            example, <code>kv_get</code>.</p>
            </blockquote>
            <h2 data-number="17.3" id="headers-and-visibility"><span
            class="header-section-number">17.3</span> Headers and
            Visibility</h2>
            <p>C does not have classes and the rules therein to support
            per-class/object encapsulation. Instead, C views each
            <code>.c</code> file as a unit of visibility. Functions and
            global variables (known as “symbols”) can be hooked up with
            references to them in other objects by the linker. However,
            it is possible to write code in a <code>.c</code> file that
            is <em>not visible</em> outside of that file. In contrast to
            the linking error above emphasizing good naming, if a symbol
            is marked as <code>static</code>, no other <code>.c</code>
            file will be able to reference that symbol.</p>
            <div class="sourceCode" id="cb374"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> global_var<span class="op">;</span></span>
<span id="cb374-2"><a href="#cb374-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> foo<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> <span class="op">}</span></span></code></pre></div>
            <p>No other <code>.c</code> file can define code that will
            be able to access <code>global_var</code> nor call
            <code>foo</code>. You can see the list of all symbols within
            a <code>.c</code> file that are accessible outside of it by
            compiling into a <code>.o</code> file (using
            <code>gcc -c ...</code>), and
            <code>nm -g --defined-only x.o | awk '{print $3}'</code>
            (replace <code>x</code> with your object file name).</p>
            <blockquote>
            <p><strong>Convention.</strong> All functions and variables
            that are not part of the <em>public interface</em> with
            which to interact with the <code>.c</code> file should be
            <code>static</code> so that they cannot be used from other
            objects.</p>
            </blockquote>
            <p>This convention enables <code>.c</code> files to support
            encapsulation. It is also important to support encapsulation
            at compile time (which is before linking). We want our
            compiler to tell us if we try and access a symbol we
            shouldn’t be able to access. Header files are
            <code>#include</code>d into <code>.c</code> files, thus
            providing access to the symbol names and types, so that the
            <code>.c</code> file can compile while referencing symbols
            in another.</p>
            <blockquote>
            <p><strong>Convention.</strong> The focus of header files
            should be to provide the types for the data and functions of
            a public interface, and nothing more.</p>
            </blockquote>
            <p>When we include a file, it just copies the file at the
            point of the <code>#include</code>. Thus, if the same header
            is included separately into two <code>.c</code> files, then
            it effectively replicates the header’s contents into the two
            <code>.o</code> files. This can cause problems if the two
            <code>.o</code> files are linked together. An example:</p>
            <p><code>a.c</code>:</p>
            <div class="sourceCode" id="cb375"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;c.h&quot;</span></span></code></pre></div>
            <p><code>b.c</code>:</p>
            <div class="sourceCode" id="cb376"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;c.h&quot;</span></span>
<span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-3"><a href="#cb376-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span></code></pre></div>
            <p><code>c.h</code>:</p>
            <div class="sourceCode" id="cb377"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> foo<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span> <span class="op">}</span></span></code></pre></div>
            <p>After compiling these files, we get</p>
            <pre><code>$ gcc -c a.c -o a.o
$ gcc -c b.c -o b.o
$ gcc a.o b.o -o test
/usr/bin/ld: b.o: in function `foo&#39;:
b.c:(.text+0x0): multiple definition of `foo&#39;; a.o:a.c:(.text+0x0): first defined here
collect2: error: ld returned 1 exit status</code></pre>
            <p>Because <code>foo</code> was replicated into each
            <code>.o</code> file, when they were linked together the
            linker said “I see two <code>foo</code>s!”. Note that we
            would have avoided this if we put only the function
            declaration (i.e. the type information) in the
            <code>.h</code> file (e.g. <code>int foo(void);</code>).</p>
            <blockquote>
            <p><strong>Convention.</strong> Never put global data in a
            <code>.h</code> file. Only put type information
            (e.g. function declarations) in <code>.h</code> files<a
            href="#fn26" class="footnote-ref" id="fnref26"
            role="doc-noteref"><sup>26</sup></a>.</p>
            </blockquote>
            <h2 data-number="17.4" id="what-to-include"><span
            class="header-section-number">17.4</span> What to
            Include?</h2>
            <p>You <em>must</em> include the header files that provide
            the functionality that you rely on and use. This sounds
            obvious, but it is <em>very</em> easy to mess this up. A
            couple of examples:</p>
            <p><em>Example 1: Implementing a library.</em> You’re
            implementing a library, and you have a <code>.h</code> file
            for it that exposes the types of the library’s functions.
            You test your library, and it works wonderfully – victory!
            However, because it is a library, it might be used by other
            people’s code, and all they are going to do is
            <code>#include &lt;your_lib.h&gt;</code>, and expect
            everything to work.</p>
            <p>What if the following happened? Your
            <code>your_lib.h</code> file does this:</p>
            <div class="sourceCode" id="cb379"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* ... */</span></span>
<span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a><span class="dt">size_t</span> my_function<span class="op">(</span><span class="kw">struct</span> my_type <span class="op">*</span>t<span class="op">);</span></span>
<span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a><span class="co">/* ... */</span></span></code></pre></div>
            <p>In your test file, you do this:</p>
            <div class="sourceCode" id="cb380"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stddef.h&gt;</span></span>
<span id="cb380-2"><a href="#cb380-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;your_lib.h&gt;</span></span>
<span id="cb380-3"><a href="#cb380-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-4"><a href="#cb380-4" aria-hidden="true" tabindex="-1"></a><span class="co">/* ... */</span></span></code></pre></div>
            <p>Your tests of your library work wonderfully! But if the
            user of your library simply does:</p>
            <div class="sourceCode" id="cb381"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;your_lib.h&gt;</span></span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a><span class="co">/* ... */</span></span></code></pre></div>
            <p>The user will get a compiler error that says it doesn’t
            understand what <code>size_t</code> is! The core problem is
            that your library’s header file didn’t include all of the
            headers it relies on! Instead, it should updated to look
            like so:</p>
            <div class="sourceCode" id="cb382"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stddef.h&gt;</span><span class="pp"> </span><span class="co">/* we require `size_t` */</span></span>
<span id="cb382-2"><a href="#cb382-2" aria-hidden="true" tabindex="-1"></a><span class="co">/* ... */</span></span>
<span id="cb382-3"><a href="#cb382-3" aria-hidden="true" tabindex="-1"></a><span class="dt">size_t</span> my_function<span class="op">(</span><span class="kw">struct</span> my_type <span class="op">*</span>t<span class="op">);</span></span>
<span id="cb382-4"><a href="#cb382-4" aria-hidden="true" tabindex="-1"></a><span class="co">/* ... */</span></span></code></pre></div>
            <p>A good way to defensively code to try to minimize the
            chance that this error happens, you should include your
            header files <em>before</em> the rest of the header files.
            The only real solution is to be very careful, and always
            include what headers are necessary for the functionality you
            depend on.</p>
            <p><em>Example 2: implementing a program or test.</em> A
            <code>.c</code> file, lets say <code>my_prog.c</code>,
            includes some header file, <code>head.h</code>. It compiles
            just fine. But if <code>my_prog.c</code> relies on some
            header file – lets say <code>dep.h</code> – that is only
            included itself in the <code>head.h</code> file, then if
            <code>head.h</code> is updated and removes the include, it
            will break any program that depends on it! In this case,
            <code>my_prog.c</code> should explicitly include
            <code>dep.h</code>: include the headers that are required
            for your functionality!</p>
            <p><em>How do you know which headers to include?</em> If
            you’re using a system function, the <code>man</code> page
            for it is explicit about which headers provide the necessary
            functionality. If you’re implementing a library in the
            class, we are explicit about what headers are required.</p>
            <h2 data-number="17.5" id="depth-complexity"><span
            class="header-section-number">17.5</span> Depth =
            Complexity</h2>
            <p>Syntactic nesting, or depth often significantly increase
            the cognitive complexity in C<a href="#fn27"
            class="footnote-ref" id="fnref27"
            role="doc-noteref"><sup>27</sup></a>. Two examples of
            this:</p>
            <p><strong>Depth through indentation nesting.</strong> Each
            additional nesting level (each nested set of
            <code>{}</code>) adds another condition that you must keep
            in your mind<a href="#fn28" class="footnote-ref"
            id="fnref28" role="doc-noteref"><sup>28</sup></a> when
            understanding the code. This includes the conditions, or
            looping conditions associated with the nesting level. This
            is <em>a lot</em> to keep in your head, and makes developing
            and reading code quite a bit more difficult.</p>
            <p>What can you do to avoid this nesting? <em>First</em>,
            return early for errors. Instead of the following code…</p>
            <div class="sourceCode" id="cb383"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>a<span class="op">)</span> <span class="op">{</span></span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* normal code */</span></span>
<span id="cb383-3"><a href="#cb383-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb383-4"><a href="#cb383-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* error code */</span></span>
<span id="cb383-5"><a href="#cb383-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb383-6"><a href="#cb383-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            <p>…do the following…</p>
            <div class="sourceCode" id="cb384"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(!</span>a<span class="op">)</span> <span class="op">{</span></span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* error code */</span></span>
<span id="cb384-3"><a href="#cb384-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb384-4"><a href="#cb384-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb384-5"><a href="#cb384-5" aria-hidden="true" tabindex="-1"></a><span class="co">/* normal code */</span></span></code></pre></div>
            <p>Though seemingly trivial, it enables you to separate your
            understanding of error conditions from the complexity of the
            following code. Try to perform as much error checking as
            soon as it possibly can be done so that you can switch into
            “normal case” thinking.</p>
            <p><em>Second</em>, if you nest deeper than four levels of
            brackets, then pull code out into appropriately-named
            functions. Long functions aren’t necessarily bad, but
            <em>complex</em> functions are.</p>
            <blockquote>
            <p><strong>Convention.</strong></p>
            <ol type="1">
            <li>Separate error handling where possible, and put it as
            close to the top of the function as possible.</li>
            <li>If you nest brackets deeper than 4 levels, pull logic
            out into separate, appropriately named functions.</li>
            </ol>
            </blockquote>
            <p>I use indentation levels in C of eight visual spaces to
            make it visually clear when I’m indenting too much.</p>
            <p><strong>Depth through field nesting.</strong> It can be
            quite difficult to follow code that nests access to fields.
            For example:</p>
            <div class="sourceCode" id="cb385"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb385-1"><a href="#cb385-1" aria-hidden="true" tabindex="-1"></a>a<span class="op">.</span>b<span class="op">-&gt;</span>c<span class="op">[</span>d<span class="op">].</span>e <span class="op">=</span> f<span class="op">.</span>g<span class="op">-&gt;</span>h<span class="op">;</span></span></code></pre></div>
            <p>Of course, this is fake code, but even if it wasn’t,
            keeping track of the types of each of the levels of
            increasing depth of field reference is nearly impossible.
            This will make writing the code fickle and challenging, and
            reading the code, needlessly complex.</p>
            <p>The main means we have to remove this complexity is
            to</p>
            <ol type="1">
            <li><p>Create an set of typed variables</p>
            <div class="sourceCode" id="cb386"><pre
            class="sourceCode c"><code class="sourceCode c"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> <span class="op">*</span>b   <span class="op">=</span> <span class="op">&amp;</span>a<span class="op">.</span>b<span class="op">;</span></span>
<span id="cb386-2"><a href="#cb386-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> <span class="op">*</span>c<span class="op">[]</span> <span class="op">=</span> b<span class="op">-&gt;</span>c<span class="op">;</span></span>
<span id="cb386-3"><a href="#cb386-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> <span class="op">*</span>g   <span class="op">=</span> <span class="op">&amp;</span>f<span class="op">.</span>g<span class="op">;</span></span>
<span id="cb386-4"><a href="#cb386-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb386-5"><a href="#cb386-5" aria-hidden="true" tabindex="-1"></a>c<span class="op">[</span>d<span class="op">].</span>e <span class="op">=</span> g<span class="op">-&gt;</span>h<span class="op">;</span></span></code></pre></div>
            <p>It is up to you to decide where it is right to provide an
            “intermediate” type for a certain depth in the fields, and
            when to directly dive into a few fields.</p></li>
            <li><p>If any the structs (or sub-structs, or arrays)
            represents an API layer, then you can call a function that
            performs the necessary operation on that part of the
            data-structure. This both provide abstraction over the data
            access, and documents the types.</p></li>
            </ol>
            <blockquote>
            <p><strong>Convention.</strong> When faced with walking
            through nested composite data-structures, use intermediate
            variables to make types explicit, or functions to abstract
            operations.</p>
            </blockquote>
            <h2 data-number="17.6"
            id="object-orientation-initialization-destruction-and-methods"><span
            class="header-section-number">17.6</span> Object
            Orientation: Initialization, Destruction, and Methods</h2>
            <p>C is an imperative programming language as it came before
            Object Orientation (OO) took hold. That said, the OO concept
            of <a
            href="https://en.wikipedia.org/wiki/Encapsulation_(computer_programming)">encapsulation</a>
            behind an <a
            href="https://en.wikipedia.org/wiki/Abstract_data_type">abstract
            data type</a> is a universal requirement of programming in
            complex environments. Though C doesn’t support this
            explicitly, conventions can provide much of the same
            benefit. Such an abstraction requires</p>
            <ol type="1">
            <li>a <em>datatype</em> that stores the information required
            for the abstraction (think: a list, a key-value store,
            etc…),</li>
            <li>a set of <em>methods</em> to operate on that datatype,
            and</li>
            <li>means to <em>create and destroy</em> objects of that
            datatype.</li>
            </ol>
            <p>If we wanted to provide a key-value datatype,
            <code>kv</code>, we’d provide these in C by</p>
            <ol type="1">
            <li>providing a <code>struct kv</code> for the datatype in
            which the rest of the data is contained,</li>
            <li>publicly providing (in <code>kv.h</code>) a set of
            functions with names all prefixed with <code>kv_</code>,
            that take the <code>kv</code> to operate on as the first
            argument
            (e.g. <code>void *kv_get(struct kv *kv, int key);</code>) –
            this first argument acts as “<code>this</code>” in Java,
            and</li>
            <li>allocate and deallocate functions, for example,
            <code>struct kv *kv_alloc(...)</code> and
            <code>void kv_free(struct kv *kv)</code><a href="#fn29"
            class="footnote-ref" id="fnref29"
            role="doc-noteref"><sup>29</sup></a>.</li>
            </ol>
            <p>C can support polymorphism, inheritance, dependency
            injection and composition as well, but we’ll leave that for
            a future discussion.</p>
            <blockquote>
            <p><strong>Convention.</strong></p>
            <ol type="1">
            <li>Meticulously name your header files, your structure, and
            the methods to act on the datatype to associate them with
            each other.</li>
            <li>Pass the object to be acted on as the first argument to
            each of the “methods” to act as the C equivalent of
            “<code>this</code>”.</li>
            <li>Provide allocation and deallocation functions for the
            datatype.</li>
            </ol>
            </blockquote>
            <p>With this, we encourage the client (user of the API) to
            think of the datatype as encapsulated.</p>
            <aside id="footnotes"
            class="footnotes footnotes-end-of-document"
            role="doc-endnotes">
            <hr />
            <ol>
            <li id="fn1"><p>Which is provided by <code>gcc</code> and
            can be found in
            <code>/usr/include/gcc/x86_64-linux-gnu/9/include/stddef.h</code>.<a
            href="#fnref1" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn2"><p>In <code>/usr/include/limits.h</code>.<a
            href="#fnref2" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn3"><p>Arrays differ from pointers as 1. the
            <code>sizeof</code> operator on an array variable gives the
            total size of the array (including all elements) whereas for
            pointers, it returns the size of the pointer (i.e. 8 bytes
            on a 64 bit architecture); 2. <code>&amp;</code> on an array
            returns the address of the first item in the array whereas
            for pointers, it returns the address of the pointer; and 3.
            assignments to pointers end up initializing the pointer to
            an address, or doing math on the pointer whereas for arrays,
            initialization will initialize items in the array, and
            math/assignment after initialization are not allowed.<a
            href="#fnref3" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn4"><p>Not always an easy feat. See the previous
            discussion on Common Errors.<a href="#fnref4"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            <li id="fn5"><p>for example, in
            <code>/usr/include/asm/errno.h</code>.<a href="#fnref5"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            <li id="fn6"><p>C was also created as part of the original
            UNIX as a necessary tool to implement the OS!<a
            href="#fnref6" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn7"><p>This is a little bit like when an agent
            transforms from a normal citizen in the Matrix.<a
            href="#fnref7" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn8"><p>Yes, yes, yes, I know this is getting
            redundant. Key-value stores are <em>everywhere</em>!<a
            href="#fnref8" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn9"><p>Hint: make sure to read the <code>man</code>
            pages for <code>exit</code> (<code>man 1 exit</code>).<a
            href="#fnref9" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn10"><p><code>ps</code> prints out process
            information, <code>grep</code> filters the output to only
            lines including the argument (<code>gparmer</code> here),
            and <code>awk</code> enables us to print out specific
            columns (column <code>2</code> here). You should start
            getting familiar with your command-line utilities!<a
            href="#fnref10" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn11"><p>“Channel” is a term that is heavily
            overloaded, but I’ll inherit the general term from the <a
            href="https://www.gnu.org/software/libc/manual/html_node/Stream_002fDescriptor-Precautions.html">glibc
            documentation</a>.<a href="#fnref11" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn12"><p>We see why the name “file” in file
            descriptors is not very accurate. Recall that I’m using the
            traditional “file descriptors” to denote all of our generic
            descriptors.<a href="#fnref12" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn13"><p>We’ll discuss the kernel later, and
            dual-mode execution to protect the implementation of these
            calls in OS.<a href="#fnref13" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn14"><p>A hallmark of <em>bad design</em> is
            functionality that is not <a
            href="https://www.youtube.com/watch?v=mKJcqvozfA8&amp;t=2124s"><em>orthogonal</em>
            with existing functionality</a>. When a feature must be
            considered in the logic for many other features, we’re
            adding a significant complexity to the system.<a
            href="#fnref14" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn15"><p>Please, please do <em>not</em> try this.<a
            href="#fnref15" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn16"><p>This is useful to redirect shell output to
            if you don’t care about the output.<a href="#fnref16"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            <li id="fn17"><p>I’ll try and call it a “file descriptor”
            when we know the descriptor is to a file.<a href="#fnref17"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            <li id="fn18"><p>This is called a “race condition”. File
            “locking” helps solve this issue, but we’ll delay discussing
            locking until the OS class.<a href="#fnref18"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            <li id="fn19"><p>ELF is a file format for binary programs in
            the same way that <code>html</code> is the data format for
            webpages, <code>.c</code> for C files, <a
            href="https://raw.githubusercontent.com/corkami/pics/master/binary/PNG.png"><code>.png</code></a>
            for images, and <a
            href="https://raw.githubusercontent.com/corkami/pics/master/binary/PDF.png"><code>.pdf</code></a>
            for documents. It just happens to contain all of the
            information necessary to link and execute a program! It may
            be surprising, but comparable formats even exist for <a
            href="https://github.com/corkami/pics/blob/master/binary/CLASS.png">java
            (<code>.class</code>) files</a> as well.<a href="#fnref19"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            <li id="fn20"><p>Note: these are hexadecimal values, not
            base-10 digits.<a href="#fnref20" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn21"><p>This is increasingly not true as many
            compilers support <a
            href="https://en.wikipedia.org/wiki/Interprocedural_optimization#WPO_and_LTO">Link-Time
            Optimization</a> (LTO). This goes beyond the scope of this
            class.<a href="#fnref21" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn22"><p>We can even choose to use a different
            program interpreter, for example, <code>interp.so</code>,
            using <code>gcc -Wl,--dynamic-linker,interp.so</code>.<a
            href="#fnref22" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn23"><p>This sharing of library memory across
            processes is why dynamic libraries are also called
            <em>shared libraries.</em><a href="#fnref23"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            <li id="fn24"><p>What are “flags”? The notion of “flags” is
            pretty confusing. Flags are often simply a set of bits (in
            this case, the bits of the <code>int</code>) where each bit
            specifies some option. In this case, there’s a bit for
            <code>RTLD_NOW</code> which says to load all of the symbol
            dependencies now, and a separate bit for
            <code>RTLD_LOCAL</code> which says that subsequent libraries
            should not see this library’s symbols. In short, these are
            just single bits in the “flags” integer, thus they can be
            bitwise or-ed together (thus the <code>|</code>) to specify
            options – they are simply a way to specify a set of
            options.<a href="#fnref24" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn25"><p>Note, this is just <span
            class="math inline">2<sup>16</sup></span>, using shifts to
            emulate the power operator.<a href="#fnref25"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            <li id="fn26"><p>There are sometimes optimization-driven
            motivations to place function definitions in <code>.h</code>
            files. In such cases, the functions <em>must</em> be marked
            <code>static</code> to avoid the above problem.<a
            href="#fnref26" class="footnote-back"
            role="doc-backlink">↩︎</a></p></li>
            <li id="fn27"><p>…and in most languages that don’t support
            first class functions/closures.<a href="#fnref27"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            <li id="fn28"><p>Short term memory only holds 7 <span
            class="math inline">±</span> 2 items, an each nesting level
            expands at least one.<a href="#fnref28"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            <li id="fn29"><p>We also often provide an initialization
            function that initializes a <code>struct kv</code> instead
            of allocating a new one
            (e.g. <code>int kv_init(struct kv *kv)</code>). These are
            useful since C allows stack and global allocation of the
            datatype, and we want to provide a means to initialize one
            of those allocations.<a href="#fnref29"
            class="footnote-back" role="doc-backlink">↩︎</a></p></li>
            </ol>
            </aside>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

</body>
</html>
